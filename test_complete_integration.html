<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分批止盈完整集成测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="static/css/components.css" rel="stylesheet">
    <style>
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">分批止盈完整集成测试</h1>
            </div>
        </div>
        
        <div class="row">
            <!-- 左侧：交易表单 -->
            <div class="col-md-6">
                <div class="test-section">
                    <h3>交易记录表单</h3>
                    <form id="trade-form">
                        <!-- 基本信息 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">股票代码</label>
                                <input type="text" class="form-control" name="stock_code" value="000001" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">股票名称</label>
                                <input type="text" class="form-control" name="stock_name" value="平安银行" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">交易类型</label>
                                <select class="form-select" name="trade_type" required>
                                    <option value="">请选择</option>
                                    <option value="buy" selected>买入</option>
                                    <option value="sell">卖出</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">价格</label>
                                <input type="number" class="form-control" name="price" value="20.00" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">数量</label>
                                <input type="number" class="form-control" name="quantity" value="1000" step="100" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">交易原因</label>
                            <select class="form-select" name="reason" required>
                                <option value="">请选择</option>
                                <option value="技术分析" selected>技术分析</option>
                                <option value="基本面分析">基本面分析</option>
                                <option value="消息面">消息面</option>
                            </select>
                        </div>
                        
                        <!-- 分批止盈开关 -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">止损止盈设置</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="use-batch-profit-taking" checked>
                                <label class="form-check-label" for="use-batch-profit-taking">
                                    分批止盈
                                </label>
                            </div>
                        </div>
                        
                        <!-- 分批止盈组件容器 -->
                        <div id="profit-targets-container" class="mb-3">
                            <!-- 组件将在这里渲染 -->
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i>
                                保存交易记录
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadTestData()">
                                <i class="bi bi-upload"></i>
                                加载测试数据
                            </button>
                            <button type="button" class="btn btn-warning" onclick="clearForm()">
                                <i class="bi bi-arrow-clockwise"></i>
                                重置表单
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 右侧：测试结果 -->
            <div class="col-md-6">
                <div class="test-section">
                    <h3>测试状态</h3>
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator status-info" id="component-status"></span>
                            <span>组件初始化</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator status-info" id="validation-status"></span>
                            <span>数据验证</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator status-info" id="api-status"></span>
                            <span>API通信</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="status-indicator status-info" id="integration-status"></span>
                            <span>集成测试</span>
                        </div>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>实时日志</h3>
                    <div id="test-log" class="console-output">
                        等待测试开始...
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                            <i class="bi bi-trash"></i>
                            清空日志
                        </button>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>数据预览</h3>
                    <div id="data-preview" class="console-output" style="max-height: 200px;">
                        等待数据...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本加载 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/utils.js"></script>
    <script src="static/js/profit-targets-manager.js"></script>
    
    <script>
        let profitManager = null;
        let testResults = {
            component: false,
            validation: false,
            api: false,
            integration: false
        };
        
        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-log');
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('test-log').textContent = '日志已清空\n';
        }
        
        // 更新状态指示器
        function updateStatus(component, success) {
            const statusElement = document.getElementById(`${component}-status`);
            statusElement.className = `status-indicator ${success ? 'status-success' : 'status-error'}`;
            testResults[component] = success;
        }
        
        // 更新数据预览
        function updateDataPreview(data) {
            const previewDiv = document.getElementById('data-preview');
            previewDiv.textContent = JSON.stringify(data, null, 2);
        }
        
        // 初始化组件
        function initProfitManager() {
            log('初始化分批止盈组件...');
            
            try {
                if (typeof ProfitTargetsManager === 'undefined') {
                    throw new Error('ProfitTargetsManager 类未定义');
                }
                
                const container = document.getElementById('profit-targets-container');
                profitManager = new ProfitTargetsManager(container, {
                    maxTargets: 5,
                    minTargets: 1,
                    buyPrice: 20.00,
                    onTargetsChange: function(targets, isValid) {
                        log(`目标变化: ${targets.length}个目标, 有效性: ${isValid}`);
                        updateDataPreview({ targets, isValid });
                        updateStatus('validation', isValid);
                    },
                    onValidationChange: function(isValid, errors) {
                        log(`验证变化: 有效性: ${isValid}, 错误数: ${Object.keys(errors).length}`);
                        if (!isValid) {
                            log(`验证错误: ${JSON.stringify(errors)}`, 'warning');
                        }
                        updateStatus('validation', isValid);
                    }
                });
                
                log('组件初始化成功', 'success');
                updateStatus('component', true);
                
                // 加载默认测试数据
                setTimeout(() => {
                    loadTestData();
                }, 500);
                
            } catch (error) {
                log(`组件初始化失败: ${error.message}`, 'error');
                updateStatus('component', false);
            }
        }
        
        // 加载测试数据
        function loadTestData() {
            if (!profitManager) {
                log('组件未初始化', 'error');
                return;
            }
            
            try {
                log('加载测试数据...');
                
                const testTargets = [
                    {
                        targetPrice: 22.00,
                        sellRatio: 30.00,
                        sequenceOrder: 1
                    },
                    {
                        targetPrice: 24.00,
                        sellRatio: 40.00,
                        sequenceOrder: 2
                    },
                    {
                        targetPrice: 26.00,
                        sellRatio: 30.00,
                        sequenceOrder: 3
                    }
                ];
                
                profitManager.setBuyPrice(20.00);
                profitManager.setTargets(testTargets);
                
                log('测试数据加载成功', 'success');
                
            } catch (error) {
                log(`加载测试数据失败: ${error.message}`, 'error');
            }
        }
        
        // 清空表单
        function clearForm() {
            if (profitManager) {
                profitManager.clear();
            }
            log('表单已重置');
        }
        
        // 表单提交处理
        document.getElementById('trade-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            log('开始提交交易记录...');
            updateStatus('api', false);
            updateStatus('integration', false);
            
            try {
                // 收集表单数据
                const formData = new FormData(this);
                const tradeData = {
                    stock_code: formData.get('stock_code'),
                    stock_name: formData.get('stock_name'),
                    trade_type: formData.get('trade_type'),
                    price: parseFloat(formData.get('price')),
                    quantity: parseInt(formData.get('quantity')),
                    reason: formData.get('reason'),
                    use_batch_profit_taking: document.getElementById('use-batch-profit-taking').checked
                };
                
                // 如果使用分批止盈，添加止盈目标
                if (tradeData.use_batch_profit_taking && profitManager) {
                    const targets = profitManager.getTargets();
                    if (targets.length === 0) {
                        throw new Error('请至少设置一个止盈目标');
                    }
                    
                    // 验证目标数据
                    if (!profitManager.isValid()) {
                        throw new Error('止盈目标数据验证失败');
                    }
                    
                    // 转换为API格式
                    tradeData.profit_targets = targets.map(target => ({
                        target_price: target.targetPrice,
                        sell_ratio: target.sellRatio / 100, // 转换为小数
                        sequence_order: target.sequenceOrder
                    }));
                }
                
                log(`提交数据: ${JSON.stringify(tradeData, null, 2)}`);
                
                // 发送API请求
                const response = await fetch('/api/trades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tradeData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log('交易记录创建成功', 'success');
                    log(`交易记录ID: ${result.data.id}`);
                    
                    updateStatus('api', true);
                    updateStatus('integration', true);
                    
                    // 显示创建的记录详情
                    if (result.data.profit_targets) {
                        log(`止盈目标数量: ${result.data.profit_targets.length}`);
                        result.data.profit_targets.forEach((target, index) => {
                            log(`  目标${index + 1}: 价格=${target.target_price}, 比例=${(target.sell_ratio * 100).toFixed(1)}%`);
                        });
                    }
                    
                    updateDataPreview(result.data);
                    
                } else {
                    throw new Error(result.error?.message || '创建失败');
                }
                
            } catch (error) {
                log(`提交失败: ${error.message}`, 'error');
                updateStatus('api', false);
                updateStatus('integration', false);
            }
        });
        
        // 监听交易类型变化
        document.querySelector('select[name="trade_type"]').addEventListener('change', function(e) {
            const isBuy = e.target.value === 'buy';
            const batchSwitch = document.getElementById('use-batch-profit-taking');
            const container = document.getElementById('profit-targets-container');
            
            if (isBuy) {
                batchSwitch.disabled = false;
                container.style.display = batchSwitch.checked ? 'block' : 'none';
            } else {
                batchSwitch.disabled = true;
                batchSwitch.checked = false;
                container.style.display = 'none';
            }
        });
        
        // 监听分批止盈开关
        document.getElementById('use-batch-profit-taking').addEventListener('change', function(e) {
            const container = document.getElementById('profit-targets-container');
            container.style.display = e.target.checked ? 'block' : 'none';
            
            if (e.target.checked && profitManager) {
                // 更新买入价格
                const buyPrice = parseFloat(document.querySelector('input[name="price"]').value) || 0;
                profitManager.setBuyPrice(buyPrice);
            }
        });
        
        // 监听价格变化
        document.querySelector('input[name="price"]').addEventListener('input', function(e) {
            if (profitManager && document.getElementById('use-batch-profit-taking').checked) {
                const buyPrice = parseFloat(e.target.value) || 0;
                profitManager.setBuyPrice(buyPrice);
            }
        });
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成');
            
            // 检查依赖
            if (typeof UXUtils !== 'undefined') {
                log('UXUtils 已加载', 'success');
            } else {
                log('UXUtils 未加载', 'error');
            }
            
            if (typeof ProfitTargetsManager !== 'undefined') {
                log('ProfitTargetsManager 已加载', 'success');
            } else {
                log('ProfitTargetsManager 未加载', 'error');
            }
            
            // 初始化组件
            setTimeout(initProfitManager, 500);
        });
    </script>
</body>
</html>