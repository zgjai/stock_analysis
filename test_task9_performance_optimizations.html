<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡9æ€§èƒ½ä¼˜åŒ–æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">ä»»åŠ¡9ï¼šæ€§èƒ½ä¼˜åŒ–æµ‹è¯•</h1>
        
        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">æ€§èƒ½ä¼˜åŒ–æµ‹è¯•æ§åˆ¶é¢æ¿</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>åŸºç¡€æµ‹è¯•</h6>
                        <button class="btn btn-primary btn-sm me-2 mb-2" onclick="testDebounce()">æµ‹è¯•é˜²æŠ–æœºåˆ¶</button>
                        <button class="btn btn-primary btn-sm me-2 mb-2" onclick="testThrottle()">æµ‹è¯•èŠ‚æµæœºåˆ¶</button>
                        <button class="btn btn-primary btn-sm me-2 mb-2" onclick="testSaveProgress()">æµ‹è¯•ä¿å­˜è¿›åº¦</button>
                        <button class="btn btn-primary btn-sm me-2 mb-2" onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
                    </div>
                    <div class="col-md-6">
                        <h6>æ€§èƒ½ç›‘æ§</h6>
                        <button class="btn btn-info btn-sm me-2 mb-2" onclick="showPerformanceReport()">æ€§èƒ½æŠ¥å‘Š</button>
                        <button class="btn btn-info btn-sm me-2 mb-2" onclick="measurePagePerformance()">é¡µé¢æ€§èƒ½</button>
                        <button class="btn btn-warning btn-sm me-2 mb-2" onclick="optimizePerformance()">æ‰§è¡Œä¼˜åŒ–</button>
                        <button class="btn btn-success btn-sm me-2 mb-2" onclick="exportPerformanceData()">å¯¼å‡ºæ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">æµ‹è¯•ç»“æœ</h5>
            </div>
            <div class="card-body">
                <div id="test-results">
                    <p class="text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ‹Ÿå¤ç›˜è¡¨å• -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">æ¨¡æ‹Ÿå¤ç›˜è¡¨å•</h5>
            </div>
            <div class="card-body">
                <form id="review-form">
                    <input type="hidden" id="review-id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" class="form-control" id="review-stock-code" name="stock_code" placeholder="000001">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å¤ç›˜æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="review-date" name="review_date">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">æŒä»“å¤©æ•°</label>
                            <input type="number" class="form-control" id="holding-days" name="holding_days" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å½“å‰ä»·æ ¼</label>
                            <input type="number" class="form-control" id="current-price-input" name="current_price" step="0.01">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†æå†…å®¹</label>
                        <textarea class="form-control" id="analysis" name="analysis" rows="3" placeholder="è¾“å…¥åˆ†æå†…å®¹..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å†³ç­–ç†ç”±</label>
                        <textarea class="form-control" id="reason" name="reason" rows="2" placeholder="è¾“å…¥å†³ç­–ç†ç”±..."></textarea>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="save-status-indicator">
                            <small class="text-muted">å·²ä¿å­˜</small>
                        </div>
                        <button type="button" class="btn btn-primary" id="save-review-btn" onclick="testSave()">ä¿å­˜å¤ç›˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ç”¨äºæµ‹è¯• -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å¤ç›˜è¯„åˆ†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- è¡¨å•å†…å®¹ä¼šè¢«å¤åˆ¶åˆ°è¿™é‡Œ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="modal-save-btn">ä¿å­˜å¤ç›˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScriptä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- åŠ è½½é¡¹ç›®è„šæœ¬ -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/performance-optimizations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/unified-message-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/review-save-manager.js') }}"></script>

    <script>
        // å…¨å±€å˜é‡
        let reviewSaveManager = null;
        let apiClient = null;
        let testResults = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–æµ‹è¯•é¡µé¢');
            
            // åˆå§‹åŒ–APIå®¢æˆ·ç«¯
            if (typeof ApiClient !== 'undefined') {
                apiClient = new ApiClient();
                console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
            }
            
            // åˆå§‹åŒ–ä¿å­˜ç®¡ç†å™¨
            if (typeof ReviewSaveManager !== 'undefined') {
                reviewSaveManager = new ReviewSaveManager('#review-form');
                console.log('âœ… ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
            }
            
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            document.getElementById('review-date').value = new Date().toISOString().split('T')[0];
            
            console.log('ğŸ‰ æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // æµ‹è¯•å‡½æ•°
        function testDebounce() {
            console.log('ğŸ§ª æµ‹è¯•é˜²æŠ–æœºåˆ¶');
            addTestResult('é˜²æŠ–æµ‹è¯•', 'å¼€å§‹æµ‹è¯•é˜²æŠ–æœºåˆ¶...', 'info');
            
            let callCount = 0;
            const debouncedFunction = debounce(() => {
                callCount++;
                console.log(`é˜²æŠ–å‡½æ•°è¢«è°ƒç”¨ï¼Œç¬¬${callCount}æ¬¡`);
                addTestResult('é˜²æŠ–æµ‹è¯•', `é˜²æŠ–å‡½æ•°æ‰§è¡Œå®Œæˆï¼Œæ€»è°ƒç”¨æ¬¡æ•°: ${callCount}`, 'success');
            }, 500);
            
            // å¿«é€Ÿè°ƒç”¨å¤šæ¬¡
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    debouncedFunction();
                    console.log(`ç¬¬${i + 1}æ¬¡è°ƒç”¨é˜²æŠ–å‡½æ•°`);
                }, i * 50);
            }
            
            addTestResult('é˜²æŠ–æµ‹è¯•', 'å·²å‘èµ·10æ¬¡å¿«é€Ÿè°ƒç”¨ï¼Œé¢„æœŸåªæ‰§è¡Œ1æ¬¡', 'warning');
        }

        function testThrottle() {
            console.log('ğŸ§ª æµ‹è¯•èŠ‚æµæœºåˆ¶');
            addTestResult('èŠ‚æµæµ‹è¯•', 'å¼€å§‹æµ‹è¯•èŠ‚æµæœºåˆ¶...', 'info');
            
            let callCount = 0;
            const throttledFunction = throttle(() => {
                callCount++;
                console.log(`èŠ‚æµå‡½æ•°è¢«è°ƒç”¨ï¼Œç¬¬${callCount}æ¬¡`);
                addTestResult('èŠ‚æµæµ‹è¯•', `èŠ‚æµå‡½æ•°æ‰§è¡Œï¼Œç¬¬${callCount}æ¬¡è°ƒç”¨`, 'primary');
            }, 200);
            
            // å¿«é€Ÿè°ƒç”¨å¤šæ¬¡
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    throttledFunction();
                }, i * 50);
            }
            
            addTestResult('èŠ‚æµæµ‹è¯•', 'å·²å‘èµ·20æ¬¡å¿«é€Ÿè°ƒç”¨ï¼Œé¢„æœŸæ‰§è¡Œçº¦5-6æ¬¡', 'warning');
        }

        function testSaveProgress() {
            console.log('ğŸ§ª æµ‹è¯•ä¿å­˜è¿›åº¦');
            addTestResult('è¿›åº¦æµ‹è¯•', 'å¼€å§‹æµ‹è¯•ä¿å­˜è¿›åº¦æ˜¾ç¤º...', 'info');
            
            if (!reviewSaveManager) {
                addTestResult('è¿›åº¦æµ‹è¯•', 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'danger');
                return;
            }
            
            // æ¨¡æ‹Ÿä¿å­˜è¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 20;
                reviewSaveManager.showSaveProgress(progress, `æ­¥éª¤${progress/20}: å¤„ç†ä¸­...`);
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    addTestResult('è¿›åº¦æµ‹è¯•', 'ä¿å­˜è¿›åº¦æµ‹è¯•å®Œæˆ', 'success');
                    
                    setTimeout(() => {
                        reviewSaveManager.hideSaveProgress();
                    }, 2000);
                }
            }, 500);
        }

        function testErrorHandling() {
            console.log('ğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†');
            addTestResult('é”™è¯¯å¤„ç†æµ‹è¯•', 'å¼€å§‹æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶...', 'info');
            
            if (!reviewSaveManager) {
                addTestResult('é”™è¯¯å¤„ç†æµ‹è¯•', 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'danger');
                return;
            }
            
            // æµ‹è¯•ä¸åŒç±»å‹çš„é”™è¯¯
            const errorTypes = [
                { message: 'Network error occurred', type: 'ç½‘ç»œé”™è¯¯' },
                { message: 'Validation failed: required field missing', type: 'éªŒè¯é”™è¯¯' },
                { message: 'Server internal error', type: 'æœåŠ¡å™¨é”™è¯¯' },
                { message: 'Request timeout', type: 'è¶…æ—¶é”™è¯¯' }
            ];
            
            errorTypes.forEach((error, index) => {
                setTimeout(() => {
                    const mockError = new Error(error.message);
                    reviewSaveManager.handleSaveError(mockError);
                    addTestResult('é”™è¯¯å¤„ç†æµ‹è¯•', `æµ‹è¯•${error.type}: ${error.message}`, 'warning');
                }, index * 2000);
            });
        }

        function testSave() {
            console.log('ğŸ§ª æµ‹è¯•ä¿å­˜åŠŸèƒ½');
            addTestResult('ä¿å­˜æµ‹è¯•', 'å¼€å§‹æµ‹è¯•ä¿å­˜åŠŸèƒ½...', 'info');
            
            if (!reviewSaveManager) {
                addTestResult('ä¿å­˜æµ‹è¯•', 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'danger');
                return;
            }
            
            // å¡«å……ä¸€äº›æµ‹è¯•æ•°æ®
            document.getElementById('review-stock-code').value = '000001';
            document.getElementById('holding-days').value = '5';
            document.getElementById('current-price-input').value = '10.50';
            document.getElementById('analysis').value = 'æµ‹è¯•åˆ†æå†…å®¹';
            document.getElementById('reason').value = 'æµ‹è¯•å†³ç­–ç†ç”±';
            
            // è§¦å‘å˜åŒ–æ£€æµ‹
            reviewSaveManager.detectChanges();
            
            // æ¨¡æ‹Ÿä¿å­˜
            setTimeout(() => {
                reviewSaveManager.saveReview();
                addTestResult('ä¿å­˜æµ‹è¯•', 'å·²è§¦å‘ä¿å­˜æ“ä½œ', 'success');
            }, 500);
        }

        function addTestResult(category, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = {
                timestamp,
                category,
                message,
                type
            };
            
            testResults.push(result);
            
            const resultsContainer = document.getElementById('test-results');
            const alertClass = `alert-${type === 'primary' ? 'primary' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'danger' ? 'danger' : 'info'}`;
            
            const resultElement = document.createElement('div');
            resultElement.className = `alert ${alertClass} alert-dismissible fade show`;
            resultElement.innerHTML = `
                <strong>[${timestamp}] ${category}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            resultsContainer.appendChild(resultElement);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }

        // æ€§èƒ½ç›‘æ§å‡½æ•°
        function showPerformanceReport() {
            if (reviewSaveManager && typeof reviewSaveManager.getPerformanceReport === 'function') {
                const report = reviewSaveManager.getPerformanceReport();
                addTestResult('æ€§èƒ½æŠ¥å‘Š', 'æ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'info');
                console.table(report.metrics);
                return report;
            } else {
                addTestResult('æ€§èƒ½æŠ¥å‘Š', 'æ€§èƒ½æŠ¥å‘ŠåŠŸèƒ½ä¸å¯ç”¨', 'warning');
                return null;
            }
        }

        function measurePagePerformance() {
            if ('performance' in window) {
                const navigation = performance.getEntriesByType('navigation')[0];
                const metrics = {
                    'DNSæŸ¥è¯¢': (navigation.domainLookupEnd - navigation.domainLookupStart).toFixed(2) + 'ms',
                    'TCPè¿æ¥': (navigation.connectEnd - navigation.connectStart).toFixed(2) + 'ms',
                    'è¯·æ±‚å“åº”': (navigation.responseEnd - navigation.requestStart).toFixed(2) + 'ms',
                    'DOMè§£æ': (navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart).toFixed(2) + 'ms',
                    'é¡µé¢åŠ è½½': (navigation.loadEventEnd - navigation.loadEventStart).toFixed(2) + 'ms'
                };
                
                addTestResult('é¡µé¢æ€§èƒ½', 'é¡µé¢æ€§èƒ½æŒ‡æ ‡å·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'info');
                console.table(metrics);
                return metrics;
            } else {
                addTestResult('é¡µé¢æ€§èƒ½', 'Performance API ä¸å¯ç”¨', 'warning');
                return null;
            }
        }

        function optimizePerformance() {
            addTestResult('æ€§èƒ½ä¼˜åŒ–', 'å¼€å§‹æ‰§è¡Œæ€§èƒ½ä¼˜åŒ–...', 'info');
            
            // æ¸…ç†æµ‹è¯•ç»“æœ
            const alerts = document.querySelectorAll('.alert:not(.show)');
            alerts.forEach(alert => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            });
            
            // æ¸…ç†ç¼“å­˜
            if (reviewSaveManager && typeof reviewSaveManager.performMemoryCleanup === 'function') {
                reviewSaveManager.performMemoryCleanup();
            }
            
            addTestResult('æ€§èƒ½ä¼˜åŒ–', 'æ€§èƒ½ä¼˜åŒ–å®Œæˆ', 'success');
        }

        function exportPerformanceData() {
            if (reviewSaveManager && typeof reviewSaveManager.exportPerformanceData === 'function') {
                reviewSaveManager.exportPerformanceData();
                addTestResult('æ•°æ®å¯¼å‡º', 'æ€§èƒ½æ•°æ®å·²å¯¼å‡º', 'success');
            } else {
                addTestResult('æ•°æ®å¯¼å‡º', 'æ•°æ®å¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨', 'warning');
            }
        }

        // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸç”¨äºæ§åˆ¶å°è°ƒè¯•
        window.testDebounce = testDebounce;
        window.testThrottle = testThrottle;
        window.testSaveProgress = testSaveProgress;
        window.testErrorHandling = testErrorHandling;
        window.testSave = testSave;
        window.showPerformanceReport = showPerformanceReport;
        window.measurePagePerformance = measurePagePerformance;
        window.optimizePerformance = optimizePerformance;
        window.exportPerformanceData = exportPerformanceData;
    </script>
</body>
</html>