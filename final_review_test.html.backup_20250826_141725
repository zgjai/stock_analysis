<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ç›˜ä¿®å¤éªŒè¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-check-circle"></i>
                            å¤ç›˜é¡µé¢ä¿®å¤éªŒè¯
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5><i class="bi bi-info-circle"></i> ä¿®å¤å†…å®¹</h5>
                            <ul class="mb-0">
                                <li>âœ… ä¿®å¤äº† FloatingProfitCalculator åˆå§‹åŒ–é”™è¯¯</li>
                                <li>âœ… æ·»åŠ äº†ç¼ºå¤±çš„ debounce å’Œ throttle å‡½æ•°</li>
                                <li>âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œä¾èµ–æ£€æŸ¥</li>
                                <li>âœ… æ·»åŠ äº†åŠ è½½çŠ¶æ€å¼ºåˆ¶æ¸…ç†åŠŸèƒ½</li>
                            </ul>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <h5>è‡ªåŠ¨æµ‹è¯•ç»“æœ</h5>
                                <div id="test-results" class="border rounded p-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                    <div class="text-muted">æ­£åœ¨è¿è¡Œè‡ªåŠ¨æµ‹è¯•...</div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <h5>æ‰‹åŠ¨æµ‹è¯•</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                                    <input type="text" id="stock-code" class="form-control" value="000001">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">ä¹°å…¥ä»·æ ¼</label>
                                    <input type="number" id="buy-price" class="form-control" value="10.50" step="0.01">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">å½“å‰ä»·æ ¼</label>
                                    <input type="number" id="current-price" class="form-control" value="11.20" step="0.01">
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button id="test-calculator" class="btn btn-primary">
                                        <i class="bi bi-calculator"></i> æµ‹è¯•æµ®ç›ˆè®¡ç®—
                                    </button>
                                    
                                    <button id="force-cleanup" class="btn btn-warning">
                                        <i class="bi bi-arrow-clockwise"></i> å¼ºåˆ¶æ¸…ç†åŠ è½½
                                    </button>
                                    
                                    <button id="rerun-tests" class="btn btn-info">
                                        <i class="bi bi-play"></i> é‡æ–°è¿è¡Œæµ‹è¯•
                                    </button>
                                    
                                    <a href="/review" class="btn btn-success">
                                        <i class="bi bi-arrow-right"></i> è®¿é—®å¤ç›˜é¡µé¢
                                    </a>
                                </div>
                                
                                <div id="manual-result" class="mt-3"></div>
                            </div>
                        </div>
                        
                        <!-- éšè—çš„æµ‹è¯•å…ƒç´  -->
                        <div style="display: none;">
                            <input type="number" id="current-price-input" step="0.01" min="0">
                            <div id="floating-profit-ratio" class="text-muted">--</div>
                            <div id="buy-price-display" class="text-muted">--</div>
                            <div id="profit-amount-display" class="text-muted">--</div>
                            <div id="floating-profit-error" class="text-danger small mt-1" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/floating-profit-calculator.js') }}"></script>
    <script src="{{ url_for('static', filename='js/review-integration.js') }}"></script>
    <script src="{{ url_for('static', filename='js/loading-cleanup.js') }}"></script>
    
    <script>
        let testResults = document.getElementById('test-results');
        let testCount = 0;
        let passedCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-info',
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-muted';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            testResults.appendChild(logEntry);
            testResults.scrollTop = testResults.scrollHeight;
        }
        
        function runTest(name, testFunc) {
            testCount++;
            log(`ğŸ§ª æµ‹è¯•: ${name}`, 'info');
            
            try {
                const result = testFunc();
                if (result) {
                    passedCount++;
                    log(`âœ… ${name} - é€šè¿‡`, 'success');
                } else {
                    log(`âŒ ${name} - å¤±è´¥`, 'error');
                }
                return result;
            } catch (error) {
                log(`ğŸ’¥ ${name} - å¼‚å¸¸: ${error.message}`, 'error');
                console.error(`æµ‹è¯• ${name} å¤±è´¥:`, error);
                return false;
            }
        }
        
        function testDependencies() {
            const deps = [
                { name: 'debounce', check: () => typeof debounce === 'function' },
                { name: 'throttle', check: () => typeof throttle === 'function' },
                { name: 'PerformanceUtils', check: () => typeof PerformanceUtils === 'object' },
                { name: 'FloatingProfitCalculator', check: () => typeof FloatingProfitCalculator === 'function' },
                { name: 'ReviewIntegrationManager', check: () => typeof ReviewIntegrationManager === 'function' },
                { name: 'forceCleanupLoadingStates', check: () => typeof forceCleanupLoadingStates === 'function' }
            ];
            
            let allPassed = true;
            deps.forEach(dep => {
                if (dep.check()) {
                    log(`  âœ“ ${dep.name}`, 'success');
                } else {
                    log(`  âŒ ${dep.name} ä¸å¯ç”¨`, 'error');
                    allPassed = false;
                }
            });
            
            return allPassed;
        }
        
        function testFloatingProfitCalculator() {
            try {
                // æµ‹è¯•åŸºæœ¬å®ä¾‹åŒ–
                const calculator = new FloatingProfitCalculator('000001', 10.50);
                log('  âœ“ å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•æ–¹æ³•ç»‘å®š
                if (typeof calculator.handlePriceInput === 'function') {
                    log('  âœ“ handlePriceInput æ–¹æ³•ç»‘å®šæ­£å¸¸', 'success');
                } else {
                    log('  âŒ handlePriceInput æ–¹æ³•ç»‘å®šå¤±è´¥', 'error');
                    return false;
                }
                
                // æµ‹è¯•è®¡ç®—åŠŸèƒ½
                calculator.setCurrentPrice(11.20);
                log('  âœ“ ä»·æ ¼è®¾ç½®æˆåŠŸ', 'success');
                
                const result = calculator.getCalculationResult();
                if (result && result.floating_profit_ratio !== null) {
                    log(`  âœ“ è®¡ç®—ç»“æœ: ${result.formatted_ratio}`, 'success');
                    return true;
                } else {
                    log('  âŒ æ— æ³•è·å–è®¡ç®—ç»“æœ', 'error');
                    return false;
                }
            } catch (error) {
                log(`  âŒ è®¡ç®—å™¨å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }
        
        function testReviewIntegrationManager() {
            try {
                const manager = new ReviewIntegrationManager();
                log('  âœ“ é›†æˆç®¡ç†å™¨åˆ›å»ºæˆåŠŸ', 'success');
                
                const state = manager.getState();
                if (state && typeof state === 'object') {
                    log('  âœ“ çŠ¶æ€è·å–æ­£å¸¸', 'success');
                    return true;
                } else {
                    log('  âŒ çŠ¶æ€è·å–å¤±è´¥', 'error');
                    return false;
                }
            } catch (error) {
                log(`  âŒ é›†æˆç®¡ç†å™¨å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }
        
        function testLoadingCleanup() {
            try {
                // åˆ›å»ºæµ‹è¯•åŠ è½½å…ƒç´ 
                const testSpinner = document.createElement('div');
                testSpinner.className = 'spinner-border test-spinner';
                testSpinner.textContent = 'åŠ è½½ä¸­...';
                document.body.appendChild(testSpinner);
                
                // æ‰§è¡Œæ¸…ç†
                forceCleanupLoadingStates();
                
                // æ£€æŸ¥æ˜¯å¦è¢«éšè—
                if (testSpinner.style.display === 'none') {
                    log('  âœ“ åŠ è½½çŠ¶æ€æ¸…ç†æ­£å¸¸', 'success');
                    testSpinner.remove();
                    return true;
                } else {
                    log('  âŒ åŠ è½½çŠ¶æ€æ¸…ç†å¤±è´¥', 'error');
                    testSpinner.remove();
                    return false;
                }
            } catch (error) {
                log(`  âŒ æ¸…ç†åŠŸèƒ½å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }
        
        function runAllTests() {
            testResults.innerHTML = '<div class="text-muted">ğŸš€ å¼€å§‹è¿è¡Œè‡ªåŠ¨æµ‹è¯•...</div>';
            testCount = 0;
            passedCount = 0;
            
            setTimeout(() => {
                runTest('JavaScriptä¾èµ–æ£€æŸ¥', testDependencies);
                runTest('æµ®ç›ˆè®¡ç®—å™¨åŠŸèƒ½', testFloatingProfitCalculator);
                runTest('é›†æˆç®¡ç†å™¨åŠŸèƒ½', testReviewIntegrationManager);
                runTest('åŠ è½½çŠ¶æ€æ¸…ç†åŠŸèƒ½', testLoadingCleanup);
                
                setTimeout(() => {
                    log('', 'info');
                    log('=' .repeat(40), 'info');
                    log(`ğŸ æµ‹è¯•å®Œæˆ: ${passedCount}/${testCount} é¡¹é€šè¿‡`, passedCount === testCount ? 'success' : 'warning');
                    
                    if (passedCount === testCount) {
                        log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¿®å¤æˆåŠŸï¼', 'success');
                        log('ğŸ‘‰ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨å¤ç›˜é¡µé¢äº†', 'success');
                    } else {
                        log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥', 'warning');
                    }
                }, 200);
            }, 500);
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('test-calculator').addEventListener('click', () => {
            const stockCode = document.getElementById('stock-code').value;
            const buyPrice = parseFloat(document.getElementById('buy-price').value);
            const currentPrice = parseFloat(document.getElementById('current-price').value);
            const resultDiv = document.getElementById('manual-result');
            
            try {
                const calculator = new FloatingProfitCalculator(stockCode, buyPrice);
                calculator.setCurrentPrice(currentPrice);
                const result = calculator.getCalculationResult();
                
                if (result) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle"></i> è®¡ç®—æˆåŠŸï¼</h6>
                            <small>
                                è‚¡ç¥¨: ${result.stock_code}<br>
                                ä¹°å…¥: Â¥${result.buy_price?.toFixed(2)}<br>
                                å½“å‰: Â¥${result.current_price?.toFixed(2)}<br>
                                æµ®ç›ˆ: <span class="${result.color_class}">${result.formatted_ratio}</span><br>
                                é‡‘é¢: Â¥${result.floating_profit_amount?.toFixed(2)}
                            </small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">âŒ è®¡ç®—å¤±è´¥</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        });
        
        document.getElementById('force-cleanup').addEventListener('click', () => {
            try {
                forceCleanupLoadingStates();
                document.getElementById('manual-result').innerHTML = 
                    '<div class="alert alert-warning">âš¡ å¼ºåˆ¶æ¸…ç†å·²æ‰§è¡Œ</div>';
            } catch (error) {
                document.getElementById('manual-result').innerHTML = 
                    `<div class="alert alert-danger">âŒ æ¸…ç†å¤±è´¥: ${error.message}</div>`;
            }
        });
        
        document.getElementById('rerun-tests').addEventListener('click', runAllTests);
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>