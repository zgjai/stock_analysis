<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UXUtils 修复测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>UXUtils 修复测试</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>测试缺失的函数</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary me-2" onclick="testShowGlobalLoading()">
                            测试 showGlobalLoading
                        </button>
                        <button class="btn btn-warning me-2" onclick="testForceHideAllLoading()">
                            测试 forceHideAllLoading
                        </button>
                        <button class="btn btn-success" onclick="testEditTradeScenario()">
                            模拟编辑交易场景
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>测试结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/utils.js"></script>
    <script>
        function logResult(message, type = 'info') {
            const results = document.getElementById('test-results');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            results.innerHTML += `
                <div class="alert ${alertClass} alert-sm py-2 mb-2">
                    ${new Date().toLocaleTimeString()}: ${message}
                </div>
            `;
            results.scrollTop = results.scrollHeight;
        }

        function testShowGlobalLoading() {
            try {
                logResult('测试 UXUtils.showGlobalLoading...', 'info');
                
                if (typeof UXUtils === 'undefined') {
                    logResult('❌ UXUtils 未定义', 'error');
                    return;
                }
                
                if (typeof UXUtils.showGlobalLoading !== 'function') {
                    logResult('❌ UXUtils.showGlobalLoading 不是函数', 'error');
                    return;
                }
                
                UXUtils.showGlobalLoading('测试加载中...');
                logResult('✅ UXUtils.showGlobalLoading 调用成功', 'success');
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    UXUtils.hideGlobalLoading();
                    logResult('✅ 自动隐藏全局加载状态', 'success');
                }, 3000);
                
            } catch (error) {
                logResult(`❌ 测试失败: ${error.message}`, 'error');
            }
        }

        function testForceHideAllLoading() {
            try {
                logResult('测试 UXUtils.forceHideAllLoading...', 'info');
                
                if (typeof UXUtils === 'undefined') {
                    logResult('❌ UXUtils 未定义', 'error');
                    return;
                }
                
                if (typeof UXUtils.forceHideAllLoading !== 'function') {
                    logResult('❌ UXUtils.forceHideAllLoading 不是函数', 'error');
                    return;
                }
                
                // 先显示一些加载状态
                UXUtils.showGlobalLoading('这个加载状态将被强制清理...');
                
                // 1秒后强制清理
                setTimeout(() => {
                    UXUtils.forceHideAllLoading();
                    logResult('✅ UXUtils.forceHideAllLoading 调用成功', 'success');
                }, 1000);
                
            } catch (error) {
                logResult(`❌ 测试失败: ${error.message}`, 'error');
            }
        }

        function testEditTradeScenario() {
            try {
                logResult('模拟编辑交易场景...', 'info');
                
                // 模拟 editTrade 函数中的调用
                logResult('1. 显示全局加载状态', 'info');
                UXUtils.showGlobalLoading('加载交易记录...');
                
                setTimeout(() => {
                    logResult('2. 模拟数据加载完成', 'info');
                    
                    // 模拟 finally 块中的调用
                    setTimeout(() => {
                        UXUtils.forceHideAllLoading();
                        logResult('3. ✅ 编辑交易场景测试完成', 'success');
                    }, 100);
                }, 2000);
                
            } catch (error) {
                logResult(`❌ 编辑交易场景测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后自动检查
        document.addEventListener('DOMContentLoaded', function() {
            logResult('页面加载完成，开始检查 UXUtils...', 'info');
            
            if (typeof UXUtils === 'undefined') {
                logResult('❌ UXUtils 未定义', 'error');
                return;
            }
            
            constFunctions = ['showGlobalLoading', 'forceHideAllLoading', 'hideGlobalLoading'];
            let allFunctionsExist = true;Functions.forEach(funcName => {
                if (typeof UXUtils[funcName] === 'function') {
                    logResult(`✅ UXUtils.${funcName} 存在`, 'success');
                } else {
                    logResult(`❌ UXUtils.${funcName} 不存在或不是函数`, 'error');
                    allFunctionsExist = false;
                }
            });
            
            if (allFunctionsExist) {
                logResult('🎉 所有必需的 UXUtils 函数都已正确定义！', 'success');
            } else {
                logResult('⚠️ 部分 UXUtils 函数缺失', 'error');
            }
        });
    </script>
</body>
</html>