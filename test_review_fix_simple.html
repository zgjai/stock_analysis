<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ç›˜ä¿®å¤ç®€å•æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-bug"></i>
                            å¤ç›˜é¡µé¢ä¿®å¤éªŒè¯
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>ä¿®å¤å†…å®¹ï¼š</strong>
                            <ul class="mb-0 mt-2">
                                <li>ä¿®å¤äº† FloatingProfitCalculator åˆå§‹åŒ–é”™è¯¯</li>
                                <li>æ·»åŠ äº† debounce å’Œ throttle å‡½æ•°</li>
                                <li>æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œä¾èµ–æ£€æŸ¥</li>
                                <li>æ·»åŠ äº†åŠ è½½çŠ¶æ€å¼ºåˆ¶æ¸…ç†åŠŸèƒ½</li>
                            </ul>
                        </div>
                        
                        <div id="test-results" class="mt-4">
                            <h5>æµ‹è¯•ç»“æœï¼š</h5>
                            <div id="test-log" class="border rounded p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <div class="text-muted">æ­£åœ¨è¿è¡Œæµ‹è¯•...</div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button id="run-tests" class="btn btn-primary">
                                <i class="bi bi-play-circle"></i>
                                é‡æ–°è¿è¡Œæµ‹è¯•
                            </button>
                            <button id="clear-log" class="btn btn-secondary">
                                <i class="bi bi-trash"></i>
                                æ¸…ç©ºæ—¥å¿—
                            </button>
                            <button id="force-cleanup" class="btn btn-warning">
                                <i class="bi bi-arrow-clockwise"></i>
                                å¼ºåˆ¶æ¸…ç†åŠ è½½çŠ¶æ€
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <h6>æµ®ç›ˆè®¡ç®—å™¨æµ‹è¯•ï¼š</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                                    <input type="text" id="stock-code" class="form-control" value="000001">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ä¹°å…¥ä»·æ ¼</label>
                                    <input type="number" id="buy-price" class="form-control" value="10.50" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">å½“å‰ä»·æ ¼</label>
                                    <input type="number" id="current-price" class="form-control" value="11.20" step="0.01">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button id="test-calculator" class="btn btn-success">
                                    <i class="bi bi-calculator"></i>
                                    æµ‹è¯•æµ®ç›ˆè®¡ç®—
                                </button>
                                
                                <div id="calculation-result" class="mt-2"></div>
                            </div>
                        </div>
                        
                        <!-- éšè—çš„æµ‹è¯•å…ƒç´  -->
                        <div style="display: none;">
                            <input type="number" id="current-price-input" step="0.01" min="0">
                            <div id="floating-profit-ratio" class="text-muted">--</div>
                            <div id="buy-price-display" class="text-muted">--</div>
                            <div id="profit-amount-display" class="text-muted">--</div>
                            <div id="floating-profit-error" class="text-danger small mt-1" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/floating-profit-calculator.js"></script>
    <script src="/static/js/review-integration.js"></script>
    <script src="/static/js/loading-cleanup.js"></script>
    
    <script>
        let testLog = document.getElementById('test-log');
        let testCount = 0;
        let passedCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-info',
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-muted';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            testLog.appendChild(logEntry);
            testLog.scrollTop = testLog.scrollHeight;
        }
        
        function runTest(name, testFunc) {
            testCount++;
            log(`å¼€å§‹æµ‹è¯•: ${name}`, 'info');
            
            try {
                const result = testFunc();
                if (result) {
                    passedCount++;
                    log(`âœ“ ${name} - é€šè¿‡`, 'success');
                } else {
                    log(`âŒ ${name} - å¤±è´¥`, 'error');
                }
                return result;
            } catch (error) {
                log(`âŒ ${name} - å¼‚å¸¸: ${error.message}`, 'error');
                console.error(`æµ‹è¯• ${name} å¤±è´¥:`, error);
                return false;
            }
        }
        
        function testDependencies() {
            const deps = [
                { name: 'debounce', check: () => typeof debounce === 'function' },
                { name: 'throttle', check: () => typeof throttle === 'function' },
                { name: 'PerformanceUtils', check: () => typeof PerformanceUtils === 'object' },
                { name: 'FloatingProfitCalculator', check: () => typeof FloatingProfitCalculator === 'function' },
                { name: 'ReviewIntegrationManager', check: () => typeof ReviewIntegrationManager === 'function' }
            ];
            
            let allPassed = true;
            deps.forEach(dep => {
                if (dep.check()) {
                    log(`  âœ“ ${dep.name} å¯ç”¨`, 'success');
                } else {
                    log(`  âŒ ${dep.name} ä¸å¯ç”¨`, 'error');
                    allPassed = false;
                }
            });
            
            return allPassed;
        }
        
        function testFloatingProfitCalculator() {
            try {
                const calculator = new FloatingProfitCalculator('000001', 10.50);
                log('  âœ“ è®¡ç®—å™¨å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                calculator.setCurrentPrice(11.20);
                log('  âœ“ è®¾ç½®å½“å‰ä»·æ ¼æˆåŠŸ', 'success');
                
                const result = calculator.getCalculationResult();
                if (result && result.floating_profit_ratio !== null) {
                    log(`  âœ“ è®¡ç®—ç»“æœ: ${result.formatted_ratio}`, 'success');
                    return true;
                } else {
                    log('  âŒ æ— æ³•è·å–è®¡ç®—ç»“æœ', 'error');
                    return false;
                }
            } catch (error) {
                log(`  âŒ è®¡ç®—å™¨æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }
        
        function testReviewIntegrationManager() {
            try {
                const manager = new ReviewIntegrationManager();
                log('  âœ“ é›†æˆç®¡ç†å™¨å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•çŠ¶æ€è·å–
                const state = manager.getState();
                if (state && typeof state === 'object') {
                    log('  âœ“ çŠ¶æ€è·å–æˆåŠŸ', 'success');
                    return true;
                } else {
                    log('  âŒ æ— æ³•è·å–çŠ¶æ€', 'error');
                    return false;
                }
            } catch (error) {
                log(`  âŒ é›†æˆç®¡ç†å™¨æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }
        
        function testLoadingCleanup() {
            try {
                if (typeof forceCleanupLoadingStates === 'function') {
                    log('  âœ“ åŠ è½½æ¸…ç†å‡½æ•°å¯ç”¨', 'success');
                    
                    // åˆ›å»ºä¸€ä¸ªæµ‹è¯•åŠ è½½å…ƒç´ 
                    const testElement = document.createElement('div');
                    testElement.className = 'spinner-border';
                    testElement.textContent = 'åŠ è½½ä¸­...';
                    document.body.appendChild(testElement);
                    
                    // æ‰§è¡Œæ¸…ç†
                    forceCleanupLoadingStates();
                    
                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦è¢«éšè—
                    if (testElement.style.display === 'none') {
                        log('  âœ“ åŠ è½½çŠ¶æ€æ¸…ç†åŠŸèƒ½æ­£å¸¸', 'success');
                        testElement.remove();
                        return true;
                    } else {
                        log('  âŒ åŠ è½½çŠ¶æ€æ¸…ç†åŠŸèƒ½å¼‚å¸¸', 'error');
                        testElement.remove();
                        return false;
                    }
                } else {
                    log('  âŒ åŠ è½½æ¸…ç†å‡½æ•°ä¸å¯ç”¨', 'error');
                    return false;
                }
            } catch (error) {
                log(`  âŒ åŠ è½½æ¸…ç†æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }
        
        function runAllTests() {
            testLog.innerHTML = '<div class="text-muted">å¼€å§‹è¿è¡Œæµ‹è¯•...</div>';
            testCount = 0;
            passedCount = 0;
            
            setTimeout(() => {
                runTest('JavaScriptä¾èµ–æ£€æŸ¥', testDependencies);
                runTest('æµ®ç›ˆè®¡ç®—å™¨åŠŸèƒ½', testFloatingProfitCalculator);
                runTest('é›†æˆç®¡ç†å™¨åŠŸèƒ½', testReviewIntegrationManager);
                runTest('åŠ è½½çŠ¶æ€æ¸…ç†åŠŸèƒ½', testLoadingCleanup);
                
                // æ˜¾ç¤ºæ€»ç»“
                setTimeout(() => {
                    log('', 'info');
                    log('='.repeat(40), 'info');
                    log(`æµ‹è¯•å®Œæˆ: ${passedCount}/${testCount} é¡¹é€šè¿‡`, passedCount === testCount ? 'success' : 'warning');
                    
                    if (passedCount === testCount) {
                        log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¿®å¤æˆåŠŸï¼', 'success');
                    } else {
                        log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥', 'warning');
                    }
                }, 100);
            }, 100);
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('run-tests').addEventListener('click', runAllTests);
        
        document.getElementById('clear-log').addEventListener('click', () => {
            testLog.innerHTML = '<div class="text-muted">æ—¥å¿—å·²æ¸…ç©º</div>';
        });
        
        document.getElementById('force-cleanup').addEventListener('click', () => {
            if (typeof forceCleanupLoadingStates === 'function') {
                forceCleanupLoadingStates();
                log('å¼ºåˆ¶æ¸…ç†æ‰§è¡Œå®Œæˆ', 'warning');
            } else {
                log('å¼ºåˆ¶æ¸…ç†å‡½æ•°ä¸å¯ç”¨', 'error');
            }
        });
        
        document.getElementById('test-calculator').addEventListener('click', () => {
            const stockCode = document.getElementById('stock-code').value;
            const buyPrice = parseFloat(document.getElementById('buy-price').value);
            const currentPrice = parseFloat(document.getElementById('current-price').value);
            const resultDiv = document.getElementById('calculation-result');
            
            try {
                const calculator = new FloatingProfitCalculator(stockCode, buyPrice);
                calculator.setCurrentPrice(currentPrice);
                const result = calculator.getCalculationResult();
                
                if (result) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>è®¡ç®—æˆåŠŸï¼</strong><br>
                            è‚¡ç¥¨ä»£ç : ${result.stock_code}<br>
                            ä¹°å…¥ä»·æ ¼: Â¥${result.buy_price?.toFixed(2) || 'N/A'}<br>
                            å½“å‰ä»·æ ¼: Â¥${result.current_price?.toFixed(2) || 'N/A'}<br>
                            æµ®ç›ˆæ¯”ä¾‹: <span class="${result.color_class}">${result.formatted_ratio}</span><br>
                            ç›ˆäºé‡‘é¢: Â¥${result.floating_profit_amount?.toFixed(2) || 'N/A'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">è®¡ç®—å¤±è´¥ï¼šæ— æ³•è·å–ç»“æœ</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">è®¡ç®—å¤±è´¥ï¼š${error.message}</div>`;
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>