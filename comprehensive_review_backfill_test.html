<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ç›˜æ•°æ®å›å¡«ç»¼åˆæµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .code-block { background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>å¤ç›˜æ•°æ®å›å¡«ç»¼åˆæµ‹è¯•</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>è‡ªåŠ¨åŒ–æµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
                        
                        <div id="test-results" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>æ‰‹åŠ¨æµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" class="form-control" id="test-stock-code" value="000001" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¤ç›˜æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="test-review-date">
                        </div>
                        <button class="btn btn-success" onclick="testSpecificRecord()">æµ‹è¯•æŒ‡å®šè®°å½•</button>
                        <button class="btn btn-info ms-2" onclick="testModalOpen()">æµ‹è¯•æ¨¡æ€æ¡†æ‰“å¼€</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•è¯´æ˜</h5>
                    </div>
                    <div class="card-body">
                        <h6>æµ‹è¯•é¡¹ç›®ï¼š</h6>
                        <ul>
                            <li>APIè¿æ¥æµ‹è¯•</li>
                            <li>æ•°æ®æ ¼å¼éªŒè¯</li>
                            <li>è®°å½•æŸ¥æ‰¾æµ‹è¯•</li>
                            <li>æ•°æ®å›å¡«æµ‹è¯•</li>
                            <li>æ¨¡æ€æ¡†åŠŸèƒ½æµ‹è¯•</li>
                        </ul>
                        
                        <h6 class="mt-3">ä½¿ç”¨æ–¹æ³•ï¼š</h6>
                        <ol>
                            <li>ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"</li>
                            <li>æŸ¥çœ‹æµ‹è¯•ç»“æœ</li>
                            <li>å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('test-review-date').value = new Date().toISOString().split('T')[0];
        
        function addTestResult(title, status, message, details = null) {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = status === 'success' ? 'test-success' : 
                               status === 'error' ? 'test-error' : 'test-warning';
            
            const resultHtml = `
                <div class="test-result ${resultClass}">
                    <strong>${title}</strong>: ${message}
                    ${details ? `<div class="mt-2"><small>${details}</small></div>` : ''}
                </div>
            `;
            
            resultsDiv.innerHTML += resultHtml;
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
        
        async function testApiConnection() {
            console.log('ğŸ” æµ‹è¯•APIè¿æ¥...');
            
            try {
                const response = await fetch('/api/reviews?per_page=1');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addTestResult('APIè¿æ¥æµ‹è¯•', 'success', 'APIè¿æ¥æ­£å¸¸');
                    return data;
                } else {
                    addTestResult('APIè¿æ¥æµ‹è¯•', 'error', `APIå“åº”å¼‚å¸¸: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                    return null;
                }
            } catch (error) {
                addTestResult('APIè¿æ¥æµ‹è¯•', 'error', `è¿æ¥å¤±è´¥: ${error.message}`);
                return null;
            }
        }
        
        async function testDataFormat(apiData) {
            console.log('ğŸ” æµ‹è¯•æ•°æ®æ ¼å¼...');
            
            if (!apiData || !apiData.data) {
                addTestResult('æ•°æ®æ ¼å¼æµ‹è¯•', 'error', 'æ²¡æœ‰æ•°æ®å¯ä¾›æµ‹è¯•');
                return false;
            }
            
            const data = apiData.data;
            let reviews = [];
            
            if (Array.isArray(data)) {
                reviews = data;
                addTestResult('æ•°æ®æ ¼å¼æµ‹è¯•', 'success', 'æ£€æµ‹åˆ°ç›´æ¥æ•°ç»„æ ¼å¼');
            } else if (data.reviews && Array.isArray(data.reviews)) {
                reviews = data.reviews;
                addTestResult('æ•°æ®æ ¼å¼æµ‹è¯•', 'success', 'æ£€æµ‹åˆ°åˆ†é¡µæ ¼å¼');
            } else {
                addTestResult('æ•°æ®æ ¼å¼æµ‹è¯•', 'warning', 'æœªçŸ¥çš„æ•°æ®æ ¼å¼');
                return false;
            }
            
            if (reviews.length > 0) {
                const sample = reviews[0];
                constFields = ['id', 'stock_code', 'review_date'];
                const missingFields =Fields.filter(field => !(field in sample));
                
                if (missingFields.length === 0) {
                    addTestResult('æ•°æ®å­—æ®µæµ‹è¯•', 'success', 'æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨');
                } else {
                    addTestResult('æ•°æ®å­—æ®µæµ‹è¯•', 'error', `ç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}`);
                }
            }
            
            return true;
        }
        
        async function testRecordSearch() {
            console.log('ğŸ” æµ‹è¯•è®°å½•æŸ¥æ‰¾...');
            
            const stockCode = '000001';
            const reviewDate = new Date().toISOString().split('T')[0];
            
            try {
                const queryParams = new URLSearchParams({
                    stock_code: stockCode,
                    start_date: reviewDate,
                    end_date: reviewDate,
                    per_page: 1
                });
                
                const response = await fetch(`/api/reviews?${queryParams}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addTestResult('è®°å½•æŸ¥æ‰¾æµ‹è¯•', 'success', `æŸ¥æ‰¾ ${stockCode} çš„è®°å½•æˆåŠŸ`);
                    return data;
                } else {
                    addTestResult('è®°å½•æŸ¥æ‰¾æµ‹è¯•', 'warning', `æ²¡æœ‰æ‰¾åˆ° ${stockCode} çš„è®°å½•`);
                    return null;
                }
            } catch (error) {
                addTestResult('è®°å½•æŸ¥æ‰¾æµ‹è¯•', 'error', `æŸ¥æ‰¾å¤±è´¥: ${error.message}`);
                return null;
            }
        }
        
        async function testModalFunctions() {
            console.log('ğŸ” æµ‹è¯•æ¨¡æ€æ¡†å‡½æ•°...');
            
            const functions = [
                'testReviewDataBackfill',
                'debugReviewModal',
                'openReviewModal',
                'checkAndLoadExistingReview',
                'populateModalWithExistingReview'
            ];
            
            let availableFunctions = 0;
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    availableFunctions++;
                } else {
                    console.warn(`å‡½æ•° ${funcName} ä¸å¯ç”¨`);
                }
            });
            
            if (availableFunctions === functions.length) {
                addTestResult('æ¨¡æ€æ¡†å‡½æ•°æµ‹è¯•', 'success', 'æ‰€æœ‰å¿…éœ€å‡½æ•°éƒ½å¯ç”¨');
            } else {
                addTestResult('æ¨¡æ€æ¡†å‡½æ•°æµ‹è¯•', 'warning', 
                    `${availableFunctions}/${functions.length} ä¸ªå‡½æ•°å¯ç”¨`);
            }
            
            return availableFunctions > 0;
        }
        
        async function runAllTests() {
            clearResults();
            addTestResult('æµ‹è¯•å¼€å§‹', 'success', 'å¼€å§‹è¿è¡Œç»¼åˆæµ‹è¯•...');
            
            // 1. æµ‹è¯•APIè¿æ¥
            const apiData = await testApiConnection();
            
            // 2. æµ‹è¯•æ•°æ®æ ¼å¼
            if (apiData) {
                await testDataFormat(apiData);
            }
            
            // 3. æµ‹è¯•è®°å½•æŸ¥æ‰¾
            await testRecordSearch();
            
            // 4. æµ‹è¯•æ¨¡æ€æ¡†å‡½æ•°
            await testModalFunctions();
            
            addTestResult('æµ‹è¯•å®Œæˆ', 'success', 'æ‰€æœ‰æµ‹è¯•å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ç»“æœ');
        }
        
        async function testSpecificRecord() {
            const stockCode = document.getElementById('test-stock-code').value;
            const reviewDate = document.getElementById('test-review-date').value;
            
            if (!stockCode || !reviewDate) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç å’Œå¤ç›˜æ—¥æœŸ');
                return;
            }
            
            clearResults();
            addTestResult('æŒ‡å®šè®°å½•æµ‹è¯•', 'success', `æµ‹è¯• ${stockCode} åœ¨ ${reviewDate} çš„è®°å½•...`);
            
            if (typeof window.testReviewDataBackfill === 'function') {
                try {
                    const result = await window.testReviewDataBackfill(stockCode, reviewDate);
                    if (result) {
                        addTestResult('è®°å½•æŸ¥æ‰¾', 'success', 'æ‰¾åˆ°åŒ¹é…è®°å½•', 
                            `ID: ${result.id}, è¯„åˆ†: ${result.total_score || 0}/5`);
                    } else {
                        addTestResult('è®°å½•æŸ¥æ‰¾', 'warning', 'æœªæ‰¾åˆ°åŒ¹é…è®°å½•');
                    }
                } catch (error) {
                    addTestResult('è®°å½•æŸ¥æ‰¾', 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            } else {
                addTestResult('å‡½æ•°æ£€æŸ¥', 'error', 'testReviewDataBackfill å‡½æ•°ä¸å¯ç”¨');
            }
        }
        
        async function testModalOpen() {
            const stockCode = document.getElementById('test-stock-code').value;
            
            if (!stockCode) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            if (typeof window.openReviewModal === 'function') {
                try {
                    await window.openReviewModal(stockCode);
                    addTestResult('æ¨¡æ€æ¡†æµ‹è¯•', 'success', `æˆåŠŸæ‰“å¼€ ${stockCode} çš„å¤ç›˜æ¨¡æ€æ¡†`);
                } catch (error) {
                    addTestResult('æ¨¡æ€æ¡†æµ‹è¯•', 'error', `æ‰“å¼€å¤±è´¥: ${error.message}`);
                }
            } else {
                addTestResult('æ¨¡æ€æ¡†æµ‹è¯•', 'error', 'openReviewModal å‡½æ•°ä¸å¯ç”¨');
            }
        }
    </script>
</body>
</html>