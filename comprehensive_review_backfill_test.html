<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复盘数据回填综合测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .code-block { background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>复盘数据回填综合测试</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>自动化测试</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="runAllTests()">运行所有测试</button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">清空结果</button>
                        
                        <div id="test-results" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>手动测试</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">股票代码</label>
                            <input type="text" class="form-control" id="test-stock-code" value="000001" placeholder="输入股票代码">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">复盘日期</label>
                            <input type="date" class="form-control" id="test-review-date">
                        </div>
                        <button class="btn btn-success" onclick="testSpecificRecord()">测试指定记录</button>
                        <button class="btn btn-info ms-2" onclick="testModalOpen()">测试模态框打开</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>测试说明</h5>
                    </div>
                    <div class="card-body">
                        <h6>测试项目：</h6>
                        <ul>
                            <li>API连接测试</li>
                            <li>数据格式验证</li>
                            <li>记录查找测试</li>
                            <li>数据回填测试</li>
                            <li>模态框功能测试</li>
                        </ul>
                        
                        <h6 class="mt-3">使用方法：</h6>
                        <ol>
                            <li>点击"运行所有测试"</li>
                            <li>查看测试结果</li>
                            <li>如有问题，查看控制台日志</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 设置默认日期为今天
        document.getElementById('test-review-date').value = new Date().toISOString().split('T')[0];
        
        function addTestResult(title, status, message, details = null) {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = status === 'success' ? 'test-success' : 
                               status === 'error' ? 'test-error' : 'test-warning';
            
            const resultHtml = `
                <div class="test-result ${resultClass}">
                    <strong>${title}</strong>: ${message}
                    ${details ? `<div class="mt-2"><small>${details}</small></div>` : ''}
                </div>
            `;
            
            resultsDiv.innerHTML += resultHtml;
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
        
        async function testApiConnection() {
            console.log('🔍 测试API连接...');
            
            try {
                const response = await fetch('/api/reviews?per_page=1');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addTestResult('API连接测试', 'success', 'API连接正常');
                    return data;
                } else {
                    addTestResult('API连接测试', 'error', `API响应异常: ${data.message || '未知错误'}`);
                    return null;
                }
            } catch (error) {
                addTestResult('API连接测试', 'error', `连接失败: ${error.message}`);
                return null;
            }
        }
        
        async function testDataFormat(apiData) {
            console.log('🔍 测试数据格式...');
            
            if (!apiData || !apiData.data) {
                addTestResult('数据格式测试', 'error', '没有数据可供测试');
                return false;
            }
            
            const data = apiData.data;
            let reviews = [];
            
            if (Array.isArray(data)) {
                reviews = data;
                addTestResult('数据格式测试', 'success', '检测到直接数组格式');
            } else if (data.reviews && Array.isArray(data.reviews)) {
                reviews = data.reviews;
                addTestResult('数据格式测试', 'success', '检测到分页格式');
            } else {
                addTestResult('数据格式测试', 'warning', '未知的数据格式');
                return false;
            }
            
            if (reviews.length > 0) {
                const sample = reviews[0];
                constFields = ['id', 'stock_code', 'review_date'];
                const missingFields =Fields.filter(field => !(field in sample));
                
                if (missingFields.length === 0) {
                    addTestResult('数据字段测试', 'success', '所有必需字段都存在');
                } else {
                    addTestResult('数据字段测试', 'error', `缺少字段: ${missingFields.join(', ')}`);
                }
            }
            
            return true;
        }
        
        async function testRecordSearch() {
            console.log('🔍 测试记录查找...');
            
            const stockCode = '000001';
            const reviewDate = new Date().toISOString().split('T')[0];
            
            try {
                const queryParams = new URLSearchParams({
                    stock_code: stockCode,
                    start_date: reviewDate,
                    end_date: reviewDate,
                    per_page: 1
                });
                
                const response = await fetch(`/api/reviews?${queryParams}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addTestResult('记录查找测试', 'success', `查找 ${stockCode} 的记录成功`);
                    return data;
                } else {
                    addTestResult('记录查找测试', 'warning', `没有找到 ${stockCode} 的记录`);
                    return null;
                }
            } catch (error) {
                addTestResult('记录查找测试', 'error', `查找失败: ${error.message}`);
                return null;
            }
        }
        
        async function testModalFunctions() {
            console.log('🔍 测试模态框函数...');
            
            const functions = [
                'testReviewDataBackfill',
                'debugReviewModal',
                'openReviewModal',
                'checkAndLoadExistingReview',
                'populateModalWithExistingReview'
            ];
            
            let availableFunctions = 0;
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    availableFunctions++;
                } else {
                    console.warn(`函数 ${funcName} 不可用`);
                }
            });
            
            if (availableFunctions === functions.length) {
                addTestResult('模态框函数测试', 'success', '所有必需函数都可用');
            } else {
                addTestResult('模态框函数测试', 'warning', 
                    `${availableFunctions}/${functions.length} 个函数可用`);
            }
            
            return availableFunctions > 0;
        }
        
        async function runAllTests() {
            clearResults();
            addTestResult('测试开始', 'success', '开始运行综合测试...');
            
            // 1. 测试API连接
            const apiData = await testApiConnection();
            
            // 2. 测试数据格式
            if (apiData) {
                await testDataFormat(apiData);
            }
            
            // 3. 测试记录查找
            await testRecordSearch();
            
            // 4. 测试模态框函数
            await testModalFunctions();
            
            addTestResult('测试完成', 'success', '所有测试已完成，请查看结果');
        }
        
        async function testSpecificRecord() {
            const stockCode = document.getElementById('test-stock-code').value;
            const reviewDate = document.getElementById('test-review-date').value;
            
            if (!stockCode || !reviewDate) {
                alert('请输入股票代码和复盘日期');
                return;
            }
            
            clearResults();
            addTestResult('指定记录测试', 'success', `测试 ${stockCode} 在 ${reviewDate} 的记录...`);
            
            if (typeof window.testReviewDataBackfill === 'function') {
                try {
                    const result = await window.testReviewDataBackfill(stockCode, reviewDate);
                    if (result) {
                        addTestResult('记录查找', 'success', '找到匹配记录', 
                            `ID: ${result.id}, 评分: ${result.total_score || 0}/5`);
                    } else {
                        addTestResult('记录查找', 'warning', '未找到匹配记录');
                    }
                } catch (error) {
                    addTestResult('记录查找', 'error', `测试失败: ${error.message}`);
                }
            } else {
                addTestResult('函数检查', 'error', 'testReviewDataBackfill 函数不可用');
            }
        }
        
        async function testModalOpen() {
            const stockCode = document.getElementById('test-stock-code').value;
            
            if (!stockCode) {
                alert('请输入股票代码');
                return;
            }
            
            if (typeof window.openReviewModal === 'function') {
                try {
                    await window.openReviewModal(stockCode);
                    addTestResult('模态框测试', 'success', `成功打开 ${stockCode} 的复盘模态框`);
                } catch (error) {
                    addTestResult('模态框测试', 'error', `打开失败: ${error.message}`);
                }
            } else {
                addTestResult('模态框测试', 'error', 'openReviewModal 函数不可用');
            }
        }
    </script>
</body>
</html>