<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘äº¤æ˜“è®°å½•ä»·æ ¼é—®é¢˜è°ƒè¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>ç¼–è¾‘äº¤æ˜“è®°å½•ä»·æ ¼é—®é¢˜è°ƒè¯•</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•è¡¨å•</h5>
                    </div>
                    <div class="card-body">
                        <form id="test-form" novalidate>
                            <div class="mb-3">
                                <label for="stock-code" class="form-label">è‚¡ç¥¨ä»£ç </label>
                                <input type="text" class="form-control" id="stock-code" name="stock_code" value="000001">
                            </div>
                            <div class="mb-3">
                                <label for="stock-name" class="form-label">è‚¡ç¥¨åç§°</label>
                                <input type="text" class="form-control" id="stock-name" name="stock_name" value="å¹³å®‰é“¶è¡Œ">
                            </div>
                            <div class="mb-3">
                                <label for="trade-type" class="form-label">äº¤æ˜“ç±»å‹</label>
                                <select class="form-select" id="trade-type" name="trade_type">
                                    <option value="buy">ä¹°å…¥</option>
                                    <option value="sell">å–å‡º</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">ä»·æ ¼</label>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" value="12.50">
                            </div>
                            <div class="mb-3">
                                <label for="quantity" class="form-label">æ•°é‡</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" value="1000">
                            </div>
                            <div class="mb-3">
                                <label for="reason" class="form-label">æ“ä½œåŸå› </label>
                                <input type="text" class="form-control" id="reason" name="reason" value="æµ‹è¯•åŸå› ">
                            </div>
                            <div class="mb-3">
                                <label for="trade-date" class="form-label">äº¤æ˜“æ—¥æœŸ</label>
                                <input type="datetime-local" class="form-control" id="trade-date" name="trade_date">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="testFormData()">æµ‹è¯•è¡¨å•æ•°æ®</button>
                            <button type="button" class="btn btn-success" onclick="testCreateTrade()">æµ‹è¯•åˆ›å»ºäº¤æ˜“</button>
                            <button type="button" class="btn btn-warning" onclick="testUpdateTrade()">æµ‹è¯•æ›´æ–°äº¤æ˜“</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>è°ƒè¯•ä¿¡æ¯</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-output" style="font-family: monospace; white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 500px; overflow-y: auto;">
                            ç­‰å¾…æµ‹è¯•...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤äº¤æ˜“æ—¥æœŸ
        document.getElementById('trade-date').value = new Date().toISOString().slice(0, 16);
        
        let testTradeId = null;

        function log(message) {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug-output').textContent = '';
        }

        // è¡¨å•æ•°æ®åºåˆ—åŒ–å‡½æ•°ï¼ˆæ¨¡æ‹ŸåŸç³»ç»Ÿï¼‰
        function serializeForm(form) {
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (Array.isArray(data[key])) {
                        data[key].push(value);
                    } else {
                        data[key] = [data[key], value];
                    }
                } else {
                    data[key] = value;
                }
            }
            
            return data;
        }

        function testFormData() {
            clearLog();
            log('=== æµ‹è¯•è¡¨å•æ•°æ®åºåˆ—åŒ– ===');
            
            const form = document.getElementById('test-form');
            const formData = serializeForm(form);
            
            log('åŸå§‹è¡¨å•æ•°æ®:');
            log(JSON.stringify(formData, null, 2));
            
            // æ¨¡æ‹Ÿå‰ç«¯å¤„ç†é€»è¾‘
            log('\n=== æ¨¡æ‹Ÿå‰ç«¯æ•°æ®å¤„ç† ===');
            
            // éªŒè¯ä»·æ ¼å­—æ®µ
            if (!formData.price || formData.price.trim() === '') {
                log('âŒ ä»·æ ¼éªŒè¯å¤±è´¥: ä»·æ ¼ä¸èƒ½ä¸ºç©º');
                return;
            } else {
                log('âœ… ä»·æ ¼éªŒè¯é€šè¿‡: ' + formData.price);
            }
            
            // å¤„ç†æ•°å€¼å­—æ®µ
            const processedData = { ...formData };
            processedData.price = parseFloat(formData.price);
            processedData.quantity = parseInt(formData.quantity);
            
            log('å¤„ç†åçš„æ•°æ®:');
            log(JSON.stringify(processedData, null, 2));
            
            // éªŒè¯æ•°å€¼æœ‰æ•ˆæ€§
            if (isNaN(processedData.price) || processedData.price <= 0) {
                log('âŒ ä»·æ ¼æ•°å€¼éªŒè¯å¤±è´¥: ä»·æ ¼å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—');
                return;
            } else {
                log('âœ… ä»·æ ¼æ•°å€¼éªŒè¯é€šè¿‡: ' + processedData.price);
            }
            
            if (isNaN(processedData.quantity) || processedData.quantity <= 0) {
                log('âŒ æ•°é‡éªŒè¯å¤±è´¥: æ•°é‡å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°');
                return;
            } else {
                log('âœ… æ•°é‡éªŒè¯é€šè¿‡: ' + processedData.quantity);
            }
            
            log('\nâœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œæ•°æ®å‡†å¤‡å°±ç»ª');
        }

        async function testCreateTrade() {
            clearLog();
            log('=== æµ‹è¯•åˆ›å»ºäº¤æ˜“è®°å½• ===');
            
            const form = document.getElementById('test-form');
            const formData = serializeForm(form);
            
            // å¤„ç†æ•°æ®
            const processedData = {
                ...formData,
                price: parseFloat(formData.price),
                quantity: parseInt(formData.quantity),
                trade_date: formData.trade_date
            };
            
            log('å‘é€çš„æ•°æ®:');
            log(JSON.stringify(processedData, null, 2));
            
            try {
                const response = await axios.post('/api/trades', processedData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log('\nâœ… åˆ›å»ºæˆåŠŸ:');
                log(JSON.stringify(response.data, null, 2));
                
                if (response.data.data && response.data.data.id) {
                    testTradeId = response.data.data.id;
                    log(`\nğŸ“ è®°å½•äº¤æ˜“ID: ${testTradeId}`);
                }
                
            } catch (error) {
                log('\nâŒ åˆ›å»ºå¤±è´¥:');
                if (error.response) {
                    log(`çŠ¶æ€ç : ${error.response.status}`);
                    log(`é”™è¯¯ä¿¡æ¯: ${JSON.stringify(error.response.data, null, 2)}`);
                } else {
                    log(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                }
            }
        }

        async function testUpdateTrade() {
            if (!testTradeId) {
                log('âŒ è¯·å…ˆåˆ›å»ºä¸€ä¸ªäº¤æ˜“è®°å½•');
                return;
            }
            
            clearLog();
            log('=== æµ‹è¯•æ›´æ–°äº¤æ˜“è®°å½• ===');
            log(`æ›´æ–°äº¤æ˜“ID: ${testTradeId}`);
            
            const form = document.getElementById('test-form');
            const formData = serializeForm(form);
            
            // ä¿®æ”¹ä»·æ ¼è¿›è¡Œæµ‹è¯•
            const newPrice = (parseFloat(formData.price) + 1.23).toFixed(2);
            
            const processedData = {
                ...formData,
                price: parseFloat(newPrice),
                quantity: parseInt(formData.quantity),
                trade_date: formData.trade_date
            };
            
            log('å‘é€çš„æ›´æ–°æ•°æ®:');
            log(JSON.stringify(processedData, null, 2));
            
            try {
                const response = await axios.put(`/api/trades/${testTradeId}`, processedData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log('\nâœ… æ›´æ–°æˆåŠŸ:');
                log(JSON.stringify(response.data, null, 2));
                
            } catch (error) {
                log('\nâŒ æ›´æ–°å¤±è´¥:');
                if (error.response) {
                    log(`çŠ¶æ€ç : ${error.response.status}`);
                    log(`é”™è¯¯ä¿¡æ¯: ${JSON.stringify(error.response.data, null, 2)}`);
                    
                    // è¯¦ç»†åˆ†æé”™è¯¯
                    if (error.response.status === 422) {
                        log('\nğŸ” è¯¦ç»†é”™è¯¯åˆ†æ:');
                        const errorData = error.response.data;
                        if (errorData.error && errorData.error.message) {
                            log(`ä¸»è¦é”™è¯¯: ${errorData.error.message}`);
                        }
                        if (errorData.error && errorData.error.details) {
                            log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(errorData.error.details, null, 2)}`);
                        }
                    }
                } else {
                    log(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                }
            }
        }

        // ç›‘å¬ä»·æ ¼å­—æ®µå˜åŒ–
        document.getElementById('price').addEventListener('input', function(e) {
            const value = e.target.value;
            log(`ä»·æ ¼å­—æ®µå˜åŒ–: "${value}" (ç±»å‹: ${typeof value})`);
        });

        log('è°ƒè¯•é¡µé¢å·²åŠ è½½ï¼Œè¯·å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>