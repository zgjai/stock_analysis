<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成本价显示测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>成本价显示测试</h2>
        
        <div class="alert alert-info">
            <strong>测试目标：</strong>验证成本价在持仓列表中能正确显示
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>1. 获取实际持仓数据</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="loadRealHoldings()">加载持仓数据</button>
                <div id="real-holdings-result" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>2. 模拟持仓显示（使用相同逻辑）</h5>
            </div>
            <div class="card-body">
                <div id="simulated-holdings"></div>
            </div>
        </div>
    </div>

    <script>
        async function loadRealHoldings() {
            const resultDiv = document.getElementById('real-holdings-result');
            const simulatedDiv = document.getElementById('simulated-holdings');
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>正在加载...';
            
            try {
                const response = await fetch('/api/holdings');
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<div class="alert alert-success">✅ 成功获取持仓数据</div>';
                    
                    // 显示原始数据
                    html += '<h6>原始数据检查：</h6>';
                    data.data.forEach((holding, index) => {
                        html += `<div class="card mb-2">`;
                        html += `<div class="card-body">`;
                        html += `<h6>持仓 ${index + 1}: ${holding.stock_code} - ${holding.stock_name}</h6>`;
                        html += `<div class="row">`;
                        html += `<div class="col-md-3"><strong>avg_buy_price:</strong> ${holding.avg_buy_price} (${typeof holding.avg_buy_price})</div>`;
                        html += `<div class="col-md-3"><strong>avg_price:</strong> ${holding.avg_price} (${typeof holding.avg_price})</div>`;
                        html += `<div class="col-md-3"><strong>current_price:</strong> ${holding.current_price} (${typeof holding.current_price})</div>`;
                        html += `<div class="col-md-3"><strong>current_quantity:</strong> ${holding.current_quantity} (${typeof holding.current_quantity})</div>`;
                        html += `</div>`;
                        
                        // 测试显示逻辑
                        const costPrice = holding.avg_buy_price ? holding.avg_buy_price.toFixed(2) : (holding.avg_price ? holding.avg_price.toFixed(2) : '--');
                        const currentPrice = holding.current_price ? holding.current_price.toFixed(2) : '--';
                        
                        html += `<div class="mt-2">`;
                        html += `<strong>显示逻辑测试：</strong>`;
                        html += `<span class="badge bg-primary ms-2">成本价: ¥${costPrice}</span>`;
                        html += `<span class="badge bg-success ms-2">当前价: ¥${currentPrice}</span>`;
                        html += `</div>`;
                        html += `</div>`;
                        html += `</div>`;
                    });
                    
                    resultDiv.innerHTML = html;
                    
                    // 生成模拟显示
                    displayHoldings(data.data);
                    
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-warning">⚠️ 没有持仓数据</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">❌ 加载失败: ' + error.message + '</div>';
            }
        }

        function displayHoldings(holdings) {
            const simulatedDiv = document.getElementById('simulated-holdings');
            
            if (!holdings || holdings.length === 0) {
                simulatedDiv.innerHTML = '<div class="alert alert-info">没有持仓数据</div>';
                return;
            }

            const holdingsHtml = holdings.map(holding => `
                <div class="holding-item card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <div class="fw-bold">${holding.stock_code}</div>
                                <div class="text-muted small">${holding.stock_name || '--'}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">成本价</div>
                                <div class="fw-bold">¥${holding.avg_buy_price ? holding.avg_buy_price.toFixed(2) : (holding.avg_price ? holding.avg_price.toFixed(2) : '--')}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">当前价</div>
                                <div class="fw-bold">¥${holding.current_price ? holding.current_price.toFixed(2) : '--'}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">持仓量</div>
                                <div class="fw-bold">${holding.current_quantity || holding.total_quantity || 0}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">持仓天数</div>
                                <div class="fw-bold">${holding.holding_days || 0}天</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">浮盈比例</div>
                                <div class="fw-bold ${getProfitClass(holding)}">
                                    ${calculateProfitRatio(holding)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            simulatedDiv.innerHTML = holdingsHtml;
        }

        function calculateProfitRatio(holding) {
            if (!holding.avg_buy_price || !holding.current_price) {
                return '--';
            }
            const ratio = ((holding.current_price - holding.avg_buy_price) / holding.avg_buy_price * 100).toFixed(2);
            return ratio + '%';
        }

        function getProfitClass(holding) {
            if (!holding.avg_buy_price || !holding.current_price) {
                return 'text-muted';
            }
            const ratio = (holding.current_price - holding.avg_buy_price) / holding.avg_buy_price;
            return ratio > 0 ? 'text-danger' : ratio < 0 ? 'text-success' : 'text-muted';
        }

        // 页面加载时自动测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('成本价显示测试页面已加载');
            loadRealHoldings();
        });
    </script>
</body>
</html>