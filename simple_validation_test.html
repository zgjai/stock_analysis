<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•éªŒè¯æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-box {
            background: #212529;
            color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>ğŸš¨ ç®€å•éªŒè¯æµ‹è¯•</h1>
                <p class="text-muted">å¿«é€Ÿæµ‹è¯•æ•°æ®éªŒè¯é—®é¢˜æ˜¯å¦å·²ä¿®å¤</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•è¡¨å•</h5>
                    </div>
                    <div class="card-body">
                        <form id="test-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">è‚¡ç¥¨ä»£ç  *</label>
                                        <input type="text" class="form-control" id="stock-code" name="stock_code" 
                                               value="000001" required maxlength="6">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">è‚¡ç¥¨åç§° *</label>
                                        <input type="text" class="form-control" id="stock-name" name="stock_name" 
                                               value="å¹³å®‰é“¶è¡Œ" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">äº¤æ˜“ç±»å‹ *</label>
                                        <select class="form-select" id="trade-type" name="trade_type" required>
                                            <option value="">è¯·é€‰æ‹©</option>
                                            <option value="buy" selected>ä¹°å…¥</option>
                                            <option value="sell">å–å‡º</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">ä»·æ ¼ *</label>
                                        <input type="number" class="form-control" id="price" name="price" 
                                               value="10.50" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">æ•°é‡ *</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" 
                                               value="1000" step="100" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">æ“ä½œåŸå›  *</label>
                                        <select class="form-select" id="reason" name="reason" required>
                                            <option value="">è¯·é€‰æ‹©</option>
                                            <option value="å°‘å¦‡B1æˆ˜æ³•" selected>å°‘å¦‡B1æˆ˜æ³•</option>
                                            <option value="å°‘å¦‡SB1æˆ˜æ³•">å°‘å¦‡SB1æˆ˜æ³•</option>
                                            <option value="å°‘å¦‡B2æˆ˜æ³•">å°‘å¦‡B2æˆ˜æ³•</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">äº¤æ˜“æ—¥æœŸ *</label>
                                        <input type="datetime-local" class="form-control" id="trade-date" name="trade_date" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">å¤‡æ³¨</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2" 
                                          placeholder="å¯é€‰å¤‡æ³¨...">æµ‹è¯•äº¤æ˜“è®°å½•</textarea>
                            </div>
                        </form>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="testFormData()">
                                ğŸ“‹ æµ‹è¯•è¡¨å•æ•°æ®
                            </button>
                            <button type="button" class="btn btn-success" onclick="testApiCall()">
                                ğŸš€ æµ‹è¯•APIè°ƒç”¨
                            </button>
                            <button type="button" class="btn btn-warning" onclick="testEmptyFields()">
                                âš ï¸ æµ‹è¯•ç©ºå­—æ®µ
                            </button>
                            <button type="button" class="btn btn-info" onclick="clearResults()">
                                ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•ç»“æœ</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="results" class="result-box">ç­‰å¾…æµ‹è¯•...</div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>ä¿®å¤è¯´æ˜</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success alert-sm">
                            <strong>å·²ä¿®å¤:</strong>
                            <ul class="mb-0 mt-1">
                                <li>ç®€åŒ–äº†å‰ç«¯éªŒè¯é€»è¾‘</li>
                                <li>å¢å¼ºäº†åç«¯æ•°æ®å¤„ç†</li>
                                <li>æ”¯æŒå­—ç¬¦ä¸²æ ¼å¼æ•°å­—</li>
                                <li>è‡ªåŠ¨å¤„ç†ç©ºæ ¼</li>
                            </ul>
                        </div>
                        <div class="alert alert-info alert-sm">
                            <strong>å¦‚æœä»æœ‰é—®é¢˜:</strong>
                            <ol class="mb-0 mt-1">
                                <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                                <li>æ£€æŸ¥æ§åˆ¶å°é”™è¯¯</li>
                                <li>ç¡®è®¤ç½‘ç»œè¿æ¥</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // è®¾ç½®å½“å‰æ—¶é—´
        document.getElementById('trade-date').value = new Date().toISOString().slice(0, 16);
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            const className = type;
            results.innerHTML += `<span class="${className}">[${time}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = 'æµ‹è¯•ç»“æœå·²æ¸…ç©º...\n';
        }
        
        // FormUtils.serialize å®ç°
        const FormUtils = {
            serialize: (form) => {
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                return data;
            }
        };
        
        function testFormData() {
            clearResults();
            log('=== æµ‹è¯•è¡¨å•æ•°æ®è·å– ===', 'info');
            
            const form = document.getElementById('test-form');
            
            // 1. æ£€æŸ¥è¡¨å•å…ƒç´ 
            log('1. æ£€æŸ¥è¡¨å•å…ƒç´ ...', 'info');
            if (!form) {
                log('âŒ è¡¨å•æœªæ‰¾åˆ°', 'error');
                return;
            }
            log('âœ… è¡¨å•å­˜åœ¨', 'success');
            
            // 2. è·å–è¡¨å•æ•°æ®
            log('2. è·å–è¡¨å•æ•°æ®...', 'info');
            const data = FormUtils.serialize(form);
            log('è¡¨å•æ•°æ®:', 'info');
            log(JSON.stringify(data, null, 2), 'info');
            
            // 3. éªŒè¯å¿…å¡«å­—æ®µ
            log('3. éªŒè¯å¿…å¡«å­—æ®µ...', 'info');
            const required = ['stock_code', 'stock_name', 'trade_type', 'price', 'quantity', 'reason'];
            let allValid = true;
            
            required.forEach(field => {
                const value = data[field];
                const isEmpty = !value || value.toString().trim() === '';
                
                if (isEmpty) {
                    log(`âŒ ${field}: ç©ºå€¼`, 'error');
                    allValid = false;
                } else {
                    log(`âœ… ${field}: "${value}"`, 'success');
                }
            });
            
            // 4. æ•°æ®ç±»å‹æ£€æŸ¥
            log('4. æ•°æ®ç±»å‹æ£€æŸ¥...', 'info');
            if (data.price) {
                const price = parseFloat(data.price);
                log(`ä»·æ ¼è½¬æ¢: "${data.price}" -> ${price} (${isNaN(price) ? 'âŒ æ— æ•ˆ' : 'âœ… æœ‰æ•ˆ'})`, 
                    isNaN(price) ? 'error' : 'success');
            }
            
            if (data.quantity) {
                const quantity = parseInt(data.quantity);
                log(`æ•°é‡è½¬æ¢: "${data.quantity}" -> ${quantity} (${isNaN(quantity) ? 'âŒ æ— æ•ˆ' : 'âœ… æœ‰æ•ˆ'})`, 
                    isNaN(quantity) ? 'error' : 'success');
            }
            
            log(`\\næ€»ä½“éªŒè¯: ${allValid ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`, allValid ? 'success' : 'error');
        }
        
        async function testApiCall() {
            clearResults();
            log('=== æµ‹è¯•APIè°ƒç”¨ ===', 'info');
            
            const form = document.getElementById('test-form');
            const data = FormUtils.serialize(form);
            
            // æ•°æ®é¢„å¤„ç†
            log('1. æ•°æ®é¢„å¤„ç†...', 'info');
            if (data.price) data.price = parseFloat(data.price);
            if (data.quantity) data.quantity = parseInt(data.quantity);
            
            log('å‘é€æ•°æ®:', 'info');
            log(JSON.stringify(data, null, 2), 'info');
            
            // å‘é€è¯·æ±‚
            log('2. å‘é€APIè¯·æ±‚...', 'info');
            try {
                const response = await axios.post('/api/trades', data, {
                    headers: { 'Content-Type': 'application/json' },
                    timeout: 15000
                });
                
                log('âœ… APIè°ƒç”¨æˆåŠŸ!', 'success');
                log(`çŠ¶æ€ç : ${response.status}`, 'success');
                log('å“åº”æ•°æ®:', 'success');
                log(JSON.stringify(response.data, null, 2), 'success');
                
            } catch (error) {
                log('âŒ APIè°ƒç”¨å¤±è´¥!', 'error');
                
                if (error.response) {
                    log(`HTTPé”™è¯¯: ${error.response.status}`, 'error');
                    
                    if (error.response.status === 403) {
                        log('è¿™æ˜¯æƒé™é”™è¯¯ï¼Œå¯èƒ½éœ€è¦ç™»å½•æˆ–CSRFä»¤ç‰Œ', 'warning');
                    } else if (error.response.status === 422) {
                        log('è¿™æ˜¯æ•°æ®éªŒè¯é”™è¯¯', 'warning');
                    }
                    
                    try {
                        const errorData = error.response.data;
                        log('é”™è¯¯è¯¦æƒ…:', 'error');
                        log(JSON.stringify(errorData, null, 2), 'error');
                    } catch (e) {
                        log('æ— æ³•è§£æé”™è¯¯å“åº”', 'error');
                    }
                } else if (error.request) {
                    log('ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                } else {
                    log(`è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
                }
            }
        }
        
        function testEmptyFields() {
            clearResults();
            log('=== æµ‹è¯•ç©ºå­—æ®µå¤„ç† ===', 'warning');
            
            const form = document.getElementById('test-form');
            
            // ä¸´æ—¶æ¸…ç©ºè‚¡ç¥¨ä»£ç 
            const stockCodeInput = document.getElementById('stock-code');
            const originalValue = stockCodeInput.value;
            stockCodeInput.value = '';
            
            log('1. æ¸…ç©ºè‚¡ç¥¨ä»£ç å­—æ®µ...', 'warning');
            
            const data = FormUtils.serialize(form);
            log('è¡¨å•æ•°æ®:', 'info');
            log(JSON.stringify(data, null, 2), 'info');
            
            // æ£€æŸ¥ç©ºå­—æ®µ
            log('2. æ£€æŸ¥ç©ºå­—æ®µ...', 'info');
            const required = ['stock_code', 'stock_name', 'trade_type', 'price', 'quantity', 'reason'];
            
            required.forEach(field => {
                const value = data[field];
                const isEmpty = !value || value.toString().trim() === '';
                
                if (isEmpty) {
                    log(`âŒ ${field}: æ£€æµ‹åˆ°ç©ºå€¼`, 'error');
                } else {
                    log(`âœ… ${field}: æœ‰å€¼`, 'success');
                }
            });
            
            // æ¢å¤åŸå€¼
            stockCodeInput.value = originalValue;
            log('3. å·²æ¢å¤åŸå§‹å€¼', 'info');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
        });
    </script>
</body>
</html>