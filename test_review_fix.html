<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复盘页面修复测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>复盘页面修复测试</h2>
        <div class="alert alert-info">
            <h5>修复内容：</h5>
            <ul>
                <li>✅ 添加了备用的 ReviewSaveManager 类定义</li>
                <li>✅ 修复了 updateQuickReviewOptions 函数调用顺序问题</li>
                <li>✅ 改进了错误处理和安全检查</li>
            </ul>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h4>问题分析</h4>
                <div class="card">
                    <div class="card-body">
                        <h6>1. 保存管理器未初始化</h6>
                        <p class="small text-muted">
                            原因：ReviewSaveManager 类可能因为外部文件加载失败而未定义<br>
                            解决：添加了备用的 ReviewSaveManager 类定义
                        </p>
                        
                        <h6>2. updateQuickReviewOptions 函数未定义</h6>
                        <p class="small text-muted">
                            原因：函数在定义之前被调用<br>
                            解决：将函数定义移到调用位置之前
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>测试结果</h4>
                <div id="test-results" class="card">
                    <div class="card-body">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">测试中...</span>
                            </div>
                            <p class="mt-2">正在运行测试...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 模拟测试环境
        function runTests() {
            const results = [];
            
            // 测试1: 检查 ReviewSaveManager 是否可用
            try {
                if (typeof ReviewSaveManager !== 'undefined') {
                    results.push({ name: 'ReviewSaveManager 类定义', status: 'success', message: '✅ 类已定义' });
                } else {
                    results.push({ name: 'ReviewSaveManager 类定义', status: 'error', message: '❌ 类未定义' });
                }
            } catch (error) {
                results.push({ name: 'ReviewSaveManager 类定义', status: 'error', message: '❌ 检查失败: ' + error.message });
            }
            
            // 测试2: 检查函数调用顺序
            try {
                if (typeof updateQuickReviewOptions === 'function') {
                    results.push({ name: 'updateQuickReviewOptions 函数', status: 'success', message: '✅ 函数已定义' });
                } else {
                    results.push({ name: 'updateQuickReviewOptions 函数', status: 'warning', message: '⚠️ 函数未在当前环境中定义（正常，因为在 review.html 中）' });
                }
            } catch (error) {
                results.push({ name: 'updateQuickReviewOptions 函数', status: 'error', message: '❌ 检查失败: ' + error.message });
            }
            
            // 测试3: 模拟保存管理器初始化
            try {
                // 创建一个模拟的表单元素
                const mockForm = document.createElement('form');
                mockForm.id = 'review-form';
                document.body.appendChild(mockForm);
                
                // 尝试创建 ReviewSaveManager 实例
                const manager = new ReviewSaveManager('#review-form');
                if (manager) {
                    results.push({ name: '保存管理器初始化', status: 'success', message: '✅ 初始化成功' });
                } else {
                    results.push({ name: '保存管理器初始化', status: 'error', message: '❌ 初始化失败' });
                }
                
                // 清理
                document.body.removeChild(mockForm);
            } catch (error) {
                results.push({ name: '保存管理器初始化', status: 'error', message: '❌ 初始化失败: ' + error.message });
            }
            
            return results;
        }
        
        // 显示测试结果
        function displayResults(results) {
            const container = document.getElementById('test-results');
            let html = '<h6>测试结果</h6>';
            
            results.forEach(result => {
                const badgeClass = result.status === 'success' ? 'bg-success' : 
                                 result.status === 'warning' ? 'bg-warning' : 'bg-danger';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">${result.name}</span>
                        <span class="badge ${badgeClass}">${result.status}</span>
                    </div>
                    <p class="small text-muted mb-3">${result.message}</p>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 备用 ReviewSaveManager 类定义（用于测试）
        if (typeof ReviewSaveManager === 'undefined') {
            class ReviewSaveManager {
                constructor(formSelector = '#review-form') {
                    this.form = document.querySelector(formSelector);
                    this.hasUnsavedChanges = false;
                    this.isSaving = false;
                    console.log('ReviewSaveManager (测试版本) 初始化完成');
                }
            }
        }
        
        // 运行测试
        setTimeout(() => {
            const results = runTests();
            displayResults(results);
        }, 1000);
    </script>
</body>
</html>