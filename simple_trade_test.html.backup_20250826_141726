<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç®€å•äº¤æ˜“æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>ğŸš¨ ç´§æ€¥äº¤æ˜“è®°å½•æµ‹è¯•</h1>
        <div class="alert alert-warning">
            <strong>æ³¨æ„ï¼š</strong>åˆ†æ‰¹æ­¢ç›ˆåŠŸèƒ½å·²æš‚æ—¶ç¦ç”¨ï¼Œä¸“æ³¨æµ‹è¯•åŸºæœ¬äº¤æ˜“è®°å½•ä¿å­˜åŠŸèƒ½ã€‚
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>åŸºæœ¬äº¤æ˜“è®°å½•æµ‹è¯•</h5>
            </div>
            <div class="card-body">
                <form id="simple-trade-form">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">è‚¡ç¥¨ä»£ç  *</label>
                            <input type="text" class="form-control" name="stock_code" value="000001" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">è‚¡ç¥¨åç§° *</label>
                            <input type="text" class="form-control" name="stock_name" value="å¹³å®‰é“¶è¡Œ" required>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <label class="form-label">äº¤æ˜“ç±»å‹ *</label>
                            <select class="form-select" name="trade_type" required>
                                <option value="buy" selected>ä¹°å…¥</option>
                                <option value="sell">å–å‡º</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ä»·æ ¼ *</label>
                            <input type="number" class="form-control" name="price" value="10.00" step="0.01" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">æ•°é‡ *</label>
                            <input type="number" class="form-control" name="quantity" value="1000" step="100" required>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">æ“ä½œåŸå›  *</label>
                            <select class="form-select" name="reason" required>
                                <option value="å°‘å¦‡B1æˆ˜æ³•" selected>å°‘å¦‡B1æˆ˜æ³•</option>
                                <option value="æµ‹è¯•">æµ‹è¯•</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">äº¤æ˜“æ—¥æœŸ *</label>
                            <input type="datetime-local" class="form-control" name="trade_date" required>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">å¤‡æ³¨</label>
                        <textarea class="form-control" name="notes" rows="2">ç´§æ€¥æµ‹è¯•äº¤æ˜“è®°å½•</textarea>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-lg" onclick="testSaveRecord()">
                            ğŸš€ æµ‹è¯•ä¿å­˜äº¤æ˜“è®°å½•
                        </button>
                        <button type="button" class="btn btn-info" onclick="checkFormData()">
                            ğŸ“‹ æ£€æŸ¥è¡¨å•æ•°æ®
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>æµ‹è¯•ç»“æœ</h5>
            </div>
            <div class="card-body">
                <div id="test-result" style="background: #212529; color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; white-space: pre-wrap; min-height: 200px;">
ç­‰å¾…æµ‹è¯•...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // è®¾ç½®å½“å‰æ—¶é—´
        document.querySelector('[name="trade_date"]').value = new Date().toISOString().slice(0, 16);
        
        function log(message) {
            const result = document.getElementById('test-result');
            const time = new Date().toLocaleTimeString();
            result.textContent += `[${time}] ${message}\n`;
            result.scrollTop = result.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('test-result').textContent = '';
        }
        
        function checkFormData() {
            clearLog();
            log('=== æ£€æŸ¥è¡¨å•æ•°æ® ===');
            
            const form = document.getElementById('simple-trade-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            log('è¡¨å•æ•°æ®:');
            log(JSON.stringify(data, null, 2));
            
            // æ£€æŸ¥å¿…å¡«å­—æ®µ
            const required = ['stock_code', 'stock_name', 'trade_type', 'price', 'quantity', 'reason'];
            log('\nå¿…å¡«å­—æ®µæ£€æŸ¥:');
            let allValid = true;
            
            required.forEach(field => {
                const value = data[field];
                const isEmpty = !value || value.toString().trim() === '';
                log(`${field}: ${isEmpty ? 'âŒ ç©ºå€¼' : 'âœ… æœ‰å€¼'} ("${value}")`);
                if (isEmpty) allValid = false;
            });
            
            log(`\néªŒè¯ç»“æœ: ${allValid ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`);
        }
        
        async function testSaveRecord() {
            clearLog();
            log('=== æµ‹è¯•ä¿å­˜äº¤æ˜“è®°å½• ===');
            
            const form = document.getElementById('simple-trade-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // æ•°æ®é¢„å¤„ç†
            data.price = parseFloat(data.price);
            data.quantity = parseInt(data.quantity);
            data.use_batch_profit_taking = false; // å¼ºåˆ¶ç¦ç”¨åˆ†æ‰¹æ­¢ç›ˆ
            
            log('å‘é€æ•°æ®:');
            log(JSON.stringify(data, null, 2));
            
            try {
                log('\nå‘é€APIè¯·æ±‚...');
                const response = await axios.post('/api/trades', data, {
                    headers: { 'Content-Type': 'application/json' },
                    timeout: 15000
                });
                
                log('âœ… ä¿å­˜æˆåŠŸ!');
                log(`çŠ¶æ€ç : ${response.status}`);
                log('å“åº”æ•°æ®:');
                log(JSON.stringify(response.data, null, 2));
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success mt-3';
                alertDiv.innerHTML = '<strong>ğŸ‰ æˆåŠŸï¼</strong> äº¤æ˜“è®°å½•ä¿å­˜æˆåŠŸï¼ŒåŸºæœ¬åŠŸèƒ½æ­£å¸¸ï¼';
                form.parentNode.insertBefore(alertDiv, form.nextSibling);
                
                setTimeout(() => alertDiv.remove(), 5000);
                
            } catch (error) {
                log('âŒ ä¿å­˜å¤±è´¥!');
                
                if (error.response) {
                    log(`HTTPé”™è¯¯: ${error.response.status}`);
                    try {
                        const errorData = error.response.data;
                        log('é”™è¯¯è¯¦æƒ…:');
                        log(JSON.stringify(errorData, null, 2));
                    } catch (e) {
                        log('æ— æ³•è§£æé”™è¯¯å“åº”');
                    }
                } else if (error.request) {
                    log('ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                } else {
                    log(`è¯·æ±‚é”™è¯¯: ${error.message}`);
                }
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = '<strong>âŒ å¤±è´¥ï¼</strong> äº¤æ˜“è®°å½•ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ã€‚';
                form.parentNode.insertBefore(alertDiv, form.nextSibling);
                
                setTimeout(() => alertDiv.remove(), 10000);
            }
        }
    </script>
</body>
</html>