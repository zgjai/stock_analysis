<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡7 - æœªä¿å­˜æ›´æ”¹è­¦å‘Šæœºåˆ¶ç»¼åˆæµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 0.25rem;
        }
        .test-pass { background-color: #d1e7dd; color: #0f5132; }
        .test-fail { background-color: #f8d7da; color: #842029; }
        .test-info { background-color: #d1ecf1; color: #055160; }
        .floating-profit-container.profit { background-color: rgba(25, 135, 84, 0.1); }
        .floating-profit-container.loss { background-color: rgba(220, 53, 69, 0.1); }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-exclamation-triangle text-warning me-2"></i>ä»»åŠ¡7 - æœªä¿å­˜æ›´æ”¹è­¦å‘Šæœºåˆ¶ç»¼åˆæµ‹è¯•</h1>
        <p class="text-muted">æµ‹è¯•ä¿å­˜ç®¡ç†å™¨çš„beforeunloadè­¦å‘ŠåŠŸèƒ½ã€æ¨¡æ€æ¡†å…³é—­ç¡®è®¤å¯¹è¯æ¡†ç­‰åŠŸèƒ½</p>
        
        <div class="row">
            <div class="col-md-8">
                <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
                <div class="test-section">
                    <h5><i class="fas fa-play-circle text-primary me-2"></i>æµ‹è¯•æ§åˆ¶é¢æ¿</h5>
                    <div class="btn-group mb-3" role="group">
                        <button class="btn btn-primary" onclick="openReviewModal()">
                            <i class="fas fa-modal me-1"></i>æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†
                        </button>
                        <button class="btn btn-success" onclick="runAllTests()">
                            <i class="fas fa-play me-1"></i>è¿è¡Œæ‰€æœ‰æµ‹è¯•
                        </button>
                        <button class="btn btn-info" onclick="testWarningMechanisms()">
                            <i class="fas fa-exclamation-triangle me-1"></i>æµ‹è¯•è­¦å‘Šæœºåˆ¶
                        </button>
                        <button class="btn btn-warning" onclick="simulateUnsavedChanges()">
                            <i class="fas fa-edit me-1"></i>æ¨¡æ‹Ÿæœªä¿å­˜æ›´æ”¹
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>
                        <ul class="mb-0 mt-2">
                            <li>ç‚¹å‡»"æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†"å¼€å§‹æµ‹è¯•</li>
                            <li>åœ¨è¡¨å•ä¸­è¾“å…¥å†…å®¹åå°è¯•å…³é—­æ¨¡æ€æ¡†</li>
                            <li>ä¿®æ”¹è¡¨å•å†…å®¹åå°è¯•åˆ·æ–°é¡µé¢æˆ–å…³é—­æ ‡ç­¾é¡µ</li>
                            <li>è§‚å¯Ÿæ˜¯å¦æ˜¾ç¤ºé€‚å½“çš„è­¦å‘Šæ¶ˆæ¯</li>
                        </ul>
                    </div>
                </div>

                <!-- æµ‹è¯•ç»“æœæ˜¾ç¤º -->
                <div class="test-section">
                    <h5><i class="fas fa-chart-bar text-success me-2"></i>æµ‹è¯•ç»“æœ</h5>
                    <div id="test-results">
                        <div class="text-muted">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
                    </div>
                </div>

                <!-- å®æ—¶çŠ¶æ€ç›‘æ§ -->
                <div class="test-section">
                    <h5><i class="fas fa-heartbeat text-danger me-2"></i>å®æ—¶çŠ¶æ€ç›‘æ§</h5>
                    <div id="status-monitor">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>ä¿å­˜ç®¡ç†å™¨çŠ¶æ€:</strong>
                                <div id="manager-status" class="text-muted">æœªåˆå§‹åŒ–</div>
                            </div>
                            <div class="col-md-6">
                                <strong>æœªä¿å­˜æ›´æ”¹:</strong>
                                <div id="unsaved-status" class="text-muted">æ— </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <strong>äº‹ä»¶ç›‘å¬å™¨:</strong>
                                <div id="listeners-status" class="text-muted">æœªæ£€æŸ¥</div>
                            </div>
                            <div class="col-md-6">
                                <strong>æ¨¡æ€æ¡†çŠ¶æ€:</strong>
                                <div id="modal-status" class="text-muted">å…³é—­</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- æµ‹è¯•ç»Ÿè®¡ -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-pie me-2"></i>æµ‹è¯•ç»Ÿè®¡</h6>
                    </div>
                    <div class="card-body">
                        <div id="test-stats">
                            <div class="d-flex justify-content-between">
                                <span>æ€»æµ‹è¯•æ•°:</span>
                                <span id="total-tests">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>é€šè¿‡:</span>
                                <span id="passed-tests" class="text-success">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>å¤±è´¥:</span>
                                <span id="failed-tests" class="text-danger">0</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span><strong>é€šè¿‡ç‡:</strong></span>
                                <span id="pass-rate" class="fw-bold">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæ—¥å¿— -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-list me-2"></i>æ“ä½œæ—¥å¿—</h6>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">æ¸…ç©º</button>
                    </div>
                    <div class="card-body">
                        <div id="operation-log" style="max-height: 300px; overflow-y: auto; font-size: 0.875rem;">
                            <div class="text-muted">ç­‰å¾…æ“ä½œ...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤ç›˜æ¨¡æ€æ¡† -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å¤ç›˜è¯„åˆ†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="review-form">
                        <input type="hidden" id="review-stock-code" value="000001">
                        <input type="hidden" id="review-id">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                                <input type="text" class="form-control" id="display-stock-code" value="000001" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">å¤ç›˜æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="review-date" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">æŒä»“å¤©æ•°</label>
                                <input type="number" class="form-control" id="holding-days" min="1" value="5" required>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">æµ®ç›ˆè®¡ç®—</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">å½“å‰ä»·æ ¼</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control" id="current-price-input" 
                                                   placeholder="è¾“å…¥å½“å‰ä»·æ ¼" step="0.01" min="0.01" max="9999.99">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">æˆæœ¬ä»·</label>
                                        <div class="form-control-plaintext" id="buy-price-display">Â¥10.50</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">æµ®ç›ˆæ¯”ä¾‹</label>
                                        <div class="floating-profit-container">
                                            <div class="form-control-plaintext fw-bold" id="floating-profit-ratio">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">è¯„åˆ†æ ‡å‡† (æ¯é¡¹1åˆ†ï¼Œæ€»åˆ†5åˆ†)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="price-up-score" value="1">
                                            <label class="form-check-label" for="price-up-score">æ”¶ç›˜ä»·ä¸Šå‡</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="bbi-score" value="1">
                                            <label class="form-check-label" for="bbi-score">ä¸ç ´BBIçº¿</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="volume-score" value="1">
                                            <label class="form-check-label" for="volume-score">æ— æ”¾é‡é˜´çº¿</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="trend-score" value="1">
                                            <label class="form-check-label" for="trend-score">è¶‹åŠ¿è¿˜åœ¨å‘ä¸Š</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="j-score" value="1">
                                            <label class="form-check-label" for="j-score">Jæ²¡æ­»å‰</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <strong>æ€»åˆ†: <span id="total-score" class="text-primary">0</span>/5</strong>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">åˆ†æå†…å®¹</label>
                            <textarea class="form-control" id="analysis" rows="3" placeholder="è¯·è¾“å…¥åˆ†æå†…å®¹..."></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">å†³ç­–ç»“æœ</label>
                                <select class="form-select" id="decision" required>
                                    <option value="">è¯·é€‰æ‹©å†³ç­–</option>
                                    <option value="hold">ç»§ç»­æŒæœ‰</option>
                                    <option value="sell_partial">éƒ¨åˆ†æ­¢ç›ˆ</option>
                                    <option value="sell_all">æ¸…ä»“</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å†³ç­–ç†ç”±</label>
                            <textarea class="form-control" id="reason" rows="2" placeholder="è¯·è¾“å…¥å†³ç­–ç†ç”±..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="save-review-btn" onclick="saveReview()">ä¿å­˜å¤ç›˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- åŠ è½½å¿…è¦çš„JavaScriptæ–‡ä»¶ -->
    <script src="static/js/unified-message-system.js"></script>
    <script src="static/js/api.js"></script>
    <script src="static/js/review-save-manager.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let apiClient = null;
        let reviewSaveManager = null;
        let reviewModal = null;
        let testResults = [];
        let testStats = { total: 0, passed: 0, failed: 0 };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            logOperation('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            
            try {
                // åˆå§‹åŒ–APIå®¢æˆ·ç«¯
                if (typeof ApiClient !== 'undefined') {
                    apiClient = new ApiClient();
                    logOperation('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    logOperation('âš ï¸ ApiClientæœªåŠ è½½ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå®ç°');
                    apiClient = createMockApiClient();
                }
                
                // åˆå§‹åŒ–ä¿å­˜ç®¡ç†å™¨
                if (typeof ReviewSaveManager !== 'undefined') {
                    reviewSaveManager = new ReviewSaveManager('#review-form');
                    logOperation('âœ… å¤ç›˜ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                    updateManagerStatus('å·²åˆå§‹åŒ–');
                } else {
                    logOperation('âŒ ReviewSaveManageræœªåŠ è½½');
                    updateManagerStatus('åŠ è½½å¤±è´¥');
                }
                
                // åˆå§‹åŒ–Bootstrapæ¨¡æ€æ¡†
                const modalElement = document.getElementById('reviewModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    reviewModal = new bootstrap.Modal(modalElement);
                    logOperation('âœ… Bootstrapæ¨¡æ€æ¡†åˆå§‹åŒ–æˆåŠŸ');
                    
                    // ç›‘å¬æ¨¡æ€æ¡†äº‹ä»¶
                    modalElement.addEventListener('shown.bs.modal', () => {
                        updateModalStatus('å·²æ‰“å¼€');
                        logOperation('ğŸ“‹ æ¨¡æ€æ¡†å·²æ‰“å¼€');
                    });
                    
                    modalElement.addEventListener('hidden.bs.modal', () => {
                        updateModalStatus('å·²å…³é—­');
                        logOperation('ğŸ“‹ æ¨¡æ€æ¡†å·²å…³é—­');
                    });
                }
                
                // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('review-date').value = today;
                
                // å¼€å§‹çŠ¶æ€ç›‘æ§
                startStatusMonitoring();
                
                logOperation('ğŸ‰ åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                logOperation('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                updateManagerStatus('åˆå§‹åŒ–å¤±è´¥');
            }
        });

        // åˆ›å»ºæ¨¡æ‹ŸAPIå®¢æˆ·ç«¯
        function createMockApiClient() {
            return {
                saveReview: async function(data, id) {
                    logOperation('ğŸ”§ æ¨¡æ‹ŸAPIä¿å­˜: ' + JSON.stringify(data, null, 2));
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return {
                        success: true,
                        data: { id: id || Date.now(), ...data }
                    };
                }
            };
        }

        // æ—¥å¿—è®°å½•
        function logOperation(message) {
            const logEl = document.getElementById('operation-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<small class="text-muted">${timestamp}</small> ${message}`;
            
            if (logEl.children.length === 1 && logEl.children[0].textContent === 'ç­‰å¾…æ“ä½œ...') {
                logEl.innerHTML = '';
            }
            
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('operation-log').innerHTML = '<div class="text-muted">ç­‰å¾…æ“ä½œ...</div>';
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateManagerStatus(status) {
            document.getElementById('manager-status').textContent = status;
        }

        function updateUnsavedStatus(hasUnsaved) {
            const statusEl = document.getElementById('unsaved-status');
            if (hasUnsaved) {
                statusEl.innerHTML = '<span class="text-warning">æœ‰æœªä¿å­˜æ›´æ”¹</span>';
            } else {
                statusEl.innerHTML = '<span class="text-success">å·²ä¿å­˜</span>';
            }
        }

        function updateModalStatus(status) {
            document.getElementById('modal-status').textContent = status;
        }

        function updateListenersStatus(status) {
            document.getElementById('listeners-status').textContent = status;
        }

        // çŠ¶æ€ç›‘æ§
        function startStatusMonitoring() {
            setInterval(() => {
                if (reviewSaveManager) {
                    updateUnsavedStatus(reviewSaveManager.hasUnsavedChanges);
                    
                    // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨çŠ¶æ€
                    const hasBeforeUnload = typeof reviewSaveManager.beforeUnloadHandler === 'function';
                    const hasModalClose = typeof reviewSaveManager.modalCloseHandler === 'function';
                    
                    if (hasBeforeUnload && hasModalClose) {
                        updateListenersStatus('æ­£å¸¸');
                    } else {
                        updateListenersStatus('å¼‚å¸¸');
                    }
                }
            }, 1000);
        }

        // æµ‹è¯•ç»“æœç®¡ç†
        function addTestResult(testName, passed, details = '') {
            testResults.push({
                name: testName,
                passed: passed,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            });
            
            testStats.total++;
            if (passed) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            
            updateTestResultsDisplay();
            updateTestStats();
            
            logOperation(`${passed ? 'âœ…' : 'âŒ'} ${testName}: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}`);
        }

        function updateTestResultsDisplay() {
            const resultsEl = document.getElementById('test-results');
            
            if (testResults.length === 0) {
                resultsEl.innerHTML = '<div class="text-muted">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>';
                return;
            }
            
            let html = '';
            testResults.forEach(result => {
                const resultClass = result.passed ? 'test-pass' : 'test-fail';
                const icon = result.passed ? 'fa-check' : 'fa-times';
                
                html += `
                    <div class="test-result ${resultClass}">
                        <i class="fas ${icon} me-2"></i>
                        <strong>${result.name}</strong>
                        <small class="float-end">${result.timestamp}</small>
                        ${result.details ? `<div class="small mt-1">${result.details}</div>` : ''}
                    </div>
                `;
            });
            
            resultsEl.innerHTML = html;
        }

        function updateTestStats() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('passed-tests').textContent = testStats.passed;
            document.getElementById('failed-tests').textContent = testStats.failed;
            
            const passRate = testStats.total > 0 ? (testStats.passed / testStats.total * 100).toFixed(1) : 0;
            document.getElementById('pass-rate').textContent = passRate + '%';
        }

        // æµ‹è¯•å‡½æ•°
        function openReviewModal() {
            if (reviewModal) {
                reviewModal.show();
                logOperation('ğŸ“‹ æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†');
            } else {
                logOperation('âŒ æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            }
        }

        function simulateUnsavedChanges() {
            const reasonField = document.getElementById('reason');
            const analysisField = document.getElementById('analysis');
            
            if (reasonField && analysisField) {
                reasonField.value = 'æµ‹è¯•æœªä¿å­˜æ›´æ”¹ - ' + new Date().toLocaleTimeString();
                analysisField.value = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åˆ†æå†…å®¹';
                
                // è§¦å‘å˜åŒ–äº‹ä»¶
                reasonField.dispatchEvent(new Event('input'));
                analysisField.dispatchEvent(new Event('input'));
                
                logOperation('ğŸ”§ æ¨¡æ‹Ÿæœªä¿å­˜æ›´æ”¹');
                
                setTimeout(() => {
                    if (reviewSaveManager && reviewSaveManager.hasUnsavedChanges) {
                        addTestResult('æ¨¡æ‹Ÿæœªä¿å­˜æ›´æ”¹', true, 'æˆåŠŸæ£€æµ‹åˆ°è¡¨å•å˜åŒ–');
                    } else {
                        addTestResult('æ¨¡æ‹Ÿæœªä¿å­˜æ›´æ”¹', false, 'æœªèƒ½æ£€æµ‹åˆ°è¡¨å•å˜åŒ–');
                    }
                }, 500);
            } else {
                addTestResult('æ¨¡æ‹Ÿæœªä¿å­˜æ›´æ”¹', false, 'è¡¨å•å­—æ®µæœªæ‰¾åˆ°');
            }
        }

        function testWarningMechanisms() {
            logOperation('ğŸ§ª å¼€å§‹æµ‹è¯•è­¦å‘Šæœºåˆ¶');
            
            if (!reviewSaveManager) {
                addTestResult('è­¦å‘Šæœºåˆ¶æµ‹è¯•', false, 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            // æµ‹è¯•éªŒè¯æ–¹æ³•
            if (typeof reviewSaveManager.verifyWarningMechanisms === 'function') {
                const results = reviewSaveManager.verifyWarningMechanisms();
                
                addTestResult('beforeunloadäº‹ä»¶ç»‘å®š', results.beforeUnloadBound, 
                    results.beforeUnloadBound ? 'äº‹ä»¶å·²æ­£ç¡®ç»‘å®š' : 'äº‹ä»¶ç»‘å®šå¤±è´¥');
                
                addTestResult('æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ç»‘å®š', results.modalCloseBound,
                    results.modalCloseBound ? 'äº‹ä»¶å·²æ­£ç¡®ç»‘å®š' : 'äº‹ä»¶ç»‘å®šå¤±è´¥');
                
                addTestResult('æœªä¿å­˜æ›´æ”¹æ£€æµ‹', results.hasUnsavedChangesDetection,
                    results.hasUnsavedChangesDetection ? 'æ£€æµ‹æœºåˆ¶æ­£å¸¸' : 'æ£€æµ‹æœºåˆ¶å¼‚å¸¸');
                
                addTestResult('è­¦å‘Šæ¶ˆæ¯å‡†ç¡®æ€§', results.warningMessageAccuracy,
                    results.warningMessageAccuracy ? 'æ¶ˆæ¯æœºåˆ¶æ­£å¸¸' : 'æ¶ˆæ¯æœºåˆ¶å¼‚å¸¸');
            } else {
                addTestResult('è­¦å‘Šæœºåˆ¶éªŒè¯', false, 'verifyWarningMechanismsæ–¹æ³•ä¸å­˜åœ¨');
            }
            
            // æµ‹è¯•æµ‹è¯•æ–¹æ³•
            if (typeof reviewSaveManager.testWarningMechanisms === 'function') {
                reviewSaveManager.testWarningMechanisms();
                addTestResult('è­¦å‘Šæœºåˆ¶æµ‹è¯•æ–¹æ³•', true, 'æµ‹è¯•æ–¹æ³•æ‰§è¡ŒæˆåŠŸ');
            } else {
                addTestResult('è­¦å‘Šæœºåˆ¶æµ‹è¯•æ–¹æ³•', false, 'testWarningMechanismsæ–¹æ³•ä¸å­˜åœ¨');
            }
        }

        async function runAllTests() {
            logOperation('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•');
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            testResults = [];
            testStats = { total: 0, passed: 0, failed: 0 };
            updateTestResultsDisplay();
            updateTestStats();
            
            // æµ‹è¯•1: ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–
            if (reviewSaveManager) {
                addTestResult('ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–', true, 'ç®¡ç†å™¨å·²æ­£ç¡®åˆå§‹åŒ–');
            } else {
                addTestResult('ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–', false, 'ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥');
            }
            
            // æµ‹è¯•2: è­¦å‘Šæœºåˆ¶
            testWarningMechanisms();
            
            // æµ‹è¯•3: æ¨¡æ‹Ÿæœªä¿å­˜æ›´æ”¹
            simulateUnsavedChanges();
            
            // æµ‹è¯•4: æ¨¡æ€æ¡†åŠŸèƒ½
            if (reviewModal) {
                addTestResult('æ¨¡æ€æ¡†åˆå§‹åŒ–', true, 'Bootstrapæ¨¡æ€æ¡†å·²æ­£ç¡®åˆå§‹åŒ–');
            } else {
                addTestResult('æ¨¡æ€æ¡†åˆå§‹åŒ–', false, 'æ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥');
            }
            
            // æµ‹è¯•5: APIå®¢æˆ·ç«¯
            if (apiClient) {
                addTestResult('APIå®¢æˆ·ç«¯åˆå§‹åŒ–', true, 'APIå®¢æˆ·ç«¯å·²æ­£ç¡®åˆå§‹åŒ–');
            } else {
                addTestResult('APIå®¢æˆ·ç«¯åˆå§‹åŒ–', false, 'APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥');
            }
            
            logOperation('ğŸ æ‰€æœ‰æµ‹è¯•å®Œæˆ');
        }

        // ä¿å­˜å¤ç›˜å‡½æ•°
        function saveReview() {
            logOperation('ğŸ’¾ å°è¯•ä¿å­˜å¤ç›˜');
            
            if (reviewSaveManager && typeof reviewSaveManager.saveReview === 'function') {
                reviewSaveManager.saveReview();
                logOperation('âœ… ä¿å­˜å¤ç›˜åŠŸèƒ½å·²è°ƒç”¨');
            } else {
                logOperation('âŒ ä¿å­˜å¤ç›˜åŠŸèƒ½ä¸å¯ç”¨');
            }
        }

        // é¡µé¢ç¦»å¼€æµ‹è¯•æç¤º
        window.addEventListener('beforeunload', function(e) {
            // è¿™ä¸ªäº‹ä»¶ä¼šè¢«ä¿å­˜ç®¡ç†å™¨å¤„ç†ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æµ‹è¯•æ—¥å¿—
            if (reviewSaveManager && reviewSaveManager.hasUnsavedChanges) {
                logOperation('âš ï¸ é¡µé¢ç¦»å¼€è­¦å‘Šå·²è§¦å‘');
            }
        });
    </script>
</body>
</html>