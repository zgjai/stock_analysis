<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复盘记录按钮修复测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>复盘记录按钮修复测试</h2>
        
        <div class="alert alert-info">
            <h5>问题说明</h5>
            <p>复盘记录列表右侧的框框实际上是编辑和删除按钮，但由于以下问题导致显示异常：</p>
            <ul>
                <li>editReview 和 deleteReview 函数未定义，点击会报错</li>
                <li>按钮可能因为CSS样式问题显示为空框</li>
            </ul>
        </div>

        <div class="alert alert-success">
            <h5>修复方案</h5>
            <p>已添加以下功能：</p>
            <ul>
                <li>✅ 添加了 editReview 函数 - 支持编辑复盘记录</li>
                <li>✅ 添加了 deleteReview 函数 - 支持删除复盘记录</li>
                <li>✅ 包含错误处理和用户友好的提示信息</li>
                <li>✅ 支持确认删除操作</li>
            </ul>
        </div>

        <!-- 模拟复盘记录列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">复盘记录</h5>
            </div>
            <div class="card-body">
                <div id="reviews-list">
                    <!-- 模拟复盘记录 -->
                    <div class="card mb-3 review-item" data-review-id="1">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6 class="card-title mb-1">
                                        <strong>000776</strong>
                                    </h6>
                                    <small class="text-muted">2025-08-22</small>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-primary">sell_partial</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">持仓天数</small><br>
                                    <strong>15天</strong>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">浮盈</small><br>
                                    <strong class="text-success">+15.27%</strong>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">总分</small><br>
                                    <strong>5/25</strong>
                                </div>
                                <div class="col-md-1">
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editReview(1)" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteReview(1)" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">分析:</small>
                                    <p class="mb-0 small">暴跌核心阵容，开始冲刺了</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 review-item" data-review-id="2">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6 class="card-title mb-1">
                                        <strong>000776</strong>
                                    </h6>
                                    <small class="text-muted">2025-08-21</small>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-primary">hold</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">持仓天数</small><br>
                                    <strong>14天</strong>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">浮盈</small><br>
                                    <strong class="text-success">+7.46%</strong>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">总分</small><br>
                                    <strong>3/25</strong>
                                </div>
                                <div class="col-md-1">
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editReview(2)" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteReview(2)" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted">分析:</small>
                                    <p class="mb-0 small">暴跌阵容，第二阶段券商龙头</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 测试结果显示区域 -->
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">测试结果</h5>
                </div>
                <div class="card-body">
                    <div id="test-results">
                        <p class="text-muted">点击上方复盘记录右侧的编辑或删除按钮进行测试</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 模拟消息显示函数
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        function showErrorMessage(message) {
            showMessage(message, 'danger');
        }

        function showInfoMessage(message, options = {}) {
            showMessage(message, 'info');
        }

        function showMessage(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const alertClass = `alert-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            
            resultsDiv.innerHTML += `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <strong>[${timestamp}]</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // 模拟fetch API
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            console.log('模拟fetch调用:', url, options);
            
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (url.includes('/api/reviews/1') && options.method !== 'DELETE') {
                        resolve({
                            ok: true,
                            status: 200,
                            json: () => Promise.resolve({
                                success: true,
                                data: {
                                    id: 1,
                                    stock_code: '000776',
                                    review_date: '2025-08-22',
                                    holding_days: 15,
                                    current_price: 12.50,
                                    analysis: '暴跌核心阵容，开始冲刺了',
                                    decision: 'sell_partial',
                                    reason: '达到止盈目标',
                                    price_up_score: 1,
                                    bbi_score: 1,
                                    volume_score: 1,
                                    trend_score: 1,
                                    j_score: 1
                                }
                            })
                        });
                    } else if (url.includes('/api/reviews/2') && options.method !== 'DELETE') {
                        resolve({
                            ok: true,
                            status: 200,
                            json: () => Promise.resolve({
                                success: true,
                                data: {
                                    id: 2,
                                    stock_code: '000776',
                                    review_date: '2025-08-21',
                                    holding_days: 14,
                                    current_price: 11.80,
                                    analysis: '暴跌阵容，第二阶段券商龙头',
                                    decision: 'hold',
                                    reason: '继续观察',
                                    price_up_score: 1,
                                    bbi_score: 0,
                                    volume_score: 1,
                                    trend_score: 1,
                                    j_score: 0
                                }
                            })
                        });
                    } else if (options.method === 'DELETE') {
                        resolve({
                            ok: true,
                            status: 200,
                            json: () => Promise.resolve({
                                success: true,
                                message: '删除成功'
                            })
                        });
                    } else {
                        resolve({
                            ok: false,
                            status: 404,
                            statusText: 'Not Found',
                            json: () => Promise.resolve({
                                success: false,
                                error: { message: '复盘记录不存在' }
                            })
                        });
                    }
                }, 500);
            });
        };

        // 模拟loadReviews函数
        function loadReviews() {
            showInfoMessage('重新加载复盘记录列表...');
        }

        // 编辑复盘记录函数（使用fetch API）
        window.editReview = function(reviewId) {
            console.log('编辑复盘记录:', reviewId);
            
            // 显示加载状态
            showInfoMessage('正在加载复盘记录...', { duration: 2000 });
            
            // 使用fetch API获取复盘记录数据
            fetch(`/api/reviews/${reviewId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.data) {
                        const review = data.data;
                        
                        showSuccessMessage(`复盘记录加载成功: ${review.stock_code} (${review.review_date})`);
                        
                        // 在实际应用中，这里会填充表单并显示模态框
                        showInfoMessage('在实际应用中，这里会打开编辑模态框并填充数据');
                        
                    } else {
                        throw new Error(data.error?.message || data.message || '获取复盘记录失败');
                    }
                })
                .catch(error => {
                    console.error('获取复盘记录失败:', error);
                    showErrorMessage('获取复盘记录失败: ' + error.message);
                });
        };

        // 删除复盘记录函数（使用fetch API）
        window.deleteReview = function(reviewId) {
            console.log('删除复盘记录:', reviewId);
            
            // 确认删除
            if (!confirm('确定要删除这条复盘记录吗？此操作不可恢复。')) {
                showInfoMessage('用户取消了删除操作');
                return;
            }
            
            // 显示加载状态
            showInfoMessage('正在删除复盘记录...', { duration: 2000 });
            
            // 使用fetch API删除复盘记录
            fetch(`/api/reviews/${reviewId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showSuccessMessage('复盘记录删除成功');
                        
                        // 重新加载复盘记录列表
                        setTimeout(() => {
                            loadReviews();
                        }, 500);
                    } else {
                        throw new Error(data.error?.message || data.message || '删除复盘记录失败');
                    }
                })
                .catch(error => {
                    console.error('删除复盘记录失败:', error);
                    showErrorMessage('删除复盘记录失败: ' + error.message);
                });
        };

        // 页面加载完成后显示说明
        document.addEventListener('DOMContentLoaded', function() {
            showInfoMessage('页面加载完成，可以测试复盘记录的编辑和删除功能');
        });
    </script>
</body>
</html>