<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期望差异功能测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-balance-scale text-primary me-2"></i>
                    期望差异功能测试
                </h1>
                
                <!-- 功能状态检查 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">功能状态检查</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>API接口测试</h6>
                                <div id="api-status" class="mb-3">
                                    <span class="badge bg-secondary">检查中...</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>前端组件测试</h6>
                                <div id="frontend-status" class="mb-3">
                                    <span class="badge bg-secondary">检查中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 期望对比数据展示 -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">期望对比数据</h5>
                        <button class="btn btn-primary btn-sm" onclick="loadExpectationData()">
                            <i class="fas fa-sync-alt me-1"></i>加载数据
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="expectation-data">
                            <div class="text-center text-muted">
                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                <p>点击"加载数据"按钮获取期望对比分析</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 导航菜单检查 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">导航菜单检查</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>期望差异功能位置说明</h6>
                            <p class="mb-2">期望差异功能已实现，位于以下位置：</p>
                            <ol class="mb-0">
                                <li>在左侧导航菜单中点击 <strong>"统计分析"</strong></li>
                                <li>在统计分析页面中选择 <strong>"期望对比"</strong> Tab</li>
                                <li>该Tab包含完整的期望vs实际对比分析功能</li>
                            </ol>
                        </div>
                        
                        <div class="mt-3">
                            <a href="/analytics" class="btn btn-success me-2" target="_blank">
                                <i class="fas fa-external-link-alt me-1"></i>
                                打开统计分析页面
                            </a>
                            <button class="btn btn-outline-primary" onclick="checkNavigationMenu()">
                                <i class="fas fa-search me-1"></i>
                                检查导航菜单
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 功能特性说明 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">期望差异功能特性</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success">已实现功能</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>期望vs实际收益率对比</li>
                                    <li><i class="fas fa-check text-success me-2"></i>期望vs实际收益金额对比</li>
                                    <li><i class="fas fa-check text-success me-2"></i>期望vs实际持仓天数对比</li>
                                    <li><i class="fas fa-check text-success me-2"></i>期望vs实际胜率对比</li>
                                    <li><i class="fas fa-check text-success me-2"></i>时间范围筛选功能</li>
                                    <li><i class="fas fa-check text-success me-2"></i>图表可视化展示</li>
                                    <li><i class="fas fa-check text-success me-2"></i>差异分析和建议</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">期望模型参数</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-cog text-primary me-2"></i>基准本金：320万元</li>
                                    <li><i class="fas fa-cog text-primary me-2"></i>期望收益率：4.1%</li>
                                    <li><i class="fas fa-cog text-primary me-2"></i>期望持仓天数：11.25天</li>
                                    <li><i class="fas fa-cog text-primary me-2"></i>期望胜率：60%</li>
                                    <li><i class="fas fa-cog text-primary me-2"></i>支持多种盈亏场景</li>
                                    <li><i class="fas fa-cog text-primary me-2"></i>概率加权计算</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载时自动检查
        document.addEventListener('DOMContentLoaded', function() {
            checkApiStatus();
            checkFrontendComponents();
        });

        // 检查API状态
        async function checkApiStatus() {
            const statusElement = document.getElementById('api-status');
            
            try {
                const response = await fetch('/api/analytics/expectation-comparison?time_range=all&base_capital=3200000');
                const data = await response.json();
                
                if (data.success) {
                    statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>API正常</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>API响应异常</span>';
                }
            } catch (error) {
                statusElement.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>API连接失败</span>';
                console.error('API检查失败:', error);
            }
        }

        // 检查前端组件
        function checkFrontendComponents() {
            const statusElement = document.getElementById('frontend-status');
            
            // 检查必要的库是否加载
            const checks = [
                { name: 'Bootstrap', test: () => typeof bootstrap !== 'undefined' },
                { name: 'Chart.js', test: () => typeof Chart !== 'undefined' },
                { name: 'FontAwesome', test: () => document.querySelector('.fas') !== null }
            ];
            
            const results = checks.map(check => ({
                name: check.name,
                passed: check.test()
            }));
            
            const allPassed = results.every(r => r.passed);
            
            if (allPassed) {
                statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>组件正常</span>';
            } else {
                const failed = results.filter(r => !r.passed).map(r => r.name).join(', ');
                statusElement.innerHTML = `<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>缺少: ${failed}</span>`;
            }
        }

        // 加载期望对比数据
        async function loadExpectationData() {
            const dataElement = document.getElementById('expectation-data');
            
            // 显示加载状态
            dataElement.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="text-muted">正在获取期望对比数据...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/analytics/expectation-comparison?time_range=all&base_capital=3200000');
                const result = await response.json();
                
                if (result.success) {
                    renderExpectationData(result.data);
                } else {
                    throw new Error(result.message || '获取数据失败');
                }
            } catch (error) {
                dataElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        加载失败: ${error.message}
                    </div>
                `;
                console.error('加载期望对比数据失败:', error);
            }
        }

        // 渲染期望对比数据
        function renderExpectationData(data) {
            const dataElement = document.getElementById('expectation-data');
            
            const { expectation, actual, comparison, time_range } = data;
            
            dataElement.innerHTML = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            时间范围: ${time_range.range_name} | 总交易数: ${time_range.total_trades}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">收益率对比</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted">期望</small>
                                        <div class="h5 text-primary">${(expectation.return_rate * 100).toFixed(2)}%</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">实际</small>
                                        <div class="h5 text-info">${(actual.return_rate * 100).toFixed(2)}%</div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <span class="badge bg-${comparison.return_rate_status.color}">
                                        ${comparison.return_rate_status.message}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">收益金额对比</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted">期望</small>
                                        <div class="h5 text-primary">¥${expectation.return_amount.toLocaleString()}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">实际</small>
                                        <div class="h5 text-info">¥${actual.return_amount.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">持仓天数对比</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted">期望</small>
                                        <div class="h5 text-primary">${expectation.holding_days.toFixed(1)}天</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">实际</small>
                                        <div class="h5 text-info">${actual.holding_days.toFixed(1)}天</div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <span class="badge bg-${comparison.holding_days_status.color}">
                                        ${comparison.holding_days_status.message}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">胜率对比</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted">期望</small>
                                        <div class="h5 text-primary">${(expectation.success_rate * 100).toFixed(1)}%</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">实际</small>
                                        <div class="h5 text-info">${(actual.success_rate * 100).toFixed(1)}%</div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <span class="badge bg-${comparison.success_rate_status.color}">
                                        ${comparison.success_rate_status.message}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-success mt-4">
                    <h6><i class="fas fa-check-circle me-2"></i>期望差异功能测试成功！</h6>
                    <p class="mb-0">API接口正常工作，数据结构完整，前端展示正常。</p>
                </div>
            `;
        }

        // 检查导航菜单
        function checkNavigationMenu() {
            alert('期望差异功能位于：\n\n1. 左侧导航菜单 → "统计分析"\n2. 统计分析页面 → "期望对比" Tab\n\n功能已完整实现，包括：\n- 期望vs实际对比\n- 时间范围筛选\n- 图表可视化\n- 差异分析');
        }
    </script>
</body>
</html>