<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史交易排序问题诊断</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>历史交易排序问题诊断</h2>
        
        <div class="card">
            <div class="card-body">
                <h5>排序控件测试</h5>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">排序字段</label>
                        <select class="form-select" id="sort-by">
                            <option value="completion_date">按完成日期</option>
                            <option value="stock_code">按股票代码</option>
                            <option value="return_rate">按收益率</option>
                            <option value="holding_days">按持仓天数</option>
                            <option value="total_investment">按投入本金</option>
                            <option value="total_return">按实际收益</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">排序方向</label>
                        <select class="form-select" id="sort-order">
                            <option value="desc">降序</option>
                            <option value="asc">升序</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-primary w-100 d-block" onclick="testSorting()">
                            测试排序
                        </button>
                    </div>
                </div>
                
                <div id="debug-output" class="mt-3">
                    <!-- 调试输出将显示在这里 -->
                </div>
                
                <div id="api-response" class="mt-3">
                    <!-- API响应将显示在这里 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function testSorting() {
            const debugOutput = document.getElementById('debug-output');
            const apiResponse = document.getElementById('api-response');
            
            // 获取排序参数
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value;
            
            debugOutput.innerHTML = `
                <div class="alert alert-info">
                    <h6>调试信息:</h6>
                    <p><strong>排序字段:</strong> ${sortBy}</p>
                    <p><strong>排序方向:</strong> ${sortOrder}</p>
                    <p><strong>请求URL:</strong> http://localhost:5001/api/historical-trades?sort_by=${sortBy}&sort_order=${sortOrder}</p>
                </div>
            `;
            
            try {
                // 发送API请求
                const response = await fetch(`http://localhost:5001/api/historical-trades?sort_by=${sortBy}&sort_order=${sortOrder}&per_page=10`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const trades = data.data.trades || [];
                    
                    let tableHTML = `
                        <div class="alert alert-success">
                            <h6>API响应成功 (共${trades.length}条记录):</h6>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>股票代码</th>
                                        <th>完成日期</th>
                                        <th>收益率</th>
                                        <th>持仓天数</th>
                                        <th>投入本金</th>
                                        <th>实际收益</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    trades.forEach(trade => {
                        tableHTML += `
                            <tr>
                                <td>${trade.stock_code}</td>
                                <td>${trade.completion_date}</td>
                                <td>${(trade.return_rate * 100).toFixed(2)}%</td>
                                <td>${trade.holding_days}天</td>
                                <td>¥${trade.total_investment}</td>
                                <td>¥${trade.total_return}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    apiResponse.innerHTML = tableHTML;
                } else {
                    apiResponse.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>API请求失败:</h6>
                            <p>${data.message || '未知错误'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                apiResponse.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>请求错误:</h6>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 页面加载时自动测试默认排序
        document.addEventListener('DOMContentLoaded', function() {
            testSorting();
        });
        
        // 监听排序字段变化
        document.getElementById('sort-by').addEventListener('change', testSorting);
        document.getElementById('sort-order').addEventListener('change', testSorting);
    </script>
</body>
</html>