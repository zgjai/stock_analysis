<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简单交易测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>🚨 紧急交易记录测试</h1>
        <div class="alert alert-warning">
            <strong>注意：</strong>分批止盈功能已暂时禁用，专注测试基本交易记录保存功能。
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>基本交易记录测试</h5>
            </div>
            <div class="card-body">
                <form id="simple-trade-form">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">股票代码 *</label>
                            <input type="text" class="form-control" name="stock_code" value="000001" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">股票名称 *</label>
                            <input type="text" class="form-control" name="stock_name" value="平安银行" required>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <label class="form-label">交易类型 *</label>
                            <select class="form-select" name="trade_type" required>
                                <option value="buy" selected>买入</option>
                                <option value="sell">卖出</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">价格 *</label>
                            <input type="number" class="form-control" name="price" value="10.00" step="0.01" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">数量 *</label>
                            <input type="number" class="form-control" name="quantity" value="1000" step="100" required>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">操作原因 *</label>
                            <select class="form-select" name="reason" required>
                                <option value="少妇B1战法" selected>少妇B1战法</option>
                                <option value="测试">测试</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">交易日期 *</label>
                            <input type="datetime-local" class="form-control" name="trade_date" required>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" name="notes" rows="2">紧急测试交易记录</textarea>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-lg" onclick="testSaveRecord()">
                            🚀 测试保存交易记录
                        </button>
                        <button type="button" class="btn btn-info" onclick="checkFormData()">
                            📋 检查表单数据
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>测试结果</h5>
            </div>
            <div class="card-body">
                <div id="test-result" style="background: #212529; color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; white-space: pre-wrap; min-height: 200px;">
等待测试...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 设置当前时间
        document.querySelector('[name="trade_date"]').value = new Date().toISOString().slice(0, 16);
        
        function log(message) {
            const result = document.getElementById('test-result');
            const time = new Date().toLocaleTimeString();
            result.textContent += `[${time}] ${message}\n`;
            result.scrollTop = result.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('test-result').textContent = '';
        }
        
        function checkFormData() {
            clearLog();
            log('=== 检查表单数据 ===');
            
            const form = document.getElementById('simple-trade-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            log('表单数据:');
            log(JSON.stringify(data, null, 2));
            
            // 检查必填字段
            const required = ['stock_code', 'stock_name', 'trade_type', 'price', 'quantity', 'reason'];
            log('\n必填字段检查:');
            let allValid = true;
            
            required.forEach(field => {
                const value = data[field];
                const isEmpty = !value || value.toString().trim() === '';
                log(`${field}: ${isEmpty ? '❌ 空值' : '✅ 有值'} ("${value}")`);
                if (isEmpty) allValid = false;
            });
            
            log(`\n验证结果: ${allValid ? '✅ 通过' : '❌ 失败'}`);
        }
        
        async function testSaveRecord() {
            clearLog();
            log('=== 测试保存交易记录 ===');
            
            const form = document.getElementById('simple-trade-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 数据预处理
            data.price = parseFloat(data.price);
            data.quantity = parseInt(data.quantity);
            data.use_batch_profit_taking = false; // 强制禁用分批止盈
            
            log('发送数据:');
            log(JSON.stringify(data, null, 2));
            
            try {
                log('\n发送API请求...');
                const response = await axios.post('/api/trades', data, {
                    headers: { 'Content-Type': 'application/json' },
                    timeout: 15000
                });
                
                log('✅ 保存成功!');
                log(`状态码: ${response.status}`);
                log('响应数据:');
                log(JSON.stringify(response.data, null, 2));
                
                // 显示成功提示
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success mt-3';
                alertDiv.innerHTML = '<strong>🎉 成功！</strong> 交易记录保存成功，基本功能正常！';
                form.parentNode.insertBefore(alertDiv, form.nextSibling);
                
                setTimeout(() => alertDiv.remove(), 5000);
                
            } catch (error) {
                log('❌ 保存失败!');
                
                if (error.response) {
                    log(`HTTP错误: ${error.response.status}`);
                    try {
                        const errorData = error.response.data;
                        log('错误详情:');
                        log(JSON.stringify(errorData, null, 2));
                    } catch (e) {
                        log('无法解析错误响应');
                    }
                } else if (error.request) {
                    log('网络错误: 无法连接到服务器');
                } else {
                    log(`请求错误: ${error.message}`);
                }
                
                // 显示错误提示
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = '<strong>❌ 失败！</strong> 交易记录保存失败，请检查错误信息。';
                form.parentNode.insertBefore(alertDiv, form.nextSibling);
                
                setTimeout(() => alertDiv.remove(), 10000);
            }
        }
    </script>
</body>
</html>