<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>当前问题调试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>当前问题调试</h2>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>系统状态检查</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary me-2" onclick="checkServerStatus()">检查服务器状态</button>
                        <button class="btn btn-info me-2" onclick="checkJavaScriptFiles()">检查JavaScript文件</button>
                        <button class="btn btn-success me-2" onclick="testTradingRecordsPage()">测试交易记录页面</button>
                        <button class="btn btn-warning me-2" onclick="testAPIEndpoints()">测试API端点</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>调试结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-results">
                            <div class="text-muted">点击上方按钮开始调试...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>控制台日志</h5>
                    </div>
                    <div class="card-body">
                        <pre id="console-log" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 重写console.log来捕获日志
        const originalLog = console.log;
        const originalError = console.error;
        const logContainer = document.getElementById('console-log');
        
        function addToLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logContainer.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog('log', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('error', ...args);
        };
        
        // 检查服务器状态
        async function checkServerStatus() {
            const resultsDiv = document.getElementById('debug-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>检查服务器状态...';
            
            try {
                const response = await fetch('/');
                const status = response.ok ? '正常' : '异常';
                const statusClass = response.ok ? 'success' : 'danger';
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-${statusClass}">
                        <h6>服务器状态: ${status}</h6>
                        <p>状态码: ${response.status}</p>
                        <p>响应时间: ${Date.now() - performance.now()}ms</p>
                    </div>
                `;
                
                console.log('服务器状态检查完成:', response.status);
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>服务器连接失败</h6>
                        <p>错误: ${error.message}</p>
                    </div>
                `;
                console.error('服务器状态检查失败:', error);
            }
        }
        
        // 检查JavaScript文件
        async function checkJavaScriptFiles() {
            const resultsDiv = document.getElementById('debug-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>检查JavaScript文件...';
            
            const jsFiles = [
                '/static/js/api.js',
                '/static/js/utils.js',
                '/static/js/form-validation.js',
                '/static/js/main.js'
            ];
            
            const results = [];
            
            for (const file of jsFiles) {
                try {
                    const response = await fetch(file);
                    results.push({
                        file: file,
                        status: response.ok ? '正常' : '失败',
                        statusCode: response.status,
                        size: response.headers.get('content-length') || '未知'
                    });
                } catch (error) {
                    results.push({
                        file: file,
                        status: '错误',
                        error: error.message
                    });
                }
            }
            
            const resultsHtml = results.map(result => `
                <tr class="${result.status === '正常' ? 'table-success' : 'table-danger'}">
                    <td>${result.file}</td>
                    <td>${result.status}</td>
                    <td>${result.statusCode || result.error || '-'}</td>
                    <td>${result.size || '-'}</td>
                </tr>
            `).join('');
            
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h6>JavaScript文件检查结果</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>文件</th>
                                <th>状态</th>
                                <th>状态码/错误</th>
                                <th>大小</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${resultsHtml}
                        </tbody>
                    </table>
                </div>
            `;
            
            console.log('JavaScript文件检查完成:', results);
        }
        
        // 测试交易记录页面
        async function testTradingRecordsPage() {
            const resultsDiv = document.getElementById('debug-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>测试交易记录页面...';
            
            try {
                const response = await fetch('/trading-records');
                const html = await response.text();
                
                // 检查页面是否包含关键元素
                const hasTradeForm = html.includes('id="trade-form"');
                const hasTradeTable = html.includes('id="trades-table-body"');
                const hasJavaScript = html.includes('TradingRecordsManager');
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-${response.ok ? 'success' : 'danger'}">
                        <h6>交易记录页面测试</h6>
                        <p>页面加载: ${response.ok ? '成功' : '失败'}</p>
                        <p>状态码: ${response.status}</p>
                        <p>包含交易表单: ${hasTradeForm ? '是' : '否'}</p>
                        <p>包含交易表格: ${hasTradeTable ? '是' : '否'}</p>
                        <p>包含JavaScript管理器: ${hasJavaScript ? '是' : '否'}</p>
                        <p>页面大小: ${html.length} 字符</p>
                    </div>
                `;
                
                console.log('交易记录页面测试完成');
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>交易记录页面测试失败</h6>
                        <p>错误: ${error.message}</p>
                    </div>
                `;
                console.error('交易记录页面测试失败:', error);
            }
        }
        
        // 测试API端点
        async function testAPIEndpoints() {
            const resultsDiv = document.getElementById('debug-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>测试API端点...';
            
            const endpoints = [
                { url: '/api/trades', method: 'GET', name: '获取交易记录' },
                { url: '/api/trades/config/buy-reasons', method: 'GET', name: '获取买入原因' },
                { url: '/api/trades/config/sell-reasons', method: 'GET', name: '获取卖出原因' },
                { url: '/api/stock-pool', method: 'GET', name: '获取股票池' }
            ];
            
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, { method: endpoint.method });
                    const data = await response.json();
                    
                    results.push({
                        name: endpoint.name,
                        url: endpoint.url,
                        status: response.ok ? '成功' : '失败',
                        statusCode: response.status,
                        hasData: data && Object.keys(data).length > 0
                    });
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        url: endpoint.url,
                        status: '错误',
                        error: error.message
                    });
                }
            }
            
            const resultsHtml = results.map(result => `
                <tr class="${result.status === '成功' ? 'table-success' : 'table-danger'}">
                    <td>${result.name}</td>
                    <td>${result.url}</td>
                    <td>${result.status}</td>
                    <td>${result.statusCode || result.error || '-'}</td>
                    <td>${result.hasData ? '是' : '否'}</td>
                </tr>
            `).join('');
            
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h6>API端点测试结果</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>API名称</th>
                                <th>URL</th>
                                <th>状态</th>
                                <th>状态码/错误</th>
                                <th>有数据</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${resultsHtml}
                        </tbody>
                    </table>
                </div>
            `;
            
            console.log('API端点测试完成:', results);
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', () => {
            console.log('调试页面已加载');
            checkServerStatus();
        });
    </script>
</body>
</html>