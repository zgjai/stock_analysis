<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript修复测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>JavaScript语法修复测试</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>测试结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="text-muted">正在测试...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>控制台日志</h5>
                    </div>
                    <div class="card-body">
                        <div id="console-log" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary" onclick="runTests()">重新测试</button>
            <button class="btn btn-success" onclick="testReviewPage()">测试复盘页面</button>
        </div>
    </div>

    <!-- 加载修复脚本 -->
    <script src="/static/js/emergency-syntax-fix.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/review-emergency-fix.js"></script>

    <script>
        // 捕获控制台输出
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsoleLog(type, message) {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-info';
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsoleLog('log', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsoleLog('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsoleLog('warn', args.join(' '));
        };

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = '';
            
            let results = [];
            
            // 测试1: Validators是否正确加载
            try {
                if (typeof window.Validators !== 'undefined' && window.Validators.stockCode) {
                    results.push('<div class="alert alert-success">✅ Validators 加载成功</div>');
                    console.log('✅ Validators 测试通过');
                } else {
                    results.push('<div class="alert alert-danger">❌ Validators 未正确加载</div>');
                    console.error('❌ Validators 测试失败');
                }
            } catch (e) {
                results.push('<div class="alert alert-danger">❌ Validators 测试异常: ' + e.message + '</div>');
                console.error('❌ Validators 测试异常:', e);
            }
            
            // 测试2: 其他工具类是否正确加载
            const utilClasses = ['Formatters', 'DOMUtils', 'DataUtils', 'StorageUtils'];
            utilClasses.forEach(className => {
                try {
                    if (typeof window[className] !== 'undefined') {
                        results.push(`<div class="alert alert-success">✅ ${className} 加载成功</div>`);
                        console.log(`✅ ${className} 测试通过`);
                    } else {
                        results.push(`<div class="alert alert-warning">⚠️ ${className} 未加载</div>`);
                        console.warn(`⚠️ ${className} 未加载`);
                    }
                } catch (e) {
                    results.push(`<div class="alert alert-danger">❌ ${className} 测试异常: ${e.message}</div>`);
                    console.error(`❌ ${className} 测试异常:`, e);
                }
            });
            
            // 测试3: 紧急修复脚本是否工作
            try {
                if (typeof window.fixAsyncSyntax === 'function') {
                    results.push('<div class="alert alert-success">✅ 紧急修复脚本加载成功</div>');
                    console.log('✅ 紧急修复脚本测试通过');
                } else {
                    results.push('<div class="alert alert-warning">⚠️ 紧急修复脚本未加载</div>');
                    console.warn('⚠️ 紧急修复脚本未加载');
                }
            } catch (e) {
                results.push('<div class="alert alert-danger">❌ 紧急修复脚本测试异常: ' + e.message + '</div>');
                console.error('❌ 紧急修复脚本测试异常:', e);
            }
            
            // 测试4: 股票代码验证功能
            try {
                if (window.Validators && window.Validators.stockCode) {
                    const testResult1 = window.Validators.stockCode('000001');
                    const testResult2 = window.Validators.stockCode('invalid');
                    
                    if (testResult1 === true && testResult2 === false) {
                        results.push('<div class="alert alert-success">✅ 股票代码验证功能正常</div>');
                        console.log('✅ 股票代码验证测试通过');
                    } else {
                        results.push('<div class="alert alert-danger">❌ 股票代码验证功能异常</div>');
                        console.error('❌ 股票代码验证测试失败');
                    }
                }
            } catch (e) {
                results.push('<div class="alert alert-danger">❌ 股票代码验证测试异常: ' + e.message + '</div>');
                console.error('❌ 股票代码验证测试异常:', e);
            }
            
            resultsDiv.innerHTML = results.join('');
        }
        
        function testReviewPage() {
            console.log('🔍 开始测试复盘页面功能...');
            
            // 模拟复盘页面的关键函数调用
            try {
                // 测试是否可以正常调用API
                fetch('/api/holdings')
                    .then(response => {
                        console.log('✅ API调用测试通过，状态:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('✅ API数据解析成功:', data);
                    })
                    .catch(error => {
                        console.warn('⚠️ API调用测试失败:', error);
                    });
                    
                console.log('✅ 复盘页面基础功能测试完成');
            } catch (e) {
                console.error('❌ 复盘页面测试异常:', e);
            }
        }
        
        // 页面加载完成后自动运行测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 页面加载完成，开始自动测试...');
            setTimeout(runTests, 1000); // 延迟1秒确保所有脚本加载完成
        });
    </script>
</body>
</html>