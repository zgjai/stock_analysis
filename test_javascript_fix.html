<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScriptä¿®å¤æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>JavaScriptè¯­æ³•ä¿®å¤æµ‹è¯•</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•ç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="text-muted">æ­£åœ¨æµ‹è¯•...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>æ§åˆ¶å°æ—¥å¿—</h5>
                    </div>
                    <div class="card-body">
                        <div id="console-log" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary" onclick="runTests()">é‡æ–°æµ‹è¯•</button>
            <button class="btn btn-success" onclick="testReviewPage()">æµ‹è¯•å¤ç›˜é¡µé¢</button>
        </div>
    </div>

    <!-- åŠ è½½ä¿®å¤è„šæœ¬ -->
    <script src="/static/js/emergency-syntax-fix.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/review-emergency-fix.js"></script>

    <script>
        // æ•è·æ§åˆ¶å°è¾“å‡º
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsoleLog(type, message) {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-info';
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsoleLog('log', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsoleLog('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsoleLog('warn', args.join(' '));
        };

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = '';
            
            let results = [];
            
            // æµ‹è¯•1: Validatorsæ˜¯å¦æ­£ç¡®åŠ è½½
            try {
                if (typeof window.Validators !== 'undefined' && window.Validators.stockCode) {
                    results.push('<div class="alert alert-success">âœ… Validators åŠ è½½æˆåŠŸ</div>');
                    console.log('âœ… Validators æµ‹è¯•é€šè¿‡');
                } else {
                    results.push('<div class="alert alert-danger">âŒ Validators æœªæ­£ç¡®åŠ è½½</div>');
                    console.error('âŒ Validators æµ‹è¯•å¤±è´¥');
                }
            } catch (e) {
                results.push('<div class="alert alert-danger">âŒ Validators æµ‹è¯•å¼‚å¸¸: ' + e.message + '</div>');
                console.error('âŒ Validators æµ‹è¯•å¼‚å¸¸:', e);
            }
            
            // æµ‹è¯•2: å…¶ä»–å·¥å…·ç±»æ˜¯å¦æ­£ç¡®åŠ è½½
            const utilClasses = ['Formatters', 'DOMUtils', 'DataUtils', 'StorageUtils'];
            utilClasses.forEach(className => {
                try {
                    if (typeof window[className] !== 'undefined') {
                        results.push(`<div class="alert alert-success">âœ… ${className} åŠ è½½æˆåŠŸ</div>`);
                        console.log(`âœ… ${className} æµ‹è¯•é€šè¿‡`);
                    } else {
                        results.push(`<div class="alert alert-warning">âš ï¸ ${className} æœªåŠ è½½</div>`);
                        console.warn(`âš ï¸ ${className} æœªåŠ è½½`);
                    }
                } catch (e) {
                    results.push(`<div class="alert alert-danger">âŒ ${className} æµ‹è¯•å¼‚å¸¸: ${e.message}</div>`);
                    console.error(`âŒ ${className} æµ‹è¯•å¼‚å¸¸:`, e);
                }
            });
            
            // æµ‹è¯•3: ç´§æ€¥ä¿®å¤è„šæœ¬æ˜¯å¦å·¥ä½œ
            try {
                if (typeof window.fixAsyncSyntax === 'function') {
                    results.push('<div class="alert alert-success">âœ… ç´§æ€¥ä¿®å¤è„šæœ¬åŠ è½½æˆåŠŸ</div>');
                    console.log('âœ… ç´§æ€¥ä¿®å¤è„šæœ¬æµ‹è¯•é€šè¿‡');
                } else {
                    results.push('<div class="alert alert-warning">âš ï¸ ç´§æ€¥ä¿®å¤è„šæœ¬æœªåŠ è½½</div>');
                    console.warn('âš ï¸ ç´§æ€¥ä¿®å¤è„šæœ¬æœªåŠ è½½');
                }
            } catch (e) {
                results.push('<div class="alert alert-danger">âŒ ç´§æ€¥ä¿®å¤è„šæœ¬æµ‹è¯•å¼‚å¸¸: ' + e.message + '</div>');
                console.error('âŒ ç´§æ€¥ä¿®å¤è„šæœ¬æµ‹è¯•å¼‚å¸¸:', e);
            }
            
            // æµ‹è¯•4: è‚¡ç¥¨ä»£ç éªŒè¯åŠŸèƒ½
            try {
                if (window.Validators && window.Validators.stockCode) {
                    const testResult1 = window.Validators.stockCode('000001');
                    const testResult2 = window.Validators.stockCode('invalid');
                    
                    if (testResult1 === true && testResult2 === false) {
                        results.push('<div class="alert alert-success">âœ… è‚¡ç¥¨ä»£ç éªŒè¯åŠŸèƒ½æ­£å¸¸</div>');
                        console.log('âœ… è‚¡ç¥¨ä»£ç éªŒè¯æµ‹è¯•é€šè¿‡');
                    } else {
                        results.push('<div class="alert alert-danger">âŒ è‚¡ç¥¨ä»£ç éªŒè¯åŠŸèƒ½å¼‚å¸¸</div>');
                        console.error('âŒ è‚¡ç¥¨ä»£ç éªŒè¯æµ‹è¯•å¤±è´¥');
                    }
                }
            } catch (e) {
                results.push('<div class="alert alert-danger">âŒ è‚¡ç¥¨ä»£ç éªŒè¯æµ‹è¯•å¼‚å¸¸: ' + e.message + '</div>');
                console.error('âŒ è‚¡ç¥¨ä»£ç éªŒè¯æµ‹è¯•å¼‚å¸¸:', e);
            }
            
            resultsDiv.innerHTML = results.join('');
        }
        
        function testReviewPage() {
            console.log('ğŸ” å¼€å§‹æµ‹è¯•å¤ç›˜é¡µé¢åŠŸèƒ½...');
            
            // æ¨¡æ‹Ÿå¤ç›˜é¡µé¢çš„å…³é”®å‡½æ•°è°ƒç”¨
            try {
                // æµ‹è¯•æ˜¯å¦å¯ä»¥æ­£å¸¸è°ƒç”¨API
                fetch('/api/holdings')
                    .then(response => {
                        console.log('âœ… APIè°ƒç”¨æµ‹è¯•é€šè¿‡ï¼ŒçŠ¶æ€:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('âœ… APIæ•°æ®è§£ææˆåŠŸ:', data);
                    })
                    .catch(error => {
                        console.warn('âš ï¸ APIè°ƒç”¨æµ‹è¯•å¤±è´¥:', error);
                    });
                    
                console.log('âœ… å¤ç›˜é¡µé¢åŸºç¡€åŠŸèƒ½æµ‹è¯•å®Œæˆ');
            } catch (e) {
                console.error('âŒ å¤ç›˜é¡µé¢æµ‹è¯•å¼‚å¸¸:', e);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            setTimeout(runTests, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        });
    </script>
</body>
</html>