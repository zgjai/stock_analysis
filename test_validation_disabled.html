<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试前端校验禁用</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="bi bi-shield-x me-2"></i>前端校验禁用测试</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            这个页面用于测试前端校验是否已经被成功禁用。
                            所有字段都不应该显示红色边框或错误消息。
                        </div>

                        <!-- 测试表单 -->
                        <form id="test-form" novalidate>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="stock-code" class="form-label">股票代码 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="stock-code" name="stock_code" 
                                               placeholder="例如: 000001">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="stock-name" class="form-label">股票名称 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="stock-name" name="stock_name" 
                                               placeholder="例如: 平安银行">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="trade-type" class="form-label">交易类型 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="trade-type" name="trade_type">
                                            <option value="">请选择交易类型</option>
                                            <option value="buy">买入</option>
                                            <option value="sell">卖出</option>
                                        </select>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="trade-date" class="form-label">交易日期 <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="trade-date" name="trade_date">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="price" class="form-label">价格 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" id="price" name="price" 
                                                   step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="quantity" class="form-label">数量 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="quantity" name="quantity" 
                                                   placeholder="100">
                                            <span class="input-group-text">股</span>
                                        </div>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="reason" class="form-label">操作原因 <span class="text-danger">*</span></label>
                                <select class="form-select" id="reason" name="reason">
                                    <option value="">请选择操作原因</option>
                                    <option value="少妇B1战法">少妇B1战法</option>
                                    <option value="技术分析">技术分析</option>
                                    <option value="基本面分析">基本面分析</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary me-md-2" onclick="testValidation()">
                                    <i class="bi bi-bug me-1"></i>测试校验
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-1"></i>提交表单
                                </button>
                            </div>
                        </form>

                        <!-- 测试结果 -->
                        <div class="mt-4">
                            <h5>测试结果</h5>
                            <div id="test-results" class="border rounded p-3 bg-light">
                                <p class="text-muted mb-0">点击"测试校验"按钮开始测试...</p>
                            </div>
                        </div>

                        <!-- 控制台日志 -->
                        <div class="mt-4">
                            <h5>控制台日志</h5>
                            <div id="console-log" class="border rounded p-3 bg-dark text-light" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                                <div class="text-success">等待日志输出...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 禁用校验脚本 -->
    <script src="static/js/disable-validation.js"></script>

    <!-- 测试脚本 -->
    <script>
        // 重写console.log来显示在页面上
        const originalConsoleLog = console.log;
        const consoleLogDiv = document.getElementById('console-log');
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
            ).join(' ');
            
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            if (message.includes('✅')) {
                logEntry.className = 'text-success';
            } else if (message.includes('❌')) {
                logEntry.className = 'text-danger';
            } else if (message.includes('🚫')) {
                logEntry.className = 'text-warning';
            } else {
                logEntry.className = 'text-light';
            }
            
            consoleLogDiv.appendChild(logEntry);
            consoleLogDiv.scrollTop = consoleLogDiv.scrollHeight;
        };

        function testValidation() {
            const resultsDiv = document.getElementById('test-results');
            const results = [];
            
            console.log('🧪 开始测试前端校验禁用状态...');
            
            // 1. 测试HTML5属性是否被移除
            console.log('📋 测试1: 检查HTML5校验属性...');
            
            const form = document.getElementById('test-form');
            const hasNoValidate = form.hasAttribute('novalidate') || form.noValidate;
            
            if (hasNoValidate) {
                results.push('✅ 表单novalidate属性已设置');
                console.log('✅ 表单novalidate属性已设置');
            } else {
                results.push('❌ 表单novalidate属性未设置');
                console.log('❌ 表单novalidate属性未设置');
            }
            
            // 检查required属性
            const requiredFields = form.querySelectorAll('[required]');
            if (requiredFields.length === 0) {
                results.push('✅ 所有required属性已移除');
                console.log('✅ 所有required属性已移除');
            } else {
                results.push(`❌ 仍有${requiredFields.length}个字段有required属性`);
                console.log(`❌ 仍有${requiredFields.length}个字段有required属性`);
            }
            
            // 2. 测试校验状态类
            console.log('📋 测试2: 检查校验状态类...');
            
            const invalidFields = form.querySelectorAll('.is-invalid');
            const validFields = form.querySelectorAll('.is-valid');
            
            if (invalidFields.length === 0 && validFields.length === 0) {
                results.push('✅ 没有校验状态类');
                console.log('✅ 没有校验状态类');
            } else {
                results.push(`❌ 发现${invalidFields.length}个is-invalid和${validFields.length}个is-valid类`);
                console.log(`❌ 发现${invalidFields.length}个is-invalid和${validFields.length}个is-valid类`);
            }
            
            // 3. 测试JavaScript校验器
            console.log('📋 测试3: 检查JavaScript校验器...');
            
            if (window.SimpleFormValidator) {
                const validator = new window.SimpleFormValidator('test-form');
                const fieldResult = validator.validateField('stock-code', '');
                const formResult = validator.validateForm();
                
                if (fieldResult === true && formResult === true) {
                    results.push('✅ SimpleFormValidator已被禁用');
                    console.log('✅ SimpleFormValidator已被禁用');
                } else {
                    results.push('❌ SimpleFormValidator仍在工作');
                    console.log('❌ SimpleFormValidator仍在工作');
                }
            } else {
                results.push('ℹ️ SimpleFormValidator未加载');
                console.log('ℹ️ SimpleFormValidator未加载');
            }
            
            // 4. 测试表单提交
            console.log('📋 测试4: 测试表单提交...');
            
            try {
                // 模拟表单提交事件
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                const prevented = !form.dispatchEvent(submitEvent);
                
                if (!prevented) {
                    results.push('✅ 表单提交不会被校验阻止');
                    console.log('✅ 表单提交不会被校验阻止');
                } else {
                    results.push('❌ 表单提交被阻止');
                    console.log('❌ 表单提交被阻止');
                }
            } catch (error) {
                results.push('❌ 表单提交测试出错: ' + error.message);
                console.log('❌ 表单提交测试出错: ' + error.message);
            }
            
            // 5. 测试输入事件
            console.log('📋 测试5: 测试输入事件校验...');
            
            const stockCodeField = document.getElementById('stock-code');
            stockCodeField.value = ''; // 设置为空值
            
            // 触发input事件
            const inputEvent = new Event('input', { bubbles: true });
            stockCodeField.dispatchEvent(inputEvent);
            
            // 触发blur事件
            const blurEvent = new Event('blur', { bubbles: true });
            stockCodeField.dispatchEvent(blurEvent);
            
            setTimeout(() => {
                const hasInvalidClass = stockCodeField.classList.contains('is-invalid');
                if (!hasInvalidClass) {
                    results.push('✅ 输入事件不会触发校验');
                    console.log('✅ 输入事件不会触发校验');
                } else {
                    results.push('❌ 输入事件仍会触发校验');
                    console.log('❌ 输入事件仍会触发校验');
                }
                
                // 显示最终结果
                displayResults(results);
            }, 100);
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('test-results');
            const successCount = results.filter(r => r.startsWith('✅')).length;
            const failCount = results.filter(r => r.startsWith('❌')).length;
            
            let html = `
                <div class="mb-3">
                    <h6>测试摘要</h6>
                    <div class="d-flex gap-3">
                        <span class="badge bg-success">通���: ${successCount}</span>
                        <span class="badge bg-danger">失败: ${failCount}</span>
                        <span class="badge bg-info">总计: ${results.length}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>详细结果</h6>
                    <ul class="list-unstyled mb-0">
            `;
            
            results.forEach(result => {
                html += `<li class="mb-1">${result}</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
            
            if (failCount === 0) {
                html += `
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>恭喜！</strong> 前端校验已成功禁用，不会再出现红框问题。
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>注意：</strong> 部分校验可能仍在工作，请检查上述失败项。
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            console.log(`🎯 测试完成: ${successCount}个通过, ${failCount}个失败`);
        }

        // 表单提交处理
        document.getElementById('test-form').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('📝 表单提交被拦截（这是正常的测试行为）');
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            console.log('📊 表单数据:', data);
            
            alert('表单提交测试成功！校验没有阻止提交。');
        });

        // 页面加载完成后自动运行一次测试
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('🚀 页面加载完成，自动运行测试...');
                testValidation();
            }, 2000);
        });
    </script>
</body>
</html>