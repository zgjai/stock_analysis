<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å¤æäº¤ä¿®å¤æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-shield-check"></i> é‡å¤æäº¤ä¿®å¤æµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6>æµ‹è¯•è¯´æ˜ï¼š</h6>
                            <ul>
                                <li>å¿«é€Ÿè¿ç»­ç‚¹å‡»"æµ‹è¯•æäº¤"æŒ‰é’®</li>
                                <li>è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼Œåº”è¯¥åªæœ‰ä¸€ä¸ªè¯·æ±‚è¢«å‘é€</li>
                                <li>å…¶ä»–é‡å¤ç‚¹å‡»åº”è¯¥è¢«é˜»æ­¢</li>
                                <li>2ç§’å†·å´æ—¶é—´åæ‰èƒ½å†æ¬¡æäº¤</li>
                            </ul>
                        </div>

                        <form id="test-form">
                            <div class="mb-3">
                                <label for="stock-code" class="form-label">è‚¡ç¥¨ä»£ç </label>
                                <input type="text" class="form-control" id="stock-code" value="002460" required>
                            </div>
                            <div class="mb-3">
                                <label for="stock-name" class="form-label">è‚¡ç¥¨åç§°</label>
                                <input type="text" class="form-control" id="stock-name" value="èµ£é”‹é”‚ä¸š" required>
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">ä»·æ ¼</label>
                                <input type="number" class="form-control" id="price" value="39.6" step="0.01" required>
                            </div>
                            <div class="mb-3">
                                <label for="quantity" class="form-label">æ•°é‡</label>
                                <input type="number" class="form-control" id="quantity" value="7600" required>
                            </div>
                            
                            <button type="button" class="btn btn-primary" id="submit-btn">
                                <span class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                æµ‹è¯•æäº¤
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6>æµ‹è¯•æ—¥å¿—</h6>
                    </div>
                    <div class="card-body">
                        <div id="log-container" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é˜²é‡å¤æäº¤çŠ¶æ€ç®¡ç†ï¼ˆä»ä¿®å¤åçš„ä»£ç å¤åˆ¶ï¼‰
        let isSubmitting = false;
        let lastSubmitTime = 0;
        const SUBMIT_COOLDOWN = 2000; // 2ç§’å†·å´æ—¶é—´

        // é‡ç½®æäº¤çŠ¶æ€
        function resetSubmissionState() {
            isSubmitting = false;
            log('ğŸ”„ æäº¤çŠ¶æ€å·²é‡ç½®', 'info');
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æäº¤
        function canSubmit() {
            const now = Date.now();
            if (isSubmitting) {
                log('ğŸ›¡ï¸ æ­£åœ¨æäº¤ä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚', 'warning');
                return false;
            }
            if (now - lastSubmitTime < SUBMIT_COOLDOWN) {
                log('ğŸ›¡ï¸ æäº¤è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•', 'warning');
                return false;
            }
            return true;
        }

        // è®¾ç½®æäº¤çŠ¶æ€
        function setSubmitting(state) {
            isSubmitting = state;
            if (state) {
                lastSubmitTime = Date.now();
                log('ğŸ”’ è®¾ç½®æäº¤çŠ¶æ€ä¸ºï¼šæ­£åœ¨æäº¤', 'info');
            } else {
                log('ğŸ”“ è®¾ç½®æäº¤çŠ¶æ€ä¸ºï¼šå¯ä»¥æäº¤', 'info');
            }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#007bff',
                success: '#28a745',
                warning: '#ffc107',
                error: '#dc3545'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.style.marginBottom = '2px';
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }

        // æ¨¡æ‹Ÿæäº¤å‡½æ•°
        async function testSubmit() {
            // é˜²é‡å¤æäº¤æ£€æŸ¥
            if (!canSubmit()) {
                return;
            }
            
            // è®¾ç½®æäº¤çŠ¶æ€
            setSubmitting(true);
            
            const submitBtn = document.getElementById('submit-btn');
            const spinner = submitBtn.querySelector('.spinner-border');
            
            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.disabled = true;
                spinner.style.display = 'inline-block';
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>æäº¤ä¸­...';
                
                log('ğŸ“¤ å¼€å§‹å‘é€è¯·æ±‚...', 'info');
                
                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = {
                    stock_code: document.getElementById('stock-code').value,
                    stock_name: document.getElementById('stock-name').value,
                    trade_type: 'buy',
                    trade_date: new Date().toISOString().slice(0, 16),
                    price: parseFloat(document.getElementById('price').value),
                    quantity: parseInt(document.getElementById('quantity').value),
                    reason: 'æµ‹è¯•æäº¤',
                    stop_loss_price: 37.95,
                    take_profit_ratio: 1,
                    sell_ratio: 0.1,
                    use_batch_profit_taking: false
                };
                
                log('ğŸ“‹ è¯·æ±‚æ•°æ®: ' + JSON.stringify(formData), 'info');
                
                // å‘é€è¯·æ±‚
                const response = await axios.post('/api/trades', formData, {
                    headers: { 'Content-Type': 'application/json' },
                    timeout: 10000
                });
                
                if (response.data.success) {
                    log('âœ… æäº¤æˆåŠŸï¼äº¤æ˜“ID: ' + response.data.data.id, 'success');
                } else {
                    log('âŒ æäº¤å¤±è´¥: ' + response.data.error?.message, 'error');
                }
                
            } catch (error) {
                log('âŒ è¯·æ±‚é”™è¯¯: ' + error.message, 'error');
            } finally {
                // é‡ç½®æŒ‰é’®çŠ¶æ€å’Œæäº¤çŠ¶æ€
                setSubmitting(false);
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                submitBtn.innerHTML = 'æµ‹è¯•æäº¤';
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.addEventListener('click', testSubmit);
            
            // è¡¨å•æäº¤é˜²æŠ¤
            const form = document.getElementById('test-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!canSubmit()) {
                    return false;
                }
                return false;
            });
            
            log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
        });

        // é¡µé¢å¸è½½æ—¶é‡ç½®çŠ¶æ€
        window.addEventListener('beforeunload', function() {
            resetSubmissionState();
        });
    </script>
</body>
</html>