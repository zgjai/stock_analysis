<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字段验证测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>字段验证测试</h2>
        
        <form id="trade-form" novalidate>
            <!-- 交易类型 -->
            <div class="mb-3">
                <label for="trade-type" class="form-label">交易类型</label>
                <select class="form-select" id="trade-type" name="trade_type">
                    <option value="">请选择交易类型</option>
                    <option value="buy" selected>买入</option>
                    <option value="sell">卖出</option>
                </select>
            </div>

            <!-- 股票代码 -->
            <div class="mb-3">
                <label for="stock-code" class="form-label">股票代码</label>
                <input type="text" class="form-control" id="stock-code" name="stock_code" value="000776">
            </div>

            <!-- 股票名称 -->
            <div class="mb-3">
                <label for="stock-name" class="form-label">股票名称</label>
                <input type="text" class="form-control" id="stock-name" name="stock_name" value="广发证券">
            </div>

            <!-- 交易日期 -->
            <div class="mb-3">
                <label for="trade-date" class="form-label">交易日期</label>
                <input type="datetime-local" class="form-control" id="trade-date" name="trade_date" value="2025-08-04T18:01">
            </div>

            <!-- 价格 -->
            <div class="mb-3">
                <label for="price" class="form-label">价格</label>
                <input type="number" class="form-control" id="price" name="price" step="0.001" value="19.453">
            </div>

            <!-- 数量 -->
            <div class="mb-3">
                <label for="quantity" class="form-label">数量</label>
                <input type="number" class="form-control" id="quantity" name="quantity" value="31100">
            </div>

            <!-- 操作原因 -->
            <div class="mb-3">
                <label for="reason" class="form-label">操作原因</label>
                <select class="form-select" id="reason" name="reason">
                    <option value="">请选择操作原因</option>
                    <option value="技术分析" selected>技术分析</option>
                    <option value="基本面分析">基本面分析</option>
                </select>
            </div>

            <button type="button" class="btn btn-primary" onclick="testValidation()">测试验证</button>
            <button type="button" class="btn btn-secondary" onclick="clearValidation()">清除验证状态</button>
        </form>

        <div id="test-results" class="mt-4"></div>
    </div>

    <script src="static/js/utils.js"></script>
    <script src="static/js/simple-form-validator.js"></script>
    
    <script>
        let validator;

        document.addEventListener('DOMContentLoaded', function() {
            validator = new SimpleFormValidator('trade-form');
            
            // 模拟实时验证
            const fieldsToValidate = ['stock-code', 'stock-name', 'trade-date', 'price', 'quantity', 'reason'];
            
            fieldsToValidate.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', () => {
                        validator.validateField(fieldId);
                    });

                    field.addEventListener('input', () => {
                        // 清除之前的验证状态
                        validator.clearFieldError(field);
                        
                        clearTimeout(field.validationTimer);
                        field.validationTimer = setTimeout(() => {
                            if (field.value && field.value.trim() !== '') {
                                validator.validateField(fieldId);
                            }
                        }, 1000);
                    });
                }
            });
        });

        function testValidation() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h4>验证测试结果：</h4>';

            try {
                const isValid = validator.validateForm();
                results.innerHTML += `<p><strong>验证结果：</strong> ${isValid ? '✅ 通过' : '❌ 失败'}</p>`;
                
                if (!isValid) {
                    results.innerHTML += '<p><strong>错误信息：</strong></p><ul>';
                    Object.entries(validator.errors).forEach(([field, message]) => {
                        results.innerHTML += `<li>${field}: ${message}</li>`;
                    });
                    results.innerHTML += '</ul>';
                }

                // 显示表单数据
                const data = validator.getFormData();
                results.innerHTML += '<p><strong>表单数据：</strong></p>';
                results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

                // 测试具体字段
                results.innerHTML += '<h5>具体字段验证：</h5>';
                const testFields = [
                    { id: 'trade-date', value: '2025-08-04T18:01' },
                    { id: 'quantity', value: '31100' },
                    { id: 'price', value: '19.453' }
                ];

                testFields.forEach(field => {
                    const isFieldValid = validator.validateField(field.id, field.value);
                    results.innerHTML += `<p>${field.id}: ${isFieldValid ? '✅' : '❌'} (值: ${field.value})</p>`;
                });

            } catch (error) {
                results.innerHTML += `<p class="text-danger"><strong>错误：</strong> ${error.message}</p>`;
                console.error('验证错误:', error);
            }
        }

        function clearValidation() {
            validator.clearAllValidation();
            document.getElementById('test-results').innerHTML = '<p class="text-success">验证状态已清除</p>';
        }
    </script>
</body>
</html>