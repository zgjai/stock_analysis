# å–å‡ºæ¯”ä¾‹å­—æ®µæ˜ å°„é—®é¢˜ä¿®å¤æ€»ç»“

## ðŸš¨ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä¿å­˜åˆ†æ‰¹æ­¢ç›ˆçš„äº¤æ˜“è®°å½•æ—¶ï¼Œç³»ç»Ÿæç¤º"å–å‡ºæ¯”ä¾‹ä¸èƒ½ä¸ºç©º"ï¼Œä½†å‰ç«¯æ˜Žæ˜Žå·²ç»å¡«å†™äº†å–å‡ºæ¯”ä¾‹å­—æ®µã€‚

## ðŸ” é—®é¢˜æ ¹å› 

é€šè¿‡åˆ†æžè°ƒè¯•ä¿¡æ¯å‘çŽ°ï¼Œé—®é¢˜å‡ºçŽ°åœ¨å‰ç«¯å’ŒåŽç«¯çš„å­—æ®µåä¸åŒ¹é…ï¼š

### å‰ç«¯æ•°æ®æ ¼å¼ï¼ˆJavaScriptï¼‰ï¼š
```javascript
{
    targetPrice: 12.00,
    profitRatio: 20,      // ç™¾åˆ†æ¯”æ ¼å¼
    sellRatio: 50,        // ç™¾åˆ†æ¯”æ ¼å¼
    sequenceOrder: 1
}
```

### åŽç«¯æœŸæœ›æ ¼å¼ï¼ˆPythonï¼‰ï¼š
```python
{
    'target_price': 12.00,
    'profit_ratio': 0.20,    # å°æ•°æ ¼å¼
    'sell_ratio': 0.50,      # å°æ•°æ ¼å¼
    'sequence_order': 1
}
```

### é—®é¢˜ç‚¹ï¼š
1. **å­—æ®µåä¸åŒ¹é…**ï¼š`sellRatio` vs `sell_ratio`
2. **æ•°å€¼æ ¼å¼ä¸åŒ¹é…**ï¼šç™¾åˆ†æ¯” vs å°æ•°
3. **åŽç«¯éªŒè¯é€»è¾‘åªæŸ¥æ‰¾ä¸‹åˆ’çº¿æ ¼å¼çš„å­—æ®µå**

## ðŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. åŽç«¯å…¼å®¹æ€§ä¿®å¤

ä¿®æ”¹ `services/profit_taking_service.py` ä¸­çš„éªŒè¯é€»è¾‘ï¼Œæ”¯æŒå¤šç§å­—æ®µåæ ¼å¼ï¼š

**ä¿®å¤å‰ï¼š**
```python
if 'sell_ratio' not in target or target['sell_ratio'] is None:
    target_errors['sell_ratio'] = "å–å‡ºæ¯”ä¾‹ä¸èƒ½ä¸ºç©º"
else:
    sell_ratio = Decimal(str(target['sell_ratio']))
```

**ä¿®å¤åŽï¼š**
```python
# æ”¯æŒå¤šç§å­—æ®µå
sell_ratio_value = target.get('sell_ratio') or target.get('sellRatio')
if sell_ratio_value is None or sell_ratio_value == '':
    target_errors['sell_ratio'] = "å–å‡ºæ¯”ä¾‹ä¸èƒ½ä¸ºç©º"
else:
    sell_ratio = Decimal(str(sell_ratio_value))
```

### 2. å‰ç«¯æ•°æ®è½¬æ¢ä¿®å¤

ä¿®æ”¹ `templates/trading_records.html` ä¸­çš„æ•°æ®å¤„ç†é€»è¾‘ï¼Œç¡®ä¿å‘é€æ­£ç¡®æ ¼å¼çš„æ•°æ®ï¼š

**ä¿®å¤å‰ï¼š**
```javascript
const profitTargets = this.profitTargetsManager.getTargets();
formData.profit_targets = profitTargets;
```

**ä¿®å¤åŽï¼š**
```javascript
const profitTargets = this.profitTargetsManager.getTargets();

// è½¬æ¢å­—æ®µåä»¥åŒ¹é…åŽç«¯æœŸæœ›çš„æ ¼å¼
const convertedTargets = profitTargets.map(target => ({
    target_price: target.targetPrice,
    profit_ratio: target.profitRatio / 100, // è½¬æ¢ä¸ºå°æ•°
    sell_ratio: target.sellRatio / 100,     // è½¬æ¢ä¸ºå°æ•°
    sequence_order: target.sequenceOrder
}));

formData.profit_targets = convertedTargets;
```

### 3. æ•°æ®éªŒè¯æ–¹æ³•ä¿®å¤

æ›´æ–°éªŒè¯æ–¹æ³•ä»¥æ”¯æŒä¸¤ç§æ•°æ®æ ¼å¼ï¼š

```javascript
validateProfitTargetsData(profitTargets) {
    return profitTargets.every(target => {
        // æ”¯æŒä¸¤ç§å­—æ®µåæ ¼å¼
        const targetPrice = target.target_price || target.targetPrice;
        const sellRatio = target.sell_ratio || target.sellRatio;
        
        return targetPrice > 0 && 
               sellRatio > 0 && 
               sellRatio <= (target.sell_ratio ? 1 : 100); // å°æ•°æ ¼å¼ä¸º1ï¼Œç™¾åˆ†æ¯”æ ¼å¼ä¸º100
    });
}
```

## ðŸ“ ä¿®å¤æ–‡ä»¶åˆ—è¡¨

### åŽç«¯æ–‡ä»¶
- **services/profit_taking_service.py** - å¢žåŠ å­—æ®µåå…¼å®¹æ€§æ”¯æŒ

### å‰ç«¯æ–‡ä»¶
- **templates/trading_records.html** - ä¿®å¤æ•°æ®è½¬æ¢é€»è¾‘

### æµ‹è¯•æ–‡ä»¶
- **field_mapping_test.html** - æ–°å¢žå­—æ®µæ˜ å°„æµ‹è¯•é¡µé¢
- **fix_sell_ratio_field_mapping.py** - ä¿®å¤è„šæœ¬

## ðŸ§ª æµ‹è¯•éªŒè¯

### 1. ä½¿ç”¨æµ‹è¯•é¡µé¢
è®¿é—® `field_mapping_test.html` è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š
- å‰ç«¯æ ¼å¼æ•°æ®éªŒè¯
- åŽç«¯æ ¼å¼æ•°æ®è½¬æ¢
- APIè°ƒç”¨æµ‹è¯•

### 2. å®žé™…åŠŸèƒ½æµ‹è¯•
1. åˆ·æ–°äº¤æ˜“è®°å½•é¡µé¢
2. æ·»åŠ ä¹°å…¥äº¤æ˜“è®°å½•
3. å¯ç”¨åˆ†æ‰¹æ­¢ç›ˆåŠŸèƒ½
4. è®¾ç½®å¤šä¸ªæ­¢ç›ˆç›®æ ‡
5. ä¿å­˜è®°å½•ï¼ŒéªŒè¯æ˜¯å¦æˆåŠŸ

### 3. è°ƒè¯•éªŒè¯
åœ¨æµè§ˆå™¨æŽ§åˆ¶å°æŸ¥çœ‹ï¼š
- `[DEBUG]` æ ‡è®°çš„æ•°æ®ä¼ é€’æ—¥å¿—
- åˆ†æ‰¹æ­¢ç›ˆæ•°æ®çš„å­—æ®µåå’Œæ ¼å¼
- APIè¯·æ±‚å’Œå“åº”æ•°æ®

## ðŸŽ¯ ä¿®å¤æ•ˆæžœ

ä¿®å¤åŽåº”è¯¥è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. âœ… **å–å‡ºæ¯”ä¾‹ä¸å†æç¤ºä¸ºç©º** - åŽç«¯èƒ½æ­£ç¡®è¯†åˆ«å‰ç«¯ä¼ é€’çš„å­—æ®µ
2. âœ… **æ”¯æŒå¤šç§å­—æ®µåæ ¼å¼** - å…¼å®¹é©¼å³°å’Œä¸‹åˆ’çº¿å‘½å
3. âœ… **è‡ªåŠ¨æ•°æ®æ ¼å¼è½¬æ¢** - ç™¾åˆ†æ¯”è‡ªåŠ¨è½¬æ¢ä¸ºå°æ•°
4. âœ… **å‘åŽå…¼å®¹æ€§** - ä¸å½±å“çŽ°æœ‰åŠŸèƒ½
5. âœ… **è¯¦ç»†çš„æµ‹è¯•å·¥å…·** - ä¾¿äºŽæŽ’æŸ¥é—®é¢˜

## ðŸ”§ ä½¿ç”¨æŒ‡å—

### æ­£å¸¸ä½¿ç”¨
1. åˆ·æ–°äº¤æ˜“è®°å½•é¡µé¢
2. æ·»åŠ ä¹°å…¥äº¤æ˜“è®°å½•
3. å¯ç”¨"åˆ†æ‰¹æ­¢ç›ˆ"å¼€å…³
4. è®¾ç½®æ­¢ç›ˆç›®æ ‡ï¼ˆä»·æ ¼å’Œå–å‡ºæ¯”ä¾‹ï¼‰
5. ç‚¹å‡»ä¿å­˜ï¼Œç³»ç»Ÿåº”è¯¥èƒ½æ­£å¸¸ä¿å­˜

### é—®é¢˜æŽ’æŸ¥
å¦‚æžœä»ç„¶é‡åˆ°é—®é¢˜ï¼š

1. **æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å°**
   - æŸ¥æ‰¾ `[DEBUG]` æ—¥å¿—
   - æŸ¥çœ‹æ•°æ®ä¼ é€’è¿‡ç¨‹

2. **ä½¿ç”¨æµ‹è¯•é¡µé¢**
   - è®¿é—® `field_mapping_test.html`
   - æµ‹è¯•å­—æ®µæ˜ å°„æ˜¯å¦æ­£ç¡®

3. **éªŒè¯æ•°æ®æ ¼å¼**
   ```javascript
   // åœ¨æŽ§åˆ¶å°è¿è¡Œ
   debugTradeForm()
   ```

## ðŸ“Š æŠ€æœ¯æ”¹è¿›

### ä¼˜ç‚¹
1. **å…¼å®¹æ€§å¼º** - æ”¯æŒå¤šç§å­—æ®µåæ ¼å¼
2. **è‡ªåŠ¨è½¬æ¢** - å‰ç«¯æ•°æ®è‡ªåŠ¨è½¬æ¢ä¸ºåŽç«¯æ ¼å¼
3. **å‘åŽå…¼å®¹** - ä¸ç ´åçŽ°æœ‰åŠŸèƒ½
4. **æ˜“äºŽè°ƒè¯•** - æä¾›è¯¦ç»†çš„æµ‹è¯•å·¥å…·

### æ³¨æ„äº‹é¡¹
1. **æ•°æ®å†—ä½™** - ä¸ºäº†å…¼å®¹æ€§ï¼Œä»£ç ä¸­æœ‰ä¸€äº›å†—ä½™å¤„ç†
2. **æ ¼å¼è½¬æ¢** - éœ€è¦æ³¨æ„ç™¾åˆ†æ¯”å’Œå°æ•°çš„è½¬æ¢
3. **å­—æ®µæ˜ å°„** - éœ€è¦ä¿æŒå‰åŽç«¯å­—æ®µæ˜ å°„çš„ä¸€è‡´æ€§

## ðŸš€ åŽç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€æ•°æ®æ ¼å¼** - è€ƒè™‘åœ¨å‰åŽç«¯ä½¿ç”¨ç»Ÿä¸€çš„å­—æ®µå‘½åè§„èŒƒ
2. **ç±»åž‹å®šä¹‰** - æ·»åŠ TypeScriptç±»åž‹å®šä¹‰ç¡®ä¿æ•°æ®æ ¼å¼ä¸€è‡´æ€§
3. **è‡ªåŠ¨åŒ–æµ‹è¯•** - æ·»åŠ å­—æ®µæ˜ å°„çš„è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹
4. **æ–‡æ¡£å®Œå–„** - å®Œå–„APIæ–‡æ¡£ä¸­çš„æ•°æ®æ ¼å¼è¯´æ˜Ž

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025å¹´1æœˆ19æ—¥  
**ä¿®å¤çŠ¶æ€**ï¼šå·²å®Œæˆï¼Œå¾…ç”¨æˆ·éªŒè¯  
**ä¼˜å…ˆçº§**ï¼šé«˜ï¼ˆå½±å“åˆ†æ‰¹æ­¢ç›ˆåŠŸèƒ½ï¼‰  
**æµ‹è¯•çŠ¶æ€**ï¼šå·²æä¾›æµ‹è¯•é¡µé¢å’Œè°ƒè¯•å·¥å…·