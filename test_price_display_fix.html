<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复盘价格显示修复测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>复盘价格显示修复测试</h2>
        
        <div class="alert alert-info">
            <h5>测试目标：</h5>
            <ul>
                <li>验证持仓列表中能正确显示当前价和买入价</li>
                <li>验证复盘模态框中的浮盈计算功能</li>
                <li>验证价格数据的获取和显示逻辑</li>
            </ul>
        </div>

        <!-- 测试持仓API -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>1. 测试持仓API数据结构</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="testHoldingsAPI()">测试持仓API</button>
                <div id="holdings-api-result" class="mt-3"></div>
            </div>
        </div>

        <!-- 测试价格服务 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>2. 测试价格服务</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="test-stock-code" placeholder="输入股票代码，如：000776">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-success" onclick="testPriceService()">获取股票价格</button>
                    </div>
                </div>
                <div id="price-service-result" class="mt-3"></div>
            </div>
        </div>

        <!-- 测试浮盈计算 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>3. 测试浮盈计算</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">股票代码</label>
                        <input type="text" class="form-control" id="calc-stock-code" value="000776">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">买入价</label>
                        <input type="number" class="form-control" id="calc-buy-price" value="10.50" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">当前价</label>
                        <input type="number" class="form-control" id="calc-current-price" value="11.20" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning mt-4" onclick="testFloatingProfitCalc()">计算浮盈</button>
                    </div>
                </div>
                <div id="floating-profit-result" class="mt-3"></div>
            </div>
        </div>

        <!-- 模拟持仓显示 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>4. 模拟持仓显示效果</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="simulateHoldingDisplay()">模拟持仓显示</button>
                <div id="simulated-holdings" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 测试持仓API
        async function testHoldingsAPI() {
            const resultDiv = document.getElementById('holdings-api-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>正在测试...';
            
            try {
                const response = await fetch('/api/holdings');
                const data = await response.json();
                
                if (data.success) {
                    let html = '<div class="alert alert-success">✅ 持仓API调用成功</div>';
                    html += '<h6>数据结构：</h6>';
                    html += '<pre class="bg-light p-3">' + JSON.stringify(data.data, null, 2) + '</pre>';
                    
                    // 检查关键字段
                    if (data.data && data.data.length > 0) {
                        const holding = data.data[0];
                        html += '<h6>字段检查：</h6><ul>';
                        html += `<li>avg_buy_price: ${holding.avg_buy_price ? '✅' : '❌'}</li>`;
                        html += `<li>avg_price: ${holding.avg_price ? '✅' : '❌'}</li>`;
                        html += `<li>current_price: ${holding.current_price ? '✅' : '❌'}</li>`;
                        html += `<li>current_quantity: ${holding.current_quantity ? '✅' : '❌'}</li>`;
                        html += '</ul>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">❌ API调用失败: ' + data.message + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">❌ 请求失败: ' + error.message + '</div>';
            }
        }

        // 测试价格服务
        async function testPriceService() {
            const stockCode = document.getElementById('test-stock-code').value;
            const resultDiv = document.getElementById('price-service-result');
            
            if (!stockCode) {
                resultDiv.innerHTML = '<div class="alert alert-warning">请输入股票代码</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>正在获取价格...';
            
            try {
                const response = await fetch(`/api/prices/${stockCode}/latest`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    let html = '<div class="alert alert-success">✅ 价格获取成功</div>';
                    html += '<div class="row">';
                    html += `<div class="col-md-4"><strong>股票名称:</strong> ${data.data.stock_name}</div>`;
                    html += `<div class="col-md-4"><strong>当前价格:</strong> ¥${data.data.current_price}</div>`;
                    html += `<div class="col-md-4"><strong>涨跌幅:</strong> ${data.data.change_percent}%</div>`;
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    // 尝试刷新价格
                    const refreshResponse = await fetch('/api/prices/refresh', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ stock_codes: [stockCode] })
                    });
                    const refreshData = await refreshResponse.json();
                    
                    if (refreshData.success_count > 0) {
                        resultDiv.innerHTML = '<div class="alert alert-success">✅ 价格刷新成功，请重新获取</div>';
                    } else {
                        resultDiv.innerHTML = '<div class="alert alert-danger">❌ 无法获取价格数据</div>';
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">❌ 请求失败: ' + error.message + '</div>';
            }
        }

        // 测试浮盈计算
        async function testFloatingProfitCalc() {
            const stockCode = document.getElementById('calc-stock-code').value;
            const buyPrice = parseFloat(document.getElementById('calc-buy-price').value);
            const currentPrice = parseFloat(document.getElementById('calc-current-price').value);
            const resultDiv = document.getElementById('floating-profit-result');
            
            if (!stockCode || !buyPrice || !currentPrice) {
                resultDiv.innerHTML = '<div class="alert alert-warning">请填写完整信息</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>正在计算...';
            
            try {
                const response = await fetch('/api/reviews/calculate-floating-profit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stock_code: stockCode,
                        current_price: currentPrice
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    const profitRatio = ((currentPrice - buyPrice) / buyPrice * 100).toFixed(2);
                    const profitAmount = (currentPrice - buyPrice).toFixed(2);
                    
                    let html = '<div class="alert alert-success">✅ 浮盈计算成功</div>';
                    html += '<div class="row">';
                    html += `<div class="col-md-3"><strong>买入价:</strong> ¥${buyPrice.toFixed(2)}</div>`;
                    html += `<div class="col-md-3"><strong>当前价:</strong> ¥${currentPrice.toFixed(2)}</div>`;
                    html += `<div class="col-md-3"><strong>浮盈比例:</strong> ${profitRatio}%</div>`;
                    html += `<div class="col-md-3"><strong>每股盈亏:</strong> ¥${profitAmount}</div>`;
                    html += '</div>';
                    
                    if (data.data) {
                        html += '<h6>API返回数据：</h6>';
                        html += '<pre class="bg-light p-3">' + JSON.stringify(data.data, null, 2) + '</pre>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">❌ 计算失败: ' + data.message + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">❌ 请求失败: ' + error.message + '</div>';
            }
        }

        // 模拟持仓显示
        function simulateHoldingDisplay() {
            const resultDiv = document.getElementById('simulated-holdings');
            
            // 模拟持仓数据
            const mockHolding = {
                stock_code: '000776',
                stock_name: '广发证券',
                current_quantity: 500,
                avg_buy_price: 10.50,
                current_price: 11.20,
                holding_days: 15
            };
            
            const profitRatio = ((mockHolding.current_price - mockHolding.avg_buy_price) / mockHolding.avg_buy_price * 100).toFixed(2);
            const profitClass = profitRatio > 0 ? 'text-danger' : profitRatio < 0 ? 'text-success' : 'text-muted';
            
            let html = '<div class="card">';
            html += '<div class="card-body">';
            html += '<div class="row align-items-center">';
            html += '<div class="col-md-2">';
            html += `<div class="fw-bold">${mockHolding.stock_code}</div>`;
            html += `<div class="text-muted small">${mockHolding.stock_name}</div>`;
            html += '</div>';
            html += '<div class="col-md-2">';
            html += '<div class="small text-muted">成本价</div>';
            html += `<div class="fw-bold">¥${mockHolding.avg_buy_price.toFixed(2)}</div>`;
            html += '</div>';
            html += '<div class="col-md-2">';
            html += '<div class="small text-muted">当前价</div>';
            html += `<div class="fw-bold">¥${mockHolding.current_price.toFixed(2)}</div>`;
            html += '</div>';
            html += '<div class="col-md-2">';
            html += '<div class="small text-muted">持仓量</div>';
            html += `<div class="fw-bold">${mockHolding.current_quantity}</div>`;
            html += '</div>';
            html += '<div class="col-md-2">';
            html += '<div class="small text-muted">浮盈比例</div>';
            html += `<div class="fw-bold ${profitClass}">${profitRatio}%</div>`;
            html += '</div>';
            html += '<div class="col-md-2">';
            html += '<div class="small text-muted">持仓天数</div>';
            html += `<div class="fw-bold">${mockHolding.holding_days}天</div>`;
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }

        // 页面加载时自动测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('价格显示修复测试页面已加载');
        });
    </script>
</body>
</html>