# æˆæœ¬ä»·å’Œå½“å‰ä»·æ˜¾ç¤ºä¿®å¤éªŒè¯

## é—®é¢˜å›é¡¾
ç”¨æˆ·åé¦ˆï¼šå¤ç›˜é¡µé¢çš„æŒä»“ä¸­æ— æ³•å±•ç¤ºå‡ºå½“å‰ä»·å’Œä¹°å…¥ä»·ï¼ˆæˆæœ¬ä»·ï¼‰

## ä¿®å¤å†…å®¹

### 1. åç«¯æ•°æ®ä¿®å¤ (services/review_service.py)
- âœ… ä¿®å¤å¹³å‡ä¹°å…¥ä»·è®¡ç®—ï¼šä»ç®€å•å¹³å‡æ”¹ä¸ºåŠ æƒå¹³å‡
- âœ… æ·»åŠ å½“å‰ä»·æ ¼è·å–é€»è¾‘ï¼Œé›†æˆAKShareä»·æ ¼æœåŠ¡
- âœ… å®Œå–„æŒä»“æ•°æ®ç»“æ„ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ

### 2. å‰ç«¯æ˜¾ç¤ºä¿®å¤ (templates/review.html)
- âœ… ä¿®å¤å­—æ®µåé”™è¯¯ï¼š`holding.buy_price` â†’ `holding.avg_buy_price`
- âœ… æ·»åŠ æµ®ç›ˆæ¯”ä¾‹è®¡ç®—å‡½æ•°
- âœ… å®Œå–„ä»·æ ¼æ˜¾ç¤ºé€»è¾‘

### 3. JavaScriptä¿®å¤ (static/js/review-emergency-fix.js)
- âœ… ç»Ÿä¸€å­—æ®µåä½¿ç”¨
- âœ… æ·»åŠ å½“å‰ä»·æ ¼æ˜¾ç¤ºåˆ—
- âœ… ä¿®å¤æŒä»“é‡å­—æ®µå¼•ç”¨

## ä¿®å¤éªŒè¯

### APIæ•°æ®ç»“æ„éªŒè¯
```
APIè¿”å›çš„æŒä»“æ•°æ®å­—æ®µ:
  avg_buy_price: 19.45 (float)     âœ… æˆæœ¬ä»·å­—æ®µæ­£ç¡®
  avg_price: 19.45 (float)         âœ… å…¼å®¹å­—æ®µæ­£ç¡®
  current_price: 21.01 (float)     âœ… å½“å‰ä»·å­—æ®µæ­£ç¡®
  current_quantity: 31100 (int)    âœ… æŒä»“é‡å­—æ®µæ­£ç¡®
  stock_code: 000776 (str)         âœ… è‚¡ç¥¨ä»£ç æ­£ç¡®
  stock_name: å¹¿å‘è¯åˆ¸ (str)        âœ… è‚¡ç¥¨åç§°æ­£ç¡®
```

### ä»·æ ¼æ˜¾ç¤ºé€»è¾‘éªŒè¯
```
å‰ç«¯æ˜¾ç¤ºé€»è¾‘æµ‹è¯•:
  æˆæœ¬ä»·: Â¥19.45      âœ… æ­£ç¡®æ˜¾ç¤º
  å½“å‰ä»·: Â¥21.01      âœ… æ­£ç¡®æ˜¾ç¤º
  æµ®ç›ˆæ¯”ä¾‹: 8.02%     âœ… æ­£ç¡®è®¡ç®—
```

### AKShareä»·æ ¼æœåŠ¡éªŒè¯
```
æµ‹è¯•è‚¡ç¥¨: 000776
  âœ… åˆ·æ–°æˆåŠŸ: 21.01 (å¹¿å‘è¯åˆ¸)
```

## ä¿®å¤åçš„æ˜¾ç¤ºæ•ˆæœ

### æŒä»“åˆ—è¡¨æ˜¾ç¤º
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 000776                                                      â”‚
â”‚ å¹¿å‘è¯åˆ¸                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¤
â”‚   æˆæœ¬ä»·    â”‚   å½“å‰ä»·    â”‚   æŒä»“é‡    â”‚   æµ®ç›ˆæ¯”ä¾‹  â”‚æ“ä½œ â”‚
â”‚  Â¥19.45     â”‚  Â¥21.01     â”‚   31100     â”‚   +8.02%    â”‚å¤ç›˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

### å¤ç›˜æ¨¡æ€æ¡†
- âœ… è‡ªåŠ¨å¡«å…¥å½“å‰ä»·æ ¼ï¼šÂ¥21.01
- âœ… æ˜¾ç¤ºæˆæœ¬ä»·ï¼šÂ¥19.45
- âœ… å®æ—¶è®¡ç®—æµ®ç›ˆæ¯”ä¾‹ï¼š8.02%

## æŠ€æœ¯å®ç°è¦ç‚¹

### 1. åŠ æƒå¹³å‡æˆæœ¬ä»·è®¡ç®—
```python
# ä¿®å¤å‰ï¼šç®€å•å¹³å‡ï¼ˆé”™è¯¯ï¼‰
func.avg(TradeRecord.price)

# ä¿®å¤åï¼šåŠ æƒå¹³å‡ï¼ˆæ­£ç¡®ï¼‰
(func.sum(TradeRecord.price * TradeRecord.quantity) / func.sum(TradeRecord.quantity))
```

### 2. AKShareä»·æ ¼é›†æˆ
```python
def _get_current_price(cls, stock_code: str) -> Optional[float]:
    """è·å–è‚¡ç¥¨å½“å‰ä»·æ ¼"""
    price_service = PriceService()
    
    # ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
    price_data = price_service.get_latest_price(stock_code)
    if price_data:
        return float(price_data['current_price'])
    
    # ç¼“å­˜å¤±æ•ˆæ—¶ä»AKShareè·å–
    result = price_service.refresh_stock_price(stock_code)
    if result.get('success'):
        return float(result['data'].get('current_price', 0))
    
    return None
```

### 3. å‰ç«¯å­—æ®µç»Ÿä¸€
```javascript
// æˆæœ¬ä»·æ˜¾ç¤ºé€»è¾‘
Â¥${holding.avg_buy_price ? holding.avg_buy_price.toFixed(2) : 
   (holding.avg_price ? holding.avg_price.toFixed(2) : '--')}

// å½“å‰ä»·æ˜¾ç¤ºé€»è¾‘  
Â¥${holding.current_price ? holding.current_price.toFixed(2) : '--'}

// æµ®ç›ˆæ¯”ä¾‹è®¡ç®—
function calculateProfitRatio(holding) {
    if (!holding.avg_buy_price || !holding.current_price) return '--';
    const ratio = ((holding.current_price - holding.avg_buy_price) / holding.avg_buy_price * 100).toFixed(2);
    return ratio + '%';
}
```

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¿®å¤å‰
- âŒ æˆæœ¬ä»·æ˜¾ç¤º"Â¥--"
- âŒ å½“å‰ä»·æ˜¾ç¤º"Â¥--"  
- âŒ æ— æ³•çœ‹åˆ°æµ®ç›ˆæƒ…å†µ
- âŒ å¤ç›˜æ—¶éœ€æ‰‹åŠ¨è¾“å…¥ä»·æ ¼

### ä¿®å¤å
- âœ… æˆæœ¬ä»·æ­£ç¡®æ˜¾ç¤º"Â¥19.45"
- âœ… å½“å‰ä»·æ­£ç¡®æ˜¾ç¤º"Â¥21.01"
- âœ… æµ®ç›ˆæ¯”ä¾‹æ˜¾ç¤º"+8.02%"
- âœ… å¤ç›˜æ—¶è‡ªåŠ¨å¡«å…¥å½“å‰ä»·æ ¼
- âœ… æ”¯æŒå®æ—¶ä»·æ ¼åˆ·æ–°

## æµ‹è¯•æ–‡ä»¶
1. `test_price_service_integration.py` - åç«¯é›†æˆæµ‹è¯•
2. `debug_price_display.html` - å‰ç«¯è°ƒè¯•é¡µé¢
3. `test_cost_price_display.html` - æˆæœ¬ä»·æ˜¾ç¤ºæµ‹è¯•

## æ€»ç»“
é€šè¿‡æœ¬æ¬¡ä¿®å¤ï¼ŒæˆåŠŸè§£å†³äº†å¤ç›˜é¡µé¢æŒä»“ä¸­æˆæœ¬ä»·å’Œå½“å‰ä»·æ— æ³•æ˜¾ç¤ºçš„é—®é¢˜ï¼š

1. **æ•°æ®å±‚é¢**ï¼šä¿®å¤äº†åŠ æƒå¹³å‡æˆæœ¬ä»·è®¡ç®—ï¼Œé›†æˆAKShareè·å–å®æ—¶ä»·æ ¼
2. **APIå±‚é¢**ï¼šå®Œå–„äº†æŒä»“æ•°æ®ç»“æ„ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„ä»·æ ¼å­—æ®µ
3. **å‰ç«¯å±‚é¢**ï¼šä¿®å¤äº†å­—æ®µåé”™è¯¯ï¼Œç»Ÿä¸€äº†æ˜¾ç¤ºé€»è¾‘
4. **ç”¨æˆ·ä½“éªŒ**ï¼šç°åœ¨å¯ä»¥ç›´è§‚çœ‹åˆ°æ¯åªè‚¡ç¥¨çš„æˆæœ¬ä»·ã€å½“å‰ä»·å’Œæµ®ç›ˆæƒ…å†µ

ç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨å¤ç›˜é¡µé¢çœ‹åˆ°å®Œæ•´çš„ä»·æ ¼ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- âœ… ä¹°å…¥ä»·ï¼ˆæˆæœ¬ä»·ï¼‰ï¼šé€šè¿‡äº¤æ˜“è®°å½•è®¡ç®—çš„åŠ æƒå¹³å‡ä»·æ ¼
- âœ… å½“å‰ä»·ï¼šé€šè¿‡AKShareæ¥å£è·å–çš„å®æ—¶ä»·æ ¼
- âœ… æµ®ç›ˆæ¯”ä¾‹ï¼šè‡ªåŠ¨è®¡ç®—çš„ç›ˆäºç™¾åˆ†æ¯”

é—®é¢˜å·²å®Œå…¨è§£å†³ï¼ğŸ‰