<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试表单验证修复</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>测试表单验证修复</h2>
        
        <div class="alert alert-info">
            <h5>问题描述:</h5>
            <p>编辑交易记录时出现错误: <code>TypeError: Cannot read properties of undefined (reading 'remove')</code></p>
            
            <h5>问题原因:</h5>
            <ul>
                <li><code>validateField('profit_targets')</code> 传入字符串而不是DOM元素</li>
                <li><code>getFieldFeedbackContainer</code> 可能返回 <code>undefined</code></li>
                <li>缺少对字段和容器存在性的检查</li>
            </ul>
            
            <h5>修复方案:</h5>
            <ul>
                <li>添加了对字符串参数的支持，自动查找对应字段</li>
                <li>增加了对字段和容器存在性的检查</li>
                <li>防止在不存在的元素上调用方法</li>
            </ul>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>测试表单</h5>
            </div>
            <div class="card-body">
                <form id="test-form">
                    <div class="mb-3">
                        <label for="test-field" class="form-label">测试字段</label>
                        <input type="text" class="form-control" id="test-field" name="test_field">
                    </div>
                    
                    <div class="mb-3">
                        <label for="test-field-2" class="form-label">测试字段2 (在input-group中)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="test-field-2" name="test_field_2">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </form>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="testValidateByName()">
                        测试通过字段名验证
                    </button>
                    <button type="button" class="btn btn-success" onclick="testValidateByElement()">
                        测试通过元素验证
                    </button>
                    <button type="button" class="btn btn-warning" onclick="testNonExistentField()">
                        测试不存在的字段
                    </button>
                    <button type="button" class="btn btn-danger" onclick="testNullField()">
                        测试空字段
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <h5>测试结果:</h5>
            <div id="test-results" class="alert alert-secondary">
                点击上面的按钮进行测试...
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/form-validation.js"></script>
    
    <script>
        // 初始化表单验证器
        const form = document.getElementById('test-form');
        const validator = new FormValidator(form);
        
        // 添加一些验证规则
        validator.addRule('test_field', {
            validator: (value) => value.length > 0,
            message: '测试字段不能为空'
        });
        
        validator.addRule('test_field_2', {
            validator: (value) => !isNaN(value) && value > 0,
            message: '测试字段2必须是正数'
        });

        function testValidateByName() {
            const results = document.getElementById('test-results');
            results.innerHTML = '测试通过字段名验证...';
            
            try {
                // 这应该能正常工作（修复后）
                const result = validator.validateField('test_field');
                results.innerHTML = `<span class="text-success">✓ 通过字段名验证成功，结果: ${result}</span>`;
            } catch (error) {
                results.innerHTML = `<span class="text-danger">✗ 通过字段名验证失败: ${error.message}</span>`;
            }
        }

        function testValidateByElement() {
            const results = document.getElementById('test-results');
            results.innerHTML = '测试通过元素验证...';
            
            try {
                const field = document.getElementById('test-field');
                const result = validator.validateField(field);
                results.innerHTML = `<span class="text-success">✓ 通过元素验证成功，结果: ${result}</span>`;
            } catch (error) {
                results.innerHTML = `<span class="text-danger">✗ 通过元素验证失败: ${error.message}</span>`;
            }
        }

        function testNonExistentField() {
            const results = document.getElementById('test-results');
            results.innerHTML = '测试不存在的字段...';
            
            try {
                // 这应该返回true并显示警告（修复后）
                const result = validator.validateField('profit_targets');
                results.innerHTML = `<span class="text-success">✓ 不存在字段测试成功，结果: ${result} (应该返回true)</span>`;
            } catch (error) {
                results.innerHTML = `<span class="text-danger">✗ 不存在字段测试失败: ${error.message}</span>`;
            }
        }

        function testNullField() {
            const results = document.getElementById('test-results');
            results.innerHTML = '测试空字段...';
            
            try {
                // 这应该返回true（修复后）
                const result1 = validator.validateField(null);
                const result2 = validator.validateField(undefined);
                results.innerHTML = `<span class="text-success">✓ 空字段测试成功，null: ${result1}, undefined: ${result2}</span>`;
            } catch (error) {
                results.innerHTML = `<span class="text-danger">✗ 空字段测试失败: ${error.message}</span>`;
            }
        }

        // 模拟原始错误场景
        function simulateOriginalError() {
            const results = document.getElementById('test-results');
            results.innerHTML = '模拟原始错误场景...';
            
            try {
                // 模拟 onProfitTargetsChange 中的调用
                if (validator) {
                    validator.validateField('profit_targets');
                }
                results.innerHTML = '<span class="text-success">✓ 原始错误场景测试成功 - 不再报错</span>';
            } catch (error) {
                results.innerHTML = `<span class="text-danger">✗ 原始错误场景仍然失败: ${error.message}</span>`;
            }
        }

        // 自动运行原始错误场景测试
        setTimeout(simulateOriginalError, 1000);
    </script>
</body>
</html>