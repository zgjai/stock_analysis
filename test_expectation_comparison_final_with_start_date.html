<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期望差异功能 - 320万本金起始日期验证</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-success">
                    <h4 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>
                        期望差异功能 - 320万本金起始日期已成功实现！
                    </h4>
                    <p class="mb-0">320万本金从2025年8月1日开始计算的功能已完整实现并通过测试验证。</p>
                </div>
                
                <!-- 功能实现概览 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            320万本金起始日期功能实现
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success">✅ 后端实现</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>设置起始日期常量：2025年8月1日</li>
                                    <li><i class="fas fa-check text-success me-2"></i>交易记录筛选考虑起始日期</li>
                                    <li><i class="fas fa-check text-success me-2"></i>时间范围自动调整到起始日期</li>
                                    <li><i class="fas fa-check text-success me-2"></i>API返回起始日期信息</li>
                                    <li><i class="fas fa-check text-success me-2"></i>DTO类支持起始日期字段</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">✅ 前端实现</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>收益金额卡片显示起始日期</li>
                                    <li><i class="fas fa-check text-success me-2"></i>期望模型说明包含起始日期</li>
                                    <li><i class="fas fa-check text-success me-2"></i>差异分析显示起始日期说明</li>
                                    <li><i class="fas fa-check text-success me-2"></i>时间范围标签显示起始日期</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API测试结果 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-flask me-2"></i>
                            API测试结果
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <button class="btn btn-primary" onclick="testAPI()">
                                    <i class="fas fa-play me-1"></i>测试API
                                </button>
                                <button class="btn btn-success ms-2" onclick="loadExpectationData()">
                                    <i class="fas fa-chart-line me-1"></i>加载期望对比数据
                                </button>
                            </div>
                            <div class="col-12">
                                <div id="api-test-results">
                                    <div class="text-muted">点击"测试API"按钮开始测试...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 期望对比数据展示 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-balance-scale me-2"></i>
                            期望对比数据展示
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="expectation-data-display">
                            <div class="text-muted">点击"加载期望对比数据"按钮查看详细数据...</div>
                        </div>
                    </div>
                </div>

                <!-- 使用指南 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-book me-2"></i>
                            使用指南
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">如何访问期望差异功能</h6>
                                <ol>
                                    <li>访问 <code>http://localhost:5001/analytics</code></li>
                                    <li>点击页面上方的"期望对比"Tab</li>
                                    <li>选择时间范围进行分析</li>
                                    <li>查看期望vs实际的对比结果</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-warning">重要说明</h6>
                                <ul>
                                    <li>320万本金从<strong>2025年8月1日</strong>开始计算</li>
                                    <li>只有此日期及之后的交易记录参与计算</li>
                                    <li>时间范围筛选会自动调整到起始日期</li>
                                    <li>期望收益金额基于320万本金标准化计算</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <a href="/analytics" class="btn btn-success me-2" target="_blank">
                                <i class="fas fa-external-link-alt me-1"></i>
                                打开期望差异功能
                            </a>
                            <a href="/test_expectation_comparison_ui.html" class="btn btn-outline-primary" target="_blank">
                                <i class="fas fa-vial me-1"></i>
                                功能测试页面
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 技术细节 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            技术实现细节
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-info">后端服务</h6>
                                <ul class="list-unstyled small">
                                    <li><code>ExpectationComparisonService</code></li>
                                    <li><code>BASE_CAPITAL_START_DATE = 2025-08-01</code></li>
                                    <li><code>_get_trades_by_time_range()</code></li>
                                    <li><code>_get_time_range_info()</code></li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-info">API端点</h6>
                                <ul class="list-unstyled small">
                                    <li><code>/api/analytics/expectation-comparison</code></li>
                                    <li>参数：<code>time_range</code>, <code>base_capital</code></li>
                                    <li>返回：期望、实际、对比、时间范围信息</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-info">前端组件</h6>
                                <ul class="list-unstyled small">
                                    <li><code>expectation-comparison-manager.js</code></li>
                                    <li><code>templates/analytics.html</code></li>
                                    <li>期望对比Tab界面</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 测试API功能
        async function testAPI() {
            const resultsDiv = document.getElementById('api-test-results');
            
            resultsDiv.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">测试中...</span>
                    </div>
                    <p class="text-muted">正在测试API功能...</p>
                </div>
            `;
            
            const testCases = [
                { time_range: 'all', name: '全部时间' },
                { time_range: '1y', name: '最近1年' },
                { time_range: '90d', name: '最近90天' },
                { time_range: '30d', name: '最近30天' }
            ];
            
            let results = [];
            
            for (const testCase of testCases) {
                try {
                    const response = await fetch(`/api/analytics/expectation-comparison?time_range=${testCase.time_range}&base_capital=3200000`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const timeRange = data.data.time_range;
                        results.push({
                            name: testCase.name,
                            success: true,
                            startDate: timeRange.base_capital_start_date,
                            note: timeRange.base_capital_start_note,
                            rangeName: timeRange.range_name,
                            totalTrades: timeRange.total_trades
                        });
                    } else {
                        results.push({
                            name: testCase.name,
                            success: false,
                            error: data.message
                        });
                    }
                } catch (error) {
                    results.push({
                        name: testCase.name,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            // 显示测试结果
            let html = '<div class="table-responsive"><table class="table table-striped">';
            html += '<thead><tr><th>时间范围</th><th>状态</th><th>起始日期</th><th>说明</th><th>交易数</th></tr></thead><tbody>';
            
            results.forEach(result => {
                const statusBadge = result.success 
                    ? '<span class="badge bg-success">✅ 成功</span>'
                    : '<span class="badge bg-danger">❌ 失败</span>';
                
                html += `<tr>
                    <td>${result.name}</td>
                    <td>${statusBadge}</td>
                    <td>${result.success ? result.startDate : '-'}</td>
                    <td>${result.success ? result.note : result.error}</td>
                    <td>${result.success ? result.totalTrades : '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 添加总结
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            
            if (successCount === totalCount) {
                html += `<div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle me-2"></i>
                    所有测试通过！320万本金起始日期功能正常工作。
                </div>`;
            } else {
                html += `<div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${successCount}/${totalCount} 个测试通过，请检查失败的测试项。
                </div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // 加载期望对比数据
        async function loadExpectationData() {
            const displayDiv = document.getElementById('expectation-data-display');
            
            displayDiv.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="text-muted">正在加载期望对比数据...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/analytics/expectation-comparison?time_range=all&base_capital=3200000');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    displayDiv.innerHTML = `
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>时间范围信息</h6>
                                    <p class="mb-1"><strong>范围：</strong>${data.time_range.range_name}</p>
                                    <p class="mb-1"><strong>起始日期：</strong>${data.time_range.start_date}</p>
                                    <p class="mb-1"><strong>结束日期：</strong>${data.time_range.end_date}</p>
                                    <p class="mb-1"><strong>交易记录数：</strong>${data.time_range.total_trades}</p>
                                    <p class="mb-0"><strong>本金起始说明：</strong>${data.time_range.base_capital_start_note}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">期望指标</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled mb-0">
                                            <li><strong>收益率：</strong>${(data.expectation.return_rate * 100).toFixed(2)}%</li>
                                            <li><strong>收益金额：</strong>¥${data.expectation.return_amount.toLocaleString()}</li>
                                            <li><strong>持仓天数：</strong>${data.expectation.holding_days.toFixed(1)}天</li>
                                            <li><strong>胜率：</strong>${(data.expectation.success_rate * 100).toFixed(1)}%</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">实际指标</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled mb-0">
                                            <li><strong>收益率：</strong>${(data.actual.return_rate * 100).toFixed(2)}%</li>
                                            <li><strong>收益金额：</strong>¥${data.actual.return_amount.toLocaleString()}</li>
                                            <li><strong>持仓天数：</strong>${data.actual.holding_days.toFixed(1)}天</li>
                                            <li><strong>胜率：</strong>${(data.actual.success_rate * 100).toFixed(1)}%</li>
                                            <li><strong>总交易数：</strong>${data.actual.total_trades}</li>
                                            <li><strong>已完成交易：</strong>${data.actual.completed_trades}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check-circle me-2"></i>功能验证成功！</h6>
                                    <p class="mb-0">
                                        320万本金起始日期功能已正确实现。基准本金：¥${data.base_capital.toLocaleString()}，
                                        起始计算日期：${data.time_range.base_capital_start_date.split('T')[0]}。
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(result.message || '获取数据失败');
                }
            } catch (error) {
                displayDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        加载失败：${error.message}
                    </div>
                `;
            }
        }
        
        // 页面加载时自动运行测试
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟1秒后自动测试API
            setTimeout(() => {
                testAPI();
            }, 1000);
        });
    </script>
</body>
</html>