<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复盘页面紧急修复测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">复盘页面紧急修复测试</h1>
                
                <!-- 测试状态面板 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">修复状态检查</h5>
                    </div>
                    <div class="card-body">
                        <div id="fix-status">
                            <div class="text-center">
                                <div class="spinner-border me-2" role="status"></div>
                                正在检查修复状态...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 持仓数据测试 -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">持仓数据测试</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="testLoadHoldings()">
                            <i class="fas fa-sync-alt"></i> 测试加载
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="holdings-test-result">
                            <div class="text-muted">点击"测试加载"按钮开始测试</div>
                        </div>
                    </div>
                </div>
                
                <!-- 复盘记录测试 -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">复盘记录测试</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="testLoadReviews()">
                            <i class="fas fa-sync-alt"></i> 测试加载
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="reviews-test-result">
                            <div class="text-muted">点击"测试加载"按钮开始测试</div>
                        </div>
                    </div>
                </div>
                
                <!-- JavaScript类测试 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">JavaScript类测试</h5>
                    </div>
                    <div class="card-body">
                        <div id="js-classes-test">
                            <div class="text-muted">正在检查JavaScript类...</div>
                        </div>
                    </div>
                </div>
                
                <!-- 浮盈计算器测试 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">浮盈计算器测试</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">买入价格</label>
                                <input type="number" class="form-control" id="test-buy-price" value="10.00" step="0.01">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">当前价格</label>
                                <input type="number" class="form-control" id="test-current-price" value="11.00" step="0.01">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">持仓数量</label>
                                <input type="number" class="form-control" id="test-quantity" value="1000">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">浮盈结果</label>
                                <div class="form-control-plaintext fw-bold" id="test-profit-result">--</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="testFloatingProfitCalculator()">
                                <i class="fas fa-calculator"></i> 测试计算
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/review-emergency-fix.js"></script>
    
    <script>
        // 测试函数
        function checkFixStatus() {
            const statusEl = document.getElementById('fix-status');
            const checks = [];
            
            // 检查全局变量
            if (typeof window.ReviewPageGlobals !== 'undefined') {
                checks.push({ name: 'ReviewPageGlobals', status: 'success', message: '全局变量管理器已创建' });
            } else {
                checks.push({ name: 'ReviewPageGlobals', status: 'error', message: '全局变量管理器缺失' });
            }
            
            // 检查BatchProcessor
            if (typeof BatchProcessor !== 'undefined') {
                checks.push({ name: 'BatchProcessor', status: 'success', message: 'BatchProcessor类已创建' });
            } else {
                checks.push({ name: 'BatchProcessor', status: 'error', message: 'BatchProcessor类缺失' });
            }
            
            // 检查FloatingProfitCalculator
            if (typeof FloatingProfitCalculator !== 'undefined') {
                checks.push({ name: 'FloatingProfitCalculator', status: 'success', message: 'FloatingProfitCalculator类已创建' });
            } else {
                checks.push({ name: 'FloatingProfitCalculator', status: 'error', message: 'FloatingProfitCalculator类缺失' });
            }
            
            // 检查加载函数
            if (typeof window.loadHoldings === 'function') {
                checks.push({ name: 'loadHoldings', status: 'success', message: '持仓加载函数已定义' });
            } else {
                checks.push({ name: 'loadHoldings', status: 'error', message: '持仓加载函数缺失' });
            }
            
            if (typeof window.loadReviews === 'function') {
                checks.push({ name: 'loadReviews', status: 'success', message: '复盘记录加载函数已定义' });
            } else {
                checks.push({ name: 'loadReviews', status: 'error', message: '复盘记录加载函数缺失' });
            }
            
            // 生成状态HTML
            const statusHtml = checks.map(check => {
                const iconClass = check.status === 'success' ? 'fa-check-circle text-success' : 'fa-times-circle text-danger';
                return `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas ${iconClass} me-2"></i>
                        <strong>${check.name}:</strong>
                        <span class="ms-2">${check.message}</span>
                    </div>
                `;
            }).join('');
            
            statusEl.innerHTML = statusHtml;
        }
        
        async function testLoadHoldings() {
            const resultEl = document.getElementById('holdings-test-result');
            resultEl.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    正在测试持仓数据加载...
                </div>
            `;
            
            try {
                const response = await fetch('/api/holdings');
                const data = await response.json();
                
                if (response.ok) {
                    resultEl.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>测试成功！</strong>
                            <div class="mt-2">
                                <small>响应状态: ${response.status}</small><br>
                                <small>数据条数: ${data.data ? data.data.length : 0}</small><br>
                                <small>消息: ${data.message || '无消息'}</small>
                            </div>
                        </div>
                        <details>
                            <summary>查看响应数据</summary>
                            <pre class="mt-2 p-2 bg-light border rounded"><code>${JSON.stringify(data, null, 2)}</code></pre>
                        </details>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>API响应异常</strong>
                            <div class="mt-2">
                                <small>状态码: ${response.status}</small><br>
                                <small>错误: ${data.message || '未知错误'}</small>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>测试失败！</strong>
                        <div class="mt-2">
                            <small>错误: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }
        
        async function testLoadReviews() {
            const resultEl = document.getElementById('reviews-test-result');
            resultEl.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    正在测试复盘记录加载...
                </div>
            `;
            
            try {
                const response = await fetch('/api/reviews');
                const data = await response.json();
                
                if (response.ok) {
                    resultEl.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>测试成功！</strong>
                            <div class="mt-2">
                                <small>响应状态: ${response.status}</small><br>
                                <small>数据条数: ${data.data && data.data.reviews ? data.data.reviews.length : 0}</small><br>
                                <small>消息: ${data.message || '无消息'}</small>
                            </div>
                        </div>
                        <details>
                            <summary>查看响应数据</summary>
                            <pre class="mt-2 p-2 bg-light border rounded"><code>${JSON.stringify(data, null, 2)}</code></pre>
                        </details>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>API响应异常</strong>
                            <div class="mt-2">
                                <small>状态码: ${response.status}</small><br>
                                <small>错误: ${data.message || '未知错误'}</small>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>测试失败！</strong>
                        <div class="mt-2">
                            <small>错误: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }
        
        function testFloatingProfitCalculator() {
            const buyPrice = parseFloat(document.getElementById('test-buy-price').value);
            const currentPrice = parseFloat(document.getElementById('test-current-price').value);
            const quantity = parseInt(document.getElementById('test-quantity').value);
            const resultEl = document.getElementById('test-profit-result');
            
            try {
                if (typeof FloatingProfitCalculator === 'undefined') {
                    resultEl.innerHTML = '<span class="text-danger">FloatingProfitCalculator未定义</span>';
                    return;
                }
                
                const calculator = new FloatingProfitCalculator();
                calculator.setBuyPrice(buyPrice);
                calculator.setCurrentPrice(currentPrice);
                calculator.setQuantity(quantity);
                
                const profitRatio = (currentPrice - buyPrice) / buyPrice;
                const profitAmount = (currentPrice - buyPrice) * quantity;
                const profitPercentage = (profitRatio * 100).toFixed(2);
                
                const color = profitRatio > 0 ? 'text-danger' : profitRatio < 0 ? 'text-success' : 'text-muted';
                resultEl.innerHTML = `
                    <span class="${color}">
                        ${profitPercentage}%
                        <br>
                        <small>${profitAmount >= 0 ? '+' : ''}¥${profitAmount.toFixed(2)}</small>
                    </span>
                `;
                
            } catch (error) {
                resultEl.innerHTML = `<span class="text-danger">计算错误: ${error.message}</span>`;
            }
        }
        
        function checkJSClasses() {
            const testEl = document.getElementById('js-classes-test');
            const classes = [
                { name: 'BatchProcessor', check: () => typeof BatchProcessor !== 'undefined' },
                { name: 'FloatingProfitCalculator', check: () => typeof FloatingProfitCalculator !== 'undefined' },
                { name: 'ReviewPageGlobals', check: () => typeof window.ReviewPageGlobals !== 'undefined' }
            ];
            
            const results = classes.map(cls => {
                const exists = cls.check();
                const status = exists ? 'success' : 'danger';
                const icon = exists ? 'check-circle' : 'times-circle';
                
                return `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-${icon} text-${status} me-2"></i>
                        <span>${cls.name}: ${exists ? '已定义' : '未定义'}</span>
                    </div>
                `;
            }).join('');
            
            testEl.innerHTML = results;
        }
        
        // 页面加载完成后执行检查
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkFixStatus();
                checkJSClasses();
            }, 1000);
        });
    </script>
</body>
</html>