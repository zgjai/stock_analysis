<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆæµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆæµ‹è¯•</h1>
        <p class="text-muted">æµ‹è¯•å¤ç›˜é¡µé¢çš„ä¿å­˜çŠ¶æ€ç®¡ç†å’ŒUIæ›´æ–°åŠŸèƒ½</p>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•ç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="text-center">
                                <div class="spinner-border" role="status"></div>
                                <p class="mt-2">æ­£åœ¨è¿è¡Œæµ‹è¯•...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•æ§åˆ¶</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100 mb-2" onclick="runAllTests()">
                            <i class="fas fa-play"></i> è¿è¡Œæ‰€æœ‰æµ‹è¯•
                        </button>
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="testSaveStateIntegration()">
                            <i class="fas fa-cog"></i> æµ‹è¯•çŠ¶æ€é›†æˆ
                        </button>
                        <button class="btn btn-outline-info w-100 mb-2" onclick="testFormChangeDetection()">
                            <i class="fas fa-edit"></i> æµ‹è¯•å˜åŒ–æ£€æµ‹
                        </button>
                        <button class="btn btn-outline-success w-100 mb-2" onclick="testSaveButtonStates()">
                            <i class="fas fa-save"></i> æµ‹è¯•æŒ‰é’®çŠ¶æ€
                        </button>
                        <button class="btn btn-outline-warning w-100" onclick="openReviewModal()">
                            <i class="fas fa-modal"></i> æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤ç›˜æ¨¡æ€æ¡† (ç®€åŒ–ç‰ˆç”¨äºæµ‹è¯•) -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å¤ç›˜è¯„åˆ†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="review-form" novalidate>
                        <input type="hidden" id="review-stock-code" value="000001">
                        <input type="hidden" id="review-id">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                                <input type="text" class="form-control" id="display-stock-code" value="000001" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">å¤ç›˜æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="review-date">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">æŒä»“å¤©æ•°</label>
                                <input type="number" class="form-control" id="holding-days" value="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">å½“å‰ä»·æ ¼</label>
                                <input type="number" class="form-control" id="current-price-input" step="0.01">
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">è¯„åˆ†æ ‡å‡†</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="price-up-score" value="1">
                                            <label class="form-check-label" for="price-up-score">æ”¶ç›˜ä»·ä¸Šå‡</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="bbi-score" value="1">
                                            <label class="form-check-label" for="bbi-score">ä¸ç ´BBIçº¿</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="volume-score" value="1">
                                            <label class="form-check-label" for="volume-score">æ— æ”¾é‡é˜´çº¿</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="trend-score" value="1">
                                            <label class="form-check-label" for="trend-score">è¶‹åŠ¿è¿˜åœ¨å‘ä¸Š</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">åˆ†æå†…å®¹</label>
                            <textarea class="form-control" id="analysis" rows="3" placeholder="è¯·è¾“å…¥åˆ†æå†…å®¹..."></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">å†³ç­–ç»“æœ</label>
                                <select class="form-select" id="decision">
                                    <option value="">è¯·é€‰æ‹©å†³ç­–</option>
                                    <option value="hold">ç»§ç»­æŒæœ‰</option>
                                    <option value="sell_partial">éƒ¨åˆ†æ­¢ç›ˆ</option>
                                    <option value="sell_all">æ¸…ä»“</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å†³ç­–ç†ç”±</label>
                            <textarea class="form-control" id="reason" rows="2" placeholder="è¯·è¾“å…¥å†³ç­–ç†ç”±..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="save-review-btn">ä¿å­˜å¤ç›˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- åŠ è½½å¿…è¦çš„JavaScriptæ–‡ä»¶ -->
    <script src="/static/js/unified-message-system.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/review-save-manager.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let apiClient = null;
        let reviewSaveManager = null;
        let reviewModal = null;
        let testResults = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æµ‹è¯•é¡µé¢');
            
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('review-date').value = today;
            
            // åˆå§‹åŒ–æ¨¡æ€æ¡†
            const modalElement = document.getElementById('reviewModal');
            if (modalElement && typeof bootstrap !== 'undefined') {
                reviewModal = new bootstrap.Modal(modalElement);
            }
            
            // å»¶è¿Ÿè¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
            setTimeout(() => {
                runAllTests();
            }, 1000);
        });

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            console.log('ğŸ§ª å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•');
            testResults = [];
            
            updateTestResults('<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">æ­£åœ¨è¿è¡Œæµ‹è¯•...</p></div>');
            
            const tests = [
                { name: 'ä¾èµ–æ£€æŸ¥', fn: testDependencies },
                { name: 'APIå®¢æˆ·ç«¯åˆå§‹åŒ–', fn: testApiClientInit },
                { name: 'ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–', fn: testSaveManagerInit },
                { name: 'ä¿å­˜çŠ¶æ€é›†æˆ', fn: testSaveStateIntegration },
                { name: 'è¡¨å•å˜åŒ–æ£€æµ‹', fn: testFormChangeDetection },
                { name: 'ä¿å­˜æŒ‰é’®çŠ¶æ€', fn: testSaveButtonStates },
                { name: 'çŠ¶æ€æŒ‡ç¤ºå™¨', fn: testStatusIndicator }
            ];
            
            for (const test of tests) {
                try {
                    console.log(`ğŸ”„ è¿è¡Œæµ‹è¯•: ${test.name}`);
                    const result = await test.fn();
                    testResults.push({
                        name: test.name,
                        passed: result.success,
                        message: result.message,
                        details: result.details || []
                    });
                } catch (error) {
                    console.error(`âŒ æµ‹è¯• ${test.name} å¼‚å¸¸:`, error);
                    testResults.push({
                        name: test.name,
                        passed: false,
                        message: `æµ‹è¯•å¼‚å¸¸: ${error.message}`,
                        details: []
                    });
                }
                
                // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
                updateTestResults();
                
                // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…æµ‹è¯•å†²çª
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            console.log('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ');
            displayFinalResults();
        }

        // æµ‹è¯•ä¾èµ–æ£€æŸ¥
        function testDependencies() {
            console.log('ğŸ” æµ‹è¯•ä¾èµ–æ£€æŸ¥');
            
            const dependencies = [
                { name: 'UnifiedMessageSystem', check: () => typeof UnifiedMessageSystem !== 'undefined' },
                { name: 'ApiClient', check: () => typeof ApiClient !== 'undefined' },
                { name: 'ReviewSaveManager', check: () => typeof ReviewSaveManager !== 'undefined' },
                { name: 'Bootstrap', check: () => typeof bootstrap !== 'undefined' }
            ];
            
            const missing = dependencies.filter(dep => !dep.check());
            const details = dependencies.map(dep => ({
                item: dep.name,
                status: dep.check() ? 'âœ… å·²åŠ è½½' : 'âŒ æœªæ‰¾åˆ°'
            }));
            
            return {
                success: missing.length === 0,
                message: missing.length === 0 ? 'æ‰€æœ‰ä¾èµ–æ£€æŸ¥é€šè¿‡' : `ç¼ºå°‘ä¾èµ–: ${missing.map(d => d.name).join(', ')}`,
                details: details
            };
        }

        // æµ‹è¯•APIå®¢æˆ·ç«¯åˆå§‹åŒ–
        function testApiClientInit() {
            console.log('ğŸ” æµ‹è¯•APIå®¢æˆ·ç«¯åˆå§‹åŒ–');
            
            try {
                if (typeof ApiClient !== 'undefined') {
                    apiClient = new ApiClient();
                    return {
                        success: true,
                        message: 'APIå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ',
                        details: [
                            { item: 'ApiClientç±»', status: 'âœ… å¯ç”¨' },
                            { item: 'å®ä¾‹åˆ›å»º', status: 'âœ… æˆåŠŸ' },
                            { item: 'saveReviewæ–¹æ³•', status: typeof apiClient.saveReview === 'function' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨' }
                        ]
                    };
                } else {
                    return {
                        success: false,
                        message: 'ApiClientç±»æœªæ‰¾åˆ°',
                        details: [{ item: 'ApiClientç±»', status: 'âŒ æœªæ‰¾åˆ°' }]
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: `APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`,
                    details: [{ item: 'åˆå§‹åŒ–å¼‚å¸¸', status: `âŒ ${error.message}` }]
                };
            }
        }

        // æµ‹è¯•ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–
        function testSaveManagerInit() {
            console.log('ğŸ” æµ‹è¯•ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–');
            
            try {
                if (typeof ReviewSaveManager !== 'undefined') {
                    reviewSaveManager = new ReviewSaveManager('#review-form');
                    
                    const details = [
                        { item: 'ReviewSaveManagerç±»', status: 'âœ… å¯ç”¨' },
                        { item: 'å®ä¾‹åˆ›å»º', status: reviewSaveManager ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' },
                        { item: 'è¡¨å•ç»‘å®š', status: reviewSaveManager && reviewSaveManager.form ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' },
                        { item: 'saveReviewæ–¹æ³•', status: reviewSaveManager && typeof reviewSaveManager.saveReview === 'function' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨' },
                        { item: 'å˜åŒ–æ£€æµ‹æ–¹æ³•', status: reviewSaveManager && typeof reviewSaveManager.detectChanges === 'function' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨' }
                    ];
                    
                    return {
                        success: reviewSaveManager !== null,
                        message: reviewSaveManager ? 'ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ' : 'ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥',
                        details: details
                    };
                } else {
                    return {
                        success: false,
                        message: 'ReviewSaveManagerç±»æœªæ‰¾åˆ°',
                        details: [{ item: 'ReviewSaveManagerç±»', status: 'âŒ æœªæ‰¾åˆ°' }]
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: `ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`,
                    details: [{ item: 'åˆå§‹åŒ–å¼‚å¸¸', status: `âŒ ${error.message}` }]
                };
            }
        }

        // æµ‹è¯•ä¿å­˜çŠ¶æ€é›†æˆ
        function testSaveStateIntegration() {
            console.log('ğŸ” æµ‹è¯•ä¿å­˜çŠ¶æ€é›†æˆ');
            
            if (!reviewSaveManager) {
                return {
                    success: false,
                    message: 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–',
                    details: [{ item: 'ä¿å­˜ç®¡ç†å™¨', status: 'âŒ æœªåˆå§‹åŒ–' }]
                };
            }
            
            const checks = [
                {
                    name: 'è¡¨å•ç»‘å®š',
                    check: () => reviewSaveManager.form && reviewSaveManager.form.id === 'review-form'
                },
                {
                    name: 'ä¿å­˜æŒ‰é’®ç»‘å®š',
                    check: () => {
                        const saveBtn = document.getElementById('save-review-btn');
                        return saveBtn !== null;
                    }
                },
                {
                    name: 'çŠ¶æ€æŒ‡ç¤ºå™¨',
                    check: () => {
                        // å°è¯•åˆ›å»ºçŠ¶æ€æŒ‡ç¤ºå™¨
                        const modalHeader = document.querySelector('#reviewModal .modal-header');
                        return modalHeader !== null;
                    }
                },
                {
                    name: 'äº‹ä»¶ç›‘å¬å™¨',
                    check: () => {
                        const form = document.getElementById('review-form');
                        const inputs = form ? form.querySelectorAll('input, select, textarea') : [];
                        return inputs.length > 0;
                    }
                }
            ];
            
            let passedChecks = 0;
            const details = checks.map(check => {
                const result = check.check();
                if (result) passedChecks++;
                return {
                    item: check.name,
                    status: result ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'
                };
            });
            
            return {
                success: passedChecks === checks.length,
                message: `ä¿å­˜çŠ¶æ€é›†æˆæ£€æŸ¥: ${passedChecks}/${checks.length} é€šè¿‡`,
                details: details
            };
        }

        // æµ‹è¯•è¡¨å•å˜åŒ–æ£€æµ‹
        async function testFormChangeDetection() {
            console.log('ğŸ” æµ‹è¯•è¡¨å•å˜åŒ–æ£€æµ‹');
            
            if (!reviewSaveManager) {
                return {
                    success: false,
                    message: 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–',
                    details: []
                };
            }
            
            const testElements = [
                { id: 'analysis', type: 'textarea', testValue: 'æµ‹è¯•åˆ†æå†…å®¹' },
                { id: 'reason', type: 'textarea', testValue: 'æµ‹è¯•å†³ç­–ç†ç”±' },
                { id: 'decision', type: 'select', testValue: 'hold' },
                { id: 'holding-days', type: 'number', testValue: '5' }
            ];
            
            const details = [];
            let passedTests = 0;
            
            // é¦–å…ˆæ•è·åŸå§‹çŠ¶æ€
            reviewSaveManager.captureOriginalFormData();
            const originalUnsavedState = reviewSaveManager.hasUnsavedChanges;
            
            for (const test of testElements) {
                const element = document.getElementById(test.id);
                if (!element) {
                    details.push({ item: test.id, status: 'âŒ å…ƒç´ æœªæ‰¾åˆ°' });
                    continue;
                }
                
                // è®°å½•åŸå§‹å€¼
                const originalValue = element.value;
                
                // æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥
                element.value = test.testValue;
                element.dispatchEvent(new Event('input', { bubbles: true }));
                element.dispatchEvent(new Event('change', { bubbles: true }));
                
                // ç­‰å¾…å˜åŒ–æ£€æµ‹ï¼ˆè€ƒè™‘é˜²æŠ–ï¼‰
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // æ£€æŸ¥æ˜¯å¦æ£€æµ‹åˆ°å˜åŒ–
                const changeDetected = reviewSaveManager.hasUnsavedChanges !== originalUnsavedState;
                
                if (changeDetected) {
                    details.push({ item: test.id, status: 'âœ… å˜åŒ–æ£€æµ‹æ­£å¸¸' });
                    passedTests++;
                } else {
                    details.push({ item: test.id, status: 'âŒ å˜åŒ–æ£€æµ‹å¤±è´¥' });
                }
                
                // æ¢å¤åŸå§‹å€¼
                element.value = originalValue;
                element.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            // æ¢å¤åŸå§‹çŠ¶æ€
            await new Promise(resolve => setTimeout(resolve, 400));
            reviewSaveManager.captureOriginalFormData();
            
            return {
                success: passedTests === testElements.length,
                message: `è¡¨å•å˜åŒ–æ£€æµ‹: ${passedTests}/${testElements.length} é€šè¿‡`,
                details: details
            };
        }

        // æµ‹è¯•ä¿å­˜æŒ‰é’®çŠ¶æ€
        function testSaveButtonStates() {
            console.log('ğŸ” æµ‹è¯•ä¿å­˜æŒ‰é’®çŠ¶æ€');
            
            const saveButton = document.getElementById('save-review-btn');
            if (!saveButton) {
                return {
                    success: false,
                    message: 'ä¿å­˜æŒ‰é’®æœªæ‰¾åˆ°',
                    details: [{ item: 'ä¿å­˜æŒ‰é’®', status: 'âŒ æœªæ‰¾åˆ°' }]
                };
            }
            
            if (!reviewSaveManager) {
                return {
                    success: false,
                    message: 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–',
                    details: [{ item: 'ä¿å­˜ç®¡ç†å™¨', status: 'âŒ æœªåˆå§‹åŒ–' }]
                };
            }
            
            const details = [];
            
            // æµ‹è¯•åˆå§‹çŠ¶æ€
            const initialDisabled = saveButton.disabled;
            details.push({ 
                item: 'åˆå§‹çŠ¶æ€', 
                status: initialDisabled ? 'âœ… æŒ‰é’®å·²ç¦ç”¨' : 'âš ï¸ æŒ‰é’®æœªç¦ç”¨' 
            });
            
            // æµ‹è¯•æŒ‰é’®æ–‡æœ¬
            const buttonText = saveButton.textContent.trim();
            details.push({ 
                item: 'æŒ‰é’®æ–‡æœ¬', 
                status: buttonText ? `âœ… "${buttonText}"` : 'âŒ æ–‡æœ¬ä¸ºç©º' 
            });
            
            // æµ‹è¯•æŒ‰é’®ç±»å
            const hasButtonClass = saveButton.classList.contains('btn');
            details.push({ 
                item: 'æŒ‰é’®æ ·å¼', 
                status: hasButtonClass ? 'âœ… æœ‰æŒ‰é’®æ ·å¼' : 'âŒ ç¼ºå°‘æŒ‰é’®æ ·å¼' 
            });
            
            // æµ‹è¯•äº‹ä»¶ç»‘å®š
            const hasClickHandler = saveButton.onclick !== null || saveButton.addEventListener;
            details.push({ 
                item: 'äº‹ä»¶ç»‘å®š', 
                status: 'âœ… æ”¯æŒäº‹ä»¶ç»‘å®š' 
            });
            
            return {
                success: true,
                message: 'ä¿å­˜æŒ‰é’®çŠ¶æ€æ£€æŸ¥å®Œæˆ',
                details: details
            };
        }

        // æµ‹è¯•çŠ¶æ€æŒ‡ç¤ºå™¨
        function testStatusIndicator() {
            console.log('ğŸ” æµ‹è¯•çŠ¶æ€æŒ‡ç¤ºå™¨');
            
            const modalHeader = document.querySelector('#reviewModal .modal-header');
            if (!modalHeader) {
                return {
                    success: false,
                    message: 'æ¨¡æ€æ¡†å¤´éƒ¨æœªæ‰¾åˆ°',
                    details: [{ item: 'æ¨¡æ€æ¡†å¤´éƒ¨', status: 'âŒ æœªæ‰¾åˆ°' }]
                };
            }
            
            // å°è¯•åˆ›å»ºçŠ¶æ€æŒ‡ç¤ºå™¨
            let indicator = modalHeader.querySelector('.save-status-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'save-status-indicator ms-auto me-2';
                indicator.innerHTML = '<small class="text-success">å·²ä¿å­˜</small>';
                
                const closeButton = modalHeader.querySelector('.btn-close');
                if (closeButton) {
                    modalHeader.insertBefore(indicator, closeButton);
                } else {
                    modalHeader.appendChild(indicator);
                }
            }
            
            const details = [
                { item: 'æŒ‡ç¤ºå™¨åˆ›å»º', status: indicator ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' },
                { item: 'æŒ‡ç¤ºå™¨ä½ç½®', status: indicator.parentNode === modalHeader ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯' },
                { item: 'æŒ‡ç¤ºå™¨æ ·å¼', status: indicator.classList.contains('save-status-indicator') ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯' }
            ];
            
            // æµ‹è¯•çŠ¶æ€æ›´æ–°
            if (indicator) {
                const originalContent = indicator.innerHTML;
                
                // æµ‹è¯•ä¸åŒçŠ¶æ€
                indicator.innerHTML = '<small class="text-warning">æœ‰æœªä¿å­˜çš„æ›´æ”¹</small>';
                details.push({ item: 'çŠ¶æ€æ›´æ–°', status: 'âœ… æ”¯æŒæ›´æ–°' });
                
                // æ¢å¤åŸå§‹å†…å®¹
                setTimeout(() => {
                    indicator.innerHTML = originalContent;
                }, 1000);
            }
            
            return {
                success: indicator !== null,
                message: indicator ? 'çŠ¶æ€æŒ‡ç¤ºå™¨æµ‹è¯•é€šè¿‡' : 'çŠ¶æ€æŒ‡ç¤ºå™¨æµ‹è¯•å¤±è´¥',
                details: details
            };
        }

        // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
        function updateTestResults(customContent = null) {
            const resultsContainer = document.getElementById('test-results');
            
            if (customContent) {
                resultsContainer.innerHTML = customContent;
                return;
            }
            
            if (testResults.length === 0) {
                resultsContainer.innerHTML = '<p class="text-muted">æš‚æ— æµ‹è¯•ç»“æœ</p>';
                return;
            }
            
            let html = '';
            testResults.forEach((result, index) => {
                const statusClass = result.passed ? 'success' : 'danger';
                const statusIcon = result.passed ? 'fa-check-circle' : 'fa-times-circle';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${index + 1}. ${result.name}</h6>
                            <span class="badge bg-${statusClass}">
                                <i class="fas ${statusIcon}"></i> ${result.passed ? 'é€šè¿‡' : 'å¤±è´¥'}
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">${result.message}</p>
                            ${result.details && result.details.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-muted">è¯¦ç»†ä¿¡æ¯:</small>
                                    <ul class="list-unstyled mt-1">
                                        ${result.details.map(detail => `
                                            <li><small>${detail.item}: ${detail.status}</small></li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        function displayFinalResults() {
            const passedTests = testResults.filter(r => r.passed).length;
            const totalTests = testResults.length;
            const successRate = Math.round((passedTests / totalTests) * 100);
            
            const summaryClass = successRate === 100 ? 'success' : successRate >= 80 ? 'warning' : 'danger';
            const summaryIcon = successRate === 100 ? 'fa-check-circle' : successRate >= 80 ? 'fa-exclamation-triangle' : 'fa-times-circle';
            
            const summaryHtml = `
                <div class="alert alert-${summaryClass} mb-3">
                    <h5><i class="fas ${summaryIcon}"></i> æµ‹è¯•å®Œæˆ</h5>
                    <p class="mb-0">
                        æ€»è®¡: ${totalTests} ä¸ªæµ‹è¯•ï¼Œé€šè¿‡: ${passedTests} ä¸ªï¼ŒæˆåŠŸç‡: ${successRate}%
                    </p>
                </div>
            `;
            
            const resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = summaryHtml + resultsContainer.innerHTML;
            
            console.log(`ğŸ‰ æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡ (${successRate}%)`);
        }

        // æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†
        function openReviewModal() {
            if (reviewModal) {
                reviewModal.show();
            } else {
                alert('æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            }
        }

        // å…¨å±€å‡½æ•°ï¼Œä¾›æŒ‰é’®è°ƒç”¨
        window.runAllTests = runAllTests;
        window.testSaveStateIntegration = testSaveStateIntegration;
        window.testFormChangeDetection = testFormChangeDetection;
        window.testSaveButtonStates = testSaveButtonStates;
        window.openReviewModal = openReviewModal;
    </script>
</body>
</html>