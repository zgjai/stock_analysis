# 月度期望收益对比功能说明

## 功能概述

在期望对比模块中新增了月度期望收益对比功能，该功能可以对比从2025年8月开始每个月的期望收益和实际收益。

## 核心特性

### 1. 期望收益计算模型

基于以下概率分布和320万启动资金计算：

| 概率 | 收益率 | 最大持仓天数 | 贡献度 |
|------|--------|-------------|--------|
| 10%  | +20%   | 30天        | +2.00% |
| 10%  | +15%   | 20天        | +1.50% |
| 15%  | +10%   | 15天        | +1.50% |
| 15%  | +5%    | 10天        | +0.75% |
| 10%  | +2%    | 5天         | +0.20% |
| 20%  | -3%    | 5天         | -0.60% |
| 15%  | -5%    | 5天         | -0.75% |
| 5%   | -10%   | 5天         | -0.50% |

**计算结果：**
- 期望收益率：4.10%
- 加权平均持仓天数：11.2天
- 月度周转次数：1.96次
- **月度期望收益率：8.02%**

### 2. 复利计算

**重要：** 采用复利计算模式，每月盈利后的资金会重新投入：

```
月末本金 = 月初本金 × (1 + 月度期望收益率)
下月本金 = 上月月末本金
```

**示例（前6个月）：**
- 2025年08月：320万 → 期望收益25.7万 → 月末345.7万
- 2025年09月：345.7万 → 期望收益27.7万 → 月末373.4万
- 2025年10月：373.4万 → 期望收益29.9万 → 月末403.3万
- 2025年11月：403.3万 → 期望收益32.3万 → 月末435.6万
- 2025年12月：435.6万 → 期望收益34.9万 → 月末470.6万
- 2026年01月：470.6万 → 期望收益37.7万 → 月末508.3万

**两年后预期：** 从320万增长到约2037万（复利效应）

## 技术实现

### 1. 后端实现

#### 新增服务类
- `monthly_expectation_service.py` - 月度期望收益服务
- 提供月度期望数据获取和对比计算功能

#### 新增API端点
- `GET /api/analytics/monthly-expectations` - 获取月度期望收益数据
- `GET /api/analytics/monthly-comparison` - 获取月度期望与实际收益对比

#### 数据文件
- `expected_monthly_returns.json` - 预计算的24个月期望收益数据
- `calculate_expected_monthly_returns.py` - 期望收益计算脚本

### 2. 前端实现

#### HTML结构（在analytics.html中）
```html
<!-- 月度期望收益对比 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>月度期望收益对比</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 左侧：月份选择 -->
                    <div class="col-md-4">
                        <div id="monthly-expectation-list">
                            <!-- 月份列表 -->
                        </div>
                    </div>
                    <!-- 右侧：对比详情 -->
                    <div class="col-md-8">
                        <div id="monthly-comparison-detail">
                            <!-- 对比详情 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

#### JavaScript功能（在expectation-comparison-manager.js中）
- `loadMonthlyExpectations()` - 加载月度期望数据
- `renderMonthlyExpectationsList()` - 渲染月份列表
- `selectMonth(index)` - 选择月份
- `loadMonthlyComparison(year, month)` - 加载月度对比数据
- `renderMonthlyComparisonDetail(data)` - 渲染对比详情
- `formatCurrency(amount)` - 格式化货币显示

## 使用方法

### 1. 访问功能
1. 打开统计分析页面：`http://localhost:5001/analytics`
2. 点击"期望对比"Tab
3. 在页面中找到"月度期望收益对比"卡片

### 2. 操作步骤
1. 点击"刷新"按钮加载月度数据
2. 在左侧月份列表中选择要查看的月份
3. 右侧会显示该月份的期望与实际收益对比详情

### 3. 对比信息
- **期望收益**：基于概率模型和复利计算的期望值
- **实际收益**：基于实际交易记录计算的收益
- **差异分析**：收益金额差异、收益率差异及表现评级
- **交易统计**：交易次数、买入金额、卖出金额等

## 数据说明

### 1. 期望数据来源
- 基于预定义的概率模型
- 采用复利计算方式
- 从2025年8月开始，覆盖24个月

### 2. 实际数据来源
- 从交易记录表中获取指定月份的交易数据
- 计算已实现收益（买入-卖出差额）
- 估算月初资本（基于期望数据或320万基准）

### 3. 对比算法
```javascript
// 收益金额差异
amount_diff = actual.realized_profit - expected.expected_amount
amount_diff_pct = (amount_diff / expected.expected_amount) * 100

// 收益率差异  
rate_diff = actual.return_rate - (expected.expected_rate / 100)
rate_diff_pct = (rate_diff / (expected.expected_rate / 100)) * 100

// 表现评级
if (abs(diff_pct) <= 10%) -> "接近期望"
else if (diff_pct > 10%) -> "超出期望" 
else -> "低于期望"
```

## 测试验证

### 1. API测试
运行 `python test_monthly_expectation_api.py` 验证：
- ✅ 月度期望数据API正常
- ✅ 月度对比数据API正常
- ✅ 数据格式正确

### 2. 前端测试
打开 `test_monthly_expectation_integration.html` 验证：
- ✅ DOM元素正确加载
- ✅ JavaScript方法正常工作
- ✅ 数据渲染正确

### 3. 集成测试
在analytics页面验证：
- ✅ 功能正确集成到期望对比Tab
- ✅ 与现有功能无冲突
- ✅ 用户体验良好

## 文件清单

### 新增文件
1. `monthly_expectation_service.py` - 月度期望收益服务
2. `calculate_expected_monthly_returns.py` - 期望收益计算脚本
3. `expected_monthly_returns.json` - 期望收益数据文件
4. `test_monthly_expectation_api.py` - API测试脚本
5. `test_monthly_expectation_integration.html` - 集成测试页面
6. `monthly_expectation_comparison.html` - 独立功能页面（可选）

### 修改文件
1. `api/analytics_routes.py` - 添加新的API端点
2. `templates/analytics.html` - 添加月度对比HTML结构
3. `static/js/expectation-comparison-manager.js` - 添加月度对比JavaScript功能

## 注意事项

1. **复利计算**：确保理解复利计算模式，每月收益会累积到下月本金
2. **数据依赖**：需要先运行计算脚本生成期望收益数据文件
3. **实际数据**：实际收益基于交易记录，需要有相应月份的交易数据
4. **性能考虑**：月度数据较多时考虑分页或虚拟滚动
5. **错误处理**：API调用失败时有相应的错误提示和重试机制

## 未来扩展

1. **图表可视化**：添加月度对比趋势图表
2. **导出功能**：支持导出月度对比报表
3. **预测功能**：基于历史数据预测未来月份表现
4. **告警功能**：当实际收益严重偏离期望时发送提醒
5. **参数调整**：允许用户调整概率模型参数