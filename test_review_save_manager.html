<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReviewSaveManager 测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>ReviewSaveManager 功能测试</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>测试结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>操作面板</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2 w-100" onclick="runAllTests()">运行所有测试</button>
                        <button class="btn btn-outline-primary mb-2 w-100" onclick="testFormChangeDetection()">测试表单变化检测</button>
                        <button class="btn btn-outline-primary mb-2 w-100" onclick="testSaveButtonState()">测试保存按钮状态</button>
                        <button class="btn btn-outline-primary mb-2 w-100" onclick="testValidation()">测试数据验证</button>
                        <button class="btn btn-outline-primary mb-2 w-100" onclick="testAutoSave()">测试自动保存</button>
                        <button class="btn btn-outline-secondary w-100" onclick="clearResults()">清除结果</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模拟复盘模态框 -->
        <div class="modal fade" id="reviewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">复盘评分</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="review-form" novalidate>
                            <input type="hidden" id="review-stock-code" value="000001">
                            <input type="hidden" id="review-id">
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">股票代码</label>
                                    <input type="text" class="form-control" id="display-stock-code" value="000001" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">复盘日期</label>
                                    <input type="date" class="form-control" id="review-date">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">持仓天数</label>
                                    <input type="number" class="form-control" id="holding-days" value="5">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">当前价格</label>
                                    <input type="number" class="form-control" id="current-price-input" step="0.01">
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">评分标准</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="price-up-score" value="1">
                                                <label class="form-check-label" for="price-up-score">收盘价上升</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="bbi-score" value="1">
                                                <label class="form-check-label" for="bbi-score">不破BBI线</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="volume-score" value="1">
                                                <label class="form-check-label" for="volume-score">无放量阴线</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="trend-score" value="1">
                                                <label class="form-check-label" for="trend-score">趋势还在向上</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="j-score" value="1">
                                                <label class="form-check-label" for="j-score">J没死叉</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">分析内容</label>
                                <textarea class="form-control" id="analysis" rows="3" placeholder="请输入分析内容..."></textarea>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">决策结果</label>
                                    <select class="form-select" id="decision">
                                        <option value="">请选择决策</option>
                                        <option value="hold">继续持有</option>
                                        <option value="sell_partial">部分止盈</option>
                                        <option value="sell_all">清仓</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">决策理由</label>
                                <textarea class="form-control" id="reason" rows="2" placeholder="请输入决策理由..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary">保存复盘</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 模拟API客户端 -->
    <script>
        // 模拟API客户端
        const apiClient = {
            async saveReview(reviewData, reviewId = null) {
                console.log('模拟API调用 - saveReview:', reviewData, reviewId);
                
                // 模拟网络延迟
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 模拟成功响应
                return {
                    success: true,
                    data: {
                        id: reviewId || Math.floor(Math.random() * 1000),
                        ...reviewData,
                        created_at: new Date().toISOString()
                    },
                    message: '保存成功'
                };
            }
        };

        // 模拟消息显示函数
        function showMessage(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
    </script>
    
    <!-- 加载ReviewSaveManager -->
    <script src="static/js/review-save-manager.js"></script>
    
    <script>
        let testResults = [];
        let reviewModal;
        let testSaveManager;

        document.addEventListener('DOMContentLoaded', function() {
            // 初始化模态框
            reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
            
            // 设置默认日期
            document.getElementById('review-date').value = new Date().toISOString().split('T')[0];
            
            // 显示模态框以便测试
            reviewModal.show();
            
            // 等待模态框显示后初始化SaveManager
            setTimeout(() => {
                testSaveManager = new ReviewSaveManager();
                addTestResult('初始化', 'ReviewSaveManager 已初始化', 'success');
            }, 500);
        });

        function addTestResult(testName, message, status = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = status === 'success' ? 'text-success' : 
                               status === 'error' ? 'text-danger' : 
                               status === 'warning' ? 'text-warning' : 'text-info';
            
            testResults.push({
                name: testName,
                message: message,
                status: status,
                timestamp: timestamp
            });
            
            updateTestResultsDisplay();
        }

        function updateTestResultsDisplay() {
            const container = document.getElementById('test-results');
            const html = testResults.map(result => `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <strong>${result.name}</strong>
                        <small class="text-muted">${result.timestamp}</small>
                    </div>
                    <div class="${result.status === 'success' ? 'text-success' : 
                                 result.status === 'error' ? 'text-danger' : 
                                 result.status === 'warning' ? 'text-warning' : 'text-info'}">
                        ${result.message}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html || '<div class="text-muted">暂无测试结果</div>';
            
            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        function clearResults() {
            testResults = [];
            updateTestResultsDisplay();
        }

        async function runAllTests() {
            clearResults();
            addTestResult('开始测试', '运行所有测试...', 'info');
            
            await testFormChangeDetection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSaveButtonState();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testValidation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAutoSave();
            
            addTestResult('测试完成', '所有测试已完成', 'success');
        }

        async function testFormChangeDetection() {
            addTestResult('表单变化检测', '开始测试表单变化检测...', 'info');
            
            try {
                if (!testSaveManager) {
                    throw new Error('SaveManager 未初始化');
                }
                
                // 检查初始状态
                const initialState = testSaveManager.hasUnsavedData();
                addTestResult('初始状态', `初始未保存状态: ${initialState}`, initialState ? 'warning' : 'success');
                
                // 修改表单字段
                const analysisField = document.getElementById('analysis');
                if (analysisField) {
                    analysisField.value = '测试分析内容';
                    analysisField.dispatchEvent(new Event('input'));
                    
                    // 等待变化检测
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const hasChanges = testSaveManager.hasUnsavedData();
                    addTestResult('变化检测', `表单修改后未保存状态: ${hasChanges}`, hasChanges ? 'success' : 'error');
                } else {
                    addTestResult('变化检测', '未找到分析字段', 'error');
                }
                
            } catch (error) {
                addTestResult('表单变化检测', `测试失败: ${error.message}`, 'error');
            }
        }

        async function testSaveButtonState() {
            addTestResult('保存按钮状态', '开始测试保存按钮状态...', 'info');
            
            try {
                const saveButton = document.querySelector('#reviewModal .modal-footer .btn-primary');
                if (!saveButton) {
                    throw new Error('未找到保存按钮');
                }
                
                // 检查按钮状态
                const isDisabled = saveButton.disabled;
                const buttonText = saveButton.textContent.trim();
                
                addTestResult('按钮状态', `按钮禁用状态: ${isDisabled}, 按钮文本: "${buttonText}"`, 'info');
                
                // 修改表单以启用按钮
                const reasonField = document.getElementById('reason');
                if (reasonField) {
                    reasonField.value = '测试决策理由';
                    reasonField.dispatchEvent(new Event('input'));
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const newDisabledState = saveButton.disabled;
                    const newButtonText = saveButton.textContent.trim();
                    
                    addTestResult('按钮更新', `修改后按钮禁用状态: ${newDisabledState}, 按钮文本: "${newButtonText}"`, 
                                 !newDisabledState ? 'success' : 'warning');
                }
                
            } catch (error) {
                addTestResult('保存按钮状态', `测试失败: ${error.message}`, 'error');
            }
        }

        async function testValidation() {
            addTestResult('数据验证', '开始测试数据验证...', 'info');
            
            try {
                if (!testSaveManager) {
                    throw new Error('SaveManager 未初始化');
                }
                
                // 清空必填字段
                const decisionField = document.getElementById('decision');
                const reasonField = document.getElementById('reason');
                
                if (decisionField) decisionField.value = '';
                if (reasonField) reasonField.value = '';
                
                // 尝试保存（应该失败）
                const testData = testSaveManager.collectReviewData();
                const validation = testSaveManager.validateReviewData(testData);
                
                addTestResult('验证结果', `验证通过: ${validation.isValid}, 错误: ${validation.message}`, 
                             !validation.isValid ? 'success' : 'error');
                
                // 填写必填字段
                if (decisionField) decisionField.value = 'hold';
                if (reasonField) reasonField.value = '测试理由';
                
                const testData2 = testSaveManager.collectReviewData();
                const validation2 = testSaveManager.validateReviewData(testData2);
                
                addTestResult('验证修复', `修复后验证通过: ${validation2.isValid}`, 
                             validation2.isValid ? 'success' : 'error');
                
            } catch (error) {
                addTestResult('数据验证', `测试失败: ${error.message}`, 'error');
            }
        }

        async function testAutoSave() {
            addTestResult('自动保存', '开始测试自动保存功能...', 'info');
            
            try {
                if (!testSaveManager) {
                    throw new Error('SaveManager 未初始化');
                }
                
                // 启用自动保存
                testSaveManager.enableAutoSave();
                addTestResult('自动保存', '自动保存已启用', 'success');
                
                // 修改表单
                const analysisField = document.getElementById('analysis');
                if (analysisField) {
                    analysisField.value = '自动保存测试内容 ' + Date.now();
                    analysisField.dispatchEvent(new Event('input'));
                }
                
                addTestResult('自动保存', '表单已修改，等待自动保存触发...', 'info');
                
                // 禁用自动保存
                setTimeout(() => {
                    testSaveManager.disableAutoSave();
                    addTestResult('自动保存', '自动保存已禁用', 'success');
                }, 2000);
                
            } catch (error) {
                addTestResult('自动保存', `测试失败: ${error.message}`, 'error');
            }
        }

        // 监听保存事件
        document.addEventListener('reviewSaved', function(event) {
            addTestResult('保存事件', '收到复盘保存成功事件', 'success');
        });

        document.addEventListener('reviewSaveError', function(event) {
            addTestResult('保存事件', `收到复盘保存失败事件: ${event.detail.error.message}`, 'error');
        });
    </script>
</body>
</html>