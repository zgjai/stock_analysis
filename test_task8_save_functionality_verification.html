<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务8 - 复盘保存功能测试验证</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .test-result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .test-result.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .test-result.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .test-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .test-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin: 20px 0;
        }
        
        .stat-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .mock-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 9999;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .mock-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }
        
        .mock-modal.show {
            display: block;
        }
        
        .mock-modal-backdrop.show {
            display: block;
        }
        
        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .btn-test {
            margin: 5px;
        }
        
        .test-scenario {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 15px 0;
        }
        
        .error-simulation {
            background-color: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="text-center mb-4">
            <h1 class="display-4">
                <i class="fas fa-clipboard-check text-primary"></i>
                任务8 - 复盘保存功能测试验证
            </h1>
            <p class="lead text-muted">全面测试复盘数据保存流程、列表刷新、错误处理和状态变化</p>
        </div>

        <!-- 测试统计 -->
        <div class="test-stats">
            <div class="stat-item">
                <div class="stat-number text-primary" id="total-tests">0</div>
                <div class="stat-label">总测试数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-success" id="passed-tests">0</div>
                <div class="stat-label">通过测试</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-danger" id="failed-tests">0</div>
                <div class="stat-label">失败测试</div>
            </div>
            <div class="stat-item">
                <div class="stat-number text-warning" id="warning-tests">0</div>
                <div class="stat-label">警告测试</div>
            </div>
        </div>

        <!-- 测试进度 -->
        <div class="test-section">
            <h3><i class="fas fa-tasks"></i> 测试进度</h3>
            <div class="progress mb-3">
                <div class="progress-bar bg-primary" id="test-progress" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-primary btn-test" onclick="runAllTests()">
                    <i class="fas fa-play"></i> 运行所有测试
                </button>
                <button class="btn btn-secondary btn-test" onclick="clearResults()">
                    <i class="fas fa-trash"></i> 清除结果
                </button>
                <button class="btn btn-info btn-test" onclick="exportResults()">
                    <i class="fas fa-download"></i> 导出结果
                </button>
            </div>
        </div>

        <!-- 1. 复盘数据完整保存流程测试 -->
        <div class="test-section">
            <h3><i class="fas fa-save"></i> 1. 复盘数据完整保存流程测试</h3>
            <p class="text-muted">测试复盘表单数据的收集、验证和保存完整流程</p>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-outline-primary btn-test" onclick="testDataCollection()">
                        <i class="fas fa-database"></i> 测试数据收集
                    </button>
                    <button class="btn btn-outline-primary btn-test" onclick="testDataValidation()">
                        <i class="fas fa-check-circle"></i> 测试数据验证
                    </button>
                    <button class="btn btn-outline-primary btn-test" onclick="testSaveProcess()">
                        <i class="fas fa-upload"></i> 测试保存流程
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-success btn-test" onclick="testCompleteFlow()">
                        <i class="fas fa-route"></i> 测试完整流程
                    </button>
                    <button class="btn btn-outline-info btn-test" onclick="testFormIntegration()">
                        <i class="fas fa-puzzle-piece"></i> 测试表单集成
                    </button>
                </div>
            </div>
            
            <div id="save-flow-results" class="mt-3"></div>
        </div>

        <!-- 2. 保存成功后列表刷新测试 -->
        <div class="test-section">
            <h3><i class="fas fa-sync-alt"></i> 2. 保存成功后列表刷新测试</h3>
            <p class="text-muted">验证保存成功后复盘列表的自动刷新功能</p>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-outline-success btn-test" onclick="testListRefresh()">
                        <i class="fas fa-list"></i> 测试列表刷新
                    </button>
                    <button class="btn btn-outline-success btn-test" onclick="testAutoRefresh()">
                        <i class="fas fa-redo"></i> 测试自动刷新
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-info btn-test" onclick="testRefreshTiming()">
                        <i class="fas fa-clock"></i> 测试刷新时机
                    </button>
                    <button class="btn btn-outline-warning btn-test" onclick="testRefreshFailure()">
                        <i class="fas fa-exclamation-triangle"></i> 测试刷新失败
                    </button>
                </div>
            </div>
            
            <div id="refresh-results" class="mt-3"></div>
        </div>

        <!-- 3. 错误场景处理测试 -->
        <div class="test-section">
            <h3><i class="fas fa-bug"></i> 3. 错误场景处理测试</h3>
            <p class="text-muted">测试各种错误场景的处理（网络错误、验证错误等）</p>
            
            <div class="row">
                <div class="col-md-4">
                    <h5>网络错误</h5>
                    <button class="btn btn-outline-danger btn-test btn-sm" onclick="testNetworkError()">
                        <i class="fas fa-wifi"></i> 网络中断
                    </button>
                    <button class="btn btn-outline-danger btn-test btn-sm" onclick="testTimeoutError()">
                        <i class="fas fa-hourglass-end"></i> 请求超时
                    </button>
                    <button class="btn btn-outline-danger btn-test btn-sm" onclick="testServerError()">
                        <i class="fas fa-server"></i> 服务器错误
                    </button>
                </div>
                <div class="col-md-4">
                    <h5>验证错误</h5>
                    <button class="btn btn-outline-warning btn-test btn-sm" onclick="testValidationError()">
                        <i class="fas fa-exclamation-circle"></i> 数据验证
                    </button>
                    <button class="btn btn-outline-warning btn-test btn-sm" onclick="testRequiredFields()">
                        <i class="fas fa-asterisk"></i> 必填字段
                    </button>
                    <button class="btn btn-outline-warning btn-test btn-sm" onclick="testDataFormat()">
                        <i class="fas fa-format-list-bulleted"></i> 格式错误
                    </button>
                </div>
                <div class="col-md-4">
                    <h5>业务错误</h5>
                    <button class="btn btn-outline-info btn-test btn-sm" onclick="testBusinessLogic()">
                        <i class="fas fa-business-time"></i> 业务逻辑
                    </button>
                    <button class="btn btn-outline-info btn-test btn-sm" onclick="testPermissionError()">
                        <i class="fas fa-lock"></i> 权限错误
                    </button>
                    <button class="btn btn-outline-info btn-test btn-sm" onclick="testConcurrencyError()">
                        <i class="fas fa-users"></i> 并发冲突
                    </button>
                </div>
            </div>
            
            <div id="error-results" class="mt-3"></div>
        </div>

        <!-- 4. 保存状态变化测试 -->
        <div class="test-section">
            <h3><i class="fas fa-exchange-alt"></i> 4. 保存状态变化测试</h3>
            <p class="text-muted">验证保存状态在不同操作下的正确变化</p>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-outline-primary btn-test" onclick="testStateTransitions()">
                        <i class="fas fa-arrows-alt"></i> 状态转换
                    </button>
                    <button class="btn btn-outline-primary btn-test" onclick="testButtonStates()">
                        <i class="fas fa-mouse-pointer"></i> 按钮状态
                    </button>
                    <button class="btn btn-outline-primary btn-test" onclick="testIndicatorStates()">
                        <i class="fas fa-signal"></i> 指示器状态
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-success btn-test" onclick="testChangeDetection()">
                        <i class="fas fa-search"></i> 变化检测
                    </button>
                    <button class="btn btn-outline-info btn-test" onclick="testUnsavedWarning()">
                        <i class="fas fa-exclamation-triangle"></i> 未保存警告
                    </button>
                </div>
            </div>
            
            <div id="state-results" class="mt-3"></div>
        </div>

        <!-- 5. 性能和用户体验测试 -->
        <div class="test-section">
            <h3><i class="fas fa-tachometer-alt"></i> 5. 性能和用户体验测试</h3>
            <p class="text-muted">测试保存功能的性能表现和用户体验</p>
            
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-outline-success btn-test" onclick="testPerformance()">
                        <i class="fas fa-stopwatch"></i> 性能测试
                    </button>
                    <button class="btn btn-outline-success btn-test" onclick="testLoadingStates()">
                        <i class="fas fa-spinner"></i> 加载状态
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-info btn-test" onclick="testUserFeedback()">
                        <i class="fas fa-comments"></i> 用户反馈
                    </button>
                    <button class="btn btn-outline-info btn-test" onclick="testAccessibility()">
                        <i class="fas fa-universal-access"></i> 可访问性
                    </button>
                </div>
            </div>
            
            <div id="performance-results" class="mt-3"></div>
        </div>

        <!-- 测试日志 -->
        <div class="test-section">
            <h3><i class="fas fa-file-alt"></i> 测试日志</h3>
            <div class="d-flex justify-content-between mb-2">
                <small class="text-muted">实时测试执行日志</small>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                    <i class="fas fa-eraser"></i> 清除日志
                </button>
            </div>
            <div id="test-log" class="test-log"></div>
        </div>

        <!-- 模拟复盘表单 -->
        <div class="mock-modal-backdrop" id="modal-backdrop"></div>
        <div class="mock-modal" id="mock-review-modal">
            <div class="modal-header p-3 border-bottom">
                <h5 class="modal-title">复盘评分 (测试模拟)</h5>
                <button type="button" class="btn-close" onclick="closeMockModal()"></button>
            </div>
            <div class="modal-body p-3">
                <form id="mock-review-form" novalidate>
                    <input type="hidden" id="mock-review-stock-code" value="000001">
                    <input type="hidden" id="mock-review-id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">股票代码</label>
                            <input type="text" class="form-control" id="mock-display-stock-code" value="000001" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">复盘日期</label>
                            <input type="date" class="form-control" id="mock-review-date">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">持仓天数</label>
                            <input type="number" class="form-control" id="mock-holding-days" value="5">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">当前价格</label>
                            <input type="number" class="form-control" id="mock-current-price-input" step="0.01" value="10.50">
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">评分标准 (每项1分，总分5分)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="mock-price-up-score" value="1">
                                        <label class="form-check-label" for="mock-price-up-score">收盘价上升</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="mock-bbi-score" value="1">
                                        <label class="form-check-label" for="mock-bbi-score">不破BBI线</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="mock-volume-score" value="1">
                                        <label class="form-check-label" for="mock-volume-score">无放量阴线</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="mock-trend-score" value="1">
                                        <label class="form-check-label" for="mock-trend-score">趋势还在向上</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="mock-j-score" value="1">
                                        <label class="form-check-label" for="mock-j-score">J没死叉</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">分析内容</label>
                        <textarea class="form-control" id="mock-analysis" rows="3" placeholder="请输入分析内容...">测试分析内容</textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">决策结果</label>
                            <select class="form-select" id="mock-decision">
                                <option value="">请选择决策</option>
                                <option value="hold" selected>继续持有</option>
                                <option value="sell_partial">部分止盈</option>
                                <option value="sell_all">清仓</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">决策理由</label>
                        <textarea class="form-control" id="mock-reason" rows="2" placeholder="请输入决策理由...">测试决策理由</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer p-3 border-top">
                <div class="save-status-indicator me-auto">
                    <small class="text-success">已保存</small>
                </div>
                <button type="button" class="btn btn-secondary" onclick="closeMockModal()">取消</button>
                <button type="button" class="btn btn-primary" id="mock-save-review-btn">保存复盘</button>
            </div>
        </div>
    </div>

    <!-- 引入必要的JavaScript库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- 引入项目的JavaScript文件 -->
    <script src="{{ url_for('static', filename='js/unified-message-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/review-save-manager.js') }}"></script>

    <script>
        // 测试框架
        class SaveFunctionalityTestFramework {
            constructor() {
                this.testResults = [];
                this.currentTest = 0;
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
                this.warningTests = 0;
                this.testLog = [];
                this.mockApiClient = null;
                this.mockReviewSaveManager = null;
                this.init();
            }

            init() {
                this.log('🚀 初始化保存功能测试框架');
                this.setupMockEnvironment();
                this.setupEventListeners();
                this.updateStats();
                this.log('✅ 测试框架初始化完成');
            }

            setupMockEnvironment() {
                this.log('🔧 设置模拟环境');
                
                // 设置当前日期
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('mock-review-date').value = today;
                
                // 创建模拟API客户端
                this.createMockApiClient();
                
                // 创建模拟保存管理器
                this.createMockSaveManager();
                
                this.log('✅ 模拟环境设置完成');
            }

            createMockApiClient() {
                this.mockApiClient = {
                    saveReview: async (reviewData, reviewId = null) => {
                        // 模拟不同的响应场景
                        const scenario = this.getCurrentTestScenario();
                        
                        switch (scenario) {
                            case 'network_error':
                                throw { code: 'NETWORK_ERROR', message: '网络连接失败' };
                            case 'validation_error':
                                throw { code: 'VALIDATION_ERROR', message: '数据验证失败' };
                            case 'server_error':
                                throw { code: 'HTTP_500', message: '服务器内部错误' };
                            case 'timeout_error':
                                await this.delay(15000); // 模拟超时
                                throw { code: 'TIMEOUT_ERROR', message: '请求超时' };
                            case 'success':
                            default:
                                await this.delay(500); // 模拟网络延迟
                                return {
                                    success: true,
                                    data: {
                                        id: reviewId || Date.now(),
                                        ...reviewData,
                                        created_at: new Date().toISOString(),
                                        updated_at: new Date().toISOString()
                                    }
                                };
                        }
                    }
                };
                
                // 替换全局API客户端
                window.apiClient = this.mockApiClient;
            }

            createMockSaveManager() {
                // 等待ReviewSaveManager类加载
                if (typeof ReviewSaveManager !== 'undefined') {
                    this.mockReviewSaveManager = new ReviewSaveManager('#mock-review-form');
                    this.log('✅ 模拟保存管理器创建成功');
                } else {
                    this.log('⚠️ ReviewSaveManager类未找到，将在测试中动态创建');
                }
            }

            setupEventListeners() {
                // 监听保存事件
                document.addEventListener('reviewSaved', (event) => {
                    this.log(`📋 复盘保存成功事件: ${JSON.stringify(event.detail)}`);
                });

                document.addEventListener('reviewSaveError', (event) => {
                    this.log(`❌ 复盘保存失败事件: ${JSON.stringify(event.detail)}`);
                });
            }

            // 工具方法
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            getCurrentTestScenario() {
                return this.currentTestScenario || 'success';
            }

            setTestScenario(scenario) {
                this.currentTestScenario = scenario;
                this.log(`🎭 设置测试场景: ${scenario}`);
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                this.testLog.push(logMessage);
                
                const logElement = document.getElementById('test-log');
                if (logElement) {
                    logElement.textContent = this.testLog.join('\n');
                    logElement.scrollTop = logElement.scrollHeight;
                }
                
                console.log(logMessage);
            }

            addTestResult(testName, success, message, details = null) {
                const result = {
                    name: testName,
                    success: success,
                    message: message,
                    details: details,
                    timestamp: new Date().toISOString()
                };
                
                this.testResults.push(result);
                
                if (success === true) {
                    this.passedTests++;
                } else if (success === false) {
                    this.failedTests++;
                } else {
                    this.warningTests++;
                }
                
                this.totalTests++;
                this.updateStats();
                this.updateProgress();
                
                this.log(`${success === true ? '✅' : success === false ? '❌' : '⚠️'} ${testName}: ${message}`);
                
                return result;
            }

            updateStats() {
                document.getElementById('total-tests').textContent = this.totalTests;
                document.getElementById('passed-tests').textContent = this.passedTests;
                document.getElementById('failed-tests').textContent = this.failedTests;
                document.getElementById('warning-tests').textContent = this.warningTests;
            }

            updateProgress() {
                const progress = this.totalTests > 0 ? (this.currentTest / this.totalTests) * 100 : 0;
                document.getElementById('test-progress').style.width = `${progress}%`;
            }

            displayResults(containerId, results) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                results.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = `test-result ${result.success === true ? 'success' : result.success === false ? 'error' : 'warning'}`;
                    
                    let icon = result.success === true ? 'fas fa-check-circle' : 
                              result.success === false ? 'fas fa-times-circle' : 'fas fa-exclamation-triangle';
                    
                    resultDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="${icon} me-2"></i>
                            <strong>${result.name}</strong>
                        </div>
                        <div class="mt-1">${result.message}</div>
                        ${result.details ? `<div class="mt-1"><small class="text-muted">${result.details}</small></div>` : ''}
                    `;
                    
                    container.appendChild(resultDiv);
                });
            }

            // 测试方法

            // 1. 复盘数据完整保存流程测试
            async testDataCollection() {
                this.log('🔍 开始测试数据收集功能');
                const results = [];
                
                try {
                    // 打开模拟模态框
                    this.openMockModal();
                    
                    // 测试表单数据收集
                    const formData = this.collectMockFormData();
                    
                    if (formData && Object.keys(formData).length > 0) {
                        results.push(this.addTestResult(
                            '表单数据收集',
                            true,
                            `成功收集到 ${Object.keys(formData).length} 个字段的数据`,
                            `字段: ${Object.keys(formData).join(', ')}`
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '表单数据收集',
                            false,
                            '未能收集到表单数据'
                        ));
                    }
                    
                    // 测试必填字段检查
                    constFields = ['stock_code', 'review_date', 'holding_days', 'decision', 'reason'];
                    const missingFields =Fields.filter(field => !formData[field]);
                    
                    if (missingFields.length === 0) {
                        results.push(this.addTestResult(
                            '必填字段检查',
                            true,
                            '所有必填字段都已填写'
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '必填字段检查',
                            false,
                            `缺少必填字段: ${missingFields.join(', ')}`
                        ));
                    }
                    
                    // 测试数据类型转换
                    const typeTests = [
                        { field: 'holding_days', expected: 'number', actual: typeof formData.holding_days },
                        { field: 'current_price', expected: 'number', actual: typeof formData.current_price },
                        { field: 'price_up_score', expected: 'number', actual: typeof formData.price_up_score }
                    ];
                    
                    typeTests.forEach(test => {
                        if (test.actual === test.expected || (test.expected === 'number' && !isNaN(formData[test.field]))) {
                            results.push(this.addTestResult(
                                `${test.field}类型转换`,
                                true,
                                `正确转换为${test.expected}类型`
                            ));
                        } else {
                            results.push(this.addTestResult(
                                `${test.field}类型转换`,
                                false,
                                `期望${test.expected}，实际${test.actual}`
                            ));
                        }
                    });
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '数据收集异常处理',
                        false,
                        `数据收集过程中发生异常: ${error.message}`
                    ));
                }
                
                this.displayResults('save-flow-results', results);
                this.closeMockModal();
            }

            async testDataValidation() {
                this.log('🔍 开始测试数据验证功能');
                const results = [];
                
                try {
                    // 测试有效数据验证
                    const validData = {
                        stock_code: '000001',
                        review_date: '2024-01-15',
                        holding_days: 5,
                        current_price: 10.50,
                        decision: 'hold',
                        reason: '测试理由'
                    };
                    
                    const validationResult = this.validateReviewData(validData);
                    if (validationResult.isValid) {
                        results.push(this.addTestResult(
                            '有效数据验证',
                            true,
                            '有效数据通过验证'
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '有效数据验证',
                            false,
                            `有效数据验证失败: ${validationResult.message}`
                        ));
                    }
                    
                    // 测试无效数据验证
                    const invalidDataTests = [
                        { data: { ...validData, stock_code: '' }, name: '空股票代码' },
                        { data: { ...validData, review_date: '' }, name: '空复盘日期' },
                        { data: { ...validData, holding_days: 0 }, name: '无效持仓天数' },
                        { data: { ...validData, decision: '' }, name: '空决策结果' },
                        { data: { ...validData, reason: '' }, name: '空决策理由' },
                        { data: { ...validData, current_price: -1 }, name: '负数价格' },
                        { data: { ...validData, current_price: 10000 }, name: '超大价格' }
                    ];
                    
                    invalidDataTests.forEach(test => {
                        const validation = this.validateReviewData(test.data);
                        if (!validation.isValid) {
                            results.push(this.addTestResult(
                                `无效数据验证-${test.name}`,
                                true,
                                `正确识别无效数据: ${validation.message}`
                            ));
                        } else {
                            results.push(this.addTestResult(
                                `无效数据验证-${test.name}`,
                                false,
                                '未能识别无效数据'
                            ));
                        }
                    });
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '数据验证异常处理',
                        false,
                        `数据验证过程中发生异常: ${error.message}`
                    ));
                }
                
                this.displayResults('save-flow-results', results);
            }

            async testSaveProcess() {
                this.log('🔍 开始测试保存流程');
                const results = [];
                
                try {
                    this.setTestScenario('success');
                    
                    // 准备测试数据
                    const testData = {
                        stock_code: '000001',
                        review_date: '2024-01-15',
                        holding_days: 5,
                        current_price: 10.50,
                        decision: 'hold',
                        reason: '测试保存流程'
                    };
                    
                    // 测试保存请求
                    const startTime = Date.now();
                    const response = await this.mockApiClient.saveReview(testData);
                    const endTime = Date.now();
                    
                    if (response && response.success) {
                        results.push(this.addTestResult(
                            '保存请求成功',
                            true,
                            `保存成功，耗时 ${endTime - startTime}ms`,
                            `返回数据: ${JSON.stringify(response.data)}`
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '保存请求成功',
                            false,
                            '保存请求未返回成功响应'
                        ));
                    }
                    
                    // 测试响应数据结构
                    if (response.data && response.data.id) {
                        results.push(this.addTestResult(
                            '响应数据结构',
                            true,
                            '响应包含必要的数据结构'
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '响应数据结构',
                            false,
                            '响应数据结构不完整'
                        ));
                    }
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '保存流程异常处理',
                        false,
                        `保存过程中发生异常: ${error.message}`
                    ));
                }
                
                this.displayResults('save-flow-results', results);
            }

            async testCompleteFlow() {
                this.log('🔍 开始测试完整保存流程');
                const results = [];
                
                try {
                    this.openMockModal();
                    
                    // 模拟用户填写表单
                    this.fillMockForm();
                    
                    // 模拟保存管理器
                    if (this.mockReviewSaveManager) {
                        // 测试变化检测
                        this.mockReviewSaveManager.detectChanges();
                        
                        if (this.mockReviewSaveManager.hasUnsavedChanges) {
                            results.push(this.addTestResult(
                                '变化检测',
                                true,
                                '正确检测到表单变化'
                            ));
                        } else {
                            results.push(this.addTestResult(
                                '变化检测',
                                'warning',
                                '未检测到表单变化'
                            ));
                        }
                        
                        // 测试保存流程
                        this.setTestScenario('success');
                        await this.mockReviewSaveManager.saveReview();
                        
                        results.push(this.addTestResult(
                            '完整保存流程',
                            true,
                            '完整保存流程执行成功'
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '保存管理器',
                            false,
                            '保存管理器未初始化'
                        ));
                    }
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '完整流程异常处理',
                        false,
                        `完整流程执行异常: ${error.message}`
                    ));
                }
                
                this.displayResults('save-flow-results', results);
                this.closeMockModal();
            }

            // 2. 列表刷新测试
            async testListRefresh() {
                this.log('🔍 开始测试列表刷新功能');
                const results = [];
                
                try {
                    // 模拟保存成功后的列表刷新
                    let refreshCalled = false;
                    
                    // 模拟loadReviews函数
                    window.loadReviews = () => {
                        refreshCalled = true;
                        this.log('📋 模拟复盘列表刷新');
                        return Promise.resolve();
                    };
                    
                    // 触发保存成功事件
                    document.dispatchEvent(new CustomEvent('reviewSaved', {
                        detail: { 
                            reviewData: { id: 123, stock_code: '000001' },
                            isNew: true
                        }
                    }));
                    
                    // 等待刷新调用
                    await this.delay(1000);
                    
                    if (refreshCalled) {
                        results.push(this.addTestResult(
                            '保存后列表刷新',
                            true,
                            '保存成功后正确触发列表刷新'
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '保存后列表刷新',
                            false,
                            '保存成功后未触发列表刷新'
                        ));
                    }
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '列表刷新异常处理',
                        false,
                        `列表刷新测试异常: ${error.message}`
                    ));
                }
                
                this.displayResults('refresh-results', results);
            }

            // 3. 错误场景测试
            async testNetworkError() {
                this.log('🔍 开始测试网络错误处理');
                const results = [];
                
                try {
                    this.setTestScenario('network_error');
                    
                    const testData = {
                        stock_code: '000001',
                        review_date: '2024-01-15',
                        holding_days: 5,
                        decision: 'hold',
                        reason: '测试网络错误'
                    };
                    
                    try {
                        await this.mockApiClient.saveReview(testData);
                        results.push(this.addTestResult(
                            '网络错误处理',
                            false,
                            '网络错误未被正确抛出'
                        ));
                    } catch (error) {
                        if (error.code === 'NETWORK_ERROR') {
                            results.push(this.addTestResult(
                                '网络错误处理',
                                true,
                                '正确处理网络错误',
                                `错误信息: ${error.message}`
                            ));
                        } else {
                            results.push(this.addTestResult(
                                '网络错误处理',
                                false,
                                `错误类型不匹配: ${error.code}`
                            ));
                        }
                    }
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '网络错误测试异常',
                        false,
                        `网络错误测试异常: ${error.message}`
                    ));
                }
                
                this.displayResults('error-results', results);
            }

            async testValidationError() {
                this.log('🔍 开始测试验证错误处理');
                const results = [];
                
                try {
                    this.setTestScenario('validation_error');
                    
                    const invalidData = {
                        stock_code: '',
                        review_date: '',
                        holding_days: 0,
                        decision: '',
                        reason: ''
                    };
                    
                    try {
                        await this.mockApiClient.saveReview(invalidData);
                        results.push(this.addTestResult(
                            '验证错误处理',
                            false,
                            '验证错误未被正确抛出'
                        ));
                    } catch (error) {
                        if (error.code === 'VALIDATION_ERROR') {
                            results.push(this.addTestResult(
                                '验证错误处理',
                                true,
                                '正确处理验证错误',
                                `错误信息: ${error.message}`
                            ));
                        } else {
                            results.push(this.addTestResult(
                                '验证错误处理',
                                false,
                                `错误类型不匹配: ${error.code}`
                            ));
                        }
                    }
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '验证错误测试异常',
                        false,
                        `验证错误测试异常: ${error.message}`
                    ));
                }
                
                this.displayResults('error-results', results);
            }

            // 4. 状态变化测试
            async testStateTransitions() {
                this.log('🔍 开始测试状态转换');
                const results = [];
                
                try {
                    this.openMockModal();
                    
                    if (this.mockReviewSaveManager) {
                        // 测试初始状态
                        const initialState = this.mockReviewSaveManager.hasUnsavedChanges;
                        results.push(this.addTestResult(
                            '初始状态',
                            !initialState,
                            `初始状态正确: ${initialState ? '有未保存更改' : '无未保存更改'}`
                        ));
                        
                        // 模拟表单变化
                        const reasonField = document.getElementById('mock-reason');
                        if (reasonField) {
                            reasonField.value = '测试状态变化 - ' + Date.now();
                            reasonField.dispatchEvent(new Event('input'));
                            
                            // 等待变化检测
                            await this.delay(500);
                            
                            const changedState = this.mockReviewSaveManager.hasUnsavedChanges;
                            results.push(this.addTestResult(
                                '变化后状态',
                                changedState,
                                `变化检测正确: ${changedState ? '检测到更改' : '未检测到更改'}`
                            ));
                        }
                        
                        // 测试保存后状态
                        this.setTestScenario('success');
                        await this.mockReviewSaveManager.saveReview();
                        
                        const savedState = this.mockReviewSaveManager.hasUnsavedChanges;
                        results.push(this.addTestResult(
                            '保存后状态',
                            !savedState,
                            `保存后状态正确: ${savedState ? '仍有未保存更改' : '已保存'}`
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '状态转换测试',
                            false,
                            '保存管理器未初始化'
                        ));
                    }
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '状态转换异常处理',
                        false,
                        `状态转换测试异常: ${error.message}`
                    ));
                }
                
                this.displayResults('state-results', results);
                this.closeMockModal();
            }

            // 5. 性能测试
            async testPerformance() {
                this.log('🔍 开始测试性能表现');
                const results = [];
                
                try {
                    const testData = {
                        stock_code: '000001',
                        review_date: '2024-01-15',
                        holding_days: 5,
                        decision: 'hold',
                        reason: '性能测试数据'
                    };
                    
                    // 测试保存响应时间
                    this.setTestScenario('success');
                    const startTime = performance.now();
                    await this.mockApiClient.saveReview(testData);
                    const endTime = performance.now();
                    const responseTime = endTime - startTime;
                    
                    if (responseTime < 2000) {
                        results.push(this.addTestResult(
                            '保存响应时间',
                            true,
                            `响应时间良好: ${responseTime.toFixed(2)}ms`
                        ));
                    } else if (responseTime < 5000) {
                        results.push(this.addTestResult(
                            '保存响应时间',
                            'warning',
                            `响应时间较慢: ${responseTime.toFixed(2)}ms`
                        ));
                    } else {
                        results.push(this.addTestResult(
                            '保存响应时间',
                            false,
                            `响应时间过慢: ${responseTime.toFixed(2)}ms`
                        ));
                    }
                    
                    // 测试内存使用
                    if (performance.memory) {
                        const memoryInfo = performance.memory;
                        results.push(this.addTestResult(
                            '内存使用情况',
                            true,
                            `已使用: ${(memoryInfo.usedJSHeapSize / 1024 / 1024).toFixed(2)}MB`,
                            `总计: ${(memoryInfo.totalJSHeapSize / 1024 / 1024).toFixed(2)}MB`
                        ));
                    }
                    
                } catch (error) {
                    results.push(this.addTestResult(
                        '性能测试异常处理',
                        false,
                        `性能测试异常: ${error.message}`
                    ));
                }
                
                this.displayResults('performance-results', results);
            }

            // 辅助方法
            openMockModal() {
                document.getElementById('modal-backdrop').classList.add('show');
                document.getElementById('mock-review-modal').classList.add('show');
            }

            closeMockModal() {
                document.getElementById('modal-backdrop').classList.remove('show');
                document.getElementById('mock-review-modal').classList.remove('show');
            }

            fillMockForm() {
                // 填写表单数据
                document.getElementById('mock-review-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('mock-holding-days').value = '5';
                document.getElementById('mock-current-price-input').value = '10.50';
                document.getElementById('mock-price-up-score').checked = true;
                document.getElementById('mock-bbi-score').checked = true;
                document.getElementById('mock-analysis').value = '测试分析内容';
                document.getElementById('mock-decision').value = 'hold';
                document.getElementById('mock-reason').value = '测试决策理由';
            }

            collectMockFormData() {
                const form = document.getElementById('mock-review-form');
                if (!form) return null;

                const formData = {};
                const elements = form.querySelectorAll('input, select, textarea');
                
                elements.forEach(element => {
                    const name = element.name || element.id.replace('mock-', '');
                    if (!name || name.startsWith('mock-')) return;

                    if (element.type === 'checkbox') {
                        formData[name] = element.checked ? 1 : 0;
                    } else if (element.type === 'number') {
                        formData[name] = parseFloat(element.value) || 0;
                    } else {
                        formData[name] = element.value;
                    }
                });

                return formData;
            }

            validateReviewData(data) {
                const errors = [];

                if (!data.stock_code) errors.push('股票代码不能为空');
                if (!data.review_date) errors.push('复盘日期不能为空');
                if (!data.holding_days || data.holding_days < 1) errors.push('持仓天数必须大于0');
                if (!data.decision) errors.push('请选择决策结果');
                if (!data.reason || !data.reason.trim()) errors.push('决策理由不能为空');
                if (data.current_price !== null && (data.current_price <= 0 || data.current_price > 9999.99)) {
                    errors.push('当前价格必须在0.01-9999.99之间');
                }

                return {
                    isValid: errors.length === 0,
                    message: errors.join('；'),
                    errors: errors
                };
            }

            // 运行所有测试
            async runAllTests() {
                this.log('🚀 开始运行所有测试');
                this.clearResults();
                
                const testMethods = [
                    'testDataCollection',
                    'testDataValidation', 
                    'testSaveProcess',
                    'testCompleteFlow',
                    'testListRefresh',
                    'testNetworkError',
                    'testValidationError',
                    'testStateTransitions',
                    'testPerformance'
                ];
                
                this.totalTests = testMethods.length;
                
                for (let i = 0; i < testMethods.length; i++) {
                    this.currentTest = i + 1;
                    this.updateProgress();
                    
                    try {
                        await this[testMethods[i]]();
                        await this.delay(500); // 测试间隔
                    } catch (error) {
                        this.log(`❌ 测试 ${testMethods[i]} 执行失败: ${error.message}`);
                    }
                }
                
                this.log('🎉 所有测试执行完成');
                this.generateSummaryReport();
            }

            generateSummaryReport() {
                const summary = {
                    totalTests: this.totalTests,
                    passedTests: this.passedTests,
                    failedTests: this.failedTests,
                    warningTests: this.warningTests,
                    successRate: this.totalTests > 0 ? ((this.passedTests / this.totalTests) * 100).toFixed(2) : 0,
                    testResults: this.testResults
                };
                
                this.log(`📊 测试总结报告:`);
                this.log(`   总测试数: ${summary.totalTests}`);
                this.log(`   通过测试: ${summary.passedTests}`);
                this.log(`   失败测试: ${summary.failedTests}`);
                this.log(`   警告测试: ${summary.warningTests}`);
                this.log(`   成功率: ${summary.successRate}%`);
                
                return summary;
            }

            clearResults() {
                this.testResults = [];
                this.currentTest = 0;
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
                this.warningTests = 0;
                this.updateStats();
                this.updateProgress();
                
                // 清除结果显示
                ['save-flow-results', 'refresh-results', 'error-results', 'state-results', 'performance-results'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.innerHTML = '';
                });
            }

            clearLog() {
                this.testLog = [];
                const logElement = document.getElementById('test-log');
                if (logElement) logElement.textContent = '';
            }

            exportResults() {
                const summary = this.generateSummaryReport();
                const dataStr = JSON.stringify(summary, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `save_functionality_test_results_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                this.log('📁 测试结果已导出');
            }
        }

        // 初始化测试框架
        let testFramework;
        
        document.addEventListener('DOMContentLoaded', function() {
            testFramework = new SaveFunctionalityTestFramework();
        });

        // 全局测试函数
        function runAllTests() {
            if (testFramework) testFramework.runAllTests();
        }

        function clearResults() {
            if (testFramework) testFramework.clearResults();
        }

        function clearLog() {
            if (testFramework) testFramework.clearLog();
        }

        function exportResults() {
            if (testFramework) testFramework.exportResults();
        }

        function closeMockModal() {
            if (testFramework) testFramework.closeMockModal();
        }

        // 具体测试函数
        function testDataCollection() {
            if (testFramework) testFramework.testDataCollection();
        }

        function testDataValidation() {
            if (testFramework) testFramework.testDataValidation();
        }

        function testSaveProcess() {
            if (testFramework) testFramework.testSaveProcess();
        }

        function testCompleteFlow() {
            if (testFramework) testFramework.testCompleteFlow();
        }

        function testFormIntegration() {
            if (testFramework) testFramework.testCompleteFlow();
        }

        function testListRefresh() {
            if (testFramework) testFramework.testListRefresh();
        }

        function testAutoRefresh() {
            if (testFramework) testFramework.testListRefresh();
        }

        function testRefreshTiming() {
            if (testFramework) testFramework.testListRefresh();
        }

        function testRefreshFailure() {
            if (testFramework) testFramework.testListRefresh();
        }

        function testNetworkError() {
            if (testFramework) testFramework.testNetworkError();
        }

        function testTimeoutError() {
            if (testFramework) {
                testFramework.setTestScenario('timeout_error');
                testFramework.testNetworkError();
            }
        }

        function testServerError() {
            if (testFramework) {
                testFramework.setTestScenario('server_error');
                testFramework.testNetworkError();
            }
        }

        function testValidationError() {
            if (testFramework) testFramework.testValidationError();
        }

        function testRequiredFields() {
            if (testFramework) testFramework.testValidationError();
        }

        function testDataFormat() {
            if (testFramework) testFramework.testValidationError();
        }

        function testBusinessLogic() {
            if (testFramework) testFramework.testValidationError();
        }

        function testPermissionError() {
            if (testFramework) testFramework.testValidationError();
        }

        function testConcurrencyError() {
            if (testFramework) testFramework.testValidationError();
        }

        function testStateTransitions() {
            if (testFramework) testFramework.testStateTransitions();
        }

        function testButtonStates() {
            if (testFramework) testFramework.testStateTransitions();
        }

        function testIndicatorStates() {
            if (testFramework) testFramework.testStateTransitions();
        }

        function testChangeDetection() {
            if (testFramework) testFramework.testStateTransitions();
        }

        function testUnsavedWarning() {
            if (testFramework) testFramework.testStateTransitions();
        }

        function testPerformance() {
            if (testFramework) testFramework.testPerformance();
        }

        function testLoadingStates() {
            if (testFramework) testFramework.testPerformance();
        }

        function testUserFeedback() {
            if (testFramework) testFramework.testPerformance();
        }

        function testAccessibility() {
            if (testFramework) testFramework.testPerformance();
        }
    </script>
</body>
</html>