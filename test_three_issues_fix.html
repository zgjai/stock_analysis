<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三个问题修复验证测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>三个问题修复验证测试</h2>
        
        <!-- 问题1: 卖出交易止盈验证测试 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>问题1: 卖出交易止盈验证测试</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>测试场景：编辑卖出交易</h6>
                        <form id="sell-trade-form">
                            <div class="mb-3">
                                <label class="form-label">股票代码</label>
                                <input type="text" class="form-control" name="stock_code" value="002643" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">股票名称</label>
                                <input type="text" class="form-control" name="stock_name" value="万润股份" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">交易类型</label>
                                <select class="form-control" name="trade_type">
                                    <option value="sell" selected>卖出</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">价格</label>
                                <input type="number" class="form-control" name="price" value="12.64" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">数量</label>
                                <input type="number" class="form-control" name="quantity" value="18000" step="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">操作原因</label>
                                <select class="form-control" name="reason">
                                    <option value="止损">止损</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="testSellTradeSubmit()">
                                测试提交卖出交易
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h6>测试结果</h6>
                        <div id="sell-trade-result" class="alert alert-info">
                            等待测试...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 问题2: 复盘记录显示测试 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>问题2: 复盘记录显示测试</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-primary" onclick="testLoadReviews()">
                            测试加载复盘记录
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="testCreateReview()">
                            测试创建复盘记录
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>测试结果</h6>
                        <div id="reviews-test-result" class="alert alert-info">
                            等待测试...
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>复盘记录列表</h6>
                    <div id="reviews-list-test" class="border p-3" style="min-height: 200px;">
                        <!-- 复盘记录将显示在这里 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 问题3: 持仓策略提醒测试 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>问题3: 持仓策略提醒测试</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-primary" onclick="testLoadHoldingAlerts()">
                            测试加载持仓策略提醒
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="testEvaluateStrategy()">
                            测试策略评估
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>测试结果</h6>
                        <div id="alerts-test-result" class="alert alert-info">
                            等待测试...
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>持仓策略提醒</h6>
                    <div id="holding-alerts-test" class="border p-3" style="min-height: 200px;">
                        <!-- 策略提醒将显示在这里 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 测试1: 卖出交易提交
        async function testSellTradeSubmit() {
            const resultDiv = document.getElementById('sell-trade-result');
            resultDiv.className = 'alert alert-info';
            resultDiv.innerHTML = '正在测试...';
            
            try {
                const formData = new FormData(document.getElementById('sell-trade-form'));
                const data = Object.fromEntries(formData.entries());
                
                console.log('[TEST] 卖出交易数据:', data);
                
                // 模拟前端处理逻辑
                const isBuyTrade = data.trade_type === 'buy';
                if (!isBuyTrade) {
                    // 卖出交易应该清空止盈相关字段
                    delete data.use_batch_profit_taking;
                    delete data.profit_targets;
                    delete data.take_profit_ratio;
                    delete data.sell_ratio;
                    delete data.stop_loss_price;
                }
                
                console.log('[TEST] 处理后的数据:', data);
                
                // 发送API请求
                const response = await fetch('/api/trades/3', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('[TEST] API响应:', result);
                
                if (response.ok && result.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        <strong>测试通过！</strong><br>
                        卖出交易提交成功，没有止盈验证错误。
                    `;
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <strong>测试失败！</strong><br>
                        错误信息: ${result.message || '未知错误'}
                    `;
                }
            } catch (error) {
                console.error('[TEST] 测试错误:', error);
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `
                    <i class="fas fa-times-circle"></i> 
                    <strong>测试异常！</strong><br>
                    ${error.message}
                `;
            }
        }
        
        // 测试2: 复盘记录加载
        async function testLoadReviews() {
            const resultDiv = document.getElementById('reviews-test-result');
            const listDiv = document.getElementById('reviews-list-test');
            
            resultDiv.className = 'alert alert-info';
            resultDiv.innerHTML = '正在测试...';
            
            try {
                console.log('[TEST] 开始加载复盘记录...');
                const response = await fetch('/api/reviews');
                console.log('[TEST] API响应状态:', response.status);
                const data = await response.json();
                console.log('[TEST] 复盘记录数据:', data);
                
                if (data.success && data.data) {
                    const reviews = data.data.reviews || data.data;
                    console.log('[TEST] 处理复盘记录:', reviews);
                    
                    if (reviews && reviews.length > 0) {
                        resultDiv.className = 'alert alert-success';
                        resultDiv.innerHTML = `
                            <i class="fas fa-check-circle"></i> 
                            <strong>测试通过！</strong><br>
                            成功加载 ${reviews.length} 条复盘记录。
                        `;
                        
                        // 显示复盘记录
                        listDiv.innerHTML = reviews.map(review => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6>${review.stock_code} - ${review.stock_name}</h6>
                                    <p class="mb-1">复盘日期: ${review.review_date}</p>
                                    <p class="mb-0">决策: ${review.decision || '未设置'}</p>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        resultDiv.className = 'alert alert-warning';
                        resultDiv.innerHTML = `
                            <i class="fas fa-info-circle"></i> 
                            <strong>数据为空</strong><br>
                            API返回成功但没有复盘记录数据。
                        `;
                        
                        listDiv.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                <p>暂无复盘记录</p>
                                <p class="small">开始您的第一次复盘分析</p>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <strong>测试失败！</strong><br>
                        API返回错误: ${data.message || '未知错误'}
                    `;
                }
            } catch (error) {
                console.error('[TEST] 测试错误:', error);
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `
                    <i class="fas fa-times-circle"></i> 
                    <strong>测试异常！</strong><br>
                    ${error.message}
                `;
            }
        }
        
        // 测试3: 持仓策略提醒加载
        async function testLoadHoldingAlerts() {
            const resultDiv = document.getElementById('alerts-test-result');
            const alertsDiv = document.getElementById('holding-alerts-test');
            
            resultDiv.className = 'alert alert-info';
            resultDiv.innerHTML = '正在测试...';
            
            try {
                console.log('[TEST] 开始加载持仓策略提醒...');
                const response = await fetch('/api/holdings/alerts');
                console.log('[TEST] 策略提醒API响应状态:', response.status);
                const data = await response.json();
                console.log('[TEST] 策略提醒数据:', data);
                
                if (data.success && data.data) {
                    const alerts = Array.isArray(data.data) ? data.data : [data.data];
                    console.log('[TEST] 处理策略提醒:', alerts);
                    
                    if (alerts.length > 0) {
                        resultDiv.className = 'alert alert-success';
                        resultDiv.innerHTML = `
                            <i class="fas fa-check-circle"></i> 
                            <strong>测试通过！</strong><br>
                            成功加载 ${alerts.length} 条策略提醒。
                        `;
                        
                        // 显示策略提醒
                        alertsDiv.innerHTML = alerts.map(alert => `
                            <div class="alert alert-warning mb-2">
                                <h6><i class="fas fa-exclamation-triangle"></i> ${alert.stock_code}</h6>
                                <p class="mb-1">${alert.message || alert.description}</p>
                                <small class="text-muted">建议: ${alert.action || '请关注'}</small>
                            </div>
                        `).join('');
                    } else {
                        resultDiv.className = 'alert alert-info';
                        resultDiv.innerHTML = `
                            <i class="fas fa-info-circle"></i> 
                            <strong>无提醒</strong><br>
                            当前没有策略提醒，持仓状况良好。
                        `;
                        
                        alertsDiv.innerHTML = `
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                                <p>暂无策略提醒</p>
                                <small class="text-muted">当前持仓状况良好</small>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <strong>测试失败！</strong><br>
                        API返回错误: ${data.message || '未知错误'}
                    `;
                }
            } catch (error) {
                console.error('[TEST] 测试错误:', error);
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `
                    <i class="fas fa-times-circle"></i> 
                    <strong>测试异常！</strong><br>
                    ${error.message}
                `;
            }
        }
        
        // 创建测试复盘记录
        async function testCreateReview() {
            try {
                const testReview = {
                    stock_code: '000776',
                    stock_name: '广发证券',
                    review_date: new Date().toISOString().split('T')[0],
                    decision: 'hold',
                    analysis: '测试复盘记录',
                    price_up_score: 3,
                    bbi_score: 3,
                    volume_score: 3,
                    trend_score: 3,
                    j_score: 3
                };
                
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testReview)
                });
                
                const result = await response.json();
                console.log('[TEST] 创建复盘记录结果:', result);
                
                if (result.success) {
                    alert('测试复盘记录创建成功！');
                    testLoadReviews(); // 重新加载列表
                } else {
                    alert('创建失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('[TEST] 创建复盘记录错误:', error);
                alert('创建异常: ' + error.message);
            }
        }
        
        // 测试策略评估
        async function testEvaluateStrategy() {
            try {
                const response = await fetch('/api/holdings/alerts/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                console.log('[TEST] 策略评估结果:', result);
                
                if (result.success) {
                    alert('策略评估完成！');
                    testLoadHoldingAlerts(); // 重新加载提醒
                } else {
                    alert('评估失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('[TEST] 策略评估错误:', error);
                alert('评估异常: ' + error.message);
            }
        }
        
        // 页面加载时自动运行测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[TEST] 页面加载完成，开始自动测试...');
            
            // 延迟执行测试，确保页面完全加载
            setTimeout(() => {
                testLoadReviews();
                testLoadHoldingAlerts();
            }, 1000);
        });
    </script>
</body>
</html>