<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»·æ ¼ä¼˜åŒ–æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-rocket text-primary"></i>
                    ä»·æ ¼æœåŠ¡ä¼˜åŒ–æµ‹è¯•
                </h1>
                
                <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs"></i>
                            æµ‹è¯•æ§åˆ¶é¢æ¿
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary me-2" onclick="testGetHoldings()">
                                    <i class="fas fa-list"></i>
                                    è·å–æŒä»“åˆ—è¡¨
                                </button>
                                <button class="btn btn-success me-2" onclick="testBatchRefresh()">
                                    <i class="fas fa-sync-alt"></i>
                                    æ‰¹é‡åˆ·æ–°ä»·æ ¼
                                </button>
                                <button class="btn btn-info me-2" onclick="testCacheInfo()">
                                    <i class="fas fa-database"></i>
                                    æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-warning me-2" onclick="testOptimizedFlow()">
                                    <i class="fas fa-magic"></i>
                                    å®Œæ•´ä¼˜åŒ–æµç¨‹
                                </button>
                                <button class="btn btn-secondary" onclick="clearResults()">
                                    <i class="fas fa-trash"></i>
                                    æ¸…ç©ºç»“æœ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line"></i>
                            æµ‹è¯•ç»“æœ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="text-muted text-center py-4">
                                <i class="fas fa-play-circle fa-2x mb-2"></i>
                                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5001/api';
        
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';
            
            const resultHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-clock"></i>
                        ${timestamp} - ${title}
                    </h6>
                    <div>${content}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            if (resultsDiv.innerHTML.includes('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•')) {
                resultsDiv.innerHTML = resultHtml;
            } else {
                resultsDiv.insertAdjacentHTML('afterbegin', resultHtml);
            }
        }
        
        function formatTime(seconds) {
            return seconds.toFixed(2) + 's';
        }
        
        async function testGetHoldings() {
            const startTime = performance.now();
            
            try {
                addResult('è·å–æŒä»“åˆ—è¡¨', 'æ­£åœ¨è¯·æ±‚...', 'info');
                
                const response = await fetch(`${API_BASE}/holdings`);
                const data = await response.json();
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                
                if (data.success) {
                    const holdings = data.data;
                    const content = `
                        <strong>âœ… è·å–æˆåŠŸ</strong><br>
                        ğŸ“Š æŒä»“æ•°é‡: ${holdings.length} åª<br>
                        â±ï¸ è€—æ—¶: ${formatTime(duration)}<br>
                        ğŸ“‹ è‚¡ç¥¨ä»£ç : ${holdings.map(h => h.stock_code).join(', ')}
                    `;
                    addResult('è·å–æŒä»“åˆ—è¡¨', content, 'success');
                } else {
                    addResult('è·å–æŒä»“åˆ—è¡¨', `âŒ å¤±è´¥: ${data.message}`, 'error');
                }
                
            } catch (error) {
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                addResult('è·å–æŒä»“åˆ—è¡¨', `âŒ è¯·æ±‚å¤±è´¥: ${error.message} (è€—æ—¶: ${formatTime(duration)})`, 'error');
            }
        }
        
        async function testBatchRefresh() {
            const startTime = performance.now();
            
            try {
                addResult('æ‰¹é‡åˆ·æ–°ä»·æ ¼', 'æ­£åœ¨è·å–æŒä»“åˆ—è¡¨...', 'info');
                
                // å…ˆè·å–æŒä»“åˆ—è¡¨
                const holdingsResponse = await fetch(`${API_BASE}/holdings`);
                const holdingsData = await holdingsResponse.json();
                
                if (!holdingsData.success || !holdingsData.data.length) {
                    addResult('æ‰¹é‡åˆ·æ–°ä»·æ ¼', 'âŒ æ²¡æœ‰æŒä»“æ•°æ®', 'error');
                    return;
                }
                
                const stockCodes = holdingsData.data.map(h => h.stock_code);
                addResult('æ‰¹é‡åˆ·æ–°ä»·æ ¼', `æ­£åœ¨åˆ·æ–° ${stockCodes.length} åªè‚¡ç¥¨ä»·æ ¼...`, 'info');
                
                // æ‰¹é‡åˆ·æ–°ä»·æ ¼
                const refreshResponse = await fetch(`${API_BASE}/holdings/refresh-prices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stock_codes: stockCodes,
                        force_refresh: true
                    })
                });
                
                const refreshData = await refreshResponse.json();
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                
                if (refreshData.success) {
                    const result = refreshData.data;
                    const performance = result.performance || {};
                    
                    const content = `
                        <strong>âœ… æ‰¹é‡åˆ·æ–°æˆåŠŸ</strong><br>
                        ğŸ“Š æˆåŠŸ: ${result.success_count}/${stockCodes.length}<br>
                        âŒ å¤±è´¥: ${result.failed_count}<br>
                        â±ï¸ æ€»è€—æ—¶: ${formatTime(duration)}<br>
                        ğŸ” APIæ—¶é—´: ${formatTime(performance.api_time || 0)}<br>
                        ğŸ” å¤„ç†æ—¶é—´: ${formatTime(performance.processing_time || 0)}<br>
                        ğŸš€ å¤„ç†é€Ÿåº¦: ${(performance.stocks_per_second || 0).toFixed(1)} è‚¡ç¥¨/ç§’
                    `;
                    addResult('æ‰¹é‡åˆ·æ–°ä»·æ ¼', content, 'success');
                    
                    if (result.errors && result.errors.length > 0) {
                        const errorContent = `
                            <strong>âš ï¸ éƒ¨åˆ†å¤±è´¥</strong><br>
                            ${result.errors.map(e => `${e.stock_code}: ${e.error}`).join('<br>')}
                        `;
                        addResult('åˆ·æ–°é”™è¯¯è¯¦æƒ…', errorContent, 'warning');
                    }
                } else {
                    addResult('æ‰¹é‡åˆ·æ–°ä»·æ ¼', `âŒ å¤±è´¥: ${refreshData.message}`, 'error');
                }
                
            } catch (error) {
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                addResult('æ‰¹é‡åˆ·æ–°ä»·æ ¼', `âŒ è¯·æ±‚å¤±è´¥: ${error.message} (è€—æ—¶: ${formatTime(duration)})`, 'error');
            }
        }
        
        async function testCacheInfo() {
            const startTime = performance.now();
            
            try {
                addResult('ç¼“å­˜çŠ¶æ€æŸ¥è¯¢', 'æ­£åœ¨æŸ¥è¯¢...', 'info');
                
                const response = await fetch(`${API_BASE}/price-service/cache-info`);
                const data = await response.json();
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                
                if (data.success) {
                    const cache = data.data;
                    const content = `
                        <strong>âœ… ç¼“å­˜ä¿¡æ¯è·å–æˆåŠŸ</strong><br>
                        ğŸ—„ï¸ æ˜¯å¦æœ‰ç¼“å­˜: ${cache.has_cache ? 'æ˜¯' : 'å¦'}<br>
                        â° ç¼“å­˜æ—¶é—´: ${cache.cache_timestamp || 'æ— '}<br>
                        ğŸ“… ç¼“å­˜å¹´é¾„: ${cache.cache_age_seconds ? formatTime(cache.cache_age_seconds) : 'æ— '}<br>
                        âœ… ç¼“å­˜æœ‰æ•ˆ: ${cache.cache_valid ? 'æ˜¯' : 'å¦'}<br>
                        ğŸ“Š ç¼“å­˜è‚¡ç¥¨æ•°: ${cache.cached_stocks_count}<br>
                        â±ï¸ ç¼“å­˜æ—¶é•¿: ${cache.cache_duration_minutes}åˆ†é’Ÿ<br>
                        ğŸš€ æŸ¥è¯¢è€—æ—¶: ${formatTime(duration)}
                    `;
                    addResult('ç¼“å­˜çŠ¶æ€æŸ¥è¯¢', content, 'success');
                } else {
                    addResult('ç¼“å­˜çŠ¶æ€æŸ¥è¯¢', `âŒ å¤±è´¥: ${data.message}`, 'error');
                }
                
            } catch (error) {
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                addResult('ç¼“å­˜çŠ¶æ€æŸ¥è¯¢', `âŒ è¯·æ±‚å¤±è´¥: ${error.message} (è€—æ—¶: ${formatTime(duration)})`, 'error');
            }
        }
        
        async function testOptimizedFlow() {
            const startTime = performance.now();
            
            try {
                addResult('å®Œæ•´ä¼˜åŒ–æµç¨‹', 'ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...', 'info');
                
                // 1. è·å–æŒä»“
                addResult('æµç¨‹æ­¥éª¤ 1/4', 'è·å–æŒä»“åˆ—è¡¨...', 'info');
                await testGetHoldings();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 2. æ‰¹é‡åˆ·æ–°
                addResult('æµç¨‹æ­¥éª¤ 2/4', 'æ‰¹é‡åˆ·æ–°ä»·æ ¼...', 'info');
                await testBatchRefresh();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. æŸ¥çœ‹ç¼“å­˜
                addResult('æµç¨‹æ­¥éª¤ 3/4', 'æŸ¥çœ‹ç¼“å­˜çŠ¶æ€...', 'info');
                await testCacheInfo();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 4. å†æ¬¡è·å–ï¼ˆæµ‹è¯•ç¼“å­˜æ•ˆæœï¼‰
                addResult('æµç¨‹æ­¥éª¤ 4/4', 'æµ‹è¯•ç¼“å­˜æ•ˆæœ...', 'info');
                await testGetHoldings();
                
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                
                const content = `
                    <strong>ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ</strong><br>
                    â±ï¸ æ€»è€—æ—¶: ${formatTime(duration)}<br>
                    ğŸ“ˆ ä¼˜åŒ–æ•ˆæœ: åç»­è¯·æ±‚æ˜æ˜¾åŠ é€Ÿ<br>
                    ğŸ’¡ ç¼“å­˜æœºåˆ¶: æœ‰æ•ˆå‡å°‘APIè°ƒç”¨
                `;
                addResult('å®Œæ•´ä¼˜åŒ–æµç¨‹', content, 'success');
                
            } catch (error) {
                addResult('å®Œæ•´ä¼˜åŒ–æµç¨‹', `âŒ æµç¨‹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function clearResults() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `
                <div class="text-muted text-center py-4">
                    <i class="fas fa-play-circle fa-2x mb-2"></i>
                    <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
                </div>
            `;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            addResult('ç³»ç»Ÿå°±ç»ª', 'ä»·æ ¼ä¼˜åŒ–æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼', 'info');
        });
    </script>
</body>
</html>