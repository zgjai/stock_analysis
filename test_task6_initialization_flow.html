<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 6 - é¡µé¢åˆå§‹åŒ–æµç¨‹æ§åˆ¶æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Task 6 - é¡µé¢åˆå§‹åŒ–æµç¨‹æ§åˆ¶æµ‹è¯•</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•ç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="text-center">
                                <div class="spinner-border" role="status"></div>
                                <p>æ­£åœ¨æµ‹è¯•åˆå§‹åŒ–æµç¨‹...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•æ§åˆ¶</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100 mb-2" onclick="runInitializationTest()">é‡æ–°æµ‹è¯•åˆå§‹åŒ–</button>
                        <button class="btn btn-info w-100 mb-2" onclick="showInitializationReport()">æ˜¾ç¤ºåˆå§‹åŒ–æŠ¥å‘Š</button>
                        <button class="btn btn-warning w-100 mb-2" onclick="exportInitializationLogs()">å¯¼å‡ºæ—¥å¿—</button>
                        <button class="btn btn-secondary w-100" onclick="clearInitializationLogs()">æ¸…é™¤æ—¥å¿—</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ‹Ÿå¤ç›˜æ¨¡æ€æ¡† -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æµ‹è¯•æ¨¡æ€æ¡†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="review-form">
                        <input type="hidden" id="review-stock-code">
                        <input type="hidden" id="review-id">
                        
                        <div class="mb-3">
                            <label class="form-label">å½“å‰ä»·æ ¼</label>
                            <input type="number" class="form-control" id="current-price-input" step="0.01">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">æˆæœ¬ä»·</label>
                            <div class="form-control-plaintext" id="buy-price-display">10.50</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">æµ®ç›ˆæ¯”ä¾‹</label>
                            <div class="floating-profit-container">
                                <div class="form-control-plaintext fw-bold" id="floating-profit-ratio">--</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="price-up-score" value="1">
                                <label class="form-check-label" for="price-up-score">æ”¶ç›˜ä»·ä¸Šå‡</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="bbi-score" value="1">
                                <label class="form-check-label" for="bbi-score">ä¸ç ´BBIçº¿</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="volume-score" value="1">
                                <label class="form-check-label" for="volume-score">æ— æ”¾é‡é˜´çº¿</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="trend-score" value="1">
                                <label class="form-check-label" for="trend-score">è¶‹åŠ¿è¿˜åœ¨å‘ä¸Š</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="j-score" value="1">
                                <label class="form-check-label" for="j-score">Jæ²¡æ­»å‰</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>æ€»åˆ†: <span id="total-score" class="text-primary">0</span>/5</strong>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="save-review-btn">ä¿å­˜å¤ç›˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- æ¨¡æ‹Ÿä¾èµ–æ–‡ä»¶ -->
    <script>
        // æ¨¡æ‹Ÿç»Ÿä¸€æ¶ˆæ¯ç³»ç»Ÿ
        class UnifiedMessageSystem {
            static showMessage(message, type = 'info', options = {}) {
                console.log(`[${type.toUpperCase()}] ${message}`);
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, options.duration || 3000);
            }
        }
        
        function showErrorMessage(message, options = {}) {
            UnifiedMessageSystem.showMessage(message, 'error', options);
        }
        
        function showSuccessMessage(message, options = {}) {
            UnifiedMessageSystem.showMessage(message, 'success', options);
        }
        
        function showWarningMessage(message, options = {}) {
            UnifiedMessageSystem.showMessage(message, 'warning', options);
        }
        
        function showInfoMessage(message, options = {}) {
            UnifiedMessageSystem.showMessage(message, 'info', options);
        }
        
        // æ¨¡æ‹ŸAPIå®¢æˆ·ç«¯
        class ApiClient {
            constructor() {
                console.log('ApiClient æ„é€ å‡½æ•°è°ƒç”¨');
            }
            
            async saveReview(data) {
                console.log('ApiClient.saveReview è°ƒç”¨:', data);
                return { success: true, data: { id: 1 } };
            }
        }
        
        // æ¨¡æ‹Ÿå¤ç›˜ä¿å­˜ç®¡ç†å™¨
        class ReviewSaveManager {
            constructor(formSelector) {
                console.log('ReviewSaveManager æ„é€ å‡½æ•°è°ƒç”¨:', formSelector);
                this.formSelector = formSelector;
            }
            
            hasUnsavedChanges() {
                return false;
            }
            
            async saveReview() {
                console.log('ReviewSaveManager.saveReview è°ƒç”¨');
                return { success: true };
            }
        }
    </script>
    
    <!-- ä»review.htmlå¤åˆ¶çš„åˆå§‹åŒ–ä»£ç  -->
    <script>
        // å…¨å±€APIå®¢æˆ·ç«¯å’Œä¿å­˜ç®¡ç†å™¨å®ä¾‹
        let apiClient = null;
        let reviewSaveManager = null;
        let reviewModal = null;

        // ä¾èµ–æ£€æŸ¥å‡½æ•°
        function checkDependencies() {
            console.log('ğŸ” æ£€æŸ¥JavaScriptä¾èµ–...');
            
            const dependencies = [
                { name: 'UnifiedMessageSystem', check: () => typeof UnifiedMessageSystem !== 'undefined' },
                { name: 'ApiClient', check: () => typeof ApiClient !== 'undefined' },
                { name: 'ReviewSaveManager', check: () => typeof ReviewSaveManager !== 'undefined' },
                { name: 'Bootstrap', check: () => typeof bootstrap !== 'undefined' }
            ];
            
            const missing = dependencies.filter(dep => !dep.check());
            
            if (missing.length > 0) {
                const missingNames = missing.map(dep => dep.name).join(', ');
                console.error('âŒ ç¼ºå°‘ä¾èµ–:', missingNames);
                
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage(`é¡µé¢ä¾èµ–åŠ è½½å¤±è´¥: ${missingNames}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`);
                } else {
                    alert(`é¡µé¢ä¾èµ–åŠ è½½å¤±è´¥: ${missingNames}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`);
                }
                return false;
            }
            
            console.log('âœ… æ‰€æœ‰ä¾èµ–æ£€æŸ¥é€šè¿‡');
            return true;
        }

        // åˆå§‹åŒ–APIå®¢æˆ·ç«¯
        function initializeApiClient() {
            console.log('ğŸ”§ åˆå§‹åŒ–APIå®¢æˆ·ç«¯...');
            
            try {
                if (typeof ApiClient !== 'undefined') {
                    apiClient = new ApiClient();
                    console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ ApiClientç±»æœªæ‰¾åˆ°');
                    showErrorMessage('APIå®¢æˆ·ç«¯åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return false;
                }
            } catch (error) {
                console.error('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
                showErrorMessage('APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨
        function initializeReviewSaveManager() {
            console.log('ğŸ”§ åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨...');
            
            try {
                if (typeof ReviewSaveManager !== 'undefined') {
                    reviewSaveManager = new ReviewSaveManager('#review-form');
                    console.log('âœ… å¤ç›˜ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ ReviewSaveManagerç±»æœªæ‰¾åˆ°');
                    showErrorMessage('ä¿å­˜ç®¡ç†å™¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return false;
                }
            } catch (error) {
                console.error('âŒ å¤ç›˜ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                showErrorMessage('ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // ç»‘å®šå¤ç›˜é¡µé¢ç›¸å…³äº‹ä»¶
        function bindReviewEvents() {
            console.log('ğŸ”— ç»‘å®šå¤ç›˜é¡µé¢äº‹ä»¶');
            
            try {
                bindScoreCheckboxes();
                bindFloatingProfitCalculator();
                bindModalEvents();
                
                console.log('âœ… å¤ç›˜é¡µé¢äº‹ä»¶ç»‘å®šæˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ å¤ç›˜é¡µé¢äº‹ä»¶ç»‘å®šå¤±è´¥:', error);
                return false;
            }
        }

        function bindScoreCheckboxes() {
            console.log('ğŸ”— ç»‘å®šè¯„åˆ†å¤é€‰æ¡†äº‹ä»¶');
            
            const checkboxes = ['price-up-score', 'bbi-score', 'volume-score', 'trend-score', 'j-score'];
            let boundCount = 0;
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', calculateTotalScore);
                    boundCount++;
                } else {
                    console.warn(`âš ï¸ è¯„åˆ†å¤é€‰æ¡† ${id} æœªæ‰¾åˆ°`);
                }
            });
            
            console.log(`âœ… è¯„åˆ†å¤é€‰æ¡†äº‹ä»¶ç»‘å®šå®Œæˆ: ${boundCount}/${checkboxes.length}`);
            return boundCount > 0;
        }

        function bindFloatingProfitCalculator() {
            console.log('ğŸ”— ç»‘å®šæµ®ç›ˆè®¡ç®—å™¨äº‹ä»¶');
            
            const currentPriceInput = document.getElementById('current-price-input');
            if (currentPriceInput) {
                currentPriceInput.addEventListener('input', calculateFloatingProfit);
                console.log('âœ… æµ®ç›ˆè®¡ç®—å™¨äº‹ä»¶ç»‘å®šæˆåŠŸ');
                return true;
            } else {
                console.warn('âš ï¸ å½“å‰ä»·æ ¼è¾“å…¥æ¡†æœªæ‰¾åˆ°');
                return false;
            }
        }

        function bindModalEvents() {
            console.log('ğŸ”— ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶');
            
            const modalElement = document.getElementById('reviewModal');
            if (modalElement) {
                modalElement.addEventListener('shown.bs.modal', function() {
                    console.log('ğŸ“‹ å¤ç›˜æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                    const firstInput = modalElement.querySelector('input:not([readonly]):not([type="hidden"])');
                    if (firstInput) {
                        firstInput.focus();
                    }
                });
                
                modalElement.addEventListener('hide.bs.modal', function(event) {
                    console.log('ğŸ“‹ å¤ç›˜æ¨¡æ€æ¡†å‡†å¤‡éšè—');
                    if (reviewSaveManager && reviewSaveManager.hasUnsavedChanges && reviewSaveManager.hasUnsavedChanges()) {
                        if (!confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ')) {
                            event.preventDefault();
                            return false;
                        }
                    }
                });
                
                console.log('âœ… æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®šæˆåŠŸ');
                return true;
            } else {
                console.warn('âš ï¸ å¤ç›˜æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                return false;
            }
        }

        function calculateTotalScore() {
            const checkboxes = ['price-up-score', 'bbi-score', 'volume-score', 'trend-score', 'j-score'];
            let total = 0;
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    total += 1;
                }
            });
            const totalScoreEl = document.getElementById('total-score');
            if (totalScoreEl) {
                totalScoreEl.textContent = total;
            }
        }

        function calculateFloatingProfit() {
            console.log('ğŸ’° è®¡ç®—æµ®ç›ˆæ¯”ä¾‹');
            
            const currentPriceInput = document.getElementById('current-price-input');
            const buyPriceDisplay = document.getElementById('buy-price-display');
            const floatingProfitRatio = document.getElementById('floating-profit-ratio');
            const floatingProfitContainer = document.querySelector('.floating-profit-container');
            
            if (!currentPriceInput || !buyPriceDisplay || !floatingProfitRatio) {
                console.warn('âš ï¸ æµ®ç›ˆè®¡ç®—æ‰€éœ€å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            const currentPrice = parseFloat(currentPriceInput.value);
            const buyPriceText = buyPriceDisplay.textContent.replace('Â¥', '').replace('--', '');
            const buyPrice = parseFloat(buyPriceText);
            
            if (!currentPrice || !buyPrice || currentPrice <= 0 || buyPrice <= 0) {
                floatingProfitRatio.textContent = '--';
                if (floatingProfitContainer) {
                    floatingProfitContainer.className = 'floating-profit-container neutral';
                }
                return;
            }
            
            const profitRatio = ((currentPrice - buyPrice) / buyPrice * 100);
            const profitRatioText = (profitRatio >= 0 ? '+' : '') + profitRatio.toFixed(2) + '%';
            
            floatingProfitRatio.textContent = profitRatioText;
            
            if (floatingProfitContainer) {
                if (profitRatio > 0) {
                    floatingProfitContainer.className = 'floating-profit-container profit';
                } else if (profitRatio < 0) {
                    floatingProfitContainer.className = 'floating-profit-container loss';
                } else {
                    floatingProfitContainer.className = 'floating-profit-container neutral';
                }
            }
            
            console.log(`ğŸ’° æµ®ç›ˆè®¡ç®—å®Œæˆ: ${profitRatioText}`);
        }

        // æ¨¡æ‹Ÿå…¶ä»–å¿…è¦å‡½æ•°
        function integrateReviewSaveStateManagement() {
            console.log('ğŸ”§ é›†æˆä¿å­˜çŠ¶æ€ç®¡ç†');
            return true;
        }

        function loadAllData() {
            console.log('ğŸ“Š åŠ è½½æ‰€æœ‰æ•°æ®');
            return Promise.resolve(true);
        }

        // æ·»åŠ åˆå§‹åŒ–è¿‡ç¨‹çš„è¯¦ç»†æ—¥å¿—è®°å½•åŠŸèƒ½
        function logInitializationProgress(step, status, details = {}) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                step,
                status,
                ...details
            };
            
            const logs = JSON.parse(sessionStorage.getItem('reviewPageInitLogs') || '[]');
            logs.push(logEntry);
            sessionStorage.setItem('reviewPageInitLogs', JSON.stringify(logs));
            
            const emoji = status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : status === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            console.log(`${emoji} [${timestamp}] ${step}:`, details);
        }

        function getInitializationLogs() {
            return JSON.parse(sessionStorage.getItem('reviewPageInitLogs') || '[]');
        }

        function clearInitializationLogs() {
            sessionStorage.removeItem('reviewPageInitLogs');
            console.log('ğŸ§¹ åˆå§‹åŒ–æ—¥å¿—å·²æ¸…é™¤');
        }

        function exportInitializationLogs() {
            const logs = getInitializationLogs();
            const logText = logs.map(log => 
                `[${log.timestamp}] ${log.step}: ${log.status} ${JSON.stringify(log, null, 2)}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `review-page-init-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ğŸ“„ åˆå§‹åŒ–æ—¥å¿—å·²å¯¼å‡º');
        }

        function showInitializationReport() {
            const logs = getInitializationLogs();
            const report = {
                totalSteps: logs.length,
                successCount: logs.filter(log => log.status === 'success').length,
                errorCount: logs.filter(log => log.status === 'error').length,
                warningCount: logs.filter(log => log.status === 'warning').length,
                lastInitTime: logs.length > 0 ? logs[logs.length - 1].timestamp : null
            };
            
            console.group('ğŸ“Š åˆå§‹åŒ–çŠ¶æ€æŠ¥å‘Š');
            console.table(report);
            console.log('ğŸ“‹ è¯¦ç»†æ—¥å¿—:');
            console.table(logs);
            console.groupEnd();
            
            // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæŠ¥å‘Š
            const resultsDiv = document.getElementById('test-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <h6>åˆå§‹åŒ–çŠ¶æ€æŠ¥å‘Š</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">${report.totalSteps}</h5>
                                    <p class="card-text">æ€»æ­¥éª¤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-success">${report.successCount}</h5>
                                    <p class="card-text">æˆåŠŸ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-danger">${report.errorCount}</h5>
                                    <p class="card-text">é”™è¯¯</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-warning">${report.warningCount}</h5>
                                    <p class="card-text">è­¦å‘Š</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>è¯¦ç»†æ—¥å¿—</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>æ­¥éª¤</th>
                                        <th>çŠ¶æ€</th>
                                        <th>è¯¦æƒ…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${logs.map(log => `
                                        <tr class="${log.status === 'success' ? 'table-success' : log.status === 'error' ? 'table-danger' : log.status === 'warning' ? 'table-warning' : ''}">
                                            <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                                            <td>${log.step}</td>
                                            <td>${log.status}</td>
                                            <td>${log.error || log.description || '--'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            return report;
        }

        // é¡µé¢åˆå§‹åŒ–ä¸»å‡½æ•° - å®ç°åˆ†æ­¥åˆå§‹åŒ–æµç¨‹ï¼ŒåŒ…å«é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
        async function initializeReviewPage() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–å¤ç›˜é¡µé¢');
            console.time('é¡µé¢åˆå§‹åŒ–è€—æ—¶');
            
            const initSteps = [
                { 
                    name: 'ä¾èµ–æ£€æŸ¥', 
                    fn: checkDependencies,
                    critical: true,
                    description: 'æ£€æŸ¥JavaScriptä¾èµ–æ˜¯å¦æ­£ç¡®åŠ è½½'
                },
                { 
                    name: 'APIå®¢æˆ·ç«¯åˆå§‹åŒ–', 
                    fn: initializeApiClient,
                    critical: true,
                    description: 'åˆå§‹åŒ–APIå®¢æˆ·ç«¯å®ä¾‹'
                },
                { 
                    name: 'ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–', 
                    fn: initializeReviewSaveManager,
                    critical: true,
                    description: 'åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨å®ä¾‹'
                },
                { 
                    name: 'äº‹ä»¶ç»‘å®š', 
                    fn: bindReviewEvents,
                    critical: false,
                    description: 'ç»‘å®šé¡µé¢äº‹ä»¶å¤„ç†å™¨'
                },
                { 
                    name: 'ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆ', 
                    fn: integrateReviewSaveStateManagement,
                    critical: false,
                    description: 'é›†æˆä¿å­˜çŠ¶æ€ç®¡ç†åŠŸèƒ½'
                },
                { 
                    name: 'æ•°æ®åŠ è½½', 
                    fn: loadAllData,
                    critical: false,
                    description: 'åŠ è½½é¡µé¢åˆå§‹æ•°æ®'
                }
            ];
            
            let successCount = 0;
            let criticalFailure = false;
            const results = [];
            
            for (let i = 0; i < initSteps.length; i++) {
                const step = initSteps[i];
                const stepStartTime = performance.now();
                
                console.group(`ğŸ“‹ æ­¥éª¤ ${i + 1}/${initSteps.length}: ${step.name}`);
                console.log(`ğŸ“ æè¿°: ${step.description}`);
                console.log(`ğŸ”§ å¼€å§‹æ‰§è¡Œ...`);
                
                logInitializationProgress(step.name, 'start', {
                    stepIndex: i + 1,
                    totalSteps: initSteps.length,
                    description: step.description,
                    critical: step.critical
                });
                
                try {
                    const result = await Promise.resolve(step.fn());
                    const stepEndTime = performance.now();
                    const stepDuration = (stepEndTime - stepStartTime).toFixed(2);
                    
                    if (result === false) {
                        console.error(`âŒ ${step.name}å¤±è´¥`);
                        console.log(`â±ï¸ è€—æ—¶: ${stepDuration}ms`);
                        
                        logInitializationProgress(step.name, 'error', {
                            error: 'å‡½æ•°è¿”å›false',
                            duration: stepDuration,
                            critical: step.critical
                        });
                        
                        results.push({
                            step: step.name,
                            success: false,
                            error: 'å‡½æ•°è¿”å›false',
                            duration: stepDuration,
                            critical: step.critical
                        });
                        
                        if (step.critical) {
                            console.error(`ğŸš¨ å…³é”®æ­¥éª¤å¤±è´¥ï¼Œåœæ­¢åç»­åˆå§‹åŒ–`);
                            logInitializationProgress('åˆå§‹åŒ–æµç¨‹', 'error', {
                                reason: 'å…³é”®æ­¥éª¤å¤±è´¥',
                                failedStep: step.name
                            });
                            criticalFailure = true;
                            console.groupEnd();
                            break;
                        }
                    } else {
                        console.log(`âœ… ${step.name}æˆåŠŸ`);
                        console.log(`â±ï¸ è€—æ—¶: ${stepDuration}ms`);
                        successCount++;
                        
                        logInitializationProgress(step.name, 'success', {
                            duration: stepDuration,
                            critical: step.critical
                        });
                        
                        results.push({
                            step: step.name,
                            success: true,
                            duration: stepDuration,
                            critical: step.critical
                        });
                    }
                } catch (error) {
                    const stepEndTime = performance.now();
                    const stepDuration = (stepEndTime - stepStartTime).toFixed(2);
                    
                    console.error(`âŒ ${step.name}å¼‚å¸¸:`, error);
                    console.log(`â±ï¸ è€—æ—¶: ${stepDuration}ms`);
                    
                    logInitializationProgress(step.name, 'error', {
                        error: error.message || error.toString(),
                        stack: error.stack,
                        duration: stepDuration,
                        critical: step.critical
                    });
                    
                    results.push({
                        step: step.name,
                        success: false,
                        error: error.message || error.toString(),
                        duration: stepDuration,
                        critical: step.critical
                    });
                    
                    if (typeof showErrorMessage === 'function') {
                        showErrorMessage(`${step.name}å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    
                    if (step.critical) {
                        console.error(`ğŸš¨ å…³é”®æ­¥éª¤å¼‚å¸¸ï¼Œåœæ­¢åç»­åˆå§‹åŒ–`);
                        logInitializationProgress('åˆå§‹åŒ–æµç¨‹', 'error', {
                            reason: 'å…³é”®æ­¥éª¤å¼‚å¸¸',
                            failedStep: step.name,
                            error: error.message
                        });
                        criticalFailure = true;
                        console.groupEnd();
                        break;
                    }
                }
                
                console.groupEnd();
                
                if (i < initSteps.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            console.timeEnd('é¡µé¢åˆå§‹åŒ–è€—æ—¶');
            
            console.group('ğŸ“Š åˆå§‹åŒ–ç»“æœæ±‡æ€»');
            console.table(results);
            console.log(`âœ… æˆåŠŸæ­¥éª¤: ${successCount}/${initSteps.length}`);
            console.log(`âŒ å¤±è´¥æ­¥éª¤: ${initSteps.length - successCount}/${initSteps.length}`);
            console.log(`ğŸš¨ å…³é”®å¤±è´¥: ${criticalFailure ? 'æ˜¯' : 'å¦'}`);
            console.groupEnd();
            
            if (criticalFailure) {
                console.error('ğŸš¨ å¤ç›˜é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œå…³é”®åŠŸèƒ½æ— æ³•ä½¿ç”¨');
                
                logInitializationProgress('åˆå§‹åŒ–å®Œæˆ', 'error', {
                    successCount,
                    totalSteps: initSteps.length,
                    criticalFailure: true,
                    results
                });
                
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                return false;
            } else if (successCount === initSteps.length) {
                console.log('ğŸ‰ å¤ç›˜é¡µé¢åˆå§‹åŒ–å®Œå…¨æˆåŠŸ');
                
                logInitializationProgress('åˆå§‹åŒ–å®Œæˆ', 'success', {
                    successCount,
                    totalSteps: initSteps.length,
                    criticalFailure: false,
                    results
                });
                
                if (typeof showSuccessMessage === 'function') {
                    showSuccessMessage('å¤ç›˜é¡µé¢åˆå§‹åŒ–æˆåŠŸ');
                }
                
                return true;
            } else {
                console.warn('âš ï¸ å¤ç›˜é¡µé¢åˆå§‹åŒ–éƒ¨åˆ†æˆåŠŸï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨');
                
                logInitializationProgress('åˆå§‹åŒ–å®Œæˆ', 'warning', {
                    successCount,
                    totalSteps: initSteps.length,
                    criticalFailure: false,
                    results
                });
                
                if (typeof showWarningMessage === 'function') {
                    showWarningMessage(`é¡µé¢åˆå§‹åŒ–éƒ¨åˆ†æˆåŠŸ (${successCount}/${initSteps.length})ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™`);
                }
                return true;
            }
        }

        // åˆå§‹åŒ–Bootstrapæ¨¡æ€æ¡†
        async function initializeBootstrapModal() {
            console.log('ğŸ”§ åˆå§‹åŒ–Bootstrapæ¨¡æ€æ¡†');
            
            const modalElement = document.getElementById('reviewModal');
            if (!modalElement) {
                console.warn('âš ï¸ å¤ç›˜æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                return false;
            }
            
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    reviewModal = new bootstrap.Modal(modalElement);
                    console.log('âœ… Bootstrapæ¨¡æ€æ¡†åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ Bootstrap Modalç±»æœªæ‰¾åˆ°');
                    if (typeof showWarningMessage === 'function') {
                        showWarningMessage('Bootstrap ModalæœªåŠ è½½ï¼Œæ¨¡æ€æ¡†åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨');
                    }
                    return false;
                }
            } catch (error) {
                console.error('âŒ Bootstrapæ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥:', error);
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage('æ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
                return false;
            }
        }

        function performPostInitializationTasks() {
            console.log('ğŸ¯ æ‰§è¡Œåç»­åˆå§‹åŒ–ä»»åŠ¡');
            
            const tasks = [
                {
                    name: 'è®¾ç½®è‡ªåŠ¨åˆ·æ–°',
                    fn: () => {
                        console.log('â° è‡ªåŠ¨åˆ·æ–°è®¾ç½®å®Œæˆ');
                        return true;
                    }
                },
                {
                    name: 'æ³¨å†Œå…¨å±€é”™è¯¯å¤„ç†',
                    fn: () => {
                        window.addEventListener('error', function(event) {
                            console.error('ğŸš¨ å…¨å±€JavaScripté”™è¯¯:', event.error);
                        });
                        window.addEventListener('unhandledrejection', function(event) {
                            console.error('ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                        });
                        console.log('ğŸ›¡ï¸ å…¨å±€é”™è¯¯å¤„ç†æ³¨å†Œå®Œæˆ');
                        return true;
                    }
                },
                {
                    name: 'æ€§èƒ½ç›‘æ§',
                    fn: () => {
                        if ('performance' in window) {
                            const loadTime = performance.now();
                            console.log(`âš¡ é¡µé¢åŠ è½½æ€§èƒ½: ${loadTime.toFixed(2)}ms`);
                        }
                        return true;
                    }
                }
            ];
            
            tasks.forEach(task => {
                try {
                    task.fn();
                    console.log(`âœ… ${task.name}å®Œæˆ`);
                } catch (error) {
                    console.error(`âŒ ${task.name}å¤±è´¥:`, error);
                }
            });
            
            console.log('ğŸ‰ åç»­åˆå§‹åŒ–ä»»åŠ¡å®Œæˆ');
        }

        // é¡µé¢åˆå§‹åŒ– - åœ¨DOMContentLoadedäº‹ä»¶ä¸­è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸŒŸ DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹å¤ç›˜é¡µé¢åˆå§‹åŒ–æµç¨‹');
            console.log('ğŸ“… åˆå§‹åŒ–æ—¶é—´:', new Date().toLocaleString('zh-CN'));
            console.log('ğŸŒ ç”¨æˆ·ä»£ç†:', navigator.userAgent);
            
            try {
                const initSuccess = await initializeReviewPage();
                await initializeBootstrapModal();
                
                console.log('ğŸ å¤ç›˜é¡µé¢åˆå§‹åŒ–æµç¨‹å®Œæˆ');
                console.log('ğŸ“Š åˆå§‹åŒ–ç»“æœ:', initSuccess ? 'æˆåŠŸ' : 'å¤±è´¥');
                
                if (initSuccess) {
                    console.log('ğŸ¯ å¼€å§‹æ‰§è¡Œåç»­åˆå§‹åŒ–æ“ä½œ');
                    setTimeout(() => {
                        performPostInitializationTasks();
                    }, 100);
                } else {
                    console.error('ğŸš¨ åˆå§‹åŒ–å¤±è´¥ï¼Œé¡µé¢åŠŸèƒ½å¯èƒ½å—é™');
                }
                
                // è‡ªåŠ¨æ˜¾ç¤ºåˆå§‹åŒ–æŠ¥å‘Š
                setTimeout(() => {
                    showInitializationReport();
                }, 500);
                
            } catch (error) {
                console.error('ğŸš¨ é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿæœªæ•è·çš„å¼‚å¸¸:', error);
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage('é¡µé¢åˆå§‹åŒ–å¼‚å¸¸: ' + error.message);
                } else {
                    alert('é¡µé¢åˆå§‹åŒ–å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }
        });

        // æµ‹è¯•å‡½æ•°
        function runInitializationTest() {
            console.log('ğŸ§ª é‡æ–°è¿è¡Œåˆå§‹åŒ–æµ‹è¯•');
            clearInitializationLogs();
            location.reload();
        }

        // æš´éœ²å…¨å±€å‡½æ•°
        window.runInitializationTest = runInitializationTest;
        window.showInitializationReport = showInitializationReport;
        window.exportInitializationLogs = exportInitializationLogs;
        window.clearInitializationLogs = clearInitializationLogs;
    </script>
</body>
</html>