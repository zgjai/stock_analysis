<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试 selectMonth 修复</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-4">
        <h2>测试 selectMonth 修复</h2>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>测试结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results"></div>
                        
                        <h6 class="mt-4">测试按钮</h6>
                        <button class="btn btn-primary me-2" onclick="testDirectSelectMonth()">
                            测试直接调用 selectMonth
                        </button>
                        <button class="btn btn-secondary me-2" onclick="testManagerSelectMonth()">
                            测试管理器 selectMonth
                        </button>
                        <button class="btn btn-info" onclick="testGlobalSelectMonth()">
                            测试全局 selectMonth
                        </button>
                        
                        <div class="mt-3">
                            <h6>模拟月份列表</h6>
                            <div id="month-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/expectation-comparison-manager.js') }}"></script>
    <script>
        let testResults = [];
        
        function addTestResult(message, type = 'info') {
            testResults.push({message, type, time: new Date().toLocaleTimeString()});
            updateTestResults();
        }
        
        function updateTestResults() {
            const container = document.getElementById('test-results');
            let html = '';
            
            testResults.forEach(result => {
                const alertClass = result.type === 'success' ? 'alert-success' : 
                                 result.type === 'error' ? 'alert-danger' : 'alert-info';
                html += `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <small class="text-muted">[${result.time}]</small> ${result.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function testDirectSelectMonth() {
            try {
                if (typeof selectMonth === 'function') {
                    addTestResult('✅ 全局 selectMonth 函数存在', 'success');
                    selectMonth('2024年09月', 0);
                    addTestResult('✅ 直接调用 selectMonth 成功', 'success');
                } else {
                    addTestResult('❌ 全局 selectMonth 函数不存在', 'error');
                }
            } catch (error) {
                addTestResult('❌ 直接调用 selectMonth 失败: ' + error.message, 'error');
            }
        }
        
        function testManagerSelectMonth() {
            try {
                if (typeof window.expectationComparisonManager !== 'undefined') {
                    addTestResult('✅ expectationComparisonManager 存在', 'success');
                    
                    if (typeof window.expectationComparisonManager.selectMonth === 'function') {
                        addTestResult('✅ selectMonth 方法存在', 'success');
                        window.expectationComparisonManager.selectMonth(0);
                        addTestResult('✅ 管理器 selectMonth 调用成功', 'success');
                    } else {
                        addTestResult('❌ selectMonth 方法不存在', 'error');
                    }
                } else {
                    addTestResult('❌ expectationComparisonManager 不存在', 'error');
                }
            } catch (error) {
                addTestResult('❌ 管理器 selectMonth 调用失败: ' + error.message, 'error');
            }
        }
        
        function testGlobalSelectMonth() {
            try {
                // 模拟创建一些测试数据
                if (window.expectationComparisonManager) {
                    window.expectationComparisonManager.monthlyExpectations = [
                        {month: '2024年09月', expected_amount: 10000},
                        {month: '2024年08月', expected_amount: 8000}
                    ];
                }
                
                window.selectMonth('2024年09月', 0);
                addTestResult('✅ 全局 selectMonth 调用成功', 'success');
            } catch (error) {
                addTestResult('❌ 全局 selectMonth 调用失败: ' + error.message, 'error');
            }
        }
        
        function createMockMonthList() {
            const monthList = document.getElementById('month-list');
            monthList.innerHTML = `
                <div class="list-group">
                    <div class="list-group-item list-group-item-action" onclick="selectMonth('2024年09月', 0)">
                        2024年09月 - 测试直接调用
                    </div>
                    <div class="list-group-item list-group-item-action" onclick="window.expectationComparisonManager.selectMonth(1)">
                        2024年08月 - 测试管理器调用
                    </div>
                </div>
            `;
        }
        
        // 全局selectMonth函数，用于兼容直接调用
        window.selectMonth = function(month, index) {
            if (typeof window.expectationComparisonManager !== 'undefined' && window.expectationComparisonManager.selectMonth) {
                // 如果传入的是月份字符串，需要找到对应的索引
                if (typeof month === 'string') {
                    const monthlyData = window.expectationComparisonManager.monthlyExpectations || [];
                    const foundIndex = monthlyData.findIndex(item => item.month === month);
                    if (foundIndex !== -1) {
                        window.expectationComparisonManager.selectMonth(foundIndex);
                        addTestResult(`✅ 找到月份 ${month}，索引: ${foundIndex}`, 'success');
                    } else {
                        addTestResult(`❌ 未找到月份: ${month}`, 'error');
                    }
                } else {
                    // 如果传入的是索引
                    window.expectationComparisonManager.selectMonth(month);
                    addTestResult(`✅ 使用索引 ${month} 调用成功`, 'success');
                }
            } else {
                addTestResult('❌ 期望对比管理器未初始化或selectMonth方法不存在', 'error');
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('页面加载完成，开始测试...', 'info');
            
            // 等待一段时间确保管理器初始化
            setTimeout(() => {
                addTestResult('检查管理器初始化状态...', 'info');
                
                if (typeof window.expectationComparisonManager !== 'undefined') {
                    addTestResult('✅ expectationComparisonManager 已初始化', 'success');
                } else {
                    addTestResult('❌ expectationComparisonManager 未初始化', 'error');
                }
                
                if (typeof window.selectMonth === 'function') {
                    addTestResult('✅ 全局 selectMonth 函数已定义', 'success');
                } else {
                    addTestResult('❌ 全局 selectMonth 函数未定义', 'error');
                }
                
                createMockMonthList();
            }, 500);
        });
    </script>
</body>
</html>