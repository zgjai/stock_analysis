<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>价格显示调试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>价格显示调试</h2>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>1. 测试API数据获取</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="testAPI()">获取持仓数据</button>
                <div id="api-result" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>2. 测试价格显示逻辑</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success" onclick="testPriceDisplay()">测试价格显示</button>
                <div id="price-display-result" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>3. 模拟持仓显示</h5>
            </div>
            <div class="card-body">
                <div id="holdings-display"></div>
            </div>
        </div>
    </div>

    <script>
        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>正在获取数据...';
            
            try {
                const response = await fetch('/api/holdings');
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.success && data.data) {
                    let html = '<div class="alert alert-success">✅ API调用成功</div>';
                    html += '<h6>原始数据：</h6>';
                    html += '<pre class="bg-light p-3">' + JSON.stringify(data.data, null, 2) + '</pre>';
                    
                    // 检查每个持仓的价格字段
                    data.data.forEach((holding, index) => {
                        html += `<h6>持仓 ${index + 1} - ${holding.stock_code}:</h6>`;
                        html += '<table class="table table-sm">';
                        html += '<tr><td>avg_buy_price</td><td>' + holding.avg_buy_price + '</td><td>' + typeof holding.avg_buy_price + '</td></tr>';
                        html += '<tr><td>avg_price</td><td>' + holding.avg_price + '</td><td>' + typeof holding.avg_price + '</td></tr>';
                        html += '<tr><td>current_price</td><td>' + holding.current_price + '</td><td>' + typeof holding.current_price + '</td></tr>';
                        html += '</table>';
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">❌ API调用失败: ' + (data.message || '未知错误') + '</div>';
                }
            } catch (error) {
                console.error('API Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">❌ 请求失败: ' + error.message + '</div>';
            }
        }

        function testPriceDisplay() {
            const resultDiv = document.getElementById('price-display-result');
            
            // 模拟持仓数据
            const mockHolding = {
                stock_code: '000776',
                stock_name: '广发证券',
                avg_buy_price: 19.45,
                avg_price: 19.45,
                current_price: 21.01,
                current_quantity: 31100,
                holding_days: 1
            };
            
            console.log('Mock Holding:', mockHolding);
            
            // 测试价格显示逻辑
            let html = '<h6>价格显示逻辑测试：</h6>';
            
            // 测试成本价显示逻辑
            const costPriceLogic = mockHolding.avg_buy_price ? mockHolding.avg_buy_price.toFixed(2) : (mockHolding.avg_price ? mockHolding.avg_price.toFixed(2) : '--');
            html += `<p><strong>成本价逻辑结果:</strong> ¥${costPriceLogic}</p>`;
            
            // 测试当前价显示逻辑
            const currentPriceLogic = mockHolding.current_price ? mockHolding.current_price.toFixed(2) : '--';
            html += `<p><strong>当前价逻辑结果:</strong> ¥${currentPriceLogic}</p>`;
            
            // 分步测试
            html += '<h6>分步测试：</h6>';
            html += '<ul>';
            html += `<li>mockHolding.avg_buy_price: ${mockHolding.avg_buy_price} (${typeof mockHolding.avg_buy_price})</li>`;
            html += `<li>mockHolding.avg_buy_price ? true : false = ${mockHolding.avg_buy_price ? true : false}</li>`;
            html += `<li>mockHolding.avg_buy_price.toFixed(2): ${mockHolding.avg_buy_price ? mockHolding.avg_buy_price.toFixed(2) : 'N/A'}</li>`;
            html += `<li>mockHolding.current_price: ${mockHolding.current_price} (${typeof mockHolding.current_price})</li>`;
            html += `<li>mockHolding.current_price ? true : false = ${mockHolding.current_price ? true : false}</li>`;
            html += `<li>mockHolding.current_price.toFixed(2): ${mockHolding.current_price ? mockHolding.current_price.toFixed(2) : 'N/A'}</li>`;
            html += '</ul>';
            
            resultDiv.innerHTML = html;
            
            // 生成实际的持仓显示HTML
            generateHoldingDisplay(mockHolding);
        }

        function generateHoldingDisplay(holding) {
            const displayDiv = document.getElementById('holdings-display');
            
            const holdingHtml = `
                <div class="holding-item card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="fw-bold">${holding.stock_code}</div>
                                <div class="text-muted small">${holding.stock_name || '--'}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">成本价</div>
                                <div class="fw-bold">¥${holding.avg_buy_price ? holding.avg_buy_price.toFixed(2) : (holding.avg_price ? holding.avg_price.toFixed(2) : '--')}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">当前价</div>
                                <div class="fw-bold">¥${holding.current_price ? holding.current_price.toFixed(2) : '--'}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">持仓量</div>
                                <div class="fw-bold">${holding.current_quantity || 0}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">持仓天数</div>
                                <div class="fw-bold">${holding.holding_days || 0}天</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            displayDiv.innerHTML = holdingHtml;
        }

        // 页面加载时自动测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('调试页面已加载');
            testAPI();
        });
    </script>
</body>
</html>