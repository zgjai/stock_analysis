<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试表单提交</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>调试交易记录表单提交</h2>
        
        <form id="trade-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="stock-code" class="form-label">股票代码</label>
                        <input type="text" class="form-control" id="stock-code" name="stock_code" 
                               value="000001" placeholder="例如: 000001">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="stock-name" class="form-label">股票名称</label>
                        <input type="text" class="form-control" id="stock-name" name="stock_name" 
                               value="平安银行" placeholder="例如: 平安银行">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="trade-type" class="form-label">交易类型</label>
                        <select class="form-select" id="trade-type" name="trade_type">
                            <option value="">请选择交易类型</option>
                            <option value="buy" selected>买入</option>
                            <option value="sell">卖出</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="price" class="form-label">价格</label>
                        <input type="number" class="form-control" id="price" name="price" 
                               value="10.50" step="0.01">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="quantity" class="form-label">数量</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               value="1000" step="100">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="reason" class="form-label">操作原因</label>
                        <select class="form-select" id="reason" name="reason">
                            <option value="">请选择操作原因</option>
                            <option value="少妇B1战法" selected>少妇B1战法</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-primary" onclick="testFormSubmission()">测试表单提交</button>
        </form>
        
        <div class="mt-4">
            <h4>调试信息</h4>
            <pre id="debug-output" class="bg-light p-3"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>
    
    <script>
        function testFormSubmission() {
            const form = document.getElementById('trade-form');
            const debugOutput = document.getElementById('debug-output');
            
            try {
                // 1. 测试FormUtils.serialize
                const serializedData = FormUtils.serialize(form);
                console.log('序列化数据:', serializedData);
                
                // 2. 测试FormData
                const formData = new FormData(form);
                const formDataObj = {};
                for (let [key, value] of formData.entries()) {
                    formDataObj[key] = value;
                }
                console.log('FormData对象:', formDataObj);
                
                // 3. 显示调试信息
                debugOutput.textContent = JSON.stringify({
                    serializedData: serializedData,
                    formDataObj: formDataObj,
                    stockCodeValue: document.getElementById('stock-code').value,
                    stockCodeName: document.getElementById('stock-code').name
                }, null, 2);
                
                // 4. 测试API调用
                testApiCall(serializedData);
                
            } catch (error) {
                console.error('测试失败:', error);
                debugOutput.textContent = '错误: ' + error.message;
            }
        }
        
        async function testApiCall(data) {
            try {
                console.log('准备发送的数据:', data);
                
                // 处理数值字段
                const processedData = {
                    ...data,
                    price: parseFloat(data.price),
                    quantity: parseInt(data.quantity)
                };
                
                console.log('处理后的数据:', processedData);
                
                // 发送API请求
                const response = await apiClient.createTrade(processedData);
                console.log('API响应:', response);
                
                document.getElementById('debug-output').textContent += '\n\nAPI调用成功:\n' + JSON.stringify(response, null, 2);
                
            } catch (error) {
                console.error('API调用失败:', error);
                document.getElementById('debug-output').textContent += '\n\nAPI调用失败:\n' + JSON.stringify({
                    message: error.message,
                    code: error.code,
                    details: error.details
                }, null, 2);
            }
        }
    </script>
</body>
</html>