{% extends "base.html" %}

{% block title %}äº¤æ˜“è®°å½• - è‚¡ç¥¨äº¤æ˜“è®°å½•ç³»ç»Ÿ{% endblock %}

{% block extra_head %}
<script>
    // ç«‹å³æ‰§è¡Œçš„æ¸…ç†è„šæœ¬ - åœ¨é¡µé¢åŠ è½½çš„æœ€æ—©é˜¶æ®µå°±å¼€å§‹æ¸…ç†
    (function () {
        console.log('ç«‹å³æ¸…ç†è„šæœ¬å¼€å§‹æ‰§è¡Œ...');

        // å®šä¹‰æ¸…ç†å‡½æ•°
        function immediateCleanup() {
            console.log('æ‰§è¡Œç«‹å³æ¸…ç†...');

            // æ¸…ç†æ‰€æœ‰å¯èƒ½çš„åŠ è½½é®ç½©
            const overlays = document.querySelectorAll('#global-loading-overlay, .loading-overlay, [id*="loading"], [class*="loading"]');
            overlays.forEach(overlay => {
                if (overlay && overlay.style) {
                    overlay.style.display = 'none';
                    try {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    } catch (e) {
                        console.warn('æ¸…ç†é®ç½©å¤±è´¥:', e);
                    }
                }
            });

            // æ¸…ç†BootstrapèƒŒæ™¯
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                try {
                    backdrop.remove();
                } catch (e) {
                    console.warn('æ¸…ç†èƒŒæ™¯å¤±è´¥:', e);
                }
            });

            // é‡ç½®bodyæ ·å¼
            if (document.body) {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }

            console.log('ç«‹å³æ¸…ç†å®Œæˆ');
        }

        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        immediateCleanup();

        // æ¯100msæ‰§è¡Œä¸€æ¬¡ï¼ŒæŒç»­5ç§’
        let cleanupCount = 0;
        const cleanupInterval = setInterval(() => {
            immediateCleanup();
            cleanupCount++;

            if (cleanupCount >= 50) { // 5ç§’ååœæ­¢
                clearInterval(cleanupInterval);
                console.log('ç«‹å³æ¸…ç†è„šæœ¬ç»“æŸ');
            }
        }, 100);

        // å…¨å±€æš´éœ²æ¸…ç†å‡½æ•°
        window.emergencyCleanup = immediateCleanup;
    })();


</script>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">äº¤æ˜“è®°å½•</li>
{% endblock %}

{% block page_title %}äº¤æ˜“è®°å½•{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTradeModal">
    <i class="bi bi-plus-circle"></i>
    æ·»åŠ äº¤æ˜“
</button>
<button type="button" class="btn btn-outline-secondary" onclick="refreshTrades()">
    <i class="bi bi-arrow-clockwise"></i>
    åˆ·æ–°
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">äº¤æ˜“è®°å½•åˆ—è¡¨</h5>
    </div>
    <div class="card-body">
        <!-- ç­›é€‰å™¨ -->
        <div class="row mb-3">
            <div class="col-md-2">
                <input type="text" class="form-control" placeholder="è‚¡ç¥¨ä»£ç " id="stock-code-filter">
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" placeholder="è‚¡ç¥¨åç§°" id="stock-name-filter">
            </div>
            <div class="col-md-2">
                <select class="form-select" id="trade-type-filter">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="buy">ä¹°å…¥</option>
                    <option value="sell">å–å‡º</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" id="date-from" title="å¼€å§‹æ—¥æœŸ">
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" id="date-to" title="ç»“æŸæ—¥æœŸ">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-primary w-100" onclick="filterTrades()">
                    <i class="bi bi-search"></i>
                    ç­›é€‰
                </button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-2">
                <select class="form-select" id="reason-filter">
                    <option value="">å…¨éƒ¨åŸå› </option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="corrected-filter">
                    <option value="">å…¨éƒ¨è®°å½•</option>
                    <option value="false">æ­£å¸¸è®°å½•</option>
                    <option value="true">å·²è®¢æ­£è®°å½•</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="sort-by">
                    <option value="trade_date">æŒ‰æ—¥æœŸæ’åº</option>
                    <option value="stock_code">æŒ‰è‚¡ç¥¨ä»£ç </option>
                    <option value="price">æŒ‰ä»·æ ¼æ’åº</option>
                    <option value="quantity">æŒ‰æ•°é‡æ’åº</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="sort-order">
                    <option value="desc">é™åº</option>
                    <option value="asc">å‡åº</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilter()">
                    <i class="bi bi-arrow-clockwise"></i>
                    é‡ç½®
                </button>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="per-page">
                    <option value="10">æ¯é¡µ10æ¡</option>
                    <option value="20" selected>æ¯é¡µ20æ¡</option>
                    <option value="50">æ¯é¡µ50æ¡</option>
                    <option value="100">æ¯é¡µ100æ¡</option>
                </select>
            </div>
        </div>

        <!-- äº¤æ˜“è®°å½•è¡¨æ ¼ -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>è‚¡ç¥¨</th>
                        <th>ç±»å‹</th>
                        <th>ä»·æ ¼</th>
                        <th>æ•°é‡</th>
                        <th>é‡‘é¢</th>
                        <th>åŸå› </th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="trades-table-body">
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            åŠ è½½ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="äº¤æ˜“è®°å½•åˆ†é¡µ">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘äº¤æ˜“æ¨¡æ€æ¡† -->
<div class="modal fade" id="addTradeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trade-modal-title">æ·»åŠ äº¤æ˜“è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- äº¤æ˜“ç±»å‹é€‰æ‹©æ­¥éª¤ -->
                <div id="trade-type-selection" class="text-center mb-4">
                    <h6 class="mb-3">è¯·é€‰æ‹©äº¤æ˜“ç±»å‹</h6>
                    <div class="row justify-content-center">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-success btn-lg w-100 mb-2" id="select-buy-btn">
                                <i class="bi bi-arrow-up-circle"></i>
                                <div>ä¹°å…¥</div>
                                <small class="text-muted">è´­ä¹°è‚¡ç¥¨</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-danger btn-lg w-100 mb-2" id="select-sell-btn">
                                <i class="bi bi-arrow-down-circle"></i>
                                <div>å–å‡º</div>
                                <small class="text-muted">å‡ºå”®æŒä»“è‚¡ç¥¨</small>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- äº¤æ˜“è¡¨å• -->
                <div id="trade-form-container" style="display: none;">
                    <form id="trade-form" novalidate>
                        <!-- ä¹°å…¥æ—¶çš„è‚¡ç¥¨è¾“å…¥ -->
                        <div id="buy-stock-input" class="row" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stock-code" class="form-label">è‚¡ç¥¨ä»£ç  <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="stock-code" name="stock_code"
                                        placeholder="ä¾‹å¦‚: 000001" title="è¯·è¾“å…¥6ä½æ•°å­—çš„è‚¡ç¥¨ä»£ç ">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stock-name" class="form-label">è‚¡ç¥¨åç§° <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="stock-name" name="stock_name"
                                        placeholder="ä¾‹å¦‚: å¹³å®‰é“¶è¡Œ">
                                </div>
                            </div>
                        </div>

                        <!-- å–å‡ºæ—¶çš„è‚¡ç¥¨é€‰æ‹© -->
                        <div id="sell-stock-selection" class="row" style="display: none;">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="holding-stock-select" class="form-label">æŒä»“è‚¡ç¥¨ <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="holding-stock-select" name="holding_stock">
                                        <option value="">è¯·é€‰æ‹©è¦å–å‡ºçš„è‚¡ç¥¨</option>
                                    </select>
                                    <div class="form-text">
                                        <small id="holding-info" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="trade-type" class="form-label">äº¤æ˜“ç±»å‹ <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="trade-type" name="trade_type">
                                        <option value="">è¯·é€‰æ‹©äº¤æ˜“ç±»å‹</option>
                                        <option value="buy">ä¹°å…¥</option>
                                        <option value="sell">å–å‡º</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="trade-date" class="form-label">äº¤æ˜“æ—¥æœŸ <span
                                            class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="trade-date" name="trade_date">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="price" class="form-label">ä»·æ ¼ <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        <input type="number" class="form-control" id="price" name="price" step="0.001"
                                            placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">æ•°é‡ <span
                                            class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="quantity" name="quantity" step="1"
                                            placeholder="100">
                                        <span class="input-group-text">è‚¡</span>
                                    </div>
                                    <div class="input-hint" id="quantity-hint">è‚¡ç¥¨æ•°é‡å¿…é¡»æ˜¯100çš„å€æ•°</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="reason" class="form-label">æ“ä½œåŸå›  <span class="text-danger">*</span></label>
                            <select class="form-select" id="reason" name="reason">
                                <option value="">è¯·é€‰æ‹©æ“ä½œåŸå› </option>
                            </select>
                        </div>

                        <!-- ä¹°å…¥æ—¶çš„æ­¢æŸæ­¢ç›ˆè®¾ç½® -->
                        <div id="buy-settings" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">æ­¢æŸæ­¢ç›ˆè®¾ç½®</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="use-batch-profit-taking"
                                        name="use_batch_profit_taking">
                                    <label class="form-check-label" for="use-batch-profit-taking">
                                        åˆ†æ‰¹æ­¢ç›ˆ
                                    </label>
                                </div>
                            </div>

                            <!-- æ­¢æŸè®¾ç½® -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="stop-loss-price" class="form-label">æ­¢æŸä»·æ ¼</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control" id="stop-loss-price"
                                                name="stop_loss_price" step="0.01" placeholder="0.00">
                                        </div>
                                        <small class="form-text text-muted">é¢„è®¡äºæŸæ¯”ä¾‹: <span
                                                id="expected-loss-ratio">-</span></small>
                                    </div>
                                </div>
                            </div>

                            <!-- å•ä¸€æ­¢ç›ˆè®¾ç½® -->
                            <div id="single-profit-settings">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="take-profit-ratio" class="form-label">æ­¢ç›ˆæ¯”ä¾‹</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="take-profit-ratio"
                                                    name="take_profit_ratio" step="0.01" placeholder="0.20">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="sell-ratio" class="form-label">å–å‡ºæ¯”ä¾‹</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="sell-ratio"
                                                    name="sell_ratio" step="0.01" placeholder="0.50">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">é¢„è®¡æ”¶ç›Šç‡</label>
                                            <div class="form-control-plaintext">
                                                <span id="expected-profit-ratio" class="fw-bold">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- åˆ†æ‰¹æ­¢ç›ˆè®¾ç½® -->
                            <div id="batch-profit-settings" style="display: none;">
                                <div id="profit-targets-container">
                                    <!-- ProfitTargetsManager ç»„ä»¶å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" maxlength="500"
                                placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯..."></textarea>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="back-to-type-selection"
                    style="display: none;">
                    <i class="bi bi-arrow-left"></i>
                    è¿”å›
                </button>
                <button type="button" class="btn btn-info" onclick="testSimpleValidation()" title="æµ‹è¯•ç®€æ´éªŒè¯">
                    âœ… æµ‹è¯•éªŒè¯
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="save-trade-btn" style="display: none;">
                    <span class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è®¢æ­£äº¤æ˜“æ¨¡æ€æ¡† -->
<div class="modal fade" id="correctTradeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">è®¢æ­£äº¤æ˜“è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    è®¢æ­£æ“ä½œå°†ä¿ç•™åŸå§‹è®°å½•å¹¶åˆ›å»ºæ–°çš„è®¢æ­£è®°å½•ï¼Œè¯·è°¨æ…æ“ä½œã€‚
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6>åŸå§‹æ•°æ®</h6>
                        <div id="original-trade-data" class="border p-3 rounded bg-light">
                            <!-- åŸå§‹äº¤æ˜“æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>è®¢æ­£åæ•°æ®</h6>
                        <form id="correction-form" novalidate>
                            <div class="mb-3">
                                <label for="corrected-stock-code" class="form-label">è‚¡ç¥¨ä»£ç </label>
                                <input type="text" class="form-control" id="corrected-stock-code" name="stock_code"
                                    maxlength="10">
                            </div>
                            <div class="mb-3">
                                <label for="corrected-stock-name" class="form-label">è‚¡ç¥¨åç§°</label>
                                <input type="text" class="form-control" id="corrected-stock-name" name="stock_name"
                                    maxlength="50">
                            </div>
                            <div class="mb-3">
                                <label for="corrected-price" class="form-label">ä»·æ ¼</label>
                                <input type="number" class="form-control" id="corrected-price" name="price" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label for="corrected-quantity" class="form-label">æ•°é‡</label>
                                <input type="number" class="form-control" id="corrected-quantity" name="quantity">
                            </div>
                            <div class="mb-3">
                                <label for="corrected-trade-date" class="form-label">äº¤æ˜“æ—¥æœŸ</label>
                                <input type="datetime-local" class="form-control" id="corrected-trade-date"
                                    name="trade_date">
                            </div>
                            <div class="mb-3">
                                <label for="corrected-reason" class="form-label">æ“ä½œåŸå› </label>
                                <select class="form-select" id="corrected-reason" name="reason">
                                    <!-- é€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                                </select>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="mt-3">
                    <label for="correction-reason" class="form-label">è®¢æ­£åŸå›  <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="correction-reason" rows="3"
                        placeholder="è¯·è¯¦ç»†è¯´æ˜è®¢æ­£çš„åŸå› ..."></textarea>
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-warning" id="submit-correction-btn">
                    <span class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>
                    ç¡®è®¤è®¢æ­£
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è®¢æ­£å†å²æ¨¡æ€æ¡† -->
<div class="modal fade" id="correctionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">è®¢æ­£å†å²</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="correction-history-content">
                    <!-- è®¢æ­£å†å²å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/simple-form-validator.js') }}"></script>
<script src="{{ url_for('static', filename='js/emergency-cleanup.js') }}"></script>
<script src="{{ url_for('static', filename='js/profit-targets-manager.js') }}"></script>
<script>
    // å…¨å±€é˜²é‡å¤æäº¤çŠ¶æ€ç®¡ç†
    let isSubmitting = false;
    let lastSubmitTime = 0;
    const SUBMIT_COOLDOWN = 2000; // 2ç§’å†·å´æ—¶é—´

    // é‡ç½®æäº¤çŠ¶æ€
    function resetSubmissionState() {
        isSubmitting = false;
        lastSubmitTime = 0; // åŒæ—¶é‡ç½®æ—¶é—´æˆ³
        console.log('ğŸ”„ æäº¤çŠ¶æ€å·²é‡ç½®');
    }

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æäº¤
    function canSubmit() {
        const now = Date.now();
        if (isSubmitting) {
            console.log('ğŸ›¡ï¸ æ­£åœ¨æäº¤ä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
            return false;
        }
        if (now - lastSubmitTime < SUBMIT_COOLDOWN) {
            console.log('ğŸ›¡ï¸ æäº¤è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
            return false;
        }
        return true;
    }

    // è®¾ç½®æäº¤çŠ¶æ€
    function setSubmitting(state) {
        isSubmitting = state;
        if (state) {
            console.log('ğŸ”’ è®¾ç½®æäº¤çŠ¶æ€ä¸ºï¼šæ­£åœ¨æäº¤');
        } else {
            // æäº¤å®Œæˆæ—¶æ›´æ–°æ—¶é—´æˆ³ï¼Œç”¨äºé˜²æ­¢è¿‡äºé¢‘ç¹çš„æäº¤
            lastSubmitTime = Date.now();
            console.log('ğŸ”“ è®¾ç½®æäº¤çŠ¶æ€ä¸ºï¼šå¯ä»¥æäº¤');
        }
    }

    // é¡µé¢å¸è½½æ—¶é‡ç½®çŠ¶æ€
    window.addEventListener('beforeunload', function () {
        resetSubmissionState();
    });
    // ç«‹å³éšè—åŠ è½½çŠ¶æ€ï¼Œé˜²æ­¢å¡ä½
    (function () {
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) {
            loadingModal.classList.remove('show');
            loadingModal.style.display = 'none';
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        }

        // ç«‹å³æ˜¾ç¤ºç©ºçŠ¶æ€ï¼Œé¿å…ä¸€ç›´æ˜¾ç¤ºåŠ è½½ä¸­
        const tbody = document.getElementById('trades-table-body');
        if (tbody && tbody.innerHTML.includes('åŠ è½½ä¸­')) {
            tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    æ­£åœ¨åŠ è½½æ•°æ®...
                </td>
            </tr>
        `;
        }
    })();

    // ç«‹å³éšè—åŠ è½½çŠ¶æ€ï¼Œé˜²æ­¢å¡ä½
    (function () {
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) {
            loadingModal.classList.remove('show');
            loadingModal.style.display = 'none';
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        }
    })();

    // äº¤æ˜“è®°å½•é¡µé¢ç®¡ç†ç±»
    class TradingRecordsManager {
        constructor() {
            this.currentPage = 1;
            this.perPage = 20;
            this.totalPages = 1;
            this.currentFilters = {};
            this.buyReasons = [];
            this.sellReasons = [];
            this.editingTradeId = null;
            this.correctingTradeId = null;
            this.simpleValidator = null;
            this.profitTargetsManager = null;
            this.useBatchProfitTaking = false;
            this.previewCalculationTimer = null;

            this.init();
        }

        async init() {
            try {
                // åŠ è½½é…ç½®æ•°æ®
                await this.loadTradeConfig();

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                this.setupEventListeners();

                // åˆå§‹åŒ–è¡¨å•
                this.initializeForms();

                // åŠ è½½äº¤æ˜“è®°å½•
                await this.loadTrades();

                console.log('Trading records page initialized successfully');
            } catch (error) {
                console.error('Failed to initialize trading records page:', error);
                showMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
            }
        }

        async loadTradeConfig() {
            try {
                const [buyReasonsResponse, sellReasonsResponse] = await Promise.all([
                    apiClient.request('GET', '/trades/config/buy-reasons'),
                    apiClient.request('GET', '/trades/config/sell-reasons')
                ]);

                this.buyReasons = buyReasonsResponse.data.buy_reasons || [];
                this.sellReasons = sellReasonsResponse.data.sell_reasons || [];

                // æ›´æ–°ç­›é€‰å™¨ä¸­çš„åŸå› é€‰é¡¹
                this.updateReasonFilters();

            } catch (error) {
                console.error('Failed to load trade config:', error);
                // ä½¿ç”¨é»˜è®¤é…ç½®
                this.buyReasons = ['å°‘å¦‡B1æˆ˜æ³•', 'å°‘å¦‡SB1æˆ˜æ³•', 'å°‘å¦‡B2æˆ˜æ³•', 'å•é’ˆäºŒåæˆ˜æ³•', 'ä¸ç¬¦åˆäº¤æ˜“çºªå¾‹'];
                this.sellReasons = ['éƒ¨åˆ†æ­¢ç›ˆ', 'æ­¢æŸ', 'ä¸‹ç­‰é©¬/è‰æ³¥é©¬', 'è§é¡¶ä¿¡å·', 'ä¸ç¬¦åˆäº¤æ˜“çºªå¾‹'];
                this.updateReasonFilters();
            }
        }

        updateReasonFilters() {
            const reasonFilter = document.getElementById('reason-filter');
            const allReasons = [...this.buyReasons, ...this.sellReasons];

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨åŸå› "ï¼‰
            reasonFilter.innerHTML = '<option value="">å…¨éƒ¨åŸå› </option>';

            // æ·»åŠ æ‰€æœ‰åŸå› é€‰é¡¹
            allReasons.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason;
                option.textContent = reason;
                reasonFilter.appendChild(option);
            });
        }

        setupEventListeners() {
            // ç­›é€‰å’Œæ’åºäº‹ä»¶
            document.getElementById('per-page').addEventListener('change', () => {
                tradingManager.perPage = parseInt(document.getElementById('per-page').value);
                tradingManager.currentPage = 1;
                tradingManager.loadTrades();
            });

            // äº¤æ˜“ç±»å‹å˜åŒ–äº‹ä»¶
            document.getElementById('trade-type').addEventListener('change', (e) => {
                this.updateReasonOptions(e.target.value);
                this.toggleBuySettings(e.target.value === 'buy');
            });

            // åˆ†æ‰¹æ­¢ç›ˆå¼€å…³äº‹ä»¶
            document.getElementById('use-batch-profit-taking').addEventListener('change', (e) => {
                tradingManager.toggleProfitTakingMode(e.target.checked);
            });

            // ä¹°å…¥ä»·æ ¼å˜åŒ–äº‹ä»¶ï¼ˆç”¨äºæ›´æ–°åˆ†æ‰¹æ­¢ç›ˆç»„ä»¶çš„ä¹°å…¥ä»·æ ¼ï¼‰
            document.getElementById('price').addEventListener('input', (e) => {
                const buyPrice = parseFloat(e.target.value) || 0;
                if (tradingManager.profitTargetsManager) {
                    tradingManager.profitTargetsManager.setBuyPrice(buyPrice);
                }
                tradingManager.calculateRiskReward();
            });

            // æ­¢æŸæ­¢ç›ˆå®æ—¶è®¡ç®—
            ['stop-loss-price', 'take-profit-ratio', 'sell-ratio'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => tradingManager.calculateRiskReward());
                }
            });

            // ä¿å­˜äº¤æ˜“æŒ‰é’® - å¸¦é‡å¤æäº¤é˜²æŠ¤
            document.getElementById('save-trade-btn').addEventListener('click', async (e) => {
                // ä½¿ç”¨å…¨å±€çš„é‡å¤æäº¤é˜²æŠ¤
                if (!canSubmit()) {
                    return;
                }

                // è®¾ç½®æäº¤çŠ¶æ€
                setSubmitting(true);

                const saveBtn = document.getElementById('save-trade-btn');

                try {
                    console.log('ğŸ¯ æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¼€å§‹å¤„ç†...');

                    // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    if (saveBtn) {
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ä¿å­˜ä¸­...';
                    }

                    console.log('ğŸ¯ å‡†å¤‡è°ƒç”¨ tradingManager.saveTrade()...');
                    // è°ƒç”¨TradingRecordsManagerå®ä¾‹çš„saveTradeæ–¹æ³•
                    await tradingManager.saveTrade();
                    console.log('ğŸ¯ tradingManager.saveTrade() æ‰§è¡Œå®Œæˆ');

                } catch (error) {
                    console.error('ğŸ’¥ ä¿å­˜æŒ‰é’®äº‹ä»¶å¤„ç†é”™è¯¯:', error);
                    console.error('ğŸ’¥ æŒ‰é’®äº‹ä»¶é”™è¯¯å †æ ˆ:', error.stack);
                    showMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                } finally {
                    // é‡ç½®æŒ‰é’®çŠ¶æ€å’Œæäº¤çŠ¶æ€
                    setSubmitting(false);
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'ä¿å­˜';
                    }
                }
            });

            // è®¢æ­£ç¡®è®¤æŒ‰é’®
            document.getElementById('submit-correction-btn').addEventListener('click', () => {
                tradingManager.submitCorrection();
            });

            // æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶åˆå§‹åŒ–äº¤æ˜“ç±»å‹é€‰æ‹©
            document.getElementById('addTradeModal').addEventListener('show.bs.modal', () => {
                console.log('æ¨¡æ€æ¡†æ˜¾ç¤ºäº‹ä»¶è§¦å‘ï¼ŒeditingTradeId:', tradingManager.editingTradeId);

                // å¦‚æœä¸æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ˜¾ç¤ºäº¤æ˜“ç±»å‹é€‰æ‹©
                if (!tradingManager.editingTradeId) {
                    console.log('æ–°å»ºæ¨¡å¼ï¼šæ˜¾ç¤ºäº¤æ˜“ç±»å‹é€‰æ‹©');
                    tradingManager.showTradeTypeSelection();
                } else {
                    console.log('ç¼–è¾‘æ¨¡å¼ï¼šè·³è¿‡äº¤æ˜“ç±»å‹é€‰æ‹©ï¼Œç›´æ¥æ˜¾ç¤ºè¡¨å•');
                    // ç¼–è¾‘æ¨¡å¼ï¼šç¡®ä¿ç•Œé¢çŠ¶æ€æ­£ç¡®
                    console.log('è®¾ç½®ç¼–è¾‘æ¨¡å¼ç•Œé¢çŠ¶æ€...');

                    // å¼ºåˆ¶éšè—äº¤æ˜“ç±»å‹é€‰æ‹©ç•Œé¢
                    const typeSelection = document.getElementById('trade-type-selection');
                    const formContainer = document.getElementById('trade-form-container');
                    const backBtn = document.getElementById('back-to-type-selection');
                    const saveBtn = document.getElementById('save-trade-btn');

                    if (typeSelection) typeSelection.style.display = 'none';
                    if (formContainer) formContainer.style.display = 'block';
                    if (backBtn) backBtn.style.display = 'none';
                    if (saveBtn) saveBtn.style.display = 'inline-block';

                    console.log('ç¼–è¾‘æ¨¡å¼ç•Œé¢çŠ¶æ€è®¾ç½®å®Œæˆ');
                }
            });

            // æ¨¡æ€æ¡†å…³é—­æ—¶é‡ç½®è¡¨å•
            document.getElementById('addTradeModal').addEventListener('hidden.bs.modal', () => {
                tradingManager.resetTradeForm();
            });

            // è‚¡ç¥¨ä»£ç å˜åŒ–æ—¶æ›´æ–°æ•°é‡æç¤º
            document.getElementById('stock-code').addEventListener('input', (e) => {
                this.updateQuantityHint(e.target.value);
            });

            document.getElementById('correctTradeModal').addEventListener('hidden.bs.modal', () => {
                tradingManager.resetCorrectionForm();
            });

            // äº¤æ˜“ç±»å‹é€‰æ‹©äº‹ä»¶
            document.getElementById('select-buy-btn').addEventListener('click', () => {
                tradingManager.selectTradeType('buy');
            });

            document.getElementById('select-sell-btn').addEventListener('click', () => {
                tradingManager.selectTradeType('sell');
            });


            // æ¨¡æ€æ¡†éšè—æ—¶æ¸…ç†çŠ¶æ€
            document.getElementById('addTradeModal').addEventListener('hidden.bs.modal', () => {
                console.log('æ¨¡æ€æ¡†å·²éšè—ï¼Œæ¸…ç†çŠ¶æ€');

                // é‡ç½®æäº¤çŠ¶æ€
                if (typeof resetSubmissionState === 'function') {
                    resetSubmissionState();
                }

                // æ¸…ç†ç¼–è¾‘çŠ¶æ€
                if (tradingManager) {
                    tradingManager.editingTradeId = null;
                }

                console.log('çŠ¶æ€æ¸…ç†å®Œæˆ');
            });
            // è¿”å›ç±»å‹é€‰æ‹©æŒ‰é’®
            document.getElementById('back-to-type-selection').addEventListener('click', () => {
                tradingManager.showTradeTypeSelection();
            });

            // æŒä»“è‚¡ç¥¨é€‰æ‹©å˜åŒ–äº‹ä»¶
            document.getElementById('holding-stock-select').addEventListener('change', (e) => {
                this.onHoldingStockSelect(e.target.value);
            });

            // è®¾ç½®è¡¨å•éªŒè¯
            this.setupFormValidation();
        }

        setupFormValidation() {
            const tradeForm = document.getElementById('trade-form');
            const correctionForm = document.getElementById('correction-form');

            // äº¤æ˜“è¡¨å•éªŒè¯
            this.formValidator = new FormValidator(tradeForm, {
                realTimeValidation: true,
                showSuccessState: true,
                scrollToError: true
            });

            // æ·»åŠ è‡ªå®šä¹‰éªŒè¯è§„åˆ™
            this.formValidator.addRule('stock_code', {
                validator: (value) => {
                    // å¦‚æœæ˜¯å–å‡ºæ¨¡å¼ä¸”é€‰æ‹©äº†æŒä»“è‚¡ç¥¨ï¼Œè‚¡ç¥¨ä»£ç ä¼šè‡ªåŠ¨å¡«å……
                    if (this.currentTradeType === 'sell') {
                        const holdingSelect = document.getElementById('holding-stock-select');
                        if (holdingSelect && holdingSelect.value) {
                            return true; // æŒä»“è‚¡ç¥¨é€‰æ‹©æœ‰æ•ˆ
                        }
                    }
                    // å¦åˆ™ä½¿ç”¨æ ‡å‡†è‚¡ç¥¨ä»£ç éªŒè¯
                    return Validators.stockCode(value);
                },
                message: () => {
                    if (this.currentTradeType === 'sell') {
                        return 'è¯·é€‰æ‹©è¦å–å‡ºçš„æŒä»“è‚¡ç¥¨';
                    }
                    return 'è¯·è¾“å…¥6ä½æ•°å­—çš„è‚¡ç¥¨ä»£ç ';
                }
            });

            this.formValidator.addRule('quantity', {
                validator: (value) => {
                    if (!value) return false;
                    const num = parseInt(value);
                    if (isNaN(num) || num <= 0) return false;

                    // å–å‡ºæ—¶æ£€æŸ¥æœ€å¤§æ•°é‡é™åˆ¶
                    if (this.currentTradeType === 'sell') {
                        const quantityInput = document.getElementById('quantity');
                        const maxQuantity = parseInt(quantityInput.max);
                        if (maxQuantity && num > maxQuantity) {
                            return false;
                        }
                    }

                    // è·å–è‚¡ç¥¨ä»£ç 
                    const stockCode = document.getElementById('stock-code').value;
                    if (!stockCode) return num > 0; // å¦‚æœæ²¡æœ‰è‚¡ç¥¨ä»£ç ï¼ŒåªéªŒè¯å¤§äº0

                    // ç§‘åˆ›æ¿è‚¡ç¥¨ï¼ˆ68å¼€å¤´ï¼‰å¯ä»¥æ˜¯ä»»æ„æ•°é‡
                    if (stockCode.startsWith('68')) {
                        return num > 0;
                    } else {
                        // å…¶ä»–è‚¡ç¥¨å¿…é¡»æ˜¯100çš„å€æ•°ï¼ˆä¹°å…¥æ—¶ï¼‰
                        if (this.currentTradeType === 'buy') {
                            return num > 0 && num % 100 === 0;
                        } else {
                            // å–å‡ºæ—¶å¯ä»¥æ˜¯ä»»æ„æ•°é‡
                            return num > 0;
                        }
                    }
                },
                message: () => {
                    const stockCode = document.getElementById('stock-code').value;
                    const num = parseInt(document.getElementById('quantity').value);

                    // å–å‡ºæ—¶çš„é”™è¯¯æ¶ˆæ¯
                    if (this.currentTradeType === 'sell') {
                        const quantityInput = document.getElementById('quantity');
                        const maxQuantity = parseInt(quantityInput.max);
                        if (maxQuantity && num > maxQuantity) {
                            return `å–å‡ºæ•°é‡ä¸èƒ½è¶…è¿‡æŒä»“æ•°é‡ ${maxQuantity} è‚¡`;
                        }
                    }

                    // ä¹°å…¥æ—¶çš„é”™è¯¯æ¶ˆæ¯
                    if (stockCode && stockCode.startsWith('68')) {
                        return 'ç§‘åˆ›æ¿è‚¡ç¥¨æ•°é‡å¿…é¡»å¤§äº0';
                    } else {
                        if (this.currentTradeType === 'buy') {
                            return 'è‚¡ç¥¨æ•°é‡å¿…é¡»æ˜¯100çš„å€æ•°';
                        } else {
                            return 'å–å‡ºæ•°é‡å¿…é¡»å¤§äº0';
                        }
                    }
                }
            });

            this.formValidator.addRule('price', {
                validator: Validators.price,
                message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼'
            });

            // æ·»åŠ åˆ†æ‰¹æ­¢ç›ˆéªŒè¯è§„åˆ™
            this.formValidator.addCustomValidator(() => {
                const tradeType = document.getElementById('trade-type').value;
                if (tradeType !== 'buy') {
                    return { isValid: true };
                }

                if (this.useBatchProfitTaking) {
                    // éªŒè¯åˆ†æ‰¹æ­¢ç›ˆè®¾ç½®
                    if (!this.profitTargetsManager) {
                        return {
                            isValid: false,
                            message: 'åˆ†æ‰¹æ­¢ç›ˆç»„ä»¶æœªåˆå§‹åŒ–'
                        };
                    }

                    if (!this.profitTargetsManager.isValidTargets()) {
                        const errors = this.profitTargetsManager.getValidationErrors();
                        return {
                            isValid: false,
                            message: 'è¯·æ£€æŸ¥åˆ†æ‰¹æ­¢ç›ˆè®¾ç½®ä¸­çš„é”™è¯¯',
                            errors: errors
                        };
                    }
                } else {
                    // éªŒè¯å•ä¸€æ­¢ç›ˆè®¾ç½®ï¼ˆå¯é€‰ï¼‰
                    const takeProfitRatio = document.getElementById('take-profit-ratio').value;
                    const sellRatio = document.getElementById('sell-ratio').value;

                    if (takeProfitRatio && !sellRatio) {
                        return {
                            isValid: false,
                            message: 'è®¾ç½®äº†æ­¢ç›ˆæ¯”ä¾‹æ—¶ï¼Œå–å‡ºæ¯”ä¾‹ä¸èƒ½ä¸ºç©º',
                            field: 'sell_ratio'
                        };
                    }

                    if (sellRatio && !takeProfitRatio) {
                        return {
                            isValid: false,
                            message: 'è®¾ç½®äº†å–å‡ºæ¯”ä¾‹æ—¶ï¼Œæ­¢ç›ˆæ¯”ä¾‹ä¸èƒ½ä¸ºç©º',
                            field: 'take_profit_ratio'
                        };
                    }
                }

                return { isValid: true };
            });

            // ç›‘å¬è¡¨å•æäº¤äº‹ä»¶
            tradeForm.addEventListener('formValidSubmit', (e) => {
                this.handleTradeFormSubmit(e.detail.formData);
            });

            // è®¢æ­£è¡¨å•éªŒè¯
            if (correctionForm) {
                this.correctionValidator = new FormValidator(correctionForm, {
                    realTimeValidation: true,
                    showSuccessState: false
                });

                correctionForm.addEventListener('formValidSubmit', (e) => {
                    this.handleCorrectionFormSubmit(e.detail.formData);
                });
            }
        }

        initializeForms() {
            // è®¾ç½®é»˜è®¤äº¤æ˜“æ—¥æœŸä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('trade-date').value = localDateTime;

            // åˆå§‹åŒ–ç®€æ´çš„éªŒè¯å™¨
            this.simpleValidator = new SimpleFormValidator('trade-form');

            // è®¾ç½®å®æ—¶éªŒè¯
            this.setupRealTimeValidation();

            console.log('âœ… è¡¨å•éªŒè¯å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        setupRealTimeValidation() {
            const fieldsToValidate = ['stock-code', 'stock-name', 'trade-type', 'trade-date', 'price', 'quantity', 'reason', 'holding-stock-select'];

            fieldsToValidate.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', () => {
                        this.simpleValidator.validateField(fieldId);
                    });

                    field.addEventListener('input', () => {
                        // æ¸…é™¤ä¹‹å‰çš„éªŒè¯çŠ¶æ€ï¼Œé¿å…è¾“å…¥æ—¶æ˜¾ç¤ºé”™è¯¯
                        this.simpleValidator.clearFieldError(field);

                        // å»¶è¿ŸéªŒè¯ï¼Œç»™ç”¨æˆ·æ›´å¤šæ—¶é—´è¾“å…¥
                        clearTimeout(field.validationTimer);
                        field.validationTimer = setTimeout(() => {
                            // åªæœ‰åœ¨å­—æ®µæœ‰å€¼æ—¶æ‰è¿›è¡ŒéªŒè¯ï¼Œé¿å…è¾“å…¥è¿‡ç¨‹ä¸­çš„è¯¯æŠ¥
                            if (field.value && field.value.trim() !== '') {
                                this.simpleValidator.validateField(fieldId);
                            }
                        }, 1000); // å¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°1ç§’
                    });
                }
            });
        }

        updateReasonOptions(tradeType) {
            const reasonSelect = document.getElementById('reason');
            const correctedReasonSelect = document.getElementById('corrected-reason');

            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = reasonSelect.value;
            const currentCorrectedValue = correctedReasonSelect ? correctedReasonSelect.value : '';

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            reasonSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ“ä½œåŸå› </option>';
            if (correctedReasonSelect) {
                correctedReasonSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ“ä½œåŸå› </option>';
            }

            const reasons = tradeType === 'buy' ? this.buyReasons :
                tradeType === 'sell' ? this.sellReasons : [];

            reasons.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason;
                option.textContent = reason;
                reasonSelect.appendChild(option);

                if (correctedReasonSelect) {
                    const correctedOption = document.createElement('option');
                    correctedOption.value = reason;
                    correctedOption.textContent = reason;
                    correctedReasonSelect.appendChild(correctedOption);
                }
            });

            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœè¯¥å€¼åœ¨æ–°çš„é€‰é¡¹ä¸­å­˜åœ¨ï¼‰
            if (currentValue && reasons.includes(currentValue)) {
                reasonSelect.value = currentValue;
                console.log('Restored reason value:', currentValue);
            }
            if (correctedReasonSelect && currentCorrectedValue && reasons.includes(currentCorrectedValue)) {
                correctedReasonSelect.value = currentCorrectedValue;
            }
        }

        toggleBuySettings(show) {
            const buySettings = document.getElementById('buy-settings');
            buySettings.style.display = show ? 'block' : 'none';

            if (show) {
                // åˆå§‹åŒ–åˆ†æ‰¹æ­¢ç›ˆç»„ä»¶
                this.initializeProfitTargetsManager();
            } else {
                // æ¸…ç©ºä¹°å…¥è®¾ç½®å­—æ®µ
                ['stop-loss-price', 'take-profit-ratio', 'sell-ratio'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                // é‡ç½®åˆ†æ‰¹æ­¢ç›ˆå¼€å…³
                document.getElementById('use-batch-profit-taking').checked = false;
                this.toggleProfitTakingMode(false);
                this.updateRiskRewardDisplay();
            }
        }

        toggleProfitTakingMode(useBatchMode) {
            this.useBatchProfitTaking = useBatchMode;

            const singleProfitSettings = document.getElementById('single-profit-settings');
            const batchProfitSettings = document.getElementById('batch-profit-settings');

            if (useBatchMode) {
                // åˆ‡æ¢åˆ°åˆ†æ‰¹æ­¢ç›ˆæ¨¡å¼
                singleProfitSettings.style.display = 'none';
                batchProfitSettings.style.display = 'block';

                // åˆå§‹åŒ–åˆ†æ‰¹æ­¢ç›ˆç»„ä»¶
                this.initializeProfitTargetsManager();

                // æ¸…ç©ºå•ä¸€æ­¢ç›ˆå­—æ®µ
                ['take-profit-ratio', 'sell-ratio'].forEach(id => {
                    document.getElementById(id).value = '';
                });

                // æ¸…ç©ºå•ä¸€æ­¢ç›ˆçš„é¢„æœŸæ”¶ç›Šç‡æ˜¾ç¤º
                document.getElementById('expected-profit-ratio').textContent = '-';
                document.getElementById('expected-profit-ratio').className = 'fw-bold';

            } else {
                // åˆ‡æ¢åˆ°å•ä¸€æ­¢ç›ˆæ¨¡å¼
                singleProfitSettings.style.display = 'block';
                batchProfitSettings.style.display = 'none';

                // é”€æ¯åˆ†æ‰¹æ­¢ç›ˆç»„ä»¶
                if (this.profitTargetsManager) {
                    this.profitTargetsManager.destroy();
                    this.profitTargetsManager = null;
                }
            }
        }

        initializeProfitTargetsManager() {
            if (this.profitTargetsManager) {
                return; // å·²ç»åˆå§‹åŒ–è¿‡äº†
            }

            const container = document.getElementById('profit-targets-container');
            if (!container) {
                console.error('Profit targets container not found');
                return;
            }

            const buyPrice = parseFloat(document.getElementById('price').value) || 0;

            this.profitTargetsManager = new ProfitTargetsManager(container, {
                maxTargets: 10,
                minTargets: 1,
                buyPrice: buyPrice,
                onTargetsChange: (targets, isValid) => {
                    this.onProfitTargetsChange(targets, isValid);
                },
                onValidationChange: (isValid, errors) => {
                    this.onProfitTargetsValidationChange(isValid, errors);
                }
            });
        }

        onProfitTargetsChange(targets, isValid) {
            // åˆ†æ‰¹æ­¢ç›ˆç›®æ ‡å˜åŒ–æ—¶çš„å›è°ƒ
            console.log('Profit targets changed:', targets, 'Valid:', isValid);

            // å®æ—¶è®¡ç®—å’Œæ˜¾ç¤ºé¢„æœŸæ”¶ç›Šé¢„è§ˆ
            this.debouncePreviewCalculation();

            // è§¦å‘è¡¨å•éªŒè¯æ›´æ–°
            if (this.formValidator) {
                this.formValidator.validateField('profit_targets');
            }
        }

        onProfitTargetsValidationChange(isValid, errors) {
            // åˆ†æ‰¹æ­¢ç›ˆéªŒè¯çŠ¶æ€å˜åŒ–æ—¶çš„å›è°ƒ
            console.log('Profit targets validation changed:', isValid, errors);

            // æ˜¾ç¤ºéªŒè¯åé¦ˆ
            this.showProfitTargetsValidationFeedback(isValid, errors);

            // æ›´æ–°ä¿å­˜æŒ‰é’®çŠ¶æ€
            const saveBtn = document.getElementById('save-trade-btn');
            if (saveBtn && this.useBatchProfitTaking) {
                saveBtn.disabled = !isValid;

                // æ›´æ–°æŒ‰é’®æ ·å¼å’Œæç¤º
                if (isValid) {
                    saveBtn.classList.remove('btn-outline-primary');
                    saveBtn.classList.add('btn-primary');
                    saveBtn.title = '';
                } else {
                    saveBtn.classList.remove('btn-primary');
                    saveBtn.classList.add('btn-outline-primary');
                    saveBtn.title = 'è¯·å…ˆä¿®æ­£åˆ†æ‰¹æ­¢ç›ˆè®¾ç½®ä¸­çš„é”™è¯¯';
                }
            }
        }

        // é˜²æŠ–å¤„ç†é¢„è§ˆè®¡ç®—
        debouncePreviewCalculation() {
            if (this.previewCalculationTimer) {
                clearTimeout(this.previewCalculationTimer);
            }

            this.previewCalculationTimer = setTimeout(() => {
                this.validateAndPreviewBatchProfit();
            }, 500); // 500ms é˜²æŠ–
        }

        // å¤„ç†æ•°æ®åŒæ­¥é”™è¯¯
        handleDataSyncError(error, operation) {
            console.error(`Data sync error during ${operation}:`, error);

            let message = `${operation}å¤±è´¥`;
            let showRetry = false;

            if (error.response) {
                const status = error.response.status;
                const data = error.response.data;

                switch (status) {
                    case 400:
                        message = data.message || 'è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯';
                        break;
                    case 422:
                        message = 'æ•°æ®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥';
                        if (data.errors) {
                            this.showBatchProfitErrors(data.errors);
                        }
                        break;
                    case 404:
                        message = 'äº¤æ˜“è®°å½•ä¸å­˜åœ¨';
                        break;
                    case 500:
                        message = 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                        showRetry = true;
                        break;
                    default:
                        message = data.message || `${operation}å¤±è´¥ (${status})`;
                        showRetry = true;
                }
            } else if (error.code === 'NETWORK_ERROR') {
                message = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                showRetry = true;
            } else {
                message = error.message || `${operation}å¤±è´¥`;
                showRetry = true;
            }

            if (showRetry) {
                UXUtils.showError(message, {
                    action: {
                        text: 'é‡è¯•',
                        callback: () => {
                            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡è¯•é€»è¾‘
                            console.log('User requested retry for:', operation);
                        }
                    }
                });
            } else {
                UXUtils.showError(message);
            }
        }

        // éªŒè¯å‰åç«¯æ•°æ®ä¸€è‡´æ€§
        async validateDataConsistency(tradeId) {
            if (!tradeId || !this.useBatchProfitTaking) {
                return true;
            }

            try {
                // è·å–åç«¯æ•°æ®
                const response = await apiClient.getProfitTargets(tradeId);

                if (!response.success) {
                    console.warn('Failed to fetch profit targets for consistency check');
                    return false;
                }

                const backendTargets = response.data.profit_targets || [];
                const frontendTargets = this.profitTargetsManager ? this.profitTargetsManager.getTargets() : [];

                // ç®€å•çš„æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
                if (backendTargets.length !== frontendTargets.length) {
                    console.warn('Data inconsistency: target count mismatch');
                    return false;
                }

                // æ£€æŸ¥å…³é”®å­—æ®µæ˜¯å¦ä¸€è‡´
                for (let i = 0; i < backendTargets.length; i++) {
                    const backend = backendTargets[i];
                    const frontend = frontendTargets[i];

                    if (Math.abs(backend.target_price - frontend.targetPrice) > 0.01 ||
                        Math.abs(backend.sell_ratio - frontend.sellRatio) > 0.01) {
                        console.warn('Data inconsistency: target values mismatch');
                        return false;
                    }
                }

                return true;
            } catch (error) {
                console.error('Failed to validate data consistency:', error);
                return false;
            }
        }

        async calculateRiskReward() {
            const buyPrice = parseFloat(document.getElementById('price').value) || 0;
            const stopLossPrice = parseFloat(document.getElementById('stop-loss-price').value) || 0;
            const takeProfitRatio = parseFloat(document.getElementById('take-profit-ratio').value) || 0;
            const sellRatio = parseFloat(document.getElementById('sell-ratio').value) || 0;

            if (buyPrice <= 0) {
                this.updateRiskRewardDisplay();
                return;
            }

            try {
                const response = await apiClient.calculateRiskReward({
                    buy_price: buyPrice,
                    stop_loss_price: stopLossPrice > 0 ? stopLossPrice : null,
                    take_profit_ratio: takeProfitRatio > 0 ? takeProfitRatio / 100 : null,
                    sell_ratio: sellRatio > 0 ? sellRatio / 100 : null
                });

                this.updateRiskRewardDisplay(response.data);
            } catch (error) {
                console.error('Failed to calculate risk reward:', error);
                this.updateRiskRewardDisplay();
            }
        }

        updateRiskRewardDisplay(data = null) {
            const expectedLossRatio = document.getElementById('expected-loss-ratio');
            const expectedProfitRatio = document.getElementById('expected-profit-ratio');

            if (data) {
                expectedLossRatio.textContent = formatPercent(data.expected_loss_ratio || 0);
                expectedProfitRatio.textContent = formatPercent(data.expected_profit_ratio || 0);

                // æ ¹æ®ç›ˆäºæ¯”ä¾‹è®¾ç½®é¢œè‰²
                expectedLossRatio.className = data.expected_loss_ratio > 0 ? 'text-success' : '';
                expectedProfitRatio.className = data.expected_profit_ratio > 0 ? 'text-danger' : '';
            } else {
                expectedLossRatio.textContent = '-';
                expectedProfitRatio.textContent = '-';
                expectedLossRatio.className = '';
                expectedProfitRatio.className = '';
            }
        }

        async loadTrades() {
            const tbody = document.getElementById('trades-table-body');

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        æ­£åœ¨åŠ è½½äº¤æ˜“è®°å½•...
                    </td>
                </tr>
            `;

                const params = {
                    page: this.currentPage,
                    per_page: this.perPage,
                    sort_by: document.getElementById('sort-by').value,
                    sort_order: document.getElementById('sort-order').value,
                    ...this.currentFilters
                };

                // è®¾ç½®5ç§’è¶…æ—¶
                const timeout = 5000;
                const response = await Promise.race([
                    apiClient.getTrades(params),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout))
                ]);

                if (response && response.success) {
                    this.renderTradesTable(response.data.trades || []);
                    this.renderPagination({
                        total: response.data.total || 0,
                        pages: response.data.pages || 1,
                        current_page: response.data.current_page || 1,
                        per_page: response.data.per_page || 20,
                        has_next: response.data.has_next || false,
                        has_prev: response.data.has_prev || false
                    });
                } else {
                    throw new Error(response?.message || 'è·å–äº¤æ˜“è®°å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to load trades:', error);

                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                let errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
                if (error.message === 'è¯·æ±‚è¶…æ—¶') {
                    errorMessage = 'åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                } else if (error.message.includes('ç½‘ç»œ')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                }

                tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-warning"></i>
                        <div class="mb-2">${errorMessage}</div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="tradingManager.loadTrades()">
                            <i class="bi bi-arrow-clockwise"></i> é‡æ–°åŠ è½½
                        </button>
                    </td>
                </tr>
            `;

                // é‡ç½®åˆ†é¡µ
                this.renderPagination({ pages: 0, current_page: 1 });

                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
                if (error.message === 'è¯·æ±‚è¶…æ—¶') {
                    showMessage('åŠ è½½è¶…æ—¶ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿåˆšå¯åŠ¨æˆ–ç½‘ç»œè¾ƒæ…¢ï¼Œè¯·ç¨åé‡è¯•', 'warning');
                } else {
                    showMessage('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }
        }

        renderTradesTable(trades) {
            const tbody = document.getElementById('trades-table-body');

            if (!trades || trades.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <div class="mb-2">æš‚æ— äº¤æ˜“è®°å½•</div>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTradeModal">
                            <i class="bi bi-plus-circle"></i> æ·»åŠ ç¬¬ä¸€æ¡è®°å½•
                        </button>
                    </td>
                </tr>
            `;
                return;
            }

            try {
                tbody.innerHTML = trades.map(trade => `
                <tr ${trade.is_corrected ? 'class="table-warning"' : ''}>
                    <td>${formatDate(trade.trade_date)}</td>
                    <td>
                        <div class="fw-bold">${trade.stock_code}</div>
                        <small class="text-muted">${trade.stock_name}</small>
                    </td>
                    <td>
                        <span class="badge ${trade.trade_type === 'buy' ? 'bg-success' : 'bg-danger'}">
                            ${trade.trade_type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}
                        </span>
                    </td>
                    <td class="fw-bold">Â¥${trade.price.toFixed(2)}</td>
                    <td>${trade.quantity.toLocaleString()}</td>
                    <td class="fw-bold">Â¥${(trade.price * trade.quantity).toLocaleString()}</td>
                    <td>
                        <span class="badge bg-secondary">${trade.reason}</span>
                    </td>
                    <td>
                        ${trade.is_corrected ?
                        '<span class="badge bg-warning">å·²è®¢æ­£</span>' :
                        '<span class="badge bg-success">æ­£å¸¸</span>'
                    }
                        ${trade.original_record_id ?
                        '<br><small class="text-muted">è®¢æ­£è®°å½•</small>' : ''
                    }
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" 
                                    onclick="tradingManager.editTrade(${trade.id})" title="ç¼–è¾‘">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning" 
                                    onclick="tradingManager.correctTrade(${trade.id})" title="è®¢æ­£">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button type="button" class="btn btn-outline-info" 
                                    onclick="tradingManager.viewCorrectionHistory(${trade.id})" title="å†å²">
                                <i class="bi bi-clock-history"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" 
                                    onclick="tradingManager.deleteTrade(${trade.id})" title="åˆ é™¤">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            } catch (error) {
                console.error('Error rendering trades table:', error);
                tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-danger"></i>
                        æ•°æ®æ¸²æŸ“å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•
                    </td>
                </tr>
            `;
            }
        }

        renderPagination(pagination) {
            const paginationEl = document.getElementById('pagination');

            if (!pagination || pagination.pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            this.totalPages = pagination.pages;
            this.currentPage = pagination.current_page;

            let paginationHtml = '';

            // ä¸Šä¸€é¡µ
            paginationHtml += `
            <li class="page-item ${this.currentPage <= 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="tradingManager.goToPage(${this.currentPage - 1})">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        `;

            // é¡µç 
            const startPage = Math.max(1, this.currentPage - 2);
            const endPage = Math.min(this.totalPages, this.currentPage + 2);

            if (startPage > 1) {
                paginationHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="tradingManager.goToPage(1)">1</a>
                </li>
            `;
                if (startPage > 2) {
                    paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="tradingManager.goToPage(${i})">${i}</a>
                </li>
            `;
            }

            if (endPage < this.totalPages) {
                if (endPage < this.totalPages - 1) {
                    paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                paginationHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="tradingManager.goToPage(${this.totalPages})">${this.totalPages}</a>
                </li>
            `;
            }

            // ä¸‹ä¸€é¡µ
            paginationHtml += `
            <li class="page-item ${this.currentPage >= this.totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="tradingManager.goToPage(${this.currentPage + 1})">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;

            paginationEl.innerHTML = paginationHtml;
        }

        goToPage(page) {
            if (page < 1 || page > this.totalPages || page === this.currentPage) {
                return;
            }

            this.currentPage = page;
            this.loadTrades();
        }

        async handleTradeFormSubmit(formData) {
            // æ³¨æ„ï¼šé˜²é‡å¤æäº¤æ£€æŸ¥å·²åœ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶ä¸­å¤„ç†ï¼Œè¿™é‡Œä¸å†é‡å¤æ£€æŸ¥

            try {
                console.log('[DEBUG] handleTradeFormSubmit æ¥æ”¶åˆ°çš„ formData:', formData);
                console.log('[DEBUG] formData.stock_code:', formData.stock_code, '(type:', typeof formData.stock_code, ')');
                console.log('[DEBUG] formData.stock_name:', formData.stock_name, '(type:', typeof formData.stock_name, ')');
                console.log('[DEBUG] formData.price:', formData.price, '(type:', typeof formData.price, ')');
                console.log('[DEBUG] formData.quantity:', formData.quantity, '(type:', typeof formData.quantity, ')');
                console.log('[DEBUG] formData.stop_loss_price:', formData.stop_loss_price, '(type:', typeof formData.stop_loss_price, ')');

                // é¢å¤–æ£€æŸ¥DOMä¸­çš„æ­¢æŸä»·æ ¼å€¼
                const stopLossPriceElement = document.getElementById('stop-loss-price');
                console.log('[DEBUG] DOMä¸­çš„æ­¢æŸä»·æ ¼å€¼:', stopLossPriceElement ? stopLossPriceElement.value : 'element not found');

                // ç´§æ€¥ä¿®å¤ï¼šå¦‚æœformDataä¸­ç¼ºå°‘å…³é”®å­—æ®µï¼Œç›´æ¥ä»DOMè·å–
                if (!formData.stock_code || formData.stock_code.trim() === '') {
                    const stockCodeElement = document.getElementById('stock-code');
                    if (stockCodeElement && stockCodeElement.value) {
                        formData.stock_code = stockCodeElement.value.trim();
                        console.log('[DEBUG] ä»DOMè·å–è‚¡ç¥¨ä»£ç :', formData.stock_code);
                    }
                }

                if (!formData.stock_name || formData.stock_name.trim() === '') {
                    const stockNameElement = document.getElementById('stock-name');
                    if (stockNameElement && stockNameElement.value) {
                        formData.stock_name = stockNameElement.value.trim();
                        console.log('[DEBUG] ä»DOMè·å–è‚¡ç¥¨åç§°:', formData.stock_name);
                    }
                }

                if (!formData.trade_type || formData.trade_type.trim() === '') {
                    const tradeTypeElement = document.getElementById('trade-type');
                    if (tradeTypeElement && tradeTypeElement.value) {
                        formData.trade_type = tradeTypeElement.value.trim();
                        console.log('[DEBUG] ä»DOMè·å–äº¤æ˜“ç±»å‹:', formData.trade_type);
                    }
                }

                if (!formData.reason || formData.reason.trim() === '') {
                    const reasonElement = document.getElementById('reason');
                    if (reasonElement && reasonElement.value) {
                        formData.reason = reasonElement.value.trim();
                        console.log('[DEBUG] ä»DOMè·å–æ“ä½œåŸå› :', formData.reason);
                    }
                }

                // ç‰¹æ®Šå¤„ç†äº¤æ˜“æ—¥æœŸ - ç¡®ä¿äº¤æ˜“æ—¥æœŸè¢«æ­£ç¡®æ”¶é›†
                if (!formData.trade_date || formData.trade_date.trim() === '') {
                    const tradeDateElement = document.getElementById('trade-date');
                    if (tradeDateElement && tradeDateElement.value) {
                        formData.trade_date = tradeDateElement.value.trim();
                        console.log('[DEBUG] ä»DOMè·å–äº¤æ˜“æ—¥æœŸ:', formData.trade_date);
                    }
                } else {
                    console.log('[DEBUG] è¡¨å•ä¸­å·²æœ‰äº¤æ˜“æ—¥æœŸ:', formData.trade_date);
                }

                // ç‰¹æ®Šå¤„ç†äº¤æ˜“æ—¥æœŸ - ç¡®ä¿äº¤æ˜“æ—¥æœŸè¢«æ­£ç¡®æ”¶é›†
                if (!formData.trade_date || formData.trade_date.trim() === '') {
                    const tradeDateElement = document.getElementById('trade-date');
                    if (tradeDateElement && tradeDateElement.value) {
                        formData.trade_date = tradeDateElement.value.trim();
                        console.log('[DEBUG] ä»DOMè·å–äº¤æ˜“æ—¥æœŸ:', formData.trade_date);
                    }
                } else {
                    console.log('[DEBUG] è¡¨å•ä¸­å·²æœ‰äº¤æ˜“æ—¥æœŸ:', formData.trade_date);
                }

                const saveBtn = document.getElementById('save-trade-btn');
                UXUtils.showLoading(saveBtn, 'ä¿å­˜ä¸­...');

                // ç®€åŒ–çš„éªŒè¯é€»è¾‘ - ç›´æ¥éªŒè¯å¿…å¡«å­—æ®µ
                console.log('[DEBUG] å¼€å§‹éªŒè¯å¿…å¡«å­—æ®µ...');

                // éªŒè¯è‚¡ç¥¨ä»£ç 
                if (!formData.stock_code || formData.stock_code.trim() === '') {
                    UXUtils.showError('è‚¡ç¥¨ä»£ç ä¸èƒ½ä¸ºç©º');
                    return;
                }

                // éªŒè¯è‚¡ç¥¨åç§°
                if (!formData.stock_name || formData.stock_name.trim() === '') {
                    UXUtils.showError('è‚¡ç¥¨åç§°ä¸èƒ½ä¸ºç©º');
                    return;
                }

                // éªŒè¯äº¤æ˜“ç±»å‹
                if (!formData.trade_type || formData.trade_type.trim() === '') {
                    UXUtils.showError('äº¤æ˜“ç±»å‹ä¸èƒ½ä¸ºç©º');
                    return;
                }

                // éªŒè¯æ“ä½œåŸå› 
                if (!formData.reason || formData.reason.trim() === '') {
                    UXUtils.showError('æ“ä½œåŸå› ä¸èƒ½ä¸ºç©º');
                    return;
                }

                console.log('[DEBUG] å¿…å¡«å­—æ®µéªŒè¯é€šè¿‡');

                // ç®€åŒ–çš„ä»·æ ¼å’Œæ•°é‡éªŒè¯
                if (!formData.price || formData.price === '') {
                    const priceElement = document.getElementById('price');
                    if (priceElement && priceElement.value) {
                        formData.price = priceElement.value;
                    } else {
                        UXUtils.showError('ä»·æ ¼ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                }

                if (!formData.quantity || formData.quantity === '') {
                    const quantityElement = document.getElementById('quantity');
                    if (quantityElement && quantityElement.value) {
                        formData.quantity = quantityElement.value;
                    } else {
                        UXUtils.showError('æ•°é‡ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                }

                // å¤„ç†æ•°å€¼å­—æ®µè½¬æ¢å’ŒéªŒè¯
                if ('price' in formData && formData.price !== null && formData.price !== undefined && formData.price !== '') {
                    const price = parseFloat(formData.price);
                    if (isNaN(price)) {
                        UXUtils.showError('ä»·æ ¼æ ¼å¼æ— æ•ˆï¼Œè¯·è¾“å…¥æœ‰æ•ˆæ•°å­—');
                        return;
                    }
                    if (price <= 0) {
                        UXUtils.showError('ä»·æ ¼å¿…é¡»å¤§äº0');
                        return;
                    }
                    formData.price = price;
                }

                if ('quantity' in formData && formData.quantity !== null && formData.quantity !== undefined && formData.quantity !== '') {
                    const quantity = parseInt(formData.quantity);
                    if (isNaN(quantity)) {
                        UXUtils.showError('æ•°é‡æ ¼å¼æ— æ•ˆï¼Œè¯·è¾“å…¥æœ‰æ•ˆæ•´æ•°');
                        return;
                    }
                    if (quantity <= 0) {
                        UXUtils.showError('æ•°é‡å¿…é¡»å¤§äº0');
                        return;
                    }
                    // æ ¹æ®è‚¡ç¥¨ç±»å‹éªŒè¯æ•°é‡è§„åˆ™
                    const stockCode = formData.stock_code;
                    if (stockCode && stockCode.startsWith('68')) {
                        // ç§‘åˆ›æ¿è‚¡ç¥¨åªéœ€è¦å¤§äº0
                        if (quantity <= 0) {
                            UXUtils.showError('ç§‘åˆ›æ¿è‚¡ç¥¨æ•°é‡å¿…é¡»å¤§äº0');
                            return;
                        }
                    } else {
                        // å…¶ä»–è‚¡ç¥¨å¿…é¡»æ˜¯100çš„å€æ•°
                        if (quantity % 100 !== 0) {
                            UXUtils.showError('æ•°é‡å¿…é¡»æ˜¯100çš„å€æ•°');
                            return;
                        }
                    }
                    formData.quantity = quantity;
                }

                // å¤„ç†æ­¢æŸä»·æ ¼ - ç›´æ¥ä»DOMè·å–ä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§
                if (stopLossPriceElement && stopLossPriceElement.value && stopLossPriceElement.value.trim() !== '') {
                    const stopLossPrice = parseFloat(stopLossPriceElement.value);
                    if (!isNaN(stopLossPrice) && stopLossPrice > 0) {
                        formData.stop_loss_price = stopLossPrice;
                        console.log('[DEBUG] ä»DOMè·å–æ­¢æŸä»·æ ¼:', formData.stop_loss_price);
                    } else {
                        console.log('[DEBUG] æ­¢æŸä»·æ ¼æ— æ•ˆï¼Œè·³è¿‡');
                        delete formData.stop_loss_price;
                    }
                } else {
                    console.log('[DEBUG] æ­¢æŸä»·æ ¼ä¸ºç©ºï¼Œè·³è¿‡');
                    delete formData.stop_loss_price;
                }

                // å¤„ç†åˆ†æ‰¹æ­¢ç›ˆæ•°æ® - åªæœ‰ä¹°å…¥äº¤æ˜“æ‰èƒ½è®¾ç½®æ­¢ç›ˆ
                const isBuyTrade = formData.trade_type === 'buy';
                formData.use_batch_profit_taking = isBuyTrade && this.useBatchProfitTaking;

                if (isBuyTrade && this.useBatchProfitTaking && this.profitTargetsManager) {
                    // éªŒè¯åˆ†æ‰¹æ­¢ç›ˆæ•°æ®
                    if (!this.profitTargetsManager.isValidTargets()) {
                        const errors = this.profitTargetsManager.getValidationErrors();
                        this.showBatchProfitErrors(errors);
                        UXUtils.showError('è¯·æ£€æŸ¥åˆ†æ‰¹æ­¢ç›ˆè®¾ç½®ä¸­çš„é”™è¯¯');
                        return;
                    }

                    // è·å–åˆ†æ‰¹æ­¢ç›ˆç›®æ ‡æ•°æ®
                    const profitTargets = this.profitTargetsManager.getTargets();

                    // éªŒè¯æ­¢ç›ˆç›®æ ‡æ•°æ®å®Œæ•´æ€§
                    if (!this.validateProfitTargetsData(profitTargets)) {
                        UXUtils.showError('åˆ†æ‰¹æ­¢ç›ˆæ•°æ®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥æ‰€æœ‰å¿…å¡«å­—æ®µ');
                        return;
                    }

                    formData.profit_targets = profitTargets;

                    // æ¸…ç©ºå•ä¸€æ­¢ç›ˆå­—æ®µ
                    delete formData.take_profit_ratio;
                    delete formData.sell_ratio;
                } else if (isBuyTrade) {
                    // å¤„ç†å•ä¸€æ­¢ç›ˆæ•°æ® - åªæœ‰ä¹°å…¥äº¤æ˜“æ‰å¤„ç†æ­¢ç›ˆ
                    // æ­£ç¡®å¤„ç† take_profit_ratio å­—æ®µ
                    if (formData.take_profit_ratio !== undefined && formData.take_profit_ratio !== null && formData.take_profit_ratio !== '') {
                        const takeProfitValue = parseFloat(formData.take_profit_ratio);
                        if (!isNaN(takeProfitValue)) {
                            formData.take_profit_ratio = takeProfitValue / 100;
                        } else {
                            delete formData.take_profit_ratio;
                        }
                    } else {
                        delete formData.take_profit_ratio;
                    }

                    // æ­£ç¡®å¤„ç† sell_ratio å­—æ®µ
                    if (formData.sell_ratio !== undefined && formData.sell_ratio !== null && formData.sell_ratio !== '') {
                        const sellRatioValue = parseFloat(formData.sell_ratio);
                        if (!isNaN(sellRatioValue)) {
                            formData.sell_ratio = sellRatioValue / 100;
                        } else {
                            delete formData.sell_ratio;
                        }
                    } else {
                        delete formData.sell_ratio;
                    }

                    // æ¸…ç©ºåˆ†æ‰¹æ­¢ç›ˆå­—æ®µ
                    delete formData.profit_targets;
                } else {
                    // å–å‡ºäº¤æ˜“ - æ¸…ç©ºæ‰€æœ‰æ­¢ç›ˆç›¸å…³å­—æ®µ
                    delete formData.use_batch_profit_taking;
                    delete formData.profit_targets;
                    delete formData.take_profit_ratio;
                    delete formData.sell_ratio;
                    delete formData.stop_loss_price;
                }

                console.log('ğŸš€ å‡†å¤‡å‘é€APIè¯·æ±‚...');
                console.log('ğŸ“Š æœ€ç»ˆè¡¨å•æ•°æ®:', JSON.stringify(formData, null, 2));

                let response;
                if (this.editingTradeId) {
                    // æ›´æ–°äº¤æ˜“è®°å½•
                    console.log('ğŸ”„ æ›´æ–°äº¤æ˜“è®°å½•ï¼ŒID:', this.editingTradeId);
                    response = await this.updateTradeWithProfitTargets(this.editingTradeId, formData);
                } else {
                    // åˆ›å»ºæ–°äº¤æ˜“è®°å½•
                    console.log('â• åˆ›å»ºæ–°äº¤æ˜“è®°å½•');
                    response = await this.createTradeWithProfitTargets(formData);
                }

                console.log('ğŸ“¥ APIå“åº”:', response);

                if (response.success) {
                    UXUtils.showSuccess(this.editingTradeId ? 'äº¤æ˜“è®°å½•æ›´æ–°æˆåŠŸ' : 'äº¤æ˜“è®°å½•åˆ›å»ºæˆåŠŸ');

                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTradeModal'));
                    modal.hide();

                    // é‡æ–°åŠ è½½äº¤æ˜“è®°å½•
                    await this.loadTrades();
                } else {
                    this.handleSaveError(response);
                }
            } catch (error) {
                console.error('ğŸ’¥ Save trade error:', error);
                console.error('ğŸ’¥ Error stack:', error.stack);
                console.error('ğŸ’¥ Error details:', {
                    name: error.name,
                    message: error.message,
                    code: error.code
                });
                this.handleSaveError(error);
            } finally {
                const saveBtn = document.getElementById('save-trade-btn');
                UXUtils.hideLoading(saveBtn);
            }
        }

        async createTradeWithProfitTargets(formData) {
            console.log('ğŸ”§ createTradeWithProfitTargets è¢«è°ƒç”¨');
            console.log('ğŸ“¤ å‘é€åˆ°APIçš„æ•°æ®:', formData);

            // åˆ›å»ºäº¤æ˜“è®°å½•
            console.log('ğŸ“¡ è°ƒç”¨ apiClient.createTrade...');
            const response = await apiClient.createTrade(formData);
            console.log('ğŸ“¨ apiClient.createTrade å“åº”:', response);

            if (response.success && formData.use_batch_profit_taking && formData.profit_targets) {
                // å¦‚æœåˆ›å»ºæˆåŠŸä¸”ä½¿ç”¨åˆ†æ‰¹æ­¢ç›ˆï¼ŒåŒæ­¥æ­¢ç›ˆç›®æ ‡æ•°æ®
                await this.syncProfitTargets(response.data.id, formData.profit_targets);
            }

            return response;
        }

        async updateTradeWithProfitTargets(tradeId, formData) {
            // æ›´æ–°äº¤æ˜“è®°å½•
            const response = await apiClient.updateTrade(tradeId, formData);

            if (response.success && formData.use_batch_profit_taking && formData.profit_targets) {
                // å¦‚æœæ›´æ–°æˆåŠŸä¸”ä½¿ç”¨åˆ†æ‰¹æ­¢ç›ˆï¼ŒåŒæ­¥æ­¢ç›ˆç›®æ ‡æ•°æ®
                await this.syncProfitTargets(tradeId, formData.profit_targets);
            }

            return response;
        }

        async syncProfitTargets(tradeId, profitTargets) {
            try {
                const response = await apiClient.setProfitTargets(tradeId, profitTargets);

                if (!response.success) {
                    throw new Error(response.message || 'æ­¢ç›ˆç›®æ ‡åŒæ­¥å¤±è´¥');
                }

                return response;
            } catch (error) {
                console.error('Sync profit targets error:', error);
                throw error;
            }
        }

        validateProfitTargetsData(profitTargets) {
            if (!profitTargets || profitTargets.length === 0) {
                return false;
            }

            return profitTargets.every(target => {
                return target.targetPrice > 0 &&
                    target.sellRatio > 0 &&
                    target.sellRatio <= 100;
            });
        }

        showBatchProfitErrors(errors) {
            // æ˜¾ç¤ºåˆ†æ‰¹æ­¢ç›ˆç›¸å…³çš„é”™è¯¯ä¿¡æ¯
            if (errors.totalSellRatio) {
                UXUtils.showWarning(errors.totalSellRatio);
            }

            // æ˜¾ç¤ºå…·ä½“ç›®æ ‡çš„é”™è¯¯
            Object.keys(errors).forEach(targetId => {
                if (targetId !== 'totalSellRatio' && typeof errors[targetId] === 'object') {
                    const targetErrors = errors[targetId];
                    Object.keys(targetErrors).forEach(field => {
                        console.warn(`Target ${targetId} ${field}: ${targetErrors[field]}`);
                    });
                }
            });
        }

        handleSaveError(error) {
            console.error('[DEBUG] handleSaveError æ¥æ”¶åˆ°çš„é”™è¯¯:', error);

            if (error.response) {
                const status = error.response.status;
                const data = error.response.data;

                console.error(`[DEBUG] HTTPé”™è¯¯ ${status}:`, data);

                if (status === 422) {
                    const errors = data.errors || {};

                    // å¤„ç†åˆ†æ‰¹æ­¢ç›ˆç›¸å…³é”™è¯¯
                    if (errors.profit_targets) {
                        this.showBatchProfitErrors(errors.profit_targets);
                    }

                    // æ˜¾ç¤ºè¡¨å•éªŒè¯é”™è¯¯
                    if (this.formValidator) {
                        this.formValidator.showValidationSummary(errors);
                    }

                    UXUtils.showError('è¯·æ£€æŸ¥è¡¨å•ä¸­çš„é”™è¯¯ä¿¡æ¯');
                } else if (status === 400) {
                    // å¤„ç†400é”™è¯¯
                    const errorMessage = data.error?.message || data.message || 'è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯';
                    console.error('[DEBUG] 400é”™è¯¯è¯¦æƒ…:', errorMessage);
                    UXUtils.showError(`æ•°æ®éªŒè¯å¤±è´¥: ${errorMessage}`);
                } else if (status === 403) {
                    UXUtils.showError('è®¿é—®è¢«æ‹’ç»ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                } else if (status === 404) {
                    UXUtils.showError('äº¤æ˜“è®°å½•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
                } else {
                    const errorMessage = data.error?.message || data.message || `æœåŠ¡å™¨é”™è¯¯ (${status})`;
                    UXUtils.showError(errorMessage);
                }
            } else if (error.message) {
                UXUtils.showError(error.message);
            } else {
                UXUtils.showError('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä¿æŒå‘åå…¼å®¹çš„æ–¹æ³•
        async saveTrade() {
            console.log('ğŸ” å¼€å§‹ä¿å­˜äº¤æ˜“...');

            // ä½¿ç”¨ç®€æ´éªŒè¯å™¨éªŒè¯è¡¨å•
            if (!this.simpleValidator.validateForm()) {
                console.log('âŒ è¡¨å•éªŒè¯å¤±è´¥:', this.simpleValidator.errors);
                showMessage('è¯·æ£€æŸ¥è¡¨å•ä¸­çš„é”™è¯¯ä¿¡æ¯', 'error');
                return;
            }

            console.log('âœ… è¡¨å•éªŒè¯é€šè¿‡');

            // è·å–è¡¨å•æ•°æ®
            const formData = this.simpleValidator.getFormData();
            console.log('ğŸ“ è¡¨å•æ•°æ®:', formData);

            // å¤„ç†è¡¨å•æäº¤
            await this.handleTradeFormSubmit(formData);
        }

        // æ—§çš„éªŒè¯å‡½æ•°å·²è¢«SimpleFormValidatoræ›¿ä»£ï¼Œæ³¨é‡Šæ‰é¿å…å†²çª
        // validateTradeForm() {
        //     const form = document.getElementById('trade-form');
        //     const inputs = form.querySelectorAll('input[required], select[required]');
        //     let isValid = true;

        //     inputs.forEach(input => {
        //         const feedback = input.parentNode.querySelector('.invalid-feedback');

        //         if (!input.value.trim()) {
        //             input.classList.add('is-invalid');
        //             if (feedback) {
        //                 feedback.textContent = 'æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹';
        //             }
        //             isValid = false;
        //         } else {
        //             input.classList.remove('is-invalid');
        //         }
        //     });

        //     // éªŒè¯ä»·æ ¼å’Œæ•°é‡
        //     const price = parseFloat(document.getElementById('price').value);
        //     const quantity = parseInt(document.getElementById('quantity').value);

        //     if (price <= 0) {
        //         const priceInput = document.getElementById('price');
        //         priceInput.classList.add('is-invalid');
        //         const feedback = priceInput.parentNode.parentNode.querySelector('.invalid-feedback');
        //         if (feedback) {
        //             feedback.textContent = 'ä»·æ ¼å¿…é¡»å¤§äº0';
        //         }
        //         isValid = false;
        //     }

        //     if (quantity <= 0) {
        //         const quantityInput = document.getElementById('quantity');
        //         quantityInput.classList.add('is-invalid');
        //         const feedback = quantityInput.parentNode.parentNode.querySelector('.invalid-feedback');
        //         if (feedback) {
        //             feedback.textContent = 'æ•°é‡å¿…é¡»å¤§äº0';
        //         }
        //         isValid = false;
        //     }

        //     return isValid;
        // }

        async editTrade(tradeId) {
            console.log('editTrade started for tradeId:', tradeId);
            let loadingShown = false;

            try {
                console.log('Showing global loading...');
                UXUtils.showGlobalLoading('åŠ è½½äº¤æ˜“è®°å½•...');
                loadingShown = true;

                // ä½¿ç”¨ä¸“é—¨çš„APIè·å–åŒ…å«æ­¢ç›ˆç›®æ ‡çš„å®Œæ•´äº¤æ˜“è®°å½•
                console.log('Fetching trade data...');
                const response = await apiClient.getTradeWithProfitTargets(tradeId);
                console.log('Trade data response:', response);

                if (response.success) {
                    const trade = response.data;
                    this.editingTradeId = tradeId;
                    console.log('Trade data loaded successfully:', trade);

                    // ç«‹å³éšè—åŠ è½½çŠ¶æ€ï¼Œé¿å…å¡ä½
                    if (loadingShown) {
                        UXUtils.hideGlobalLoading();
                        loadingShown = false;
                        console.log('Global loading hidden after data loaded');
                    }

                    // å…ˆæ›´æ–°åŸå› é€‰é¡¹ï¼Œç¡®ä¿é€‰é¡¹å¯ç”¨
                    console.log('Updating reason options...');
                    this.updateReasonOptions(trade.trade_type);

                    // ç„¶åå¡«å……åŸºæœ¬è¡¨å•æ•°æ®
                    console.log('Populating basic form...');
                    this.populateBasicTradeForm(trade);

                    // è®¾ç½®ä¹°å…¥è®¾ç½®æ˜¾ç¤ºçŠ¶æ€
                    console.log('Toggling buy settings...');
                    this.toggleBuySettings(trade.trade_type === 'buy');

                    // å¡«å……ä¹°å…¥è®¾ç½®ï¼ˆåŒ…æ‹¬åˆ†æ‰¹æ­¢ç›ˆæ•°æ®ï¼‰
                    if (trade.trade_type === 'buy') {
                        console.log('Populating buy settings...');
                        try {
                            await this.populateBuySettings(trade);
                            console.log('Buy settings populated');
                        } catch (buySettingsError) {
                            console.error('Buy settings population failed:', buySettingsError);
                            // å³ä½¿ä¹°å…¥è®¾ç½®å¤±è´¥ï¼Œä¹Ÿè¦ç»§ç»­æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®
                            UXUtils.showWarning('ä¹°å…¥è®¾ç½®åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®æ­¢ç›ˆæ­¢æŸ');
                        }
                    }

                    // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
                    console.log('Updating modal title...');
                    document.getElementById('trade-modal-title').textContent = 'ç¼–è¾‘äº¤æ˜“è®°å½•';

                    // ç¼–è¾‘æ¨¡å¼ï¼šç¡®ä¿ç•Œé¢çŠ¶æ€æ­£ç¡®
                    console.log('è®¾ç½®ç¼–è¾‘æ¨¡å¼ç•Œé¢çŠ¶æ€...');

                    // å¼ºåˆ¶éšè—äº¤æ˜“ç±»å‹é€‰æ‹©ç•Œé¢
                    const typeSelection = document.getElementById('trade-type-selection');
                    const formContainer = document.getElementById('trade-form-container');
                    const backBtn = document.getElementById('back-to-type-selection');
                    const saveBtn = document.getElementById('save-trade-btn');

                    if (typeSelection) typeSelection.style.display = 'none';
                    if (formContainer) formContainer.style.display = 'block';
                    if (backBtn) backBtn.style.display = 'none';
                    if (saveBtn) saveBtn.style.display = 'inline-block';

                    console.log('ç¼–è¾‘æ¨¡å¼ç•Œé¢çŠ¶æ€è®¾ç½®å®Œæˆ');

                    // æ ¹æ®äº¤æ˜“ç±»å‹æ˜¾ç¤ºç›¸åº”çš„è‚¡ç¥¨è¾“å…¥ç•Œé¢
                    if (trade.trade_type === 'buy') {
                        document.getElementById('buy-stock-input').style.display = 'block';
                        document.getElementById('sell-stock-selection').style.display = 'none';
                    } else {
                        document.getElementById('buy-stock-input').style.display = 'none';
                        document.getElementById('sell-stock-selection').style.display = 'block';
                    }

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    console.log('Showing modal...');
                    const modal = new bootstrap.Modal(document.getElementById('addTradeModal'));
                    modal.show();

                    // æ¨¡æ€æ¡†æ˜¾ç¤ºåï¼Œè§¦å‘è¡¨å•éªŒè¯ä»¥ç¡®ä¿è‚¡ç¥¨ä»£ç ç­‰å­—æ®µè¢«æ­£ç¡®è¯†åˆ«
                    setTimeout(() => {
                        console.log('Triggering form validation after modal show...');
                        this.triggerFormValidation();
                    }, 300);

                    console.log('Modal shown');
                } else {
                    throw new Error(response.message || 'è·å–äº¤æ˜“è®°å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to load trade for editing:', error);
                this.handleEditTradeError(error);
            } finally {
                console.log('editTrade finally block - ensuring loading is hidden...');
                if (loadingShown) {
                    UXUtils.hideGlobalLoading();
                    console.log('Global loading hidden in finally');
                }
                // é¢å¤–çš„æ¸…ç†ï¼Œç¡®ä¿æ²¡æœ‰é—ç•™çš„åŠ è½½çŠ¶æ€
                setTimeout(() => {
                    UXUtils.forceHideAllLoading();
                }, 100);
                console.log('editTrade completed');
            }
        }

        populateBasicTradeForm(trade) {
            console.log('Populating basic form with trade data:', trade);

            // å¡«å……åŸºæœ¬è¡¨å•å­—æ®µ
            const stockCodeField = document.getElementById('stock-code');
            const stockNameField = document.getElementById('stock-name');
            const tradeTypeField = document.getElementById('trade-type');
            const priceField = document.getElementById('price');
            const quantityField = document.getElementById('quantity');
            const reasonField = document.getElementById('reason');
            const notesField = document.getElementById('notes');

            if (stockCodeField) {
                stockCodeField.value = trade.stock_code || '';
                console.log('Stock code set to:', stockCodeField.value);
            }
            if (stockNameField) stockNameField.value = trade.stock_name || '';
            if (tradeTypeField) tradeTypeField.value = trade.trade_type || '';
            if (priceField) priceField.value = trade.price || '';
            if (quantityField) quantityField.value = trade.quantity || '';
            if (reasonField) reasonField.value = trade.reason || '';
            if (notesField) notesField.value = trade.notes || '';

            // è®¾ç½®äº¤æ˜“æ—¥æœŸ
            if (trade.trade_date) {
                const tradeDate = new Date(trade.trade_date);
                const localDateTime = new Date(tradeDate.getTime() - tradeDate.getTimezoneOffset() * 60000)
                    .toISOString().slice(0, 16);
                const tradeDateField = document.getElementById('trade-date');
                if (tradeDateField) {
                    tradeDateField.value = localDateTime;
                }
            }

            console.log('Basic form populated successfully');
        }

        async populateBuySettings(trade) {
            console.log('populateBuySettings started:', trade);
            try {
                // å¡«å……æ­¢æŸä»·æ ¼
                console.log('Setting stop loss price...');
                document.getElementById('stop-loss-price').value = trade.stop_loss_price || '';

                // å¤„ç†åˆ†æ‰¹æ­¢ç›ˆæ•°æ®
                const useBatchProfitTaking = trade.use_batch_profit_taking || false;
                console.log('Use batch profit taking:', useBatchProfitTaking);
                document.getElementById('use-batch-profit-taking').checked = useBatchProfitTaking;

                // åˆ‡æ¢åˆ°ç›¸åº”çš„æ­¢ç›ˆæ¨¡å¼
                console.log('Toggling profit taking mode...');
                this.toggleProfitTakingMode(useBatchProfitTaking);

                if (useBatchProfitTaking) {
                    // åŠ è½½åˆ†æ‰¹æ­¢ç›ˆæ•°æ®
                    console.log('Loading profit targets for edit...');
                    try {
                        await this.loadProfitTargetsForEdit(trade);
                        console.log('Profit targets loaded');
                    } catch (profitTargetsError) {
                        console.error('Failed to load profit targets:', profitTargetsError);
                        UXUtils.showWarning('æ­¢ç›ˆç›®æ ‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°è®¾ç½®');
                        // ä¸é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©ä¸»æµç¨‹ç»§ç»­
                    }
                } else {
                    // åŠ è½½å•ä¸€æ­¢ç›ˆæ•°æ®
                    console.log('Loading single profit taking...');
                    try {
                        this.loadSingleProfitTakingForEdit(trade);
                        console.log('Single profit taking loaded');
                    } catch (singleProfitError) {
                        console.error('Failed to load single profit taking:', singleProfitError);
                        UXUtils.showWarning('æ­¢ç›ˆè®¾ç½®åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°è®¾ç½®');
                        // ä¸é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©ä¸»æµç¨‹ç»§ç»­
                    }
                }

                // è®¡ç®—é£é™©æ”¶ç›Šæ¯”
                console.log('Scheduling risk reward calculation...');
                setTimeout(() => {
                    try {
                        console.log('Calculating risk reward...');
                        this.calculateRiskReward();
                    } catch (riskRewardError) {
                        console.error('Risk reward calculation failed:', riskRewardError);
                        // é£é™©æ”¶ç›Šæ¯”è®¡ç®—å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
                    }
                }, 100);

                console.log('populateBuySettings completed successfully');
            } catch (error) {
                console.error('Failed to populate buy settings:', error);
                // ä¸é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©ä¸»æµç¨‹ç»§ç»­ï¼Œåªæ˜¾ç¤ºè­¦å‘Š
                UXUtils.showWarning('ä¹°å…¥è®¾ç½®åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®');
            }
        }

        async loadProfitTargetsForEdit(trade) {
            try {
                let profitTargets = [];

                // å¦‚æœäº¤æ˜“è®°å½•ä¸­å·²æœ‰æ­¢ç›ˆç›®æ ‡æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
                if (trade.profit_targets && trade.profit_targets.length > 0) {
                    profitTargets = trade.profit_targets;
                } else {
                    // å¦åˆ™ä»APIè·å–æœ€æ–°çš„æ­¢ç›ˆç›®æ ‡æ•°æ®
                    try {
                        const targetsResponse = await apiClient.getProfitTargets(trade.id);
                        if (targetsResponse.success && targetsResponse.data.profit_targets) {
                            profitTargets = targetsResponse.data.profit_targets;
                        }
                    } catch (apiError) {
                        console.warn('Failed to fetch profit targets from API:', apiError);
                        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°ç»„ï¼Œè®©ç”¨æˆ·é‡æ–°è®¾ç½®
                        profitTargets = [];
                    }
                }

                // è®¾ç½®åˆ†æ‰¹æ­¢ç›ˆç®¡ç†å™¨çš„æ•°æ®
                if (this.profitTargetsManager) {
                    if (profitTargets.length > 0) {
                        this.profitTargetsManager.setTargets(profitTargets);
                    } else {
                        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ¸…ç©ºå¹¶æ·»åŠ é»˜è®¤ç›®æ ‡
                        this.profitTargetsManager.clear();
                    }

                    // è®¾ç½®ä¹°å…¥ä»·æ ¼ç”¨äºè®¡ç®—
                    this.profitTargetsManager.setBuyPrice(parseFloat(trade.price) || 0);
                } else {
                    console.warn('ProfitTargetsManager not initialized');
                }
            } catch (error) {
                console.error('Failed to load profit targets for edit:', error);
                UXUtils.showWarning('åˆ†æ‰¹æ­¢ç›ˆæ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°è®¾ç½®');

                // æ¸…ç©ºåˆ†æ‰¹æ­¢ç›ˆç®¡ç†å™¨
                if (this.profitTargetsManager) {
                    this.profitTargetsManager.clear();
                }
            }
        }

        loadSingleProfitTakingForEdit(trade) {
            try {
                // åŠ è½½å•ä¸€æ­¢ç›ˆæ•°æ®
                const takeProfitRatio = trade.take_profit_ratio ? (trade.take_profit_ratio * 100).toFixed(2) : '';
                const sellRatio = trade.sell_ratio ? (trade.sell_ratio * 100).toFixed(2) : '';

                document.getElementById('take-profit-ratio').value = takeProfitRatio;
                document.getElementById('sell-ratio').value = sellRatio;
            } catch (error) {
                console.error('Failed to load single profit taking data:', error);
                UXUtils.showWarning('å•ä¸€æ­¢ç›ˆæ•°æ®åŠ è½½å¤±è´¥');
            }
        }

        handleEditTradeError(error) {
            let message = 'åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥';

            if (error.response) {
                if (error.response.status === 404) {
                    message = 'äº¤æ˜“è®°å½•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤';
                } else if (error.response.status === 403) {
                    message = 'æ²¡æœ‰æƒé™è®¿é—®æ­¤äº¤æ˜“è®°å½•';
                } else if (error.response.data && error.response.data.message) {
                    message = error.response.data.message;
                }
            } else if (error.message) {
                message = error.message;
            }

            UXUtils.showError(message);
        }

        async correctTrade(tradeId) {
            try {
                const response = await apiClient.request('GET', `/api/trades/${tradeId}`);

                if (response.success) {
                    const trade = response.data;
                    this.correctingTradeId = tradeId;

                    // æ˜¾ç¤ºåŸå§‹æ•°æ®
                    const originalDataEl = document.getElementById('original-trade-data');
                    originalDataEl.innerHTML = `
                    <div class="mb-2"><strong>è‚¡ç¥¨ä»£ç :</strong> ${trade.stock_code}</div>
                    <div class="mb-2"><strong>è‚¡ç¥¨åç§°:</strong> ${trade.stock_name}</div>
                    <div class="mb-2"><strong>äº¤æ˜“ç±»å‹:</strong> ${trade.trade_type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}</div>
                    <div class="mb-2"><strong>ä»·æ ¼:</strong> Â¥${trade.price.toFixed(2)}</div>
                    <div class="mb-2"><strong>æ•°é‡:</strong> ${trade.quantity}</div>
                    <div class="mb-2"><strong>äº¤æ˜“æ—¥æœŸ:</strong> ${formatDateTime(trade.trade_date)}</div>
                    <div class="mb-2"><strong>åŸå› :</strong> ${trade.reason}</div>
                `;

                    // å¡«å……è®¢æ­£è¡¨å•ï¼ˆåˆå§‹å€¼ä¸ºåŸå§‹å€¼ï¼‰
                    document.getElementById('corrected-stock-code').value = trade.stock_code;
                    document.getElementById('corrected-stock-name').value = trade.stock_name;
                    document.getElementById('corrected-price').value = trade.price;
                    document.getElementById('corrected-quantity').value = trade.quantity;

                    const tradeDate = new Date(trade.trade_date);
                    const localDateTime = new Date(tradeDate.getTime() - tradeDate.getTimezoneOffset() * 60000)
                        .toISOString().slice(0, 16);
                    document.getElementById('corrected-trade-date').value = localDateTime;

                    // æ›´æ–°åŸå› é€‰é¡¹
                    this.updateCorrectionReasonOptions(trade.trade_type);
                    document.getElementById('corrected-reason').value = trade.reason;

                    // æ¸…ç©ºè®¢æ­£åŸå› 
                    document.getElementById('correction-reason').value = '';

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    const modal = new bootstrap.Modal(document.getElementById('correctTradeModal'));
                    modal.show();
                } else {
                    throw new Error(response.message || 'è·å–äº¤æ˜“è®°å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to load trade for correction:', error);
                showMessage('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        updateCorrectionReasonOptions(tradeType) {
            const reasonSelect = document.getElementById('corrected-reason');
            const reasons = tradeType === 'buy' ? this.buyReasons : this.sellReasons;

            reasonSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ“ä½œåŸå› </option>';
            reasons.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason;
                option.textContent = reason;
                reasonSelect.appendChild(option);
            });
        }

        async submitCorrection() {
            const form = document.getElementById('correction-form');
            const reasonTextarea = document.getElementById('correction-reason');
            const submitBtn = document.getElementById('submit-correction-btn');
            const spinner = submitBtn.querySelector('.spinner-border');

            try {
                // éªŒè¯è®¢æ­£åŸå› 
                if (!reasonTextarea.value.trim()) {
                    reasonTextarea.classList.add('is-invalid');
                    reasonTextarea.parentNode.querySelector('.invalid-feedback').textContent = 'è¯·è¾“å…¥è®¢æ­£åŸå› ';
                    return;
                } else {
                    reasonTextarea.classList.remove('is-invalid');
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                submitBtn.disabled = true;
                spinner.style.display = 'inline-block';

                // æ”¶é›†è®¢æ­£æ•°æ®
                const formData = new FormData(form);
                const correctedData = Object.fromEntries(formData.entries());

                // å¤„ç†æ•°å€¼å­—æ®µ
                correctedData.price = parseFloat(correctedData.price);
                correctedData.quantity = parseInt(correctedData.quantity);

                // å‘é€è®¢æ­£è¯·æ±‚
                const response = await apiClient.correctTrade(
                    this.correctingTradeId,
                    correctedData,
                    reasonTextarea.value.trim()
                );

                if (response.success) {
                    showMessage('äº¤æ˜“è®°å½•è®¢æ­£æˆåŠŸ', 'success');

                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('correctTradeModal'));
                    modal.hide();

                    // é‡æ–°åŠ è½½æ•°æ®
                    await this.loadTrades();
                } else {
                    throw new Error(response.message || 'è®¢æ­£å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to correct trade:', error);
                showMessage('è®¢æ­£äº¤æ˜“è®°å½•å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        async viewCorrectionHistory(tradeId) {
            try {
                const response = await apiClient.getCorrectionHistory(tradeId);

                if (response.success) {
                    const history = response.data;
                    const contentEl = document.getElementById('correction-history-content');

                    if (history.length === 0) {
                        contentEl.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-clock-history fs-1 d-block mb-2"></i>
                            è¯¥äº¤æ˜“è®°å½•æš‚æ— è®¢æ­£å†å²
                        </div>
                    `;
                    } else {
                        contentEl.innerHTML = history.map(item => `
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">è®¢æ­£æ—¶é—´: ${formatDateTime(item.created_at)}</h6>
                                    <span class="badge bg-warning">è®¢æ­£è®°å½•</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>è®¢æ­£åŸå› :</strong>
                                    <p class="mb-0">${item.correction_reason}</p>
                                </div>
                                <div class="mb-3">
                                    <strong>ä¿®æ”¹å­—æ®µ:</strong>
                                    <div class="mt-2">
                                        ${this.renderCorrectedFields(item.corrected_fields)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    }

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    const modal = new bootstrap.Modal(document.getElementById('correctionHistoryModal'));
                    modal.show();
                } else {
                    throw new Error(response.message || 'è·å–è®¢æ­£å†å²å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to load correction history:', error);
                showMessage('åŠ è½½è®¢æ­£å†å²å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        renderCorrectedFields(correctedFieldsJson) {
            try {
                const fields = JSON.parse(correctedFieldsJson);

                return Object.entries(fields).map(([field, change]) => `
                <div class="row mb-2">
                    <div class="col-md-3"><strong>${this.getFieldDisplayName(field)}:</strong></div>
                    <div class="col-md-4">
                        <span class="text-muted">åŸå€¼: </span>
                        <span class="text-decoration-line-through">${change.old_value}</span>
                    </div>
                    <div class="col-md-4">
                        <span class="text-success">æ–°å€¼: </span>
                        <span class="fw-bold text-success">${change.new_value}</span>
                    </div>
                </div>
            `).join('');
            } catch (error) {
                return '<span class="text-muted">æ— æ³•è§£æä¿®æ”¹å­—æ®µä¿¡æ¯</span>';
            }
        }

        getFieldDisplayName(field) {
            const fieldNames = {
                'stock_code': 'è‚¡ç¥¨ä»£ç ',
                'stock_name': 'è‚¡ç¥¨åç§°',
                'price': 'ä»·æ ¼',
                'quantity': 'æ•°é‡',
                'trade_date': 'äº¤æ˜“æ—¥æœŸ',
                'reason': 'æ“ä½œåŸå› ',
                'notes': 'å¤‡æ³¨'
            };
            return fieldNames[field] || field;
        }

        async deleteTrade(tradeId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡äº¤æ˜“è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await apiClient.deleteTrade(tradeId);

                if (response.success) {
                    showMessage('äº¤æ˜“è®°å½•åˆ é™¤æˆåŠŸ', 'success');
                    await this.loadTrades();
                } else {
                    throw new Error(response.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to delete trade:', error);
                showMessage('åˆ é™¤äº¤æ˜“è®°å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ·»åŠ åˆ†æ‰¹æ­¢ç›ˆæ•°æ®éªŒè¯å’Œç”¨æˆ·æç¤ºæ–¹æ³•
        showProfitTargetsValidationFeedback(isValid, errors) {
            const container = document.getElementById('profit-targets-container');
            if (!container) return;

            // æ¸…é™¤ä¹‹å‰çš„å…¨å±€é”™è¯¯æç¤º
            const existingAlert = container.querySelector('.profit-targets-global-error');
            if (existingAlert) {
                existingAlert.remove();
            }

            if (!isValid && errors) {
                // æ˜¾ç¤ºå…¨å±€é”™è¯¯æç¤º
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-sm profit-targets-global-error mt-2';
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>åˆ†æ‰¹æ­¢ç›ˆè®¾ç½®æœ‰è¯¯ï¼š</strong>
                    <ul class="mb-0 mt-1">
                        ${Object.keys(errors).map(key => {
                    if (key === 'totalSellRatio') {
                        return `<li>${errors[key]}</li>`;
                    } else if (typeof errors[key] === 'object') {
                        const targetErrors = Object.values(errors[key]);
                        return targetErrors.map(err => `<li>${err}</li>`).join('');
                    }
                    return '';
                }).join('')}
                    </ul>
                `;
                container.appendChild(alertDiv);
            }
        }

        showBatchProfitSuccessFeedback(message) {
            const container = document.getElementById('profit-targets-container');
            if (!container) return;

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-sm mt-2';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                ${message}
            `;
            container.appendChild(alertDiv);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        async validateAndPreviewBatchProfit() {
            if (!this.useBatchProfitTaking || !this.profitTargetsManager) {
                return;
            }

            try {
                const buyPrice = parseFloat(document.getElementById('price').value) || 0;
                const profitTargets = this.profitTargetsManager.getTargets();

                // æ›´ä¸¥æ ¼çš„éªŒè¯æ¡ä»¶
                if (buyPrice <= 0) {
                    return; // ä¹°å…¥ä»·æ ¼æ— æ•ˆï¼Œä¸è¿›è¡Œè®¡ç®—
                }

                if (!profitTargets || profitTargets.length === 0) {
                    return; // æ²¡æœ‰æ­¢ç›ˆç›®æ ‡ï¼Œä¸è¿›è¡Œè®¡ç®—
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ­¢ç›ˆç›®æ ‡ï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªç›®æ ‡ä»·æ ¼ä¸ä¸ºç©ºï¼‰
                const validTargets = profitTargets.filter(target => {
                    const targetPrice = parseFloat(target.targetPrice || target.target_price);
                    const sellRatio = parseFloat(target.sellRatio || target.sell_ratio);
                    return targetPrice > 0 && sellRatio > 0;
                });

                if (validTargets.length === 0) {
                    return; // æ²¡æœ‰æœ‰æ•ˆçš„æ­¢ç›ˆç›®æ ‡ï¼Œä¸è¿›è¡Œè®¡ç®—
                }

                // è°ƒç”¨APIè®¡ç®—é¢„æœŸæ”¶ç›Š
                const response = await apiClient.calculateBatchProfit(buyPrice, validTargets);

                if (response.success) {
                    // æ˜¾ç¤ºè®¡ç®—ç»“æœé¢„è§ˆ
                    this.showBatchProfitPreview(response.data);
                }
            } catch (error) {
                console.warn('Failed to calculate batch profit preview:', error);
                // æ¸…é™¤å¯èƒ½æ˜¾ç¤ºçš„é¢„è§ˆä¿¡æ¯
                this.clearBatchProfitPreview();
            }
        }

        clearBatchProfitPreview() {
            const container = document.getElementById('profit-targets-container');
            if (container) {
                const previewElement = container.querySelector('.batch-profit-preview');
                if (previewElement) {
                    previewElement.remove();
                }
            }
        }

        // ç´§æ€¥éšè—å…¨å±€åŠ è½½çŠ¶æ€çš„æ–¹æ³•
        forceHideGlobalLoading() {
            console.log('Force hiding global loading...');

            // è°ƒç”¨æ ‡å‡†çš„éšè—æ–¹æ³•
            if (typeof UXUtils !== 'undefined' && UXUtils.hideGlobalLoading) {
                UXUtils.hideGlobalLoading();
            }

            // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰å¯èƒ½çš„åŠ è½½é®ç½©
            const overlays = document.querySelectorAll('#global-loading-overlay, .loading-overlay, [id*="loading"], [class*="loading"]');
            overlays.forEach(overlay => {
                if (overlay.style) {
                    overlay.style.display = 'none';
                }
                // å°è¯•ç§»é™¤ï¼Œä½†è¦å®‰å…¨å¤„ç†
                try {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                } catch (e) {
                    console.warn('Failed to remove overlay:', e);
                }
            });

            // æ¸…ç†å¯èƒ½çš„Bootstrapæ¨¡æ€èƒŒæ™¯
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                try {
                    backdrop.remove();
                } catch (e) {
                    console.warn('Failed to remove backdrop:', e);
                }
            });

            // ç¡®ä¿bodyæ²¡æœ‰modalç›¸å…³çš„ç±»
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';

            // æ¸…ç†å¯èƒ½çš„spinner
            const spinners = document.querySelectorAll('.spinner-border, .spinner-grow, [class*="spinner"]');
            spinners.forEach(spinner => {
                const parent = spinner.closest('.loading-overlay, #global-loading-overlay');
                if (parent) {
                    try {
                        parent.remove();
                    } catch (e) {
                        console.warn('Failed to remove spinner parent:', e);
                    }
                }
            });

            console.log('Global loading force hidden - all cleanup completed');
        }

        showBatchProfitPreview(calculationResult) {
            const container = document.getElementById('profit-targets-container');
            if (!container) return;

            // ç§»é™¤ä¹‹å‰çš„é¢„è§ˆ
            const existingPreview = container.querySelector('.batch-profit-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // åˆ›å»ºé¢„è§ˆæ˜¾ç¤º
            const previewDiv = document.createElement('div');
            previewDiv.className = 'batch-profit-preview mt-3 p-3 bg-info bg-opacity-10 border border-info rounded';
            previewDiv.innerHTML = `
                <h6 class="text-info mb-2">
                    <i class="bi bi-calculator me-2"></i>
                    åˆ†æ‰¹æ­¢ç›ˆé¢„è§ˆ
                </h6>
                <div class="row">
                    <div class="col-md-4">
                        <small class="text-muted">æ€»é¢„æœŸæ”¶ç›Šç‡:</small>
                        <div class="fw-bold text-success">${(calculationResult.total_expected_profit_ratio * 100).toFixed(2)}%</div>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">æ€»å–å‡ºæ¯”ä¾‹:</small>
                        <div class="fw-bold">${(calculationResult.total_sell_ratio * 100).toFixed(2)}%</div>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">é¢„æœŸæ”¶ç›Šé‡‘é¢:</small>
                        <div class="fw-bold text-success">Â¥${calculationResult.expected_profit_amount?.toFixed(2) || '0.00'}</div>
                    </div>
                </div>
            `;
            container.appendChild(previewDiv);
        }

        resetTradeForm() {
            const form = document.getElementById('trade-form');

            // ä¿å­˜å½“å‰äº¤æ˜“æ—¥æœŸå’Œç¼–è¾‘çŠ¶æ€ï¼ˆåœ¨é‡ç½®ä¹‹å‰ï¼‰
            const isEditing = this.editingTradeId !== null;
            let currentTradeDate = null;
            if (isEditing) {
                const tradeDateField = document.getElementById('trade-date');
                if (tradeDateField) {
                    currentTradeDate = tradeDateField.value;
                    console.log('ä¿å­˜ç¼–è¾‘æ¨¡å¼ä¸‹çš„äº¤æ˜“æ—¥æœŸ:', currentTradeDate);
                }
            }

            form.reset();

            // é‡ç½®éªŒè¯çŠ¶æ€
            form.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });

            // é‡ç½®æ¨¡æ€æ¡†æ ‡é¢˜
            document.getElementById('trade-modal-title').textContent = 'æ·»åŠ äº¤æ˜“è®°å½•';

            // é‡ç½®åˆ†æ‰¹æ­¢ç›ˆçŠ¶æ€
            this.useBatchProfitTaking = false;
            document.getElementById('use-batch-profit-taking').checked = false;

            // æ¸…é™¤é˜²æŠ–è®¡æ—¶å™¨
            if (this.previewCalculationTimer) {
                clearTimeout(this.previewCalculationTimer);
                this.previewCalculationTimer = null;
            }

            // é”€æ¯åˆ†æ‰¹æ­¢ç›ˆç»„ä»¶
            if (this.profitTargetsManager) {
                this.profitTargetsManager.destroy();
                this.profitTargetsManager = null;
            }

            // æ¸…é™¤åˆ†æ‰¹æ­¢ç›ˆç›¸å…³çš„UIåé¦ˆ
            const container = document.getElementById('profit-targets-container');
            if (container) {
                const alerts = container.querySelectorAll('.alert');
                alerts.forEach(alert => alert.remove());
            }

            // éšè—ä¹°å…¥è®¾ç½®
            this.toggleBuySettings(false);

            // é‡ç½®é£é™©æ”¶ç›Šæ˜¾ç¤º
            this.updateRiskRewardDisplay();

            // å¤„ç†äº¤æ˜“æ—¥æœŸï¼šåªæœ‰åœ¨éç¼–è¾‘æ¨¡å¼ä¸‹æ‰é‡ç½®ä¸ºå½“å‰æ—¶é—´
            if (!isEditing) {
                console.log('éç¼–è¾‘æ¨¡å¼ï¼Œè®¾ç½®å½“å‰æ—¶é—´ä¸ºäº¤æ˜“æ—¥æœŸ');
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                    .toISOString().slice(0, 16);
                document.getElementById('trade-date').value = localDateTime;
            } else if (currentTradeDate) {
                console.log('ç¼–è¾‘æ¨¡å¼ï¼Œæ¢å¤åŸæœ‰äº¤æ˜“æ—¥æœŸ:', currentTradeDate);
                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ¢å¤åŸæœ‰çš„äº¤æ˜“æ—¥æœŸ
                document.getElementById('trade-date').value = currentTradeDate;
            }

            // é‡ç½®äº¤æ˜“ç±»å‹é€‰æ‹©çŠ¶æ€
            this.currentTradeType = null;
            this.currentHoldings = [];

            // é‡ç½®ç•Œé¢æ˜¾ç¤ºçŠ¶æ€
            console.log('é‡ç½®è¡¨å•ï¼Œå½“å‰ç¼–è¾‘çŠ¶æ€:', this.editingTradeId);

            // åªæœ‰åœ¨éç¼–è¾‘æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºäº¤æ˜“ç±»å‹é€‰æ‹©
            if (!this.editingTradeId) {
                this.showTradeTypeSelection();
            }

            // æœ€åé‡ç½®ç¼–è¾‘çŠ¶æ€ï¼ˆåœ¨å¤„ç†å®Œæ—¥æœŸä¹‹åï¼‰
            this.editingTradeId = null;
            console.log('è¡¨å•é‡ç½®å®Œæˆï¼Œç¼–è¾‘çŠ¶æ€å·²æ¸…é™¤');
        }

        resetCorrectionForm() {
            const form = document.getElementById('correction-form');
            form.reset();

            document.getElementById('correction-reason').value = '';
            document.getElementById('correction-reason').classList.remove('is-invalid');

            this.correctingTradeId = null;
        }

        // äº¤æ˜“ç±»å‹é€‰æ‹©å·¥ä½œæµç¨‹æ–¹æ³•
        showTradeTypeSelection() {
            // æ˜¾ç¤ºäº¤æ˜“ç±»å‹é€‰æ‹©ç•Œé¢
            document.getElementById('trade-type-selection').style.display = 'block';
            document.getElementById('trade-form-container').style.display = 'none';
            document.getElementById('back-to-type-selection').style.display = 'none';
            document.getElementById('save-trade-btn').style.display = 'none';

            // é‡ç½®æ¨¡æ€æ¡†æ ‡é¢˜
            document.getElementById('trade-modal-title').textContent = 'æ·»åŠ äº¤æ˜“è®°å½•';
        }

        async selectTradeType(tradeType) {
            try {
                this.currentTradeType = tradeType;

                // éšè—ç±»å‹é€‰æ‹©ç•Œé¢ï¼Œæ˜¾ç¤ºè¡¨å•
                document.getElementById('trade-type-selection').style.display = 'none';
                document.getElementById('trade-form-container').style.display = 'block';
                document.getElementById('back-to-type-selection').style.display = 'inline-block';
                document.getElementById('save-trade-btn').style.display = 'inline-block';

                // è®¾ç½®äº¤æ˜“ç±»å‹
                document.getElementById('trade-type').value = tradeType;

                // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
                const title = tradeType === 'buy' ? 'ä¹°å…¥è‚¡ç¥¨' : 'å–å‡ºè‚¡ç¥¨';
                document.getElementById('trade-modal-title').textContent = title;

                if (tradeType === 'buy') {
                    // ä¹°å…¥æµç¨‹ï¼šæ˜¾ç¤ºè‚¡ç¥¨è¾“å…¥æ¡†
                    document.getElementById('buy-stock-input').style.display = 'block';
                    document.getElementById('sell-stock-selection').style.display = 'none';

                    // è®¾ç½®ä¹°å…¥æ—¶çš„å¿…å¡«å­—æ®µ
                    document.getElementById('stock-code').required = true;
                    document.getElementById('stock-name').required = true;
                    document.getElementById('holding-stock-select').required = false;

                    // æ›´æ–°åŸå› é€‰é¡¹
                    this.updateReasonOptions('buy');

                    // æ˜¾ç¤ºä¹°å…¥è®¾ç½®
                    this.toggleBuySettings(true);

                } else if (tradeType === 'sell') {
                    // å–å‡ºæµç¨‹ï¼šåŠ è½½æŒä»“è‚¡ç¥¨å¹¶æ˜¾ç¤ºé€‰æ‹©å™¨
                    document.getElementById('buy-stock-input').style.display = 'none';
                    document.getElementById('sell-stock-selection').style.display = 'block';

                    // è®¾ç½®å–å‡ºæ—¶çš„å¿…å¡«å­—æ®µ
                    document.getElementById('stock-code').required = false;
                    document.getElementById('stock-name').required = false;
                    document.getElementById('holding-stock-select').required = true;

                    // åŠ è½½å½“å‰æŒä»“
                    await this.loadCurrentHoldings();

                    // æ›´æ–°åŸå› é€‰é¡¹
                    this.updateReasonOptions('sell');

                    // éšè—ä¹°å…¥è®¾ç½®
                    this.toggleBuySettings(false);
                }

            } catch (error) {
                console.error('Failed to select trade type:', error);
                showMessage('åŠ è½½äº¤æ˜“ç±»å‹å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        async loadCurrentHoldings() {
            try {
                const response = await apiClient.request('GET', '/trades/current-holdings');

                if (response.success && response.data.holdings) {
                    this.currentHoldings = response.data.holdings;
                    this.populateHoldingStockSelect(this.currentHoldings);
                } else {
                    throw new Error(response?.message || 'è·å–æŒä»“æ•°æ®å¤±è´¥');
                }

            } catch (error) {
                console.error('Failed to load current holdings:', error);
                showMessage('åŠ è½½æŒä»“æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');

                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                const select = document.getElementById('holding-stock-select');
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
            }
        }

        populateHoldingStockSelect(holdings) {
            const select = document.getElementById('holding-stock-select');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è¦å–å‡ºçš„è‚¡ç¥¨</option>';

            if (!holdings || holdings.length === 0) {
                select.innerHTML = '<option value="">æš‚æ— æŒä»“è‚¡ç¥¨</option>';
                document.getElementById('holding-info').textContent = 'å½“å‰æ²¡æœ‰æŒä»“è‚¡ç¥¨å¯ä»¥å–å‡º';
                return;
            }

            // æ·»åŠ æŒä»“è‚¡ç¥¨é€‰é¡¹
            holdings.forEach(holding => {
                const option = document.createElement('option');
                option.value = holding.stock_code;
                option.textContent = `${holding.stock_code} - ${holding.stock_name} (æŒä»“: ${holding.quantity}è‚¡)`;
                option.dataset.holding = JSON.stringify(holding);
                select.appendChild(option);
            });

            document.getElementById('holding-info').textContent = `å…±æœ‰ ${holdings.length} åªæŒä»“è‚¡ç¥¨å¯é€‰æ‹©`;
        }

        onHoldingStockSelect(stockCode) {
            if (!stockCode) {
                document.getElementById('holding-info').textContent = 'è¯·é€‰æ‹©è¦å–å‡ºçš„è‚¡ç¥¨';
                return;
            }

            // ä»é€‰é¡¹ä¸­è·å–æŒä»“ä¿¡æ¯
            const select = document.getElementById('holding-stock-select');
            const selectedOption = select.querySelector(`option[value="${stockCode}"]`);

            if (selectedOption && selectedOption.dataset.holding) {
                const holding = JSON.parse(selectedOption.dataset.holding);

                // è‡ªåŠ¨å¡«å……è‚¡ç¥¨ä¿¡æ¯
                document.getElementById('stock-code').value = holding.stock_code;
                document.getElementById('stock-name').value = holding.stock_name;

                // æ˜¾ç¤ºæŒä»“ä¿¡æ¯
                const info = `æŒä»“æ•°é‡: ${holding.quantity}è‚¡ | å¹³å‡æˆæœ¬: Â¥${holding.avg_cost} | å½“å‰ä»·æ ¼: Â¥${holding.current_price}`;
                document.getElementById('holding-info').innerHTML = `<strong>${info}</strong>`;

                // è®¾ç½®æœ€å¤§å¯å–æ•°é‡æç¤º
                const quantityInput = document.getElementById('quantity');
                quantityInput.max = holding.quantity;
                quantityInput.placeholder = `æœ€å¤šå¯å– ${holding.quantity} è‚¡`;

                // æ›´æ–°æ•°é‡éªŒè¯æç¤º
                this.updateQuantityHintForSell(holding.stock_code, holding.quantity);
            }
        }

        updateQuantityHintForSell(stockCode, maxQuantity) {
            const quantityHint = document.getElementById('quantity-hint');
            if (!quantityHint) return;

            if (stockCode && stockCode.startsWith('68')) {
                quantityHint.textContent = `ç§‘åˆ›æ¿è‚¡ç¥¨ï¼Œæœ€å¤šå¯å– ${maxQuantity} è‚¡`;
                quantityHint.className = 'input-hint text-info';
            } else {
                quantityHint.textContent = `æœ€å¤šå¯å– ${maxQuantity} è‚¡ï¼Œå»ºè®®æŒ‰100è‚¡å€æ•°å–å‡º`;
                quantityHint.className = 'input-hint';
            }
        }

        updateQuantityHint(stockCode) {
            const quantityHint = document.getElementById('quantity-hint');
            if (!quantityHint) return;

            if (stockCode && stockCode.startsWith('68')) {
                quantityHint.textContent = 'ç§‘åˆ›æ¿è‚¡ç¥¨å¯è´­ä¹°ä»»æ„æ•°é‡';
                quantityHint.className = 'input-hint text-info';
            } else {
                quantityHint.textContent = 'è‚¡ç¥¨æ•°é‡å¿…é¡»æ˜¯100çš„å€æ•°';
                quantityHint.className = 'input-hint';
            }
        }

        // è§¦å‘è¡¨å•éªŒè¯çš„è¾…åŠ©å‡½æ•°
        triggerFormValidation() {
            console.log('Triggering form validation...');

            // è·å–æ‰€æœ‰éœ€è¦éªŒè¯çš„å­—æ®µ
            const fieldsToValidate = [
                'stock-code', 'stock-name', 'trade-type',
                'price', 'quantity', 'reason'
            ];

            fieldsToValidate.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    console.log(`Triggering validation for ${fieldId}:`, field.value);

                    // è§¦å‘inputäº‹ä»¶ä»¥æ¿€æ´»éªŒè¯
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    field.dispatchEvent(new Event('blur', { bubbles: true }));

                    // å¦‚æœæœ‰è¡¨å•éªŒè¯å™¨ï¼Œæ‰‹åŠ¨è§¦å‘éªŒè¯
                    if (this.formValidator) {
                        this.formValidator.validateField(field);
                    }
                }
            });

            console.log('Form validation triggered');
        }
    }

    // å…¨å±€å‡½æ•°
    let tradingManager;

    function initTradingRecords() {
        tradingManager = new TradingRecordsManager();
        window.tradingManager = tradingManager;



        // åˆå§‹åŒ–å®Œæˆåï¼Œç¡®ä¿æ¸…ç†ä»»ä½•é—ç•™çš„åŠ è½½çŠ¶æ€
        setTimeout(() => {
            if (tradingManager && typeof tradingManager.forceHideGlobalLoading === 'function') {
                tradingManager.forceHideGlobalLoading();
            }
        }, 2000);
    }

    // å…¨å±€æ¸…ç†å‡½æ•°ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°ç›´æ¥è°ƒç”¨
    window.clearAllLoadingStates = function () {
        console.log('å¼ºåˆ¶æ¸…ç†æ‰€æœ‰åŠ è½½çŠ¶æ€...');

        // æ¸…ç†å…¨å±€åŠ è½½é®ç½©
        const overlays = document.querySelectorAll('#global-loading-overlay, .loading-overlay, [id*="loading"], [class*="loading"]');
        overlays.forEach(overlay => {
            if (overlay.style) {
                overlay.style.display = 'none';
            }
            try {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            } catch (e) {
                console.warn('ç§»é™¤é®ç½©å¤±è´¥:', e);
            }
        });

        // æ¸…ç†Bootstrapæ¨¡æ€èƒŒæ™¯
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            try {
                backdrop.remove();
            } catch (e) {
                console.warn('ç§»é™¤èƒŒæ™¯å¤±è´¥:', e);
            }
        });

        // é‡ç½®bodyæ ·å¼
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        // æ¸…ç†è¡¨æ ¼ä¸­çš„åŠ è½½çŠ¶æ€
        const tbody = document.getElementById('trades-table-body');
        if (tbody && tbody.innerHTML.includes('åŠ è½½ä¸­')) {
            console.log('æ¸…ç†è¡¨æ ¼åŠ è½½çŠ¶æ€...');
            if (window.tradingManager && typeof window.tradingManager.loadTrades === 'function') {
                window.tradingManager.loadTrades();
            }
        }

        console.log('æ‰€æœ‰åŠ è½½çŠ¶æ€å·²æ¸…ç†å®Œæˆ');
        return 'âœ… åŠ è½½çŠ¶æ€æ¸…ç†å®Œæˆ';
    };

    function filterTrades() {
        if (!tradingManager) return;

        // æ”¶é›†ç­›é€‰æ¡ä»¶
        const filters = {};

        const stockCode = document.getElementById('stock-code-filter').value.trim();
        if (stockCode) filters.stock_code = stockCode;

        const stockName = document.getElementById('stock-name-filter').value.trim();
        if (stockName) filters.stock_name = stockName;

        const tradeType = document.getElementById('trade-type-filter').value;
        if (tradeType) filters.trade_type = tradeType;

        const dateFrom = document.getElementById('date-from').value;
        if (dateFrom) filters.start_date = dateFrom;

        const dateTo = document.getElementById('date-to').value;
        if (dateTo) filters.end_date = dateTo;

        const reason = document.getElementById('reason-filter').value;
        if (reason) filters.reason = reason;

        const corrected = document.getElementById('corrected-filter').value;
        if (corrected !== '') filters.is_corrected = corrected;

        // åº”ç”¨ç­›é€‰
        tradingManager.currentFilters = filters;
        tradingManager.currentPage = 1;
        tradingManager.loadTrades();
    }

    function resetFilter() {
        if (!tradingManager) return;

        // æ¸…ç©ºç­›é€‰è¡¨å•
        document.getElementById('stock-code-filter').value = '';
        document.getElementById('stock-name-filter').value = '';
        document.getElementById('trade-type-filter').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.getElementById('reason-filter').value = '';
        document.getElementById('corrected-filter').value = '';
        document.getElementById('sort-by').value = 'trade_date';
        document.getElementById('sort-order').value = 'desc';

        // é‡ç½®ç­›é€‰æ¡ä»¶
        tradingManager.currentFilters = {};
        tradingManager.currentPage = 1;
        tradingManager.loadTrades();
    }

    function refreshTrades() {
        if (!tradingManager) return;

        tradingManager.loadTrades();
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        if (window.location.pathname.includes('trading-records')) {
            // ç«‹å³æ¸…ç†ä»»ä½•å¯èƒ½å­˜åœ¨çš„å…¨å±€åŠ è½½é®ç½©
            setTimeout(() => {
                const overlay = document.getElementById('global-loading-overlay');
                if (overlay) {
                    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ¸…ç†å…¨å±€åŠ è½½é®ç½©...');
                    overlay.style.display = 'none';
                    try {
                        overlay.remove();
                    } catch (e) {
                        console.warn('æ¸…ç†é®ç½©å¤±è´¥:', e);
                    }
                }
            }, 100);

            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (!window.tradingManagerInitialized) {
                window.tradingManagerInitialized = true;
                initTradingRecords();
            }
        }
    });

    // é¡µé¢åŠ è½½å®Œæˆåçš„é¢å¤–æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', function () {
        // ç«‹å³æ£€æŸ¥å¹¶æ¸…ç†ä»»ä½•é—ç•™çš„å…¨å±€åŠ è½½é®ç½©
        setTimeout(() => {
            console.log('å¼€å§‹æ£€æŸ¥é¡µé¢åŠ è½½çŠ¶æ€...');

            // æ£€æŸ¥è¡¨æ ¼åŠ è½½çŠ¶æ€
            const tbody = document.getElementById('trades-table-body');
            if (tbody && tbody.innerHTML.includes('åŠ è½½ä¸­')) {
                console.log('æ£€æµ‹åˆ°é¡µé¢ä»åœ¨åŠ è½½çŠ¶æ€ï¼Œå°è¯•ä¿®å¤...');
                tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-triangle fs-1 d-block mb-2 text-warning"></i>
                        <div class="mb-2">é¡µé¢åŠ è½½å¼‚å¸¸</div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°é¡µé¢
                        </button>
                    </td>
                </tr>
            `;
            }

            // å¼ºåˆ¶æ¸…ç†ä»»ä½•å…¨å±€åŠ è½½é®ç½©
            const globalOverlay = document.getElementById('global-loading-overlay');
            if (globalOverlay) {
                console.log('æ£€æµ‹åˆ°å…¨å±€åŠ è½½é®ç½©ï¼Œå¼ºåˆ¶æ¸…ç†...');
                if (window.tradingManager && typeof window.tradingManager.forceHideGlobalLoading === 'function') {
                    window.tradingManager.forceHideGlobalLoading();
                } else {
                    // ç›´æ¥æ¸…ç†
                    globalOverlay.style.display = 'none';
                    try {
                        globalOverlay.remove();
                    } catch (e) {
                        console.warn('Failed to remove global overlay:', e);
                    }

                    // æ¸…ç†å¯èƒ½çš„BootstrapèƒŒæ™¯
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        try {
                            backdrop.remove();
                        } catch (e) {
                            console.warn('Failed to remove backdrop:', e);
                        }
                    });

                    // é‡ç½®bodyæ ·å¼
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }
        }, 1000); // ç¼©çŸ­åˆ°1ç§’ï¼Œæ›´å¿«å“åº”

        // æ›´é¢‘ç¹çš„æ£€æŸ¥ï¼Œé˜²æ­¢åŠ è½½çŠ¶æ€å¡ä½
        const checkInterval = setInterval(() => {
            const overlay = document.getElementById('global-loading-overlay');
            if (overlay && overlay.style.display !== 'none') {
                const overlayTime = overlay.dataset.showTime;
                const currentTime = Date.now();

                // å¦‚æœåŠ è½½é®ç½©æ˜¾ç¤ºè¶…è¿‡5ç§’ï¼Œè‡ªåŠ¨æ¸…ç†ï¼ˆç¼©çŸ­æ—¶é—´ï¼‰
                if (!overlayTime || (currentTime - parseInt(overlayTime)) > 5000) {
                    console.log('åŠ è½½é®ç½©æ˜¾ç¤ºæ—¶é—´è¿‡é•¿ï¼Œè‡ªåŠ¨æ¸…ç†...');
                    if (window.tradingManager && typeof window.tradingManager.forceHideGlobalLoading === 'function') {
                        window.tradingManager.forceHideGlobalLoading();
                    } else {
                        overlay.style.display = 'none';
                        try {
                            overlay.remove();
                        } catch (e) {
                            console.warn('Failed to remove overlay:', e);
                        }
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰é®ç½©ï¼Œæ¸…é™¤æ£€æŸ¥é—´éš”
                clearInterval(checkInterval);
            }
        }, 1000); // æ›´é¢‘ç¹æ£€æŸ¥ï¼Œæ¯1ç§’ä¸€æ¬¡

        // 30ç§’åæ¸…é™¤æ£€æŸ¥é—´éš”ï¼Œé¿å…å†…å­˜æ³„æ¼
        setTimeout(() => {
            clearInterval(checkInterval);
        }, 30000);
    });

    // æœ€ç»ˆçš„å¼ºåˆ¶æ¸…ç† - ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åæ¸…ç†ä»»ä½•é—ç•™çŠ¶æ€
    setTimeout(() => {
        console.log('æ‰§è¡Œæœ€ç»ˆå¼ºåˆ¶æ¸…ç†...');

        // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰åŠ è½½çŠ¶æ€
        const allOverlays = document.querySelectorAll('*[id*="loading"], *[class*="loading"], .modal-backdrop, #global-loading-overlay');
        allOverlays.forEach(element => {
            if (element && element.style) {
                element.style.display = 'none';
                try {
                    element.remove();
                } catch (e) {
                    console.warn('æ¸…ç†å…ƒç´ å¤±è´¥:', e);
                }
            }
        });

        // é‡ç½®æ‰€æœ‰å¯èƒ½çš„æ ·å¼
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        document.documentElement.style.overflow = '';

        console.log('æœ€ç»ˆå¼ºåˆ¶æ¸…ç†å®Œæˆ');
    }, 2000);

    // æŒç»­ç›‘æ§å’Œæ¸…ç†
    setInterval(() => {
        const overlay = document.getElementById('global-loading-overlay');
        if (overlay && overlay.style.display !== 'none') {
            console.log('æ£€æµ‹åˆ°é¡½å›ºçš„åŠ è½½çŠ¶æ€ï¼Œå¼ºåˆ¶æ¸…ç†...');
            overlay.style.display = 'none';
            try {
                overlay.remove();
            } catch (e) {
                console.warn('æ¸…ç†å¤±è´¥:', e);
            }
        }
    }, 1000);

    // åˆ›å»ºè°ƒè¯•é¢æ¿
    function createDebugPanel() {
        if (document.getElementById('validation-debug-panel')) return;

        const panel = document.createElement('div');
        panel.id = 'validation-debug-panel';
        panel.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            z-index: 9999;
            font-family: monospace;
            font-size: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        `;
        panel.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; color: #dc3545;">ğŸ› éªŒè¯è°ƒè¯•é¢æ¿</h4>
                <button onclick="this.parentElement.parentElement.remove()" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">å…³é—­</button>
            </div>
            <div style="margin-bottom: 10px;">
                <button onclick="fixReasonOptions()" style="background: #28a745; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; margin-right: 5px;">ğŸ”§ ä¿®å¤æ“ä½œåŸå› </button>
                <button onclick="forceSubmit()" style="background: #ffc107; color: black; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">ğŸš€ å¼ºåˆ¶æäº¤</button>
            </div>
            <div id="debug-content" style="max-height: 400px; overflow-y: auto;"></div>
        `;
        document.body.appendChild(panel);
        return panel;
    }

    // è°ƒè¯•æ—¥å¿—å‡½æ•°
    function debugLog(message, type = 'info') {
        console.log(`ğŸ› [VALIDATION DEBUG] ${message}`);

        const panel = createDebugPanel();
        const content = document.getElementById('debug-content');
        if (content) {
            const colors = {
                'error': '#dc3545',
                'warning': '#ffc107',
                'success': '#28a745',
                'info': '#17a2b8'
            };

            const logEntry = document.createElement('div');
            logEntry.style.cssText = `
                margin-bottom: 5px;
                padding: 5px;
                border-left: 3px solid ${colors[type] || colors.info};
                background: white;
                border-radius: 3px;
            `;
            logEntry.innerHTML = `<span style="color: ${colors[type] || colors.info}; font-weight: bold;">[${type.toUpperCase()}]</span> ${message}`;
            content.appendChild(logEntry);
            content.scrollTop = content.scrollHeight;
        }
    }

    // ç®€æ´çš„è¡¨å•éªŒè¯æµ‹è¯•
    function testSimpleValidation() {
        console.log('ğŸ§ª å¼€å§‹æµ‹è¯•ç®€æ´éªŒè¯å™¨...');

        if (!window.tradingManager || !window.tradingManager.simpleValidator) {
            console.error('âŒ ç®€æ´éªŒè¯å™¨æœªåˆå§‹åŒ–');
            showMessage('éªŒè¯å™¨æœªåˆå§‹åŒ–', 'error');
            return;
        }

        const validator = window.tradingManager.simpleValidator;
        const isValid = validator.validateForm();

        if (isValid) {
            const formData = validator.getFormData();
            console.log('âœ… éªŒè¯é€šè¿‡ï¼è¡¨å•æ•°æ®:', formData);
            showMessage('è¡¨å•éªŒè¯é€šè¿‡ï¼', 'success');
        } else {
            console.log('âŒ éªŒè¯å¤±è´¥ï¼Œé”™è¯¯:', validator.errors);
            showMessage('è¡¨å•éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯', 'error');
        }

        // è°ƒè¯•å­—æ®µéªŒè¯çŠ¶æ€
        const fieldsToDebug = [
            { id: 'stock-code', name: 'è‚¡ç¥¨ä»£ç ' },
            { id: 'price', name: 'ä»·æ ¼' },
            { id: 'quantity', name: 'æ•°é‡' }
        ];

        fieldsToDebug.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
                const value = element.value;
                const isInvalid = element.classList.contains('is-invalid');
                const isValid = element.classList.contains('is-valid');
                const isRequired = element.hasAttribute('required');
                const pattern = element.getAttribute('pattern');
                const maxLength = element.getAttribute('maxlength');

                debugLog(`ğŸ“‹ ${field.name} (${field.id}):`, 'info');
                debugLog(`   å€¼: "${value}"`, 'info');
                debugLog(`   is-invalid: ${isInvalid}`, isInvalid ? 'error' : 'success');
                debugLog(`   is-valid: ${isValid}`, isValid ? 'success' : 'info');
                debugLog(`: ${isRequired}`, 'info');
                if (pattern) debugLog(`   pattern: ${pattern}`, 'warning');
                if (maxLength) debugLog(`   maxlength: ${maxLength}`, 'warning');

                // æµ‹è¯•Validators
                if (field.id === 'stock-code' && window.Validators && window.Validators.stockCode) {
                    try {
                        const validatorResult = window.Validators.stockCode(value);
                        debugLog(`   Validators.stockCode("${value}"): ${validatorResult}`, validatorResult ? 'success' : 'error');
                    } catch (e) {
                        debugLog(`   Validators.stockCode é”™è¯¯: ${e.message}`, 'error');
                    }
                }

                if (field.id === 'price' && window.Validators && window.Validators.price) {
                    try {
                        const validatorResult = window.Validators.price(value);
                        debugLog(`   Validators.price("${value}"): ${validatorResult}`, validatorResult ? 'success' : 'error');
                    } catch (e) {
                        debugLog(`   Validators.price é”™è¯¯: ${e.message}`, 'error');
                    }
                }

                if (field.id === 'quantity' && window.Validators && window.Validators.quantity) {
                    try {
                        const validatorResult = window.Validators.quantity(value);
                        debugLog(`   Validators.quantity("${value}"): ${validatorResult}`, validatorResult ? 'success' : 'error');

                        // è¯¦ç»†æ£€æŸ¥æ•°é‡
                        const num = parseInt(value);
                        debugLog(`   æ•°é‡è¯¦ç»†: ${num}, æ˜¯æ•°å­—: ${!isNaN(num)}, >0: ${num > 0}, %100==0: ${num % 100 === 0}`, 'info');
                    } catch (e) {
                        debugLog(`   Validators.quantity é”™è¯¯: ${e.message}`, 'error');
                    }
                }
            } else {
                debugLog(`âŒ æ‰¾ä¸åˆ°å­—æ®µ: ${field.id}`, 'error');
            }
        });

        // æ£€æŸ¥FormValidator
        if (window.tradingManager && window.tradingManager.formValidator) {
            debugLog('âœ… æ‰¾åˆ°FormValidatorå®ä¾‹', 'success');

            // å°è¯•æ‰‹åŠ¨éªŒè¯
            try {
                const validationResult = window.tradingManager.formValidator.validateForm();
                debugLog(`FormValidator.validateForm(): ${validationResult.isValid}`, validationResult.isValid ? 'success' : 'error');
                if (!validationResult.isValid) {
                    debugLog(`éªŒè¯é”™è¯¯: ${JSON.stringify(validationResult.errors)}`, 'error');
                }
            } catch (e) {
                debugLog(`FormValidator.validateForm() é”™è¯¯: ${e.message}`, 'error');
            }
        } else {
            debugLog('âŒ æ‰¾ä¸åˆ°FormValidatorå®ä¾‹', 'error');
        }

        debugLog('éªŒè¯è°ƒè¯•å®Œæˆ', 'info');

        // ğŸ”§ ä¿®å¤å­—æ®µéªŒè¯çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜
        debugLog('ğŸ”§ å¼€å§‹ä¿®å¤å­—æ®µéªŒè¯çŠ¶æ€...', 'info');
        fixFieldValidationStates();
    }

    // ä¿®å¤å­—æ®µéªŒè¯çŠ¶æ€çš„å‡½æ•°
    function fixFieldValidationStates() {
        const fieldsToFix = ['trade-date', 'quantity'];

        fieldsToFix.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                debugLog(`ä¿®å¤å­—æ®µ: ${fieldId}`, 'info');

                // æ£€æŸ¥å­—æ®µå½“å‰çŠ¶æ€
                const hasInvalidClass = field.classList.contains('is-invalid');
                const hasValidClass = field.classList.contains('is-valid');
                const fieldValue = field.value;

                debugLog(`   å½“å‰çŠ¶æ€: is-invalid=${hasInvalidClass}, is-valid=${hasValidClass}, value="${fieldValue}"`, 'info');

                // å¦‚æœå­—æ®µæœ‰å€¼ä¸”è¢«æ ‡è®°ä¸ºæ— æ•ˆï¼Œä½†å®é™…éªŒè¯é€šè¿‡äº†ï¼Œåˆ™ä¿®å¤çŠ¶æ€
                if (hasInvalidClass && fieldValue && fieldValue.trim() !== '') {
                    // éªŒè¯å­—æ®µå€¼æ˜¯å¦çœŸçš„æœ‰æ•ˆ
                    let isActuallyValid = true;

                    if (fieldId === 'quantity') {
                        const num = parseInt(fieldValue);
                        isActuallyValid = !isNaN(num) && num > 0 && num % 100 === 0;
                    } else if (fieldId === 'trade-date') {
                        isActuallyValid = fieldValue.length > 0;
                    }

                    if (isActuallyValid) {
                        debugLog(`   ğŸ”§ ä¿®å¤ ${fieldId}: ç§»é™¤æ— æ•ˆçŠ¶æ€ï¼Œæ·»åŠ æœ‰æ•ˆçŠ¶æ€`, 'success');
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');

                        // ç§»é™¤é”™è¯¯åé¦ˆæ¶ˆæ¯
                        const container = getFieldContainer(field);
                        if (container) {
                            const invalidFeedback = container.querySelector('.invalid-feedback');
                            if (invalidFeedback) {
                                invalidFeedback.remove();
                                debugLog(`   ğŸ—‘ï¸ ç§»é™¤ ${fieldId} çš„é”™è¯¯åé¦ˆ`, 'info');
                            }
                        }
                    }
                }
            }
        });
    }

    // è·å–å­—æ®µå®¹å™¨çš„è¾…åŠ©å‡½æ•°
    function getFieldContainer(field) {
        if (!field || !field.parentNode) {
            return null;
        }

        // å¦‚æœå­—æ®µåœ¨input-groupä¸­ï¼Œè¿”å›input-groupçš„çˆ¶å®¹å™¨
        if (field.parentNode.classList && field.parentNode.classList.contains('input-group')) {
            return field.parentNode.parentNode;
        }
        return field.parentNode;
    }

    // ç›‘å¬æ‰€æœ‰å¯èƒ½çš„éªŒè¯äº‹ä»¶
    function setupValidationDebugging() {
        debugLog('è®¾ç½®éªŒè¯è°ƒè¯•ç›‘å¬å™¨...', 'info');

        // ç›‘å¬è¡¨å•æäº¤
        const form = document.getElementById('trade-form');
        if (form) {
            form.addEventListener('submit', function (e) {
                debugLog('ğŸš¨ è¡¨å•æäº¤äº‹ä»¶è§¦å‘', 'warning');
                debugLog(`äº‹ä»¶è¢«é˜»æ­¢: ${e.defaultPrevented}`, e.defaultPrevented ? 'error' : 'success');

                // è®©SimpleFormValidatorå¤„ç†éªŒè¯ï¼Œä¸å†æ‰‹åŠ¨ä¿®å¤å­—æ®µçŠ¶æ€
                debugLog('è¡¨å•æäº¤ç”±SimpleFormValidatorå¤„ç†', 'info');
            });

            // ç›‘å¬è¾“å…¥å˜åŒ–
            form.addEventListener('input', function (e) {
                if (e.target.matches('input, select')) {
                    debugLog(`ğŸ“ è¾“å…¥å˜åŒ–: ${e.target.id} = "${e.target.value}"`, 'info');

                    // æ£€æŸ¥éªŒè¯çŠ¶æ€å˜åŒ–
                    setTimeout(() => {
                        const isInvalid = e.target.classList.contains('is-invalid');
                        const isValid = e.target.classList.contains('is-valid');
                        if (isInvalid || isValid) {
                            debugLog(`   éªŒè¯çŠ¶æ€: is-invalid=${isInvalid}, is-valid=${isValid}`, isInvalid ? 'error' : 'success');
                        }
                    }, 100);
                }
            });

            // ç›‘å¬bluräº‹ä»¶
            form.addEventListener('blur', function (e) {
                if (e.target.matches('input, select')) {
                    debugLog(`ğŸ‘ï¸ å¤±ç„¦äº‹ä»¶: ${e.target.id}`, 'info');

                    setTimeout(() => {
                        const isInvalid = e.target.classList.contains('is-invalid');
                        if (isInvalid) {
                            debugLog(`   å¤±ç„¦åæ ‡è®°ä¸ºæ— æ•ˆ: ${e.target.id}`, 'error');
                        }
                    }, 100);
                }
            }, true);
        }

        // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²åœ¨ä¸»è¦äº‹ä»¶ç›‘å¬å™¨ä¸­å¤„ç†ï¼Œè¿™é‡Œä¸å†é‡å¤æ·»åŠ 
    }

    // ä¿®å¤è¡¨å•éªŒè¯å†²çªé—®é¢˜
    function fixFormValidationConflicts() {
        const form = document.getElementById('trade-form');
        if (form) {
            // ç¡®ä¿ç¦ç”¨HTML5éªŒè¯
            form.noValidate = true;

            // æ¸…é™¤ä»»ä½•é—ç•™çš„éªŒè¯çŠ¶æ€
            form.querySelectorAll('.is-invalid, .is-valid').forEach(el => {
                el.classList.remove('is-invalid', 'is-valid');
            });

            debugLog('âœ… è¡¨å•éªŒè¯å†²çªå·²ä¿®å¤', 'success');
        }

        // è®¾ç½®è°ƒè¯•
        setupValidationDebugging();
    }

    // ä¿®å¤æ“ä½œåŸå› é€‰é¡¹
    function fixReasonOptions() {
        debugLog('ğŸ”§ å¼€å§‹ä¿®å¤æ“ä½œåŸå› é€‰é¡¹...', 'warning');

        const reasonSelect = document.getElementById('reason');
        if (!reasonSelect) {
            debugLog('âŒ æ‰¾ä¸åˆ°æ“ä½œåŸå› ä¸‹æ‹‰æ¡†', 'error');
            return;
        }

        // ç›´æ¥æ·»åŠ ä¹°å…¥åŸå› é€‰é¡¹
        const buyReasons = ['å°‘å¦‡B1æˆ˜æ³•', 'å°‘å¦‡SB1æˆ˜æ³•', 'å°‘å¦‡B2æˆ˜æ³•', 'å•é’ˆäºŒåæˆ˜æ³•', 'ä¸ç¬¦åˆäº¤æ˜“çºªå¾‹'];

        reasonSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ“ä½œåŸå› </option>';
        buyReasons.forEach(reason => {
            const option = document.createElement('option');
            option.value = reason;
            option.textContent = reason;
            reasonSelect.appendChild(option);
        });

        // è‡ªåŠ¨é€‰æ‹©"å•é’ˆäºŒåæˆ˜æ³•"
        reasonSelect.value = 'å•é’ˆäºŒåæˆ˜æ³•';

        debugLog('âœ… æ“ä½œåŸå› é€‰é¡¹å·²ä¿®å¤ï¼Œè‡ªåŠ¨é€‰æ‹©äº†"å•é’ˆäºŒåæˆ˜æ³•"', 'success');

        // è§¦å‘changeäº‹ä»¶
        reasonSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // å¼ºåˆ¶æäº¤è¡¨å•
    function forceSubmit() {
        debugLog('ğŸš€ å¼€å§‹å¼ºåˆ¶æäº¤...', 'warning');

        // å…ˆä¿®å¤æ“ä½œåŸå› 
        fixReasonOptions();

        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = {
            stock_code: document.getElementById('stock-code')?.value?.trim() || '',
            stock_name: document.getElementById('stock-name')?.value?.trim() || '',
            trade_type: 'buy',
            price: parseFloat(document.getElementById('price')?.value) || 0,
            quantity: parseInt(document.getElementById('quantity')?.value) || 0,
            trade_date: document.getElementById('trade-date')?.value || new Date().toISOString().slice(0, 16),
            reason: document.getElementById('reason')?.value?.trim() || 'å•é’ˆäºŒåæˆ˜æ³•'
        };

        debugLog('ğŸ“‹ å¼ºåˆ¶æäº¤æ•°æ®: ' + JSON.stringify(formData), 'info');

        // æ£€æŸ¥é‡å¤æäº¤
        if (!canSubmit()) {
            debugLog('ğŸ›¡ï¸ å¼ºåˆ¶æäº¤è¢«é˜»æ­¢ï¼šé‡å¤æäº¤', 'warning');
            return;
        }

        // è®¾ç½®æäº¤çŠ¶æ€
        setSubmitting(true);

        // ç›´æ¥è°ƒç”¨API
        fetch('/api/trades', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    debugLog('âœ… å¼ºåˆ¶æäº¤æˆåŠŸï¼äº¤æ˜“ID: ' + result.data.id, 'success');
                    alert('âœ… ä¹°å…¥è®°å½•æ·»åŠ æˆåŠŸï¼\näº¤æ˜“ID: ' + result.data.id);

                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTradeModal'));
                    if (modal) modal.hide();

                    // åˆ·æ–°é¡µé¢
                    location.reload();
                } else {
                    debugLog('âŒ å¼ºåˆ¶æäº¤å¤±è´¥: ' + result.error?.message, 'error');
                    alert('âŒ æäº¤å¤±è´¥: ' + result.error?.message);
                }
            })
            .catch(error => {
                debugLog('âŒ å¼ºåˆ¶æäº¤é”™è¯¯: ' + error.message, 'error');
                alert('âŒ æäº¤é”™è¯¯: ' + error.message);
            })
            .finally(() => {
                // é‡ç½®æäº¤çŠ¶æ€
                setSubmitting(false);
            });
    }

    // å…¨å±€æš´éœ²è°ƒè¯•å‡½æ•°
    window.createDebugPanel = createDebugPanel;
    window.fixReasonOptions = fixReasonOptions;
    window.forceSubmit = forceSubmit;

    // é¡µé¢åŠ è½½æ—¶ä¿®å¤
    document.addEventListener('DOMContentLoaded', fixFormValidationConflicts);

    // æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶ä¹Ÿä¿®å¤
    document.addEventListener('show.bs.modal', function (e) {
        if (e.target.id === 'addTradeModal') {
            setTimeout(() => {
                fixFormValidationConflicts();
                debugLog('ğŸ”„ æ¨¡æ€æ¡†æ˜¾ç¤ºï¼Œé‡æ–°åˆå§‹åŒ–è°ƒè¯•', 'info');
            }, 100);
        }
    });

    // æ·»åŠ å¿«æ·é”® Ctrl+Shift+D è§¦å‘è°ƒè¯•
    document.addEventListener('keydown', function (e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            testSimpleValidation();
        }
    });

    // é¢å¤–é˜²æŠ¤ï¼šç›‘å¬è¡¨å•æäº¤äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤æäº¤
    // è¿™éƒ¨åˆ†ä»£ç å·²ç»åœ¨ä¸Šé¢å®šä¹‰è¿‡äº†ï¼Œåˆ é™¤é‡å¤ä»£ç 
</script>
{% endblock %}