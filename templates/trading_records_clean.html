{% extends "base.html" %}

{% block title %}äº¤æ˜“è®°å½• - è‚¡ç¥¨äº¤æ˜“è®°å½•ç³»ç»Ÿ{% endblock %}

{% block extra_head %}
<script>
    // ç«‹å³æ‰§è¡Œçš„æ¸…ç†è„šæœ¬
    (function () {
        console.log('ç«‹å³æ¸…ç†è„šæœ¬å¼€å§‹æ‰§è¡Œ...');

        function immediateCleanup() {
            console.log('æ‰§è¡Œç«‹å³æ¸…ç†...');

            // æ¸…ç†æ‰€æœ‰å¯èƒ½çš„åŠ è½½é®ç½©
            const overlays = document.querySelectorAll('#global-loading-overlay, .loading-overlay, [id*="loading"], [class*="loading"]');
            overlays.forEach(overlay => {
                if (overlay && overlay.style) {
                    overlay.style.display = 'none';
                    try {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    } catch (e) {
                        console.warn('æ¸…ç†é®ç½©å¤±è´¥:', e);
                    }
                }
            });

            // æ¸…ç†BootstrapèƒŒæ™¯
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                try {
                    backdrop.remove();
                } catch (e) {
                    console.warn('æ¸…ç†èƒŒæ™¯å¤±è´¥:', e);
                }
            });

            // é‡ç½®bodyæ ·å¼
            if (document.body) {
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }

            console.log('ç«‹å³æ¸…ç†å®Œæˆ');
        }

        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        immediateCleanup();

        // æ¯100msæ‰§è¡Œä¸€æ¬¡ï¼ŒæŒç»­5ç§’
        let cleanupCount = 0;
        const cleanupInterval = setInterval(() => {
            immediateCleanup();
            cleanupCount++;

            if (cleanupCount >= 50) { // 5ç§’ååœæ­¢
                clearInterval(cleanupInterval);
                console.log('ç«‹å³æ¸…ç†è„šæœ¬ç»“æŸ');
            }
        }, 100);

        // å…¨å±€æš´éœ²æ¸…ç†å‡½æ•°
        window.emergencyCleanup = immediateCleanup;
    })();
</script>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">äº¤æ˜“è®°å½•</li>
{% endblock %}

{% block page_title %}äº¤æ˜“è®°å½•{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTradeModal">
    <i class="bi bi-plus-circle"></i>
    æ·»åŠ äº¤æ˜“
</button>
<button type="button" class="btn btn-outline-secondary" onclick="refreshTrades()">
    <i class="bi bi-arrow-clockwise"></i>
    åˆ·æ–°
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">äº¤æ˜“è®°å½•åˆ—è¡¨</h5>
    </div>
    <div class="card-body">
        <!-- ç­›é€‰å™¨ -->
        <div class="row mb-3">
            <div class="col-md-2">
                <input type="text" class="form-control" placeholder="è‚¡ç¥¨ä»£ç " id="stock-code-filter">
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" placeholder="è‚¡ç¥¨åç§°" id="stock-name-filter">
            </div>
            <div class="col-md-2">
                <select class="form-select" id="trade-type-filter">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="buy">ä¹°å…¥</option>
                    <option value="sell">å–å‡º</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" id="date-from" title="å¼€å§‹æ—¥æœŸ">
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" id="date-to" title="ç»“æŸæ—¥æœŸ">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-primary w-100" onclick="filterTrades()">
                    <i class="bi bi-search"></i>
                    ç­›é€‰
                </button>
            </div>
        </div>

        <!-- äº¤æ˜“è®°å½•è¡¨æ ¼ -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>è‚¡ç¥¨</th>
                        <th>ç±»å‹</th>
                        <th>ä»·æ ¼</th>
                        <th>æ•°é‡</th>
                        <th>é‡‘é¢</th>
                        <th>åŸå› </th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="trades-table-body">
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            åŠ è½½ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        <nav aria-label="äº¤æ˜“è®°å½•åˆ†é¡µ">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘äº¤æ˜“æ¨¡æ€æ¡† -->
<div class="modal fade" id="addTradeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trade-modal-title">æ·»åŠ äº¤æ˜“è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- äº¤æ˜“ç±»å‹é€‰æ‹©æ­¥éª¤ -->
                <div id="trade-type-selection" class="text-center mb-4">
                    <h6 class="mb-3">è¯·é€‰æ‹©äº¤æ˜“ç±»å‹</h6>
                    <div class="row justify-content-center">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-success btn-lg w-100 mb-2" id="select-buy-btn">
                                <i class="bi bi-arrow-up-circle"></i>
                                <div>ä¹°å…¥</div>
                                <small class="text-muted">è´­ä¹°è‚¡ç¥¨</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-danger btn-lg w-100 mb-2" id="select-sell-btn">
                                <i class="bi bi-arrow-down-circle"></i>
                                <div>å–å‡º</div>
                                <small class="text-muted">å‡ºå”®æŒä»“è‚¡ç¥¨</small>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- äº¤æ˜“è¡¨å• -->
                <div id="trade-form-container" style="display: none;">
                    <form id="trade-form" novalidate>
                        <!-- ä¹°å…¥æ—¶çš„è‚¡ç¥¨è¾“å…¥ -->
                        <div id="buy-stock-input" class="row" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stock-code" class="form-label">è‚¡ç¥¨ä»£ç  <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="stock-code" name="stock_code" placeholder="ä¾‹å¦‚: 000001">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stock-name" class="form-label">è‚¡ç¥¨åç§° <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="stock-name" name="stock_name" placeholder="ä¾‹å¦‚: å¹³å®‰é“¶è¡Œ">
                                </div>
                            </div>
                        </div>

                        <!-- å–å‡ºæ—¶çš„è‚¡ç¥¨é€‰æ‹© -->
                        <div id="sell-stock-selection" class="row" style="display: none;">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="holding-stock-select" class="form-label">é€‰æ‹©æŒä»“è‚¡ç¥¨ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="holding-stock-select" name="holding_stock">
                                        <option value="">è¯·é€‰æ‹©è¦å–å‡ºçš„è‚¡ç¥¨</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="trade-type" class="form-label">äº¤æ˜“ç±»å‹ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="trade-type" name="trade_type">
                                        <option value="">è¯·é€‰æ‹©äº¤æ˜“ç±»å‹</option>
                                        <option value="buy">ä¹°å…¥</option>
                                        <option value="sell">å–å‡º</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="trade-date" class="form-label">äº¤æ˜“æ—¥æœŸ <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="trade-date" name="trade_date">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="price" class="form-label">ä»·æ ¼ <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        <input type="number" class="form-control" id="price" name="price" step="0.01" placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">æ•°é‡ <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="quantity" name="quantity" step="100" placeholder="100">
                                        <span class="input-group-text">è‚¡</span>
                                    </div>
                                    <div class="form-text">è‚¡ç¥¨æ•°é‡å¿…é¡»æ˜¯100çš„å€æ•°</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="reason" class="form-label">æ“ä½œåŸå›  <span class="text-danger">*</span></label>
                            <select class="form-select" id="reason" name="reason">
                                <option value="">è¯·é€‰æ‹©æ“ä½œåŸå› </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" maxlength="500" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯..."></textarea>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="back-to-type-selection" style="display: none;">
                    <i class="bi bi-arrow-left"></i>
                    è¿”å›
                </button>
                <button type="button" class="btn btn-info" onclick="testSimpleValidation()" title="æµ‹è¯•ç®€æ´éªŒè¯">
                    âœ… æµ‹è¯•éªŒè¯
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="save-trade-btn" style="display: none;">
                    <span class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/simple-form-validator.js') }}"></script>
<script src="{{ url_for('static', filename='js/emergency-cleanup.js') }}"></script>
<script>
    // äº¤æ˜“è®°å½•é¡µé¢ç®¡ç†ç±»
    class TradingRecordsManager {
        constructor() {
            this.currentPage = 1;
            this.perPage = 20;
            this.totalPages = 1;
            this.currentFilters = {};
            this.buyReasons = ['å°‘å¦‡B1æˆ˜æ³•', 'å°‘å¦‡SB1æˆ˜æ³•', 'å°‘å¦‡B2æˆ˜æ³•', 'å•é’ˆäºŒåæˆ˜æ³•'];
            this.sellReasons = ['éƒ¨åˆ†æ­¢ç›ˆ', 'æ­¢æŸ', 'ä¸‹ç­‰é©¬/è‰æ³¥é©¬'];
            this.editingTradeId = null;
            this.simpleValidator = null;

            this.init();
        }

        async init() {
            try {
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                this.setupEventListeners();

                // åˆå§‹åŒ–è¡¨å•
                this.initializeForms();

                // åŠ è½½äº¤æ˜“è®°å½•
                await this.loadTrades();

                console.log('Trading records page initialized successfully');
            } catch (error) {
                console.error('Failed to initialize trading records page:', error);
                this.showMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
            }
        }

        initializeForms() {
            // è®¾ç½®é»˜è®¤äº¤æ˜“æ—¥æœŸä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('trade-date').value = localDateTime;
            
            // åˆå§‹åŒ–ç®€æ´çš„éªŒè¯å™¨
            this.simpleValidator = new SimpleFormValidator('trade-form');
            
            // è®¾ç½®å®æ—¶éªŒè¯
            this.setupRealTimeValidation();
            
            console.log('âœ… è¡¨å•éªŒè¯å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        setupRealTimeValidation() {
            const fieldsToValidate = ['stock-code', 'stock-name', 'trade-type', 'trade-date', 'price', 'quantity', 'reason', 'holding-stock-select'];
            
            fieldsToValidate.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', () => {
                        this.simpleValidator.validateField(fieldId);
                    });
                    
                    field.addEventListener('input', () => {
                        // å»¶è¿ŸéªŒè¯ï¼Œé¿å…è¾“å…¥æ—¶é¢‘ç¹æç¤º
                        clearTimeout(field.validationTimer);
                        field.validationTimer = setTimeout(() => {
                            this.simpleValidator.validateField(fieldId);
                        }, 500);
                    });
                }
            });
        }

        setupEventListeners() {
            // ä¿å­˜äº¤æ˜“æŒ‰é’®
            document.getElementById('save-trade-btn').addEventListener('click', () => {
                this.saveTrade();
            });

            // äº¤æ˜“ç±»å‹å˜åŒ–äº‹ä»¶
            document.getElementById('trade-type').addEventListener('change', (e) => {
                this.updateReasonOptions(e.target.value);
            });

            // äº¤æ˜“ç±»å‹é€‰æ‹©äº‹ä»¶
            document.getElementById('select-buy-btn').addEventListener('click', () => {
                this.selectTradeType('buy');
            });

            document.getElementById('select-sell-btn').addEventListener('click', () => {
                this.selectTradeType('sell');
            });

            // è¿”å›æŒ‰é’®
            document.getElementById('back-to-type-selection').addEventListener('click', () => {
                this.showTradeTypeSelection();
            });

            // æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('addTradeModal').addEventListener('show.bs.modal', () => {
                if (!this.editingTradeId) {
                    this.showTradeTypeSelection();
                }
            });

            document.getElementById('addTradeModal').addEventListener('hidden.bs.modal', () => {
                this.resetTradeForm();
            });
        }

        async saveTrade() {
            console.log('ğŸ” å¼€å§‹ä¿å­˜äº¤æ˜“...');
            
            // ä½¿ç”¨ç®€æ´éªŒè¯å™¨éªŒè¯è¡¨å•
            if (!this.simpleValidator.validateForm()) {
                console.log('âŒ è¡¨å•éªŒè¯å¤±è´¥:', this.simpleValidator.errors);
                this.showMessage('è¯·æ£€æŸ¥è¡¨å•ä¸­çš„é”™è¯¯ä¿¡æ¯', 'error');
                return;
            }
            
            console.log('âœ… è¡¨å•éªŒè¯é€šè¿‡');
            
            // è·å–è¡¨å•æ•°æ®
            const formData = this.simpleValidator.getFormData();
            console.log('ğŸ“ è¡¨å•æ•°æ®:', formData);
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘
            this.showMessage('è¡¨å•éªŒè¯é€šè¿‡ï¼ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰', 'success');
        }

        selectTradeType(type) {
            document.getElementById('trade-type').value = type;
            this.updateReasonOptions(type);
            
            // æ˜¾ç¤ºè¡¨å•
            document.getElementById('trade-type-selection').style.display = 'none';
            document.getElementById('trade-form-container').style.display = 'block';
            document.getElementById('back-to-type-selection').style.display = 'inline-block';
            document.getElementById('save-trade-btn').style.display = 'inline-block';

            // æ˜¾ç¤ºç›¸åº”çš„å­—æ®µ
            if (type === 'buy') {
                document.getElementById('buy-stock-input').style.display = 'block';
                document.getElementById('sell-stock-selection').style.display = 'none';
            } else {
                document.getElementById('buy-stock-input').style.display = 'none';
                document.getElementById('sell-stock-selection').style.display = 'block';
            }
        }

        showTradeTypeSelection() {
            document.getElementById('trade-type-selection').style.display = 'block';
            document.getElementById('trade-form-container').style.display = 'none';
            document.getElementById('back-to-type-selection').style.display = 'none';
            document.getElementById('save-trade-btn').style.display = 'none';
        }

        updateReasonOptions(tradeType) {
            const reasonSelect = document.getElementById('reason');
            reasonSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ“ä½œåŸå› </option>';

            const reasons = tradeType === 'buy' ? this.buyReasons : 
                           tradeType === 'sell' ? this.sellReasons : [];

            reasons.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason;
                option.textContent = reason;
                reasonSelect.appendChild(option);
            });
        }

        resetTradeForm() {
            document.getElementById('trade-form').reset();
            this.simpleValidator.clearAllValidation();
            this.editingTradeId = null;
            
            // é‡ç½®é»˜è®¤æ—¥æœŸ
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('trade-date').value = localDateTime;
        }

        async loadTrades() {
            // æ¼”ç¤ºç”¨çš„ç©ºå®ç°
            const tbody = document.getElementById('trades-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        æš‚æ— äº¤æ˜“è®°å½•ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰
                    </td>
                </tr>
            `;
        }

        showMessage(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    }

    // ç®€æ´çš„è¡¨å•éªŒè¯æµ‹è¯•
    function testSimpleValidation() {
        console.log('ğŸ§ª å¼€å§‹æµ‹è¯•ç®€æ´éªŒè¯å™¨...');
        
        if (!window.tradingManager || !window.tradingManager.simpleValidator) {
            console.error('âŒ ç®€æ´éªŒè¯å™¨æœªåˆå§‹åŒ–');
            window.tradingManager.showMessage('éªŒè¯å™¨æœªåˆå§‹åŒ–', 'error');
            return;
        }
        
        const validator = window.tradingManager.simpleValidator;
        const isValid = validator.validateForm();
        
        if (isValid) {
            const formData = validator.getFormData();
            console.log('âœ… éªŒè¯é€šè¿‡ï¼è¡¨å•æ•°æ®:', formData);
            window.tradingManager.showMessage('è¡¨å•éªŒè¯é€šè¿‡ï¼', 'success');
        } else {
            console.log('âŒ éªŒè¯å¤±è´¥ï¼Œé”™è¯¯:', validator.errors);
            window.tradingManager.showMessage('è¡¨å•éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯', 'error');
        }
    }

    // å…¨å±€å‡½æ•°
    let tradingManager;

    function initTradingRecords() {
        tradingManager = new TradingRecordsManager();
        window.tradingManager = tradingManager;
    }

    function filterTrades() {
        if (tradingManager) {
            tradingManager.loadTrades();
        }
    }

    function refreshTrades() {
        if (tradingManager) {
            tradingManager.loadTrades();
        }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initTradingRecords);
</script>
{% endblock %}