{% extends "base.html" %}

{% block title %}å¤ç›˜åˆ†æ - è‚¡ç¥¨äº¤æ˜“è®°å½•ç³»ç»Ÿ{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">å¤ç›˜åˆ†æ</li>
{% endblock %}

{% block page_title %}å¤ç›˜åˆ†æ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-optimizations.css') }}">
<style>
    body {
        background-color: #f8f9fa;
    }

    /* æµ®ç›ˆè®¡ç®—å™¨æ ·å¼ */
    .floating-profit-container {
        position: relative;
    }

    .floating-profit-container.profit {
        background-color: rgba(25, 135, 84, 0.1);
        border-radius: 4px;
        padding: 2px 4px;
    }

    .floating-profit-container.loss {
        background-color: rgba(220, 53, 69, 0.1);
        border-radius: 4px;
        padding: 2px 4px;
    }

    .floating-profit-container.neutral {
        background-color: rgba(108, 117, 125, 0.1);
        border-radius: 4px;
        padding: 2px 4px;
    }

    #floating-profit-ratio {
        font-size: 1.1em;
        font-weight: bold;
    }

    /* æŒä»“åˆ—è¡¨å¢å¼ºæ ·å¼ */
    .holding-item {
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
        background-color: #fff;
    }

    .holding-item:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
        border-color: #007bff;
    }

    .holding-item .fw-bold {
        font-size: 1.1rem;
    }

    .holding-item .text-success {
        color: #28a745 !important;
        font-weight: 600;
    }

    .holding-item .text-danger {
        color: #dc3545 !important;
        font-weight: 600;
    }

    /* æŒä»“å¤©æ•°æ˜¾ç¤ºæ ·å¼ */
    .holding-days-display {
        position: relative;
        cursor: help;
    }

    .holding-days-display .text-info {
        color: #0d6efd !important;
        font-weight: 600;
    }

    .holding-days-display:hover .text-info {
        color: #0a58ca !important;
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="review-page">
    <div class="row">
        <!-- å½“å‰æŒä»“åˆ—è¡¨ -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">å½“å‰æŒä»“</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshHoldings()">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="refreshHoldingsWithPrices()">
                                <i class="fas fa-dollar-sign"></i> åˆ·æ–°ä»·æ ¼
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="toggleAutoRefresh()"
                                id="auto-refresh-btn">
                                <i class="fas fa-play"></i> è‡ªåŠ¨åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="price-update-status">
                            <i class="fas fa-clock"></i> ä»·æ ¼æ›´æ–°æ—¶é—´: <span id="last-price-update">--</span>
                        </small>
                    </div>
                </div>
                <div class="card-body">
                    <div id="holdings-list">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤ç›˜è®°å½•å†å² -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">å¤ç›˜è®°å½•</h5>
                </div>
                <div class="card-body">
                    <div id="reviews-list">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŒä»“æé†’å’Œæ“ä½œé¢æ¿ -->
        <div class="col-lg-4">
            <!-- å¿«é€Ÿå¤ç›˜é¢æ¿ -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">å¿«é€Ÿå¤ç›˜</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è‚¡ç¥¨</label>
                        <select class="form-select" id="quick-review-stock">
                            <option value="">è¯·é€‰æ‹©æŒä»“è‚¡ç¥¨</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="openQuickReview()">å¼€å§‹å¤ç›˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤ç›˜è¯„åˆ†æ¨¡æ€æ¡† -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å¤ç›˜è¯„åˆ†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="review-form" novalidate>
                        <input type="hidden" id="review-stock-code">
                        <input type="hidden" id="review-id">

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                                <input type="text" class="form-control" id="display-stock-code" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">å¤ç›˜æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="review-date">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">æŒä»“å¤©æ•°</label>
                                <input type="number" class="form-control" id="holding-days">
                            </div>
                        </div>

                        <!-- å½“å‰ä»·æ ¼å’Œæµ®ç›ˆè®¡ç®— -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">æµ®ç›ˆè®¡ç®—</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">å½“å‰ä»·æ ¼</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control" id="current-price-input"
                                                placeholder="è¾“å…¥å½“å‰ä»·æ ¼" step="0.01">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">æˆæœ¬ä»·</label>
                                        <div class="form-control-plaintext" id="buy-price-display">--</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">æµ®ç›ˆæ¯”ä¾‹</label>
                                        <div class="floating-profit-container">
                                            <div class="form-control-plaintext fw-bold" id="floating-profit-ratio">--
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">è¯„åˆ†æ ‡å‡† (æ¯é¡¹1åˆ†ï¼Œæ€»åˆ†5åˆ†)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="price-up-score"
                                                value="1">
                                            <label class="form-check-label" for="price-up-score">æ”¶ç›˜ä»·ä¸Šå‡</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="bbi-score" value="1">
                                            <label class="form-check-label" for="bbi-score">ä¸ç ´BBIçº¿</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="volume-score" value="1">
                                            <label class="form-check-label" for="volume-score">æ— æ”¾é‡é˜´çº¿</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="trend-score" value="1">
                                            <label class="form-check-label" for="trend-score">è¶‹åŠ¿è¿˜åœ¨å‘ä¸Š</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="j-score" value="1">
                                            <label class="form-check-label" for="j-score">Jæ²¡æ­»å‰</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <strong>æ€»åˆ†: <span id="total-score" class="text-primary">0</span>/5</strong>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">åˆ†æå†…å®¹</label>
                            <textarea class="form-control" id="analysis" rows="3" placeholder="è¯·è¾“å…¥åˆ†æå†…å®¹..."></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">å†³ç­–ç»“æœ</label>
                                <select class="form-select" id="decision">
                                    <option value="">è¯·é€‰æ‹©å†³ç­–</option>
                                    <option value="hold">ç»§ç»­æŒæœ‰</option>
                                    <option value="sell_partial">éƒ¨åˆ†æ­¢ç›ˆ</option>
                                    <option value="sell_all">æ¸…ä»“</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å†³ç­–ç†ç”±</label>
                            <textarea class="form-control" id="reason" rows="2" placeholder="è¯·è¾“å…¥å†³ç­–ç†ç”±..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="save-review-btn"
                        onclick="saveReview()">ä¿å­˜å¤ç›˜</button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- ç´§æ€¥è¯­æ³•ä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
<script src="{{ url_for('static', filename='js/emergency-syntax-fix.js') }}"></script>

<!-- ç´§æ€¥ä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
<script src="{{ url_for('static', filename='js/review-emergency-fix.js') }}"></script>

<!-- å·¥å…·å‡½æ•°åº“ - æä¾›æ€§èƒ½ä¼˜åŒ–å·¥å…· -->
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>

<!-- æ€§èƒ½ä¼˜åŒ–å·¥å…· - æä¾›é«˜çº§ä¼˜åŒ–åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/performance-optimizations.js') }}"></script>

<!-- ç»Ÿä¸€æ¶ˆæ¯ç³»ç»Ÿ - å¿…é¡»åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰åŠ è½½ -->
<script src="{{ url_for('static', filename='js/unified-message-system.js') }}"></script>

<!-- APIå®¢æˆ·ç«¯ - å¿…é¡»åœ¨ä¿å­˜ç®¡ç†å™¨ä¹‹å‰åŠ è½½ -->
<script src="{{ url_for('static', filename='js/api.js') }}"></script>

<!-- å¤ç›˜ä¿å­˜ç®¡ç†å™¨ - ä¾èµ–APIå®¢æˆ·ç«¯ -->
<script src="{{ url_for('static', filename='js/review-save-manager.js') }}"></script>

<!-- è°ƒè¯•ç›‘æ§ç³»ç»Ÿ - æä¾›é”™è¯¯ç›‘æ§å’Œè°ƒè¯•æ”¯æŒ -->
<script src="{{ url_for('static', filename='js/debug-monitoring.js') }}"></script>
<script>
    // å¤‡ç”¨ ReviewSaveManager ç±»å®šä¹‰ - é˜²æ­¢å¤–éƒ¨æ–‡ä»¶åŠ è½½å¤±è´¥
    if (typeof ReviewSaveManager === 'undefined') {
        class ReviewSaveManager {
            constructor(formSelector = '#review-form') {
                this.form = document.querySelector(formSelector);
                this.hasUnsavedChanges = false;
                this.isSaving = false;
                this.originalFormData = {};
                this.saveButton = null;

                if (this.form) {
                    this.init();
                }
            }

            init() {
                this.setupFormElements();
                this.setupEventListeners();
                this.captureOriginalFormData();
                console.log('ReviewSaveManager (å¤‡ç”¨ç‰ˆæœ¬) åˆå§‹åŒ–å®Œæˆ');
            }

            setupFormElements() {
                this.saveButton = document.querySelector('#reviewModal .btn-primary[onclick*="saveReview"]') ||
                    document.querySelector('#reviewModal .modal-footer .btn-primary');

                if (this.saveButton) {
                    this.saveButton.removeAttribute('onclick');
                    this.saveButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.saveReview();
                    });
                }
            }

            setupEventListeners() {
                if (!this.form) return;

                const formElements = this.form.querySelectorAll('input, select, textarea');
                formElements.forEach(element => {
                    element.addEventListener('input', () => this.detectChanges());
                    element.addEventListener('change', () => this.detectChanges());
                });
            }

            detectChanges() {
                if (this.isSaving) return;

                const currentFormData = this.getCurrentFormData();
                const hasChanges = JSON.stringify(this.originalFormData) !== JSON.stringify(currentFormData);

                if (hasChanges !== this.hasUnsavedChanges) {
                    this.hasUnsavedChanges = hasChanges;
                    this.updateSaveButtonState();
                }
            }

            getCurrentFormData() {
                const formData = {};
                if (!this.form) return formData;

                const elements = this.form.querySelectorAll('input, select, textarea');
                elements.forEach(element => {
                    const name = element.name || element.id;
                    if (!name) return;

                    if (element.type === 'checkbox') {
                        formData[name] = element.checked;
                    } else if (element.type === 'radio') {
                        if (element.checked) {
                            formData[name] = element.value;
                        }
                    } else {
                        formData[name] = element.value;
                    }
                });

                return formData;
            }

            captureOriginalFormData() {
                this.originalFormData = this.getCurrentFormData();
                this.hasUnsavedChanges = false;
                this.updateSaveButtonState();
            }

            updateSaveButtonState() {
                if (!this.saveButton) return;

                if (this.isSaving) {
                    this.saveButton.disabled = true;
                    this.saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ä¿å­˜ä¸­...';
                } else if (this.hasUnsavedChanges) {
                    this.saveButton.disabled = false;
                    this.saveButton.innerHTML = 'ä¿å­˜å¤ç›˜';
                    this.saveButton.classList.remove('btn-outline-primary');
                    this.saveButton.classList.add('btn-primary');
                } else {
                    this.saveButton.disabled = true;
                    this.saveButton.innerHTML = 'å·²ä¿å­˜';
                    this.saveButton.classList.remove('btn-primary');
                    this.saveButton.classList.add('btn-outline-primary');
                }
            }

            async saveReview() {
                if (this.isSaving || !this.hasUnsavedChanges) return;

                this.isSaving = true;
                this.updateSaveButtonState();

                try {
                    const reviewData = this.collectReviewData();
                    const reviewId = document.getElementById('review-id')?.value || null;

                    if (typeof apiClient !== 'undefined' && apiClient.saveReview) {
                        const response = await apiClient.saveReview(reviewData, reviewId);

                        if (response.success) {
                            this.captureOriginalFormData();
                            if (typeof showSuccessMessage === 'function') {
                                showSuccessMessage('å¤ç›˜ä¿å­˜æˆåŠŸ');
                            }
                            if (typeof loadReviews === 'function') {
                                loadReviews();
                            }
                        } else {
                            throw new Error(response.error?.message || 'ä¿å­˜å¤±è´¥');
                        }
                    } else {
                        throw new Error('APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    }
                } catch (error) {
                    console.error('ä¿å­˜å¤ç›˜å¤±è´¥:', error);
                    if (typeof showErrorMessage === 'function') {
                        showErrorMessage('ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                } finally {
                    this.isSaving = false;
                    this.updateSaveButtonState();
                }
            }

            collectReviewData() {
                return {
                    stock_code: document.getElementById('review-stock-code')?.value || '',
                    review_date: document.getElementById('review-date')?.value || '',
                    holding_days: parseInt(document.getElementById('holding-days')?.value) || 0,
                    current_price: parseFloat(document.getElementById('current-price-input')?.value) || null,
                    price_up_score: document.getElementById('price-up-score')?.checked ? 1 : 0,
                    bbi_score: document.getElementById('bbi-score')?.checked ? 1 : 0,
                    volume_score: document.getElementById('volume-score')?.checked ? 1 : 0,
                    trend_score: document.getElementById('trend-score')?.checked ? 1 : 0,
                    j_score: document.getElementById('j-score')?.checked ? 1 : 0,
                    analysis: document.getElementById('analysis')?.value || '',
                    decision: document.getElementById('decision')?.value || '',
                    reason: document.getElementById('reason')?.value || ''
                };
            }
        }

        console.log('âœ… å¤‡ç”¨ ReviewSaveManager ç±»å·²å®šä¹‰');
    }

    // å…¨å±€APIå®¢æˆ·ç«¯å’Œä¿å­˜ç®¡ç†å™¨å®ä¾‹ - ä½¿ç”¨æ¡ä»¶å£°æ˜é¿å…é‡å¤
    if (typeof window.apiClient === 'undefined') {
        window.apiClient = null;
    }
    if (typeof window.reviewSaveManager === 'undefined') {
        window.reviewSaveManager = null;
    }

    // ä¾èµ–æ£€æŸ¥å‡½æ•° - å¢å¼ºç‰ˆæœ¬ï¼ŒåŒ…å«æ€§èƒ½ä¼˜åŒ–å·¥å…·å’Œè°ƒè¯•ç›‘æ§æ£€æŸ¥
    function checkDependencies() {
        console.log('ğŸ” æ£€æŸ¥JavaScriptä¾èµ–...');

        const dependencies = [
            { name: 'PerformanceUtils', check: () => typeof PerformanceUtils !== 'undefined', critical: false },
            { name: 'debounce', check: () => typeof debounce !== 'undefined', critical: true },
            { name: 'throttle', check: () => typeof throttle !== 'undefined', critical: true },
            { name: 'UnifiedMessageSystem', check: () => typeof UnifiedMessageSystem !== 'undefined', critical: true },
            { name: 'ApiClient', check: () => typeof ApiClient !== 'undefined', critical: true },
            { name: 'ReviewSaveManager', check: () => typeof ReviewSaveManager !== 'undefined', critical: true },
            { name: 'Bootstrap', check: () => typeof bootstrap !== 'undefined', critical: true },
            { name: 'DebugMonitoringSystem', check: () => typeof DebugMonitoringSystem !== 'undefined', critical: false },
            { name: 'debugTools', check: () => typeof debugTools !== 'undefined', critical: false },
            { name: 'logInitializationProgress', check: () => typeof logInitializationProgress === 'function', critical: false }
        ];

        const missing = dependencies.filter(dep => !dep.check());
        const criticalMissing = missing.filter(dep => dep.critical !== false);

        if (missing.length > 0) {
            const missingNames = missing.map(dep => dep.name).join(', ');
            console.error('âŒ ç¼ºå°‘ä¾èµ–:', missingNames);

            // åŒºåˆ†å…³é”®å’Œéå…³é”®ä¾èµ–
            if (criticalMissing.length > 0) {
                const criticalNames = criticalMissing.map(dep => dep.name).join(', ');
                console.error('ğŸš¨ å…³é”®ä¾èµ–ç¼ºå¤±:', criticalNames);

                // å¦‚æœæ¶ˆæ¯ç³»ç»Ÿå¯ç”¨ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨fallback
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage(`å…³é”®ä¾èµ–åŠ è½½å¤±è´¥: ${criticalNames}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`);
                } else {
                    alert(`å…³é”®ä¾èµ–åŠ è½½å¤±è´¥: ${criticalNames}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`);
                }
                return false;
            } else {
                // åªæœ‰éå…³é”®ä¾èµ–ç¼ºå¤±ï¼Œæ˜¾ç¤ºè­¦å‘Šä½†ç»§ç»­
                const nonCriticalNames = missing.map(dep => dep.name).join(', ');
                console.warn('âš ï¸ éå…³é”®ä¾èµ–ç¼ºå¤±:', nonCriticalNames);

                if (typeof showWarningMessage === 'function') {
                    showWarningMessage(`éƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™: ${nonCriticalNames}`);
                }
            }
        }

        console.log('âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ');
        return true;
    }

    // åˆå§‹åŒ–APIå®¢æˆ·ç«¯
    function initializeApiClient() {
        console.log('ğŸ”§ åˆå§‹åŒ–APIå®¢æˆ·ç«¯...');

        try {
            if (typeof ApiClient !== 'undefined') {
                // å¦‚æœå·²ç»å­˜åœ¨å®ä¾‹ï¼Œç›´æ¥ä½¿ç”¨
                if (window.apiClient && typeof window.apiClient.get === 'function') {
                    console.log('âœ… APIå®¢æˆ·ç«¯å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
                    return true;
                }
                window.apiClient = new ApiClient();
                console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } else {
                console.error('âŒ ApiClientç±»æœªæ‰¾åˆ°');
                showErrorMessage('APIå®¢æˆ·ç«¯åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return false;
            }
        } catch (error) {
            console.error('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
            showErrorMessage('APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            return false
        }
    }

    // åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨
    function initializeReviewSaveManager() {
        console.log('ğŸ”§ åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨...');

        try {
            if (typeof ReviewSaveManager !== 'undefined') {
                // å¦‚æœå·²ç»å­˜åœ¨å®ä¾‹ï¼Œç›´æ¥ä½¿ç”¨
                if (window.reviewSaveManager && typeof window.reviewSaveManager.saveReview === 'function') {
                    console.log('âœ… å¤ç›˜ä¿å­˜ç®¡ç†å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
                    return true;
                }
                window.reviewSaveManager = new ReviewSaveManager('#review-form');
                console.log('âœ… å¤ç›˜ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } else {
                console.error('âŒ ReviewSaveManagerç±»æœªæ‰¾åˆ°');
                showErrorMessage('ä¿å­˜ç®¡ç†å™¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return false;
            }
        } catch (error) {
            console.error('âŒ å¤ç›˜ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            showErrorMessage('ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            return false
        }
    }

    // æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•° - ä½¿ç”¨ç»Ÿä¸€æ¶ˆæ¯ç³»ç»Ÿ
    // è¿™äº›å‡½æ•°ç°åœ¨ç”±unified-message-system.jsæä¾›
    // ä¿ç•™è¿™é‡Œçš„æ³¨é‡Šä»¥ä¾¿ç†è§£æ¶ˆæ¯ç³»ç»Ÿçš„ä½¿ç”¨æ–¹å¼
    // showErrorMessage(message, options) - æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    // showSuccessMessage(message, options) - æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    // showWarningMessage(message, options) - æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
    // showInfoMessage(message, options) - æ˜¾ç¤ºä¿¡æ¯æ¶ˆæ¯
    // ç¤ºä¾‹ç”¨æ³•:
    // showErrorMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•')
    // showSuccessMessage('ä¿å­˜æˆåŠŸ', { position: 'toast' })
    // showWarningMessage('æ•°æ®å¯èƒ½ä¸å®Œæ•´', { duration: 4000 })
    // showInfoMessage('æ­£åœ¨åŠ è½½æ•°æ®...', { dismissible: false })

    // é¡µé¢åˆå§‹åŒ–ä¸»å‡½æ•° - å®ç°åˆ†æ­¥åˆå§‹åŒ–æµç¨‹ï¼ŒåŒ…å«é”™è¯¯å¤„ç†å’Œè¯¦ç»†æ—¥å¿—è®°å½•
    function initializeReviewPage() {
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–å¤ç›˜é¡µé¢');
        console.time('é¡µé¢åˆå§‹åŒ–è€—æ—¶');

        // è®°å½•åˆå§‹åŒ–å¼€å§‹
        if (typeof logInitializationProgress === 'function') {
            logInitializationProgress('å¤ç›˜é¡µé¢åˆå§‹åŒ–', 'start', {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            });
        }

        // å®šä¹‰åˆå§‹åŒ–æ­¥éª¤ï¼ŒæŒ‰ä¾èµ–é¡ºåºæ’åˆ—
        const initSteps = [
            {
                name: 'ä¾èµ–æ£€æŸ¥',
                fn: checkDependencies,
                critical: true, // å…³é”®æ­¥éª¤ï¼Œå¤±è´¥åˆ™åœæ­¢åç»­åˆå§‹åŒ–
                description: 'æ£€æŸ¥JavaScriptä¾èµ–æ˜¯å¦æ­£ç¡®åŠ è½½'
            },
            {
                name: 'APIå®¢æˆ·ç«¯åˆå§‹åŒ–',
                fn: initializeApiClient,
                critical: true,
                description: 'åˆå§‹åŒ–APIå®¢æˆ·ç«¯å®ä¾‹'
            },
            {
                name: 'ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–',
                fn: initializeReviewSaveManager,
                critical: true,
                description: 'åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨å®ä¾‹'
            },
            {
                name: 'äº‹ä»¶ç»‘å®š',
                fn: bindReviewEvents,
                critical: false,
                description: 'ç»‘å®šé¡µé¢äº‹ä»¶å¤„ç†å™¨'
            },
            {
                name: 'ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆ',
                fn: integrateReviewSaveStateManagement,
                critical: false,
                description: 'é›†æˆä¿å­˜çŠ¶æ€ç®¡ç†åŠŸèƒ½'
            },
            {
                name: 'æ•°æ®åŠ è½½',
                fn: loadAllData,
                critical: false,
                description: 'åŠ è½½é¡µé¢åˆå§‹æ•°æ®'
            }
        ];

        let successCount = 0;
        let criticalFailure = false;
        const results = [];

        // åˆ†æ­¥æ‰§è¡Œåˆå§‹åŒ–
        for (let i = 0; i < initSteps.length; i++) {
            const step = initSteps[i];
            const stepStartTime = performance.now();

            console.group(`ğŸ“‹ æ­¥éª¤ ${i + 1}/${initSteps.length}: ${step.name}`);
            console.log(`ğŸ“ æè¿°: ${step.description}`);
            console.log(`ğŸ”§ å¼€å§‹æ‰§è¡Œ...`);

            // è®°å½•æ­¥éª¤å¼€å§‹
            logInitializationProgress(step.name, 'start', {
                stepIndex: i + 1,
                totalSteps: initSteps.length,
                description: step.description,
                critical: step.critical
            });

            try {
                // æ‰§è¡Œåˆå§‹åŒ–æ­¥éª¤
                const result = step.fn();
                const stepEndTime = performance.now();
                const stepDuration = (stepEndTime - stepStartTime).toFixed(2);

                if (result === false) {
                    console.error(`âŒ ${step.name}å¤±è´¥`);
                    console.log(`â±ï¸ è€—æ—¶: ${stepDuration}ms`);

                    // è®°å½•æ­¥éª¤å¤±è´¥
                    logInitializationProgress(step.name, 'error', {
                        error: 'å‡½æ•°è¿”å›false',
                        duration: stepDuration,
                        critical: step.critical
                    });

                    results.push({
                        step: step.name,
                        success: false,
                        error: 'å‡½æ•°è¿”å›false',
                        duration: stepDuration,
                        critical: step.critical
                    });

                    if (step.critical) {
                        console.error(`ğŸš¨ å…³é”®æ­¥éª¤å¤±è´¥ï¼Œåœæ­¢åç»­åˆå§‹åŒ–`);
                        logInitializationProgress('åˆå§‹åŒ–æµç¨‹', 'error', {
                            reason: 'å…³é”®æ­¥éª¤å¤±è´¥',
                            failedStep: step.name
                        });
                        criticalFailure = true;
                        console.groupEnd();
                        break;
                    }
                } else {
                    console.log(`âœ… ${step.name}æˆåŠŸ`);
                    console.log(`â±ï¸ è€—æ—¶: ${stepDuration}ms`);
                    successCount++;

                    // è®°å½•æ­¥éª¤æˆåŠŸ
                    logInitializationProgress(step.name, 'success', {
                        duration: stepDuration,
                        critical: step.critical
                    });

                    results.push({
                        step: step.name,
                        success: true,
                        duration: stepDuration,
                        critical: step.critical
                    });
                }
            } catch (error) {
                const stepEndTime = performance.now();
                const stepDuration = (stepEndTime - stepStartTime).toFixed(2);

                console.error(`âŒ ${step.name}å¼‚å¸¸:`, error);
                console.log(`â±ï¸ è€—æ—¶: ${stepDuration}ms`);

                // è®°å½•æ­¥éª¤å¼‚å¸¸
                logInitializationProgress(step.name, 'error', {
                    error: error.message || error.toString(),
                    stack: error.stack,
                    duration: stepDuration,
                    critical: step.critical
                });

                results.push({
                    step: step.name,
                    success: false,
                    error: error.message || error.toString(),
                    duration: stepDuration,
                    critical: step.critical
                });

                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage(`${step.name}å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                if (step.critical) {
                    console.error(`ğŸš¨ å…³é”®æ­¥éª¤å¼‚å¸¸ï¼Œåœæ­¢åç»­åˆå§‹åŒ–`);
                    logInitializationProgress('åˆå§‹åŒ–æµç¨‹', 'error', {
                        reason: 'å…³é”®æ­¥éª¤å¼‚å¸¸',
                        failedStep: step.name,
                        error: error.message
                    });
                    criticalFailure = true;
                    console.groupEnd();
                    break;
                }
            }

            console.groupEnd();

            // åœ¨æ­¥éª¤ä¹‹é—´æ·»åŠ å°å»¶è¿Ÿï¼Œé¿å…é˜»å¡UI
            if (i < initSteps.length - 1) {
                setTimeout(() => { }, 10);
            }
        }

        console.timeEnd('é¡µé¢åˆå§‹åŒ–è€—æ—¶');

        // è®°å½•åˆå§‹åŒ–ç»“æœ
        console.group('ğŸ“Š åˆå§‹åŒ–ç»“æœæ±‡æ€»');
        console.table(results);
        console.log(`âœ… æˆåŠŸæ­¥éª¤: ${successCount}/${initSteps.length}`);
        console.log(`âŒ å¤±è´¥æ­¥éª¤: ${initSteps.length - successCount}/${initSteps.length}`);
        console.log(`ğŸš¨ å…³é”®å¤±è´¥: ${criticalFailure ? 'æ˜¯' : 'å¦'}`);
        console.groupEnd();

        // æ ¹æ®ç»“æœæ˜¾ç¤ºç›¸åº”æ¶ˆæ¯å¹¶è®°å½•æœ€ç»ˆçŠ¶æ€
        if (criticalFailure) {
            console.error('ğŸš¨ å¤ç›˜é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œå…³é”®åŠŸèƒ½æ— æ³•ä½¿ç”¨');

            logInitializationProgress('åˆå§‹åŒ–å®Œæˆ', 'error', {
                successCount,
                totalSteps: initSteps.length,
                criticalFailure: true,
                results,
            });

            if (typeof showErrorMessage === 'function') {
                showErrorMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
            return false;
        } else if (successCount === initSteps.length) {
            console.log('ğŸ‰ å¤ç›˜é¡µé¢åˆå§‹åŒ–å®Œå…¨æˆåŠŸ');

            logInitializationProgress('åˆå§‹åŒ–å®Œæˆ', 'success', {
                successCount,
                totalSteps: initSteps.length,
                criticalFailure: false,
                results,
            });

            if (typeof showSuccessMessage === 'function') {
                showSuccessMessage('å¤ç›˜é¡µé¢åˆå§‹åŒ–æˆåŠŸ');
            }

            // æ‰§è¡Œé›†æˆéªŒè¯ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é˜»å¡ï¼‰
            setTimeout(() => {
                if (typeof verifySaveStateManagementIntegration === 'function') {
                    verifySaveStateManagementIntegration()
                }
            }, 1000);

            return true;
        } else {
            console.warn('âš ï¸ å¤ç›˜é¡µé¢åˆå§‹åŒ–éƒ¨åˆ†æˆåŠŸï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨');

            logInitializationProgress('åˆå§‹åŒ–å®Œæˆ', 'warning', {
                successCount,
                totalSteps: initSteps.length,
                criticalFailure: false,
                results,
            });

            if (typeof showWarningMessage === 'function') {
                showWarningMessage(`é¡µé¢åˆå§‹åŒ–éƒ¨åˆ†æˆåŠŸ (${successCount}/${initSteps.length})ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™`);
            }
            return true; // éƒ¨åˆ†æˆåŠŸä»ç„¶è¿”å›trueï¼Œå…è®¸é¡µé¢ç»§ç»­ä½¿ç”¨
        }
    }

    // éªŒè¯JavaScriptæ–‡ä»¶åŠ è½½çŠ¶æ€ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    function verifyJavaScriptDependencies() {
        return checkDependencies()
    }

    // ç®€åŒ–çš„å¤ç›˜åˆ†æé¡µé¢ç®¡ç†
    let reviewModal = null;
    let currentHoldings = [];
    let currentReviews = [];

    // é¡µé¢åˆå§‹åŒ– - åœ¨DOMContentLoadedäº‹ä»¶ä¸­è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('ğŸŒŸ DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹å¤ç›˜é¡µé¢åˆå§‹åŒ–æµç¨‹');
        console.log('ğŸ“… åˆå§‹åŒ–æ—¶é—´:', new Date().toLocaleString('zh-CN'));
        console.log('ğŸŒ ç”¨æˆ·ä»£ç†:', navigator.userAgent);

        try {
            // æ‰§è¡Œä¸»åˆå§‹åŒ–æµç¨‹
            const initSuccess = initializeReviewPage();

            // åˆå§‹åŒ–Bootstrapæ¨¡æ€æ¡†ï¼ˆç‹¬ç«‹äºä¸»æµç¨‹ï¼‰
            initializeBootstrapModal()

            // è®°å½•åˆå§‹åŒ–å®Œæˆ
            console.log('ğŸ å¤ç›˜é¡µé¢åˆå§‹åŒ–æµç¨‹å®Œæˆ');
            console.log('ğŸ“Š åˆå§‹åŒ–ç»“æœ:', initSuccess ? 'æˆåŠŸ' : 'å¤±è´¥');

            // å¦‚æœåˆå§‹åŒ–æˆåŠŸï¼Œæ‰§è¡Œåç»­æ“ä½œ
            if (initSuccess) {
                console.log('ğŸ¯ å¼€å§‹æ‰§è¡Œåç»­åˆå§‹åŒ–æ“ä½œ');

                // å»¶è¿Ÿæ‰§è¡Œéå…³é”®æ“ä½œï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
                setTimeout(() => {
                    performPostInitializationTasks();
                }, 100);
            } else {
                console.error('ğŸš¨ åˆå§‹åŒ–å¤±è´¥ï¼Œé¡µé¢åŠŸèƒ½å¯èƒ½å—é™');
            }
        } catch (error) {
            console.error('ğŸš¨ é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿæœªæ•è·çš„å¼‚å¸¸:', error);
            if (typeof showErrorMessage === 'function') {
                showErrorMessage('é¡µé¢åˆå§‹åŒ–å¼‚å¸¸: ' + error.message);
            } else {
                alert('é¡µé¢åˆå§‹åŒ–å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
    });

    // åˆå§‹åŒ–Bootstrapæ¨¡æ€æ¡†
    function initializeBootstrapModal() {
        console.log('ğŸ”§ åˆå§‹åŒ–Bootstrapæ¨¡æ€æ¡†');

        const modalElement = document.getElementById('reviewModal');
        if (!modalElement) {
            console.warn('âš ï¸ å¤ç›˜æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
            return false;
        }

        try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                reviewModal = new bootstrap.Modal(modalElement);
                console.log('âœ… Bootstrapæ¨¡æ€æ¡†åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } else {
                console.error('âŒ Bootstrap Modalç±»æœªæ‰¾åˆ°');
                if (typeof showWarningMessage === 'function') {
                    showWarningMessage('Bootstrap ModalæœªåŠ è½½ï¼Œæ¨¡æ€æ¡†åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨');
                }
                return false;
            }
        } catch (error) {
            console.error('âŒ Bootstrapæ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥:', error);
            if (typeof showErrorMessage === 'function') {
                showErrorMessage('æ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥: ' + error.message)
            }
            return false;
        }
    }

    // æ‰§è¡Œåç»­åˆå§‹åŒ–ä»»åŠ¡
    function performPostInitializationTasks() {
        console.log('ğŸ¯ æ‰§è¡Œåç»­åˆå§‹åŒ–ä»»åŠ¡');

        const tasks = [
            {
                name: 'è®¾ç½®è‡ªåŠ¨åˆ·æ–°',
                fn: () => {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨åˆ·æ–°é€»è¾‘
                    console.log('â° è‡ªåŠ¨åˆ·æ–°è®¾ç½®å®Œæˆ');
                    return true;
                }
            },
            {
                name: 'æ³¨å†Œå…¨å±€é”™è¯¯å¤„ç†',
                fn: () => {
                    window.addEventListener('error', function (event) {
                        console.error('ğŸš¨ å…¨å±€JavaScripté”™è¯¯:', event.error);
                    });
                    window.addEventListener('unhandledrejection', function (event) {
                        console.error('ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                    });
                    console.log('ğŸ›¡ï¸ å…¨å±€é”™è¯¯å¤„ç†æ³¨å†Œå®Œæˆ');
                    return true;
                }
            },
            {
                name: 'æ€§èƒ½ç›‘æ§',
                fn: () => {
                    if ('performance' in window) {
                        const loadTime = performance.now();
                        console.log(`âš¡ é¡µé¢åŠ è½½æ€§èƒ½: ${loadTime.toFixed(2)}ms`);
                    }
                    return true;
                }
            }
        ];

        tasks.forEach(task => {
            try {
                task.fn();
                console.log(`âœ… ${task.name}å®Œæˆ`);
            } catch (error) {
                console.error(`âŒ ${task.name}å¤±è´¥:`, error);
            }
        });

        console.log('ğŸ‰ åç»­åˆå§‹åŒ–ä»»åŠ¡å®Œæˆ');
    }

    // ç»‘å®šå¤ç›˜é¡µé¢ç›¸å…³äº‹ä»¶
    function bindReviewEvents() {
        console.log('ğŸ”— ç»‘å®šå¤ç›˜é¡µé¢äº‹ä»¶');

        try {
            // ç»‘å®šè¯„åˆ†å¤é€‰æ¡†äº‹ä»¶
            bindScoreCheckboxes();

            // ç»‘å®šæµ®ç›ˆè®¡ç®—å™¨äº‹ä»¶
            bindFloatingProfitCalculator();

            // ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
            bindModalEvents();

            console.log('âœ… å¤ç›˜é¡µé¢äº‹ä»¶ç»‘å®šæˆåŠŸ');
            return true;
        } catch (error) {
            console.error('âŒ å¤ç›˜é¡µé¢äº‹ä»¶ç»‘å®šå¤±è´¥:', error);
            return false;
        }
    }

    function bindScoreCheckboxes() {
        console.log('ğŸ”— ç»‘å®šè¯„åˆ†å¤é€‰æ¡†äº‹ä»¶');

        const checkboxes = ['price-up-score', 'bbi-score', 'volume-score', 'trend-score', 'j-score'];
        let boundCount = 0;

        checkboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.addEventListener('change', calculateTotalScore);
                boundCount++;
            } else {
                console.warn(`âš ï¸ è¯„åˆ†å¤é€‰æ¡† ${id} æœªæ‰¾åˆ°`);
            }
        });

        console.log(`âœ… è¯„åˆ†å¤é€‰æ¡†äº‹ä»¶ç»‘å®šå®Œæˆ: ${boundCount}/${checkboxes.length}`);
        return boundCount > 0;
    }

    function bindFloatingProfitCalculator() {
        console.log('ğŸ”— ç»‘å®šæµ®ç›ˆè®¡ç®—å™¨äº‹ä»¶');

        const currentPriceInput = document.getElementById('current-price-input');
        if (currentPriceInput) {
            currentPriceInput.addEventListener('input', calculateFloatingProfit);
            console.log('âœ… æµ®ç›ˆè®¡ç®—å™¨äº‹ä»¶ç»‘å®šæˆåŠŸ');
            return true;
        } else {
            console.warn('âš ï¸ å½“å‰ä»·æ ¼è¾“å…¥æ¡†æœªæ‰¾åˆ°');
            return false;
        }
    }

    function bindModalEvents() {
        console.log('ğŸ”— ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶');

        const modalElement = document.getElementById('reviewModal');
        if (modalElement) {
            // ç»‘å®šæ¨¡æ€æ¡†æ˜¾ç¤ºäº‹ä»¶
            modalElement.addEventListener('shown.bs.modal', function () {
                console.log('ğŸ“‹ å¤ç›˜æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
                const firstInput = modalElement.querySelector('input:not([readonly]):not([type="hidden"])');
                if (firstInput) {
                    firstInput.focus();
                }
            });

            // ç»‘å®šæ¨¡æ€æ¡†éšè—äº‹ä»¶
            modalElement.addEventListener('hide.bs.modal', function (event) {
                console.log('ğŸ“‹ å¤ç›˜æ¨¡æ€æ¡†å‡†å¤‡éšè—');
                // è¿™é‡Œå¯ä»¥æ·»åŠ æœªä¿å­˜æ›´æ”¹çš„æ£€æŸ¥é€»è¾‘
                if (reviewSaveManager && reviewSaveManager.hasUnsavedChanges && reviewSaveManager.hasUnsavedChanges()) {
                    if (!confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ')) {
                        event.preventDefault();
                        return false;
                    }
                }
            });

            console.log('âœ… æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®šæˆåŠŸ');
            return true;
        } else {
            console.warn('âš ï¸ å¤ç›˜æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
            return false;
        }
    }

    // é›†æˆä¿å­˜çŠ¶æ€ç®¡ç†åŠŸèƒ½
    function integrateReviewSaveStateManagement() {
        console.log('ğŸ”— é›†æˆä¿å­˜çŠ¶æ€ç®¡ç†åŠŸèƒ½');

        try {
            if (!window.reviewSaveManager) {
                console.warn('âš ï¸ ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè·³è¿‡çŠ¶æ€ç®¡ç†é›†æˆ');
                return false;
            }

            // ç¡®ä¿ä¿å­˜ç®¡ç†å™¨å·²æ­£ç¡®ç»‘å®šåˆ°è¡¨å•
            const form = document.querySelector('#review-form');
            if (!form) {
                console.error('âŒ å¤ç›˜è¡¨å•æœªæ‰¾åˆ°');
                return false;
            }

            // éªŒè¯ä¿å­˜æŒ‰é’®çŠ¶æ€ç®¡ç†
            const saveBtn = document.querySelector('#save-review-btn');
            if (saveBtn) {
                console.log('âœ… ä¿å­˜æŒ‰é’®æ‰¾åˆ°ï¼ŒçŠ¶æ€ç®¡ç†å·²é›†æˆ');

                // ç¡®ä¿ä¿å­˜ç®¡ç†å™¨æ­£ç¡®ç»‘å®šåˆ°è¡¨å•å’ŒæŒ‰é’®
                if (window.reviewSaveManager.form !== form) {
                    console.log('ğŸ”§ é‡æ–°ç»‘å®šè¡¨å•åˆ°ä¿å­˜ç®¡ç†å™¨');
                    window.reviewSaveManager.form = form;
                }

                if (window.reviewSaveManager.saveButton !== saveBtn) {
                    console.log('ğŸ”§ é‡æ–°ç»‘å®šä¿å­˜æŒ‰é’®åˆ°ä¿å­˜ç®¡ç†å™¨');
                    window.reviewSaveManager.saveButton = saveBtn;
                }

            } else {
                console.warn('âš ï¸ ä¿å­˜æŒ‰é’®æœªæ‰¾åˆ°ï¼Œä½†ç»§ç»­æ‰§è¡Œ');
                // ä¸è¿”å›falseï¼Œå› ä¸ºæŒ‰é’®å¯èƒ½ç¨ååŠ¨æ€åˆ›å»º
            }

            // éªŒè¯ä¿å­˜ç®¡ç†å™¨çš„å…³é”®æ–¹æ³•
            if (typeof window.reviewSaveManager.saveReview === 'function') {
                console.log('âœ… ä¿å­˜ç®¡ç†å™¨æ–¹æ³•éªŒè¯é€šè¿‡');
            } else {
                console.error('âŒ ä¿å­˜ç®¡ç†å™¨ç¼ºå°‘å…³é”®æ–¹æ³•');
                return false;
            }

            console.log('âœ… ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆæˆåŠŸ');
            return true;
        } catch (error) {
            console.error('âŒ ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆå¤±è´¥:', error);
            return false;
        }
    }

    // åŠ è½½æ‰€æœ‰é¡µé¢æ•°æ®
    function loadAllData() {
        console.log('ğŸ“Š åŠ è½½é¡µé¢æ•°æ®');

        try {
            // åŠ è½½æŒä»“æ•°æ®
            if (typeof refreshHoldings === 'function') {
                refreshHoldings();
            } else {
                console.warn('âš ï¸ refreshHoldingså‡½æ•°æœªå®šä¹‰');
            }

            // åŠ è½½å¤ç›˜è®°å½•
            if (typeof loadReviews === 'function') {
                loadReviews();
            } else {
                console.warn('âš ï¸ loadReviewså‡½æ•°æœªå®šä¹‰');
            }

            console.log('âœ… æ•°æ®åŠ è½½å®Œæˆ');
            return true;
        } catch (error) {
            console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
            return false;
        }
    }

    // éªŒè¯ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆ
    function verifySaveStateManagementIntegration() {
        console.log('ğŸ” éªŒè¯ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆ');

        if (!reviewSaveManager) {
            console.error('âŒ ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            return false;
        }

        try {
            // æ£€æŸ¥ä¿å­˜ç®¡ç†å™¨çš„å…³é”®æ–¹æ³•
            constMethods = ['saveReview', 'hasUnsavedChanges'];
            const missingMethods =Methods.filter(method =>
                typeof reviewSaveManager[method] !== 'function'
            );

            if (missingMethods.length > 0) {
                console.error('âŒ ä¿å­˜ç®¡ç†å™¨ç¼ºå°‘æ–¹æ³•:', missingMethods);
                return false;
            }

            // æ£€æŸ¥è¡¨å•ç»‘å®š
            const form = document.querySelector('#review-form');
            if (!form) {
                console.error('âŒ å¤ç›˜è¡¨å•æœªæ‰¾åˆ°');
                return false;
            }

            console.log('âœ… ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆéªŒè¯é€šè¿‡');
            return true;
        } catch (error) {
            console.error('âŒ ä¿å­˜çŠ¶æ€ç®¡ç†é›†æˆéªŒè¯å¤±è´¥:', error);
            return false;
        }
    }

    function calculateTotalScore() {
        const checkboxes = ['price-up-score', 'bbi-score', 'volume-score', 'trend-score', 'j-score'];
        let total = 0;

        checkboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox && checkbox.checked) {
                total += parseInt(checkbox.value) || 0;
            }
        });

        const totalScoreElement = document.getElementById('total-score');
        if (totalScoreElement) {
            totalScoreElement.textContent = total;
        }

        return total;
    }

    function calculateFloatingProfit() {
        const currentPriceInput = document.getElementById('current-price-input');
        const buyPriceDisplay = document.getElementById('buy-price-display');
        const floatingProfitRatio = document.getElementById('floating-profit-ratio');
        const floatingProfitContainer = document.querySelector('.floating-profit-container');

        if (!currentPriceInput || !buyPriceDisplay || !floatingProfitRatio) {
            return;
        }

        const currentPrice = parseFloat(currentPriceInput.value);
        const buyPriceText = buyPriceDisplay.textContent.replace('Â¥', '').trim();
        const buyPrice = parseFloat(buyPriceText);

        if (isNaN(currentPrice) || isNaN(buyPrice) || buyPrice === 0) {
            floatingProfitRatio.textContent = '--';
            if (floatingProfitContainer) {
                floatingProfitContainer.className = 'floating-profit-container';
            }
            return;
        }

        const profitRatio = ((currentPrice - buyPrice) / buyPrice * 100);
        const profitRatioText = (profitRatio >= 0 ? '+' : '') + profitRatio.toFixed(2) + '%';

        floatingProfitRatio.textContent = profitRatioText;

        if (floatingProfitContainer) {
            if (profitRatio > 0) {
                floatingProfitContainer.className = 'floating-profit-container profit';
            } else if (profitRatio < 0) {
                floatingProfitContainer.className = 'floating-profit-container loss';
            } else {
                floatingProfitContainer.className = 'floating-profit-container neutral';
            }
        }
    }

    // æ›¿æ¢å ä½ç¬¦ä¿å­˜å‡½æ•° - ä½¿ç”¨ä¿å­˜ç®¡ç†å™¨
    function saveReview() {
        console.log('ğŸ”§ æ‰§è¡Œå¤ç›˜ä¿å­˜');

        // ä½¿ç”¨è°ƒè¯•ç›‘æ§è®°å½•ä¿å­˜æ“ä½œ
        if (typeof logInitializationProgress === 'function') {
            logInitializationProgress('å¤ç›˜ä¿å­˜', 'start', {
                timestamp: new Date().toISOString()
            });
        }

        // æ£€æŸ¥ä¿å­˜ç®¡ç†å™¨æ˜¯å¦å·²åˆå§‹åŒ–
        if (!reviewSaveManager) {
            console.error('âŒ ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–');
            const errorMsg = 'ä¿å­˜åŠŸèƒ½æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';

            if (typeof showErrorMessage === 'function') {
                showErrorMessage(errorMsg);
            } else {
                alert(errorMsg);
            }

            if (typeof logInitializationProgress === 'function') {
                logInitializationProgress('å¤ç›˜ä¿å­˜', 'error', {
                    error: 'ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–'
                });
            }
            return;
        }

        // æ£€æŸ¥APIå®¢æˆ·ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
        if (!apiClient) {
            console.error('âŒ APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            const errorMsg = 'ç½‘ç»œè¿æ¥æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';

            if (typeof showErrorMessage === 'function') {
                showErrorMessage(errorMsg);
            } else {
                alert(errorMsg);
            }

            if (typeof logInitializationProgress === 'function') {
                logInitializationProgress('å¤ç›˜ä¿å­˜', 'error', {
                    error: 'APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–'
                });
            }
            return;
        }

        try {
            // è°ƒç”¨ä¿å­˜ç®¡ç†å™¨çš„ä¿å­˜æ–¹æ³•
            reviewSaveManager.saveReview();

            if (typeof logInitializationProgress === 'function') {
                logInitializationProgress('å¤ç›˜ä¿å­˜', 'success', {
                    timestamp: new Date().toISOString()
                });
            }
        } catch (error) {
            console.error('âŒ å¤ç›˜ä¿å­˜å¼‚å¸¸:', error);

            const errorMsg = 'ä¿å­˜è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ' + error.message;
            if (typeof showErrorMessage === 'function') {
                showErrorMessage(errorMsg)
            } else {
                alert(errorMsg);
            }

            if (typeof logInitializationProgress === 'function') {
                logInitializationProgress('å¤ç›˜ä¿å­˜', 'error', {
                    error: error.message,
                    stack: error.stack
                });
            }
        }
    }

    // è°ƒè¯•å’Œæµ‹è¯•å‡½æ•°
    function testInitialization() {
        console.log('ğŸ§ª æµ‹è¯•åˆå§‹åŒ–çŠ¶æ€');

        const tests = [
            {
                name: 'APIå®¢æˆ·ç«¯',
                test: () => apiClient !== null && typeof apiClient.saveReview === 'function'
            },
            {
                name: 'ä¿å­˜ç®¡ç†å™¨',
                test: () => reviewSaveManager !== null && typeof reviewSaveManager.saveReview === 'function'
            },
            {
                name: 'è°ƒè¯•å·¥å…·',
                test: () => typeof debugTools !== 'undefined'
            },
            {
                name: 'æ¶ˆæ¯ç³»ç»Ÿ',
                test: () => typeof showErrorMessage === 'function'
            },
            {
                name: 'å¤ç›˜è¡¨å•',
                test: () => document.querySelector('#review-form') !== null
            },
            {
                name: 'ä¿å­˜æŒ‰é’®',
                test: () => document.querySelector('#save-review-btn') !== null
            }
        ];

        console.group('ğŸ§ª åˆå§‹åŒ–æµ‹è¯•ç»“æœ');
        tests.forEach(test => {
            const result = test.test();
            console.log(`${result ? 'âœ…' : 'âŒ'} ${test.name}: ${result ? 'é€šè¿‡' : 'å¤±è´¥'}`);
        });
        console.groupEnd();

        return tests.map(test => ({
            name: test.name,
            passed: test.test()
        }));
    }

    function diagnoseReviewPage() {
        console.log('ğŸ” è¯Šæ–­å¤ç›˜é¡µé¢çŠ¶æ€');

        const diagnosis = {
            timestamp: new Date().toISOString(),
            dependencies: checkDependencies(),
            initialization: testInitialization(),
            elements: {
                reviewModal: !!document.querySelector('#reviewModal'),
                reviewForm: !!document.querySelector('#review-form'),
                saveButton: !!document.querySelector('#save-review-btn'),
                holdingsList: !!document.querySelector('#holdings-list'),
                reviewsList: !!document.querySelector('#reviews-list')
            },
            globalObjects: {
                apiClient: !!apiClient,
                reviewSaveManager: !!reviewSaveManager,
                debugTools: typeof debugTools !== 'undefined',
                debugMonitor: typeof debugMonitor !== 'undefined'
            },
            performance: typeof measurePagePerformance === 'function' ? measurePagePerformance() : null
        };

        console.group('ğŸ” é¡µé¢è¯Šæ–­æŠ¥å‘Š');
        console.log('ä¾èµ–çŠ¶æ€:', diagnosis.dependencies);
        console.log('åˆå§‹åŒ–çŠ¶æ€:', diagnosis.initialization);
        console.log('DOMå…ƒç´ :', diagnosis.elements);
        console.log('å…¨å±€å¯¹è±¡:', diagnosis.globalObjects);
        if (diagnosis.performance) {
            console.log('æ€§èƒ½æŒ‡æ ‡:', diagnosis.performance);
        }
        console.groupEnd();

        return diagnosis;
    }

    // åˆå§‹åŒ–æ—¥å¿—ç®¡ç†
    const initializationLogs = [];

    function getInitializationLogs() {
        return initializationLogs;
    }

    function clearInitializationLogs() {
        initializationLogs.length = 0;
        console.log('ğŸ§¹ åˆå§‹åŒ–æ—¥å¿—å·²æ¸…ç†');
    }

    function exportInitializationLogs() {
        const data = {
            timestamp: new Date().toISOString(),
            logs: initializationLogs,
            diagnosis: diagnoseReviewPage()
        };

        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `review-page-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        link.click();

        console.log('ğŸ“ åˆå§‹åŒ–æ—¥å¿—å·²å¯¼å‡º');
    }

    function showInitializationReport() {
        const report = {
            timestamp: new Date().toISOString(),
            totalLogs: initializationLogs.length,
            errors: initializationLogs.filter(log => log.level === 'error').length,
            warnings: initializationLogs.filter(log => log.level === 'warn').length,
            recentLogs: initializationLogs.slice(-10)
        };

        const logs = initializationLogs.map(log => ({
            æ—¶é—´: new Date(log.timestamp).toLocaleTimeString(),
            çº§åˆ«: log.level,
            æ¶ˆæ¯: log.message.substring(0, 50) + (log.message.length > 50 ? '...' : '')
        }));
        let total = 0;
        checkboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox && checkbox.checked) {
                total += 1;
            }
        });
        const totalScoreEl = document.getElementById('total-score');
        if (totalScoreEl) {
            totalScoreEl.textContent = total;
        }
    }

    function calculateFloatingProfit() {
        console.log('ğŸ’° è®¡ç®—æµ®ç›ˆæ¯”ä¾‹');

        const currentPriceInput = document.getElementById('current-price-input');
        const buyPriceDisplay = document.getElementById('buy-price-display');
        const floatingProfitRatio = document.getElementById('floating-profit-ratio');
        const floatingProfitContainer = document.querySelector('.floating-profit-container');

        if (!currentPriceInput || !buyPriceDisplay || !floatingProfitRatio) {
            console.warn('âš ï¸ æµ®ç›ˆè®¡ç®—æ‰€éœ€å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }

        const currentPrice = parseFloat(currentPriceInput.value);
        const buyPriceText = buyPriceDisplay.textContent.replace('Â¥', '').replace('--', '');
        const buyPrice = parseFloat(buyPriceText);

        if (!currentPrice || !buyPrice || currentPrice <= 0 || buyPrice <= 0) {
            floatingProfitRatio.textContent = '--';
            if (floatingProfitContainer) {
                floatingProfitContainer.className = 'floating-profit-container neutral';
            }
            return;
        }

        const profitRatio = ((currentPrice - buyPrice) / buyPrice * 100);
        const profitRatioText = (profitRatio >= 0 ? '+' : '') + profitRatio.toFixed(2) + '%';

        floatingProfitRatio.textContent = profitRatioText;

        // æ›´æ–°æ ·å¼
        if (floatingProfitContainer) {
            if (profitRatio > 0) {
                floatingProfitContainer.className = 'floating-profit-container profit';
            } else if (profitRatio < 0) {
                floatingProfitContainer.className = 'floating-profit-container loss';
            } else {
                floatingProfitContainer.className = 'floating-profit-container neutral';
            }
        }

        console.log(`ğŸ’° æµ®ç›ˆè®¡ç®—å®Œæˆ: ${profitRatioText}`);
    }

    function loadAllData() {
        try {
            Promise.allSettled([
                loadHoldings(),
                loadReviews(),
                loadHoldingAlerts()
            ]);
        } catch (error) {
            console.error('åŠ è½½æ•°æ®æ—¶å‡ºé”™:', error);
        }
    }

    // é˜²æŠ–å˜é‡
    let loadHoldingsDebounceTimer = null;

    // æ›´æ–°å¿«é€Ÿå¤ç›˜é€‰é¡¹ - ç§»åˆ°è¿™é‡Œé¿å…è°ƒç”¨é¡ºåºé—®é¢˜
    function updateQuickReviewOptions(holdings) {
        const select = document.getElementById('quick-review-stock');
        if (!select) return;

        select.innerHTML = '<option value="">è¯·é€‰æ‹©æŒä»“è‚¡ç¥¨</option>';

        if (holdings && holdings.length > 0) {
            holdings.forEach(holding => {
                const option = document.createElement('option');
                option.value = holding.stock_code;
                option.textContent = `${holding.stock_code} - ${holding.stock_name || ''}`;
                select.appendChild(option);
            });
        }
    }

    function loadHoldings(forceRefreshPrices = false) {
        console.log('ğŸ“Š å¼€å§‹åŠ è½½æŒä»“æ•°æ®', forceRefreshPrices ? '(å¼ºåˆ¶åˆ·æ–°ä»·æ ¼)' : '');

        // é˜²æŠ–æœºåˆ¶ï¼šå¦‚æœæ­£åœ¨åŠ è½½ï¼Œåˆ™å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
        if (loadHoldingsDebounceTimer) {
            clearTimeout(loadHoldingsDebounceTimer);
        }

        // å¦‚æœæ­£åœ¨åˆ·æ–°ï¼Œç›´æ¥è¿”å›
        if (window.isRefreshing && forceRefreshPrices) {
            console.log('â¸ï¸ ä»·æ ¼åˆ·æ–°æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡è¯·æ±‚');
            return;
        }

        const holdingsList = document.getElementById('holdings-list');

        if (!holdingsList) {
            console.error('æŒä»“åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');
            return;
        }

        try {
            holdingsList.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                ${forceRefreshPrices ? 'æ­£åœ¨åˆ·æ–°ä»·æ ¼æ•°æ®...' : 'æ­£åœ¨åŠ è½½æŒä»“æ•°æ®...'}
            </div>
        `;

            const url = forceRefreshPrices ? '/api/holdings?force_refresh=true&include_actual_days=true' : '/api/holdings?include_actual_days=true';
            fetch(url).then(response => response.json()).then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    currentHoldings = data.data;
                    displayHoldings(data.data);
                    updateQuickReviewOptions(data.data);

                    // æ›´æ–°ä»·æ ¼æ›´æ–°æ—¶é—´
                    updatePriceUpdateTime(forceRefreshPrices);
                } else {
                    showEmptyHoldings();
                }
            }).catch(error => {
                console.error('åŠ è½½æŒä»“æ•°æ®å¤±è´¥:', error);
                showHoldingsError(error.message);
            });
        } catch (error) {
            console.error('åŠ è½½æŒä»“æ•°æ®å¤±è´¥:', error);
            showHoldingsError(error.message);
        }
    }


    function displayHoldings(holdings) {
        const holdingsList = document.getElementById('holdings-list');
        if (!holdingsList) return;

        if (!holdings || holdings.length === 0) {
            showEmptyHoldings();
            return;
        }

        const holdingsHtml = holdings.map(holding => `
        <div class="holding-item card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 col-sm-4">
                        <div class="fw-bold">${holding.stock_code}</div>
                        <div class="text-muted small">${holding.stock_name || '--'}</div>
                    </div>
                    <div class="col-md-3 col-sm-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-muted me-2">æˆæœ¬ä»·</span>
                            <span class="fw-bold">Â¥${holding.avg_buy_price ? holding.avg_buy_price.toFixed(2) : (holding.avg_price ? holding.avg_price.toFixed(2) : '--')}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-muted me-2">å½“å‰ä»·</span>
                            <span class="fw-bold">Â¥${holding.current_price ? holding.current_price.toFixed(2) : '--'}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted me-2">æŒä»“é‡</span>
                            <span class="fw-bold">${holding.current_quantity || holding.total_quantity || 0}</span>
                        </div>
                        <div class="small text-muted text-end mt-1">${getPriceUpdateTime()}</div>
                    </div>
                    <div class="col-md-2 col-sm-4">
                        <div class="small text-muted">æŒä»“å¤©æ•°</div>
                        <div class="holding-days-display fw-bold text-info" title="${getHoldingDaysTooltip(holding)}">
                            ${getHoldingDaysDisplay(holding)}
                        </div>
                        <div class="small text-muted">ä»…äº¤æ˜“æ—¥</div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div class="small text-muted">æµ®ç›ˆæ¯”ä¾‹</div>
                        <div class="fw-bold ${getProfitClass(holding)}">${calculateProfitRatio(holding)}</div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <button class="btn btn-primary btn-sm w-100" onclick="openReviewModal('${holding.stock_code}')">
                            <i class="fas fa-chart-line"></i> å¤ç›˜åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

        holdingsList.innerHTML = holdingsHtml;
    }

    function calculateProfitRatio(holding) {
        if (!holding.avg_buy_price || !holding.current_price) {
            return '--';
        }
        const ratio = ((holding.current_price - holding.avg_buy_price) / holding.avg_buy_price * 100).toFixed(2);
        return ratio + '%';
    }

    function getProfitClass(holding) {
        if (!holding.avg_buy_price || !holding.current_price) {
            return 'text-muted';
        }
        const ratio = (holding.current_price - holding.avg_buy_price) / holding.avg_buy_price;
        return ratio > 0 ? 'text-danger' : ratio < 0 ? 'text-success' : 'text-muted';
    }

    function getPriceUpdateTime() {
        const now = new Date();
        return now.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function getHoldingDaysDisplay(holding) {
        // ä¼˜å…ˆæ˜¾ç¤ºå®é™…äº¤æ˜“æ—¥æ•°
        const actualDays = holding.actual_holding_days || holding.holding_days || 0;
        return `${actualDays} å¤©`;
    }

    function getHoldingDaysTooltip(holding) {
        const actualDays = holding.actual_holding_days || holding.holding_days || 0;
        const firstBuyDate = holding.first_buy_date ? new Date(holding.first_buy_date).toLocaleDateString('zh-CN') : '--';
        return `å®é™…æŒä»“ ${actualDays} ä¸ªäº¤æ˜“æ—¥ï¼ˆä¸å«å‘¨æœ«åŠèŠ‚å‡æ—¥ï¼‰\né¦–æ¬¡ä¹°å…¥: ${firstBuyDate}`;
    }

    function updatePriceUpdateTime(wasForceRefresh = false) {
        const statusEl = document.getElementById('last-price-update');
        if (statusEl) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            statusEl.textContent = timeStr;

            // å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ ‡è¯†
            if (wasForceRefresh) {
                statusEl.parentElement.innerHTML = `
                <i class="fas fa-sync-alt text-success"></i> 
                ä»·æ ¼å·²åˆ·æ–°: <span class="text-success">${timeStr}</span>
            `;

                // 3ç§’åæ¢å¤æ­£å¸¸æ˜¾ç¤º
                setTimeout(() => {
                    statusEl.parentElement.innerHTML = `
                    <i class="fas fa-clock"></i> 
                    ä»·æ ¼æ›´æ–°æ—¶é—´: <span id="last-price-update">${timeStr}</span>
                `;
                }, 3000);
            }
        }
    }

    function showEmptyHoldings() {
        const holdingsList = document.getElementById('holdings-list');
        if (holdingsList) {
            holdingsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-briefcase fa-3x mb-3 text-muted"></i>
                <div class="h5 mb-2">æš‚æ— æŒä»“æ•°æ®</div>
                <p class="mb-3">æ‚¨å½“å‰æ²¡æœ‰æŒä»“è‚¡ç¥¨</p>
                <a href="/trading-records" class="btn btn-outline-primary">
                    <i class="fas fa-plus"></i> æ·»åŠ äº¤æ˜“è®°å½•
                </a>
            </div>
        `;
        }
    }

    function showHoldingsError(message) {
        const holdingsList = document.getElementById('holdings-list');
        if (holdingsList) {
            holdingsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <div class="h5 mb-2">åŠ è½½å¤±è´¥</div>
                <p class="mb-3">${message}</p>
                <button class="btn btn-outline-primary" onclick="loadHoldings()">
                    <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                </button>
            </div>
        `;
        }
    }

    // åŠ è½½å¤ç›˜è®°å½• - æœ€ç»ˆä¿®å¤ç‰ˆ
    function loadReviews() {
        console.log('[DEBUG] å¼€å§‹åŠ è½½å¤ç›˜è®°å½•...');

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const reviewsList = document.getElementById('reviews-list');
            if (reviewsList) {
                reviewsList.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½å¤ç›˜è®°å½•...</p>
                </div>
            `;
            }

            fetch('/api/reviews').then(response => {
                console.log('[DEBUG] APIå“åº”çŠ¶æ€:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return response.json();
            }).then(data => {
                console.log('[DEBUG] å¤ç›˜è®°å½•åŸå§‹æ•°æ®:', data);

                if (data.success && data.data && data.data.reviews) {
                    const reviews = data.data.reviews;
                    console.log('[DEBUG] æ‰¾åˆ°å¤ç›˜è®°å½•:', reviews.length, 'æ¡');

                    if (reviews.length > 0) {
                        displayReviews(reviews);
                        console.log(`[DEBUG] æˆåŠŸæ˜¾ç¤º ${reviews.length} æ¡å¤ç›˜è®°å½•`);
                    } else {
                        if (reviewsList) {
                            reviewsList.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-clipboard-list fa-3x mb-3 opacity-50"></i>
                            <h5>æš‚æ— å¤ç›˜è®°å½•</h5>
                            <p class="mb-3">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¤ç›˜åˆ†æ</p>
                            <button class="btn btn-primary btn-sm" onclick="openReviewModal()">
                                <i class="fas fa-plus"></i> åˆ›å»ºå¤ç›˜è®°å½•
                            </button>
                        </div>
                    `;
                        }
                        console.log('[DEBUG] å¤ç›˜è®°å½•æ•°ç»„ä¸ºç©º');
                    }
                } else {
                    throw new Error(data.message || 'è·å–å¤ç›˜è®°å½•å¤±è´¥');
                }
            }).catch(error => {
                console.error('[ERROR] åŠ è½½å¤ç›˜è®°å½•å¤±è´¥:', error);

                const reviewsList = document.getElementById('reviews-list');
                if (reviewsList) {
                    reviewsList.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h6>åŠ è½½å¤ç›˜è®°å½•å¤±è´¥</h6>
                    <p class="mb-3">${error.message}</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadReviews()">
                        <i class="fas fa-redo"></i> é‡è¯•
                    </button>
                </div>
            `;
                }

                // æ˜¾ç¤ºé”™è¯¯æç¤º
                if (typeof window.showError === 'function') {
                    window.showError('åŠ è½½å¤ç›˜è®°å½•å¤±è´¥', error.message);
                }
            });
        } catch (error) {
            console.error('åŠ è½½å¤ç›˜è®°å½•å¤±è´¥:', error);
            showReviewsError(error.message);
        }
    }

    function displayReviews(reviews) {
        console.log('[DEBUG] displayReviews æ¥æ”¶åˆ°çš„æ•°æ®:', reviews);

        const container = document.getElementById('reviews-list');
        if (!container) {
            console.error('[ERROR] æ‰¾ä¸åˆ°reviews-listå®¹å™¨');
            return;
        }

        if (!reviews || reviews.length === 0) {
            container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-clipboard-list fa-2x mb-3 opacity-50"></i>
                <p>æš‚æ— å¤ç›˜è®°å½•</p>
                <small class="text-muted">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¤ç›˜åˆ†æ</small>
            </div>
        `;
            return;
        }

        // ç”Ÿæˆå¤ç›˜è®°å½•HTML
        const reviewsHtml = reviews.map(review => {
            const profitDisplay = review.floating_profit_display || {};
            const profitColor = profitDisplay.color || 'text-muted';
            const profitText = profitDisplay.display || 'æ— æ•°æ®';

            return `
            <div class="card mb-3 review-item" data-review-id="${review.id}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="card-title mb-1">
                                <strong>${review.stock_code}</strong>
                            </h6>
                            <small class="text-muted">${review.review_date}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-primary">${review.decision || 'æœªè®¾ç½®'}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æŒä»“å¤©æ•°</small><br>
                            <strong>${review.holding_days || 0}å¤©</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æµ®ç›ˆ</small><br>
                            <strong class="${profitColor}">${profitText}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æ€»åˆ†</small><br>
                            <strong>${review.total_score || 0}/25</strong>
                        </div>
                        <div class="col-md-1">
                            <div class="btn-group-vertical btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="editReview(${review.id})" title="ç¼–è¾‘">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteReview(${review.id})" title="åˆ é™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    ${review.analysis ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">åˆ†æ:</small>
                                <p class="mb-0 small">${review.analysis}</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        }).join('');

        container.innerHTML = reviewsHtml;
        console.log('[DEBUG] å¤ç›˜è®°å½•HTMLå·²ç”Ÿæˆå¹¶æ’å…¥åˆ°é¡µé¢');
    }

    // ç¼–è¾‘å¤ç›˜è®°å½•å‡½æ•°
    window.editReview = function (reviewId) {
        console.log('ç¼–è¾‘å¤ç›˜è®°å½•:', reviewId);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (typeof showInfoMessage === 'function') {
            showInfoMessage('æ­£åœ¨åŠ è½½å¤ç›˜è®°å½•...', { duration: 2000 });
        }

        // ä½¿ç”¨fetch APIè·å–å¤ç›˜è®°å½•æ•°æ®
        fetch(`/api/reviews/${reviewId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data) {
                    const review = data.data;

                    // å¡«å……è¡¨å•æ•°æ®
                    document.getElementById('review-id').value = reviewId;
                    document.getElementById('review-stock-code').value = review.stock_code || '';
                    document.getElementById('display-stock-code').value = review.stock_code || '';
                    document.getElementById('review-date').value = review.review_date || '';
                    document.getElementById('holding-days').value = review.holding_days || '';
                    document.getElementById('current-price-input').value = review.current_price || '';
                    document.getElementById('analysis').value = review.analysis || '';
                    document.getElementById('decision').value = review.decision || '';
                    document.getElementById('reason').value = review.reason || '';

                    // è®¾ç½®è¯„åˆ†å¤é€‰æ¡†
                    document.getElementById('price-up-score').checked = review.price_up_score === 1;
                    document.getElementById('bbi-score').checked = review.bbi_score === 1;
                    document.getElementById('volume-score').checked = review.volume_score === 1;
                    document.getElementById('trend-score').checked = review.trend_score === 1;
                    document.getElementById('j-score').checked = review.j_score === 1;

                    // è®¡ç®—æ€»åˆ†
                    if (typeof calculateTotalScore === 'function') {
                        calculateTotalScore();
                    }

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    const modal = document.getElementById('reviewModal');
                    if (modal) {
                        const bsModal = new bootstrap.Modal(modal);
                        bsModal.show();
                    }

                    if (typeof showSuccessMessage === 'function') {
                        showSuccessMessage('å¤ç›˜è®°å½•åŠ è½½æˆåŠŸ');
                    }
                } else {
                    throw new Error(data.error?.message || data.message || 'è·å–å¤ç›˜è®°å½•å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('è·å–å¤ç›˜è®°å½•å¤±è´¥:', error);
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage('è·å–å¤ç›˜è®°å½•å¤±è´¥: ' + error.message);
                } else {
                    alert('è·å–å¤ç›˜è®°å½•å¤±è´¥: ' + error.message);
                }
            });
    };

    // åˆ é™¤å¤ç›˜è®°å½•å‡½æ•°
    window.deleteReview = function (reviewId) {
        console.log('åˆ é™¤å¤ç›˜è®°å½•:', reviewId);

        // ç¡®è®¤åˆ é™¤
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤ç›˜è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (typeof showInfoMessage === 'function') {
            showInfoMessage('æ­£åœ¨åˆ é™¤å¤ç›˜è®°å½•...', { duration: 2000 });
        }

        // ä½¿ç”¨fetch APIåˆ é™¤å¤ç›˜è®°å½•
        fetch(`/api/reviews/${reviewId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (typeof showSuccessMessage === 'function') {
                        showSuccessMessage('å¤ç›˜è®°å½•åˆ é™¤æˆåŠŸ');
                    }

                    // é‡æ–°åŠ è½½å¤ç›˜è®°å½•åˆ—è¡¨
                    if (typeof loadReviews === 'function') {
                        setTimeout(() => {
                            loadReviews();
                        }, 500);
                    }
                } else {
                    throw new Error(data.error?.message || data.message || 'åˆ é™¤å¤ç›˜è®°å½•å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤ç›˜è®°å½•å¤±è´¥:', error);
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage('åˆ é™¤å¤ç›˜è®°å½•å¤±è´¥: ' + error.message);
                } else {
                    alert('åˆ é™¤å¤ç›˜è®°å½•å¤±è´¥: ' + error.message);
                }
            });
    };

    function showEmptyReviews() {
        const reviewsList = document.getElementById('reviews-list');
        if (reviewsList) {
            reviewsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-journal-whills fa-3x mb-3 text-muted"></i>
                <div class="h5 mb-2">æš‚æ— å¤ç›˜è®°å½•</div>
                <p class="mb-3">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¤ç›˜åˆ†æ</p>
            </div>
        `;
        }
    }

    function showReviewsError(message) {
        const reviewsList = document.getElementById('reviews-list');
        if (reviewsList) {
            reviewsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <div class="h5 mb-2">åŠ è½½å¤±è´¥</div>
                <p class="mb-3">${message}</p>
                <button class="btn btn-outline-primary" onclick="loadReviews()">
                    <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                </button>
            </div>
        `;
        }
    }

    function loadHoldingAlerts() {
        console.log('ğŸ”” å¼€å§‹åŠ è½½æŒä»“æé†’');
        const holdingAlerts = document.getElementById('holding-alerts');

        if (!holdingAlerts) return;

        try {
            holdingAlerts.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                æ­£åœ¨åŠ è½½æé†’...
            </div>
        `;

            fetch('/api/holdings/alerts').then(response => {
                return response.json();
            }).then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    displayHoldingAlerts(data.data);
                } else {
                    showEmptyAlerts();
                }
            }).catch(error => {
                console.error('åŠ è½½æŒä»“æé†’å¤±è´¥:', error);
                showAlertsError(error.message);
            });
        } catch (error) {
            console.error('åŠ è½½æŒä»“æé†’å¤±è´¥:', error);
            showAlertsError(error.message);
        }

        function displayHoldingAlerts(alerts) {
            const holdingAlerts = document.getElementById('holding-alerts');
            if (!holdingAlerts) return;

            const alertsHtml = alerts.map(alert => `
        <div class="alert alert-${alert.type || 'info'} alert-dismissible fade show">
            <div class="d-flex align-items-center">
                <i class="fas fa-bell me-2"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${alert.stock_code}</div>
                    <div class="small">${alert.message}</div>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `).join('');

            holdingAlerts.innerHTML = alertsHtml;
        }

        function showEmptyAlerts() {
            const holdingAlerts = document.getElementById('holding-alerts');
            if (holdingAlerts) {
                holdingAlerts.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <div class="h5 mb-2">æš‚æ— æé†’</div>
                <p class="mb-0">å½“å‰æŒä»“çŠ¶æ€è‰¯å¥½</p>
            </div>
        `;
            }
        }

        function showAlertsError(message) {
            const holdingAlerts = document.getElementById('holding-alerts');
            if (holdingAlerts) {
                holdingAlerts.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <div class="h5 mb-2">åŠ è½½å¤±è´¥</div>
                <p class="mb-3">${message}</p>
                <button class="btn btn-outline-primary" onclick="loadHoldingAlerts()">
                    <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                </button>
            </div>
        `;
            }
        }



        function getDecisionText(decision) {
            const decisions = {
                'hold': 'ç»§ç»­æŒæœ‰',
                'sell_partial': 'éƒ¨åˆ†æ­¢ç›ˆ',
                'sell_all': 'æ¸…ä»“',
                '': '--'
            };
            return decisions[decision] || decision || '--';
        }
    } // Close loadHoldingAlerts function

    // å…¨å±€å˜é‡
    let autoRefreshInterval = null;
    let isAutoRefreshEnabled = false;

    // å…¨å±€å‡½æ•°
    function refreshHoldings() {
        console.log('åˆ·æ–°æŒä»“æ•°æ®');
        loadHoldings();
    }

    // ä»·æ ¼åˆ·æ–°è¿›åº¦æ˜¾ç¤ºå‡½æ•°
    function showPriceRefreshProgress(message) {
        const holdingsList = document.getElementById('holdings-list');
        if (holdingsList) {
            holdingsList.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary me-2" role="status"></div>
                <div class="fw-bold text-primary" id="price-refresh-message">${message}</div>
                <div class="small text-muted mt-2">ä½¿ç”¨æ‰¹é‡ä¼˜åŒ–ç®—æ³•ï¼Œé€Ÿåº¦æ›´å¿«</div>
            </div>
        `;
        }
    }

    function updatePriceRefreshProgress(message) {
        const messageElement = document.getElementById('price-refresh-message');
        if (messageElement) {
            messageElement.textContent = message;
        }
    }

    function hidePriceRefreshProgress() {
        // è¿›åº¦éšè—ç”±loadHoldingså‡½æ•°å¤„ç†
    }

    function refreshHoldingsWithPrices() {
        console.log('ğŸ”„ å¼€å§‹æ‰¹é‡åˆ·æ–°æŒä»“ä»·æ ¼...');

        if (window.isRefreshing) {
            console.log('â¸ï¸ ä»·æ ¼åˆ·æ–°æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡è¯·æ±‚');
            return;
        }

        window.isRefreshing = true;

        try {
            // æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨
            showPriceRefreshProgress('æ­£åœ¨è·å–æŒä»“åˆ—è¡¨...');

            // å…ˆè·å–æŒä»“åˆ—è¡¨ï¼ˆä¸åˆ·æ–°ä»·æ ¼ï¼‰
            fetch('/api/holdings')
                .then(response => response.json())
                .then(holdingsData => {
                    if (holdingsData.success && holdingsData.data.length > 0) {
                        const stockCodes = holdingsData.data.map(h => h.stock_code);

                        updatePriceRefreshProgress(`æ­£åœ¨åˆ·æ–° ${stockCodes.length} åªè‚¡ç¥¨ä»·æ ¼...`);

                        // ä½¿ç”¨æ‰¹é‡åˆ·æ–°æ¥å£
                        return fetch('/api/holdings/refresh-prices', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                stock_codes: stockCodes,
                                force_refresh: true
                            })
                        });
                    } else {
                        updatePriceRefreshProgress('æ²¡æœ‰æŒä»“æ•°æ®éœ€è¦åˆ·æ–°');
                        setTimeout(() => {
                            hidePriceRefreshProgress();
                        }, 2000);
                        return null;
                    }
                })
                .then(response => {
                    if (!response) return null;
                    return response.json();
                })
                .then(refreshResult => {
                    if (!refreshResult) return;

                    if (refreshResult.success) {
                        const { success_count, failed_count, performance } = refreshResult.data;
                        updatePriceRefreshProgress(
                            `ä»·æ ¼åˆ·æ–°å®Œæˆ: ${success_count}/${refreshResult.data.total || success_count} æˆåŠŸ ` +
                            `(è€—æ—¶ ${performance.total_time.toFixed(1)}s)`
                        );

                        // é‡æ–°åŠ è½½æŒä»“æ•°æ®ï¼ˆå¸¦æœ€æ–°ä»·æ ¼ï¼‰
                        setTimeout(() => {
                            loadHoldings(false); // ä¸å†å¼ºåˆ¶åˆ·æ–°ï¼Œå› ä¸ºå·²ç»åˆ·æ–°è¿‡äº†
                            hidePriceRefreshProgress();
                        }, 1000);

                    } else {
                        throw new Error(refreshResult.message || 'æ‰¹é‡ä»·æ ¼åˆ·æ–°å¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡ä»·æ ¼åˆ·æ–°å¤±è´¥:', error);
                    updatePriceRefreshProgress('ä»·æ ¼åˆ·æ–°å¤±è´¥: ' + error.message);
                    setTimeout(() => {
                        hidePriceRefreshProgress();
                    }, 3000);
                })
                .finally(() => {
                    window.isRefreshing = false;
                });

        } catch (error) {
            console.error('æ‰¹é‡ä»·æ ¼åˆ·æ–°å¤±è´¥:', error);
            updatePriceRefreshProgress('ä»·æ ¼åˆ·æ–°å¤±è´¥: ' + error.message);
            setTimeout(() => {
                hidePriceRefreshProgress();
            }, 3000);
            window.isRefreshing = false;
        }
    }

    function toggleAutoRefresh() {
        const btn = document.getElementById('auto-refresh-btn');

        if (isAutoRefreshEnabled) {
            // åœæ­¢è‡ªåŠ¨åˆ·æ–°
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            isAutoRefreshEnabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i> è‡ªåŠ¨åˆ·æ–°';
            btn.className = 'btn btn-sm btn-outline-info';
            console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
        } else {
            // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
            isAutoRefreshEnabled = true;
            btn.innerHTML = '<i class="fas fa-pause"></i> åœæ­¢åˆ·æ–°';
            btn.className = 'btn btn-sm btn-warning';

            // æ¯60ç§’åˆ·æ–°ä¸€æ¬¡ä»·æ ¼ï¼ˆé™ä½é¢‘ç‡ï¼‰
            autoRefreshInterval = setInterval(() => {
                console.log('è‡ªåŠ¨åˆ·æ–°ä»·æ ¼...');
                // ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é‡å¤è°ƒç”¨
                if (!window.isRefreshing) {
                    window.isRefreshing = true;
                    loadHoldings(true).finally(() => {
                        window.isRefreshing = false;
                    });
                }
            }, 60000); // 60ç§’
            console.log('è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œæ¯60ç§’åˆ·æ–°ä¸€æ¬¡');
        }
    }

    function openQuickReview() {
        const select = document.getElementById('quick-review-stock');
        if (!select || !select.value) {
            alert('è¯·å…ˆé€‰æ‹©è‚¡ç¥¨');
            return;
        }
        openReviewModal(select.value);
    }

    function openReviewModal(stockCode) {
        console.log('ğŸ”§ æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†:', stockCode);

        if (!reviewModal) {
            console.error('âŒ å¤ç›˜æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
            if (typeof showErrorMessage === 'function') {
                showErrorMessage('å¤ç›˜æ¨¡æ€æ¡†æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            } else {
                alert('å¤ç›˜æ¨¡æ€æ¡†æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
            return;
        }

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (typeof showInfoMessage === 'function') {
                showInfoMessage('æ­£åœ¨åŠ è½½å¤ç›˜æ•°æ®...', {
                    position: 'toast',
                    duration: 1000
                });
            }

            // é‡ç½®è¡¨å•
            const form = document.getElementById('review-form');
            if (form) {
                form.reset();
                console.log('âœ… è¡¨å•å·²é‡ç½®');
            }

            // è®¾ç½®è‚¡ç¥¨ä»£ç 
            const stockCodeInput = document.getElementById('review-stock-code');
            const displayStockCode = document.getElementById('display-stock-code');

            if (stockCodeInput) {
                stockCodeInput.value = stockCode;
                console.log('âœ… å·²è®¾ç½®è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†:', stockCode);
            }
            if (displayStockCode) {
                displayStockCode.value = stockCode;
                console.log('âœ… å·²è®¾ç½®è‚¡ç¥¨ä»£ç æ˜¾ç¤ºæ¡†:', stockCode);
            }

            // è®¾ç½®å½“å‰æ—¥æœŸ
            const reviewDate = document.getElementById('review-date');
            const currentDate = new Date().toISOString().split('T')[0];
            if (reviewDate) {
                reviewDate.value = currentDate;
                console.log('âœ… å·²è®¾ç½®å¤ç›˜æ—¥æœŸ:', currentDate);
            }

            // å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¤ç›˜è®°å½•ï¼ˆè¿™æ˜¯å…³é”®æ­¥éª¤ï¼‰
            console.log('ğŸ” å¼€å§‹æ£€æŸ¥ç°æœ‰å¤ç›˜è®°å½•...');
            checkAndLoadExistingReview(stockCode, currentDate);

            // æŸ¥æ‰¾æŒä»“ä¿¡æ¯å¹¶å¡«å……æ•°æ®ï¼ˆåªåœ¨æ²¡æœ‰ç°æœ‰è®°å½•æ—¶å¡«å……åŸºç¡€æ•°æ®ï¼‰
            const reviewIdField = document.getElementById('review-id');
            const hasExistingReview = reviewIdField && reviewIdField.value;

            if (!hasExistingReview) {
                console.log('ï¿½ æ²¡æœ‰ç°æœ‰è®°å½•ç°ï¼Œå¡«å……æŒä»“åŸºç¡€æ•°æ®');
                const holding = currentHoldings.find(h => h.stock_code === stockCode);
                if (holding) {
                    console.log('âœ… æ‰¾åˆ°æŒä»“ä¿¡æ¯:', holding);
                    populateModalWithHoldingData(stockCode, holding);
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°æŒä»“ä¿¡æ¯ï¼Œå°è¯•ä»APIè·å–:', stockCode);
                    try {
                        const holdingData = loadHoldingInfo(stockCode);
                        if (holdingData) {
                            populateModalWithHoldingData(stockCode, holdingData);
                        }
                    } catch (error) {
                        console.warn('âš ï¸ è·å–æŒä»“ä¿¡æ¯å¤±è´¥:', error);
                    }
                }
            } else {
                console.log('ğŸ“ å·²æœ‰ç°æœ‰è®°å½•ï¼Œè·³è¿‡åŸºç¡€æ•°æ®å¡«å……');
            }

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            reviewModal.show();
            console.log('âœ… æ¨¡æ€æ¡†æ˜¾ç¤ºæˆåŠŸ');

            // å»¶è¿Ÿæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œç¡®ä¿æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤º
            setTimeout(() => {
                // é‡æ–°è®¡ç®—æ€»åˆ†ï¼ˆé˜²æ­¢æ˜¾ç¤ºä¸ä¸€è‡´ï¼‰
                if (typeof calculateTotalScore === 'function') {
                    calculateTotalScore();
                }

                // å¦‚æœæœ‰å½“å‰ä»·æ ¼ï¼Œé‡æ–°è®¡ç®—æµ®ç›ˆ
                const currentPriceInput = document.getElementById('current-price-input');
                if (currentPriceInput && currentPriceInput.value && typeof calculateFloatingProfit === 'function') {
                    calculateFloatingProfit();
                }
            }, 200);

        } catch (error) {
            console.error('âŒ openReviewModalå¤±è´¥:', error);

            if (typeof showErrorMessage === 'function') {
                showErrorMessage('æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†å¤±è´¥: ' + error.message);
            } else {
                alert('æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†å¤±è´¥: ' + error.message);
            }
        }
    }

    function checkAndLoadExistingReview(stockCode, reviewDate) {
        console.log('ğŸ” æ£€æŸ¥ç°æœ‰å¤ç›˜è®°å½•:', stockCode, reviewDate);

        try {
            // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼Œç›´æ¥æŸ¥è¯¢ç‰¹å®šè‚¡ç¥¨å’Œæ—¥æœŸçš„è®°å½•
            const queryParams = new URLSearchParams({
                stock_code: stockCode,
                start_date: reviewDate,
                end_date: reviewDate,
                per_page: 1
            });

            fetch(`/api/reviews?${queryParams}`).then(response => {
                if (!response.ok) {
                    console.warn('âš ï¸ è·å–å¤ç›˜è®°å½•å¤±è´¥:', response.status, response.statusText);
                    return;
                }

                return response.json();
            }).then(data => {
                console.log('ğŸ“Š APIå“åº”æ•°æ®:', data);

                if (!data.success) {
                    console.warn('âš ï¸ APIè¿”å›å¤±è´¥çŠ¶æ€:', data.message || 'æœªçŸ¥é”™è¯¯');
                    return;
                }

                // å¤„ç†ä¸åŒçš„æ•°æ®ç»“æ„
                let reviews = [];
                if (data.data) {
                    if (Array.isArray(data.data)) {
                        // ç›´æ¥æ˜¯æ•°ç»„æ ¼å¼
                        reviews = data.data;
                    } else if (data.data.reviews && Array.isArray(data.data.reviews)) {
                        // åˆ†é¡µæ ¼å¼
                        reviews = data.data.reviews;
                    } else if (data.data.data && Array.isArray(data.data.data)) {
                        // åµŒå¥—æ ¼å¼
                        reviews = data.data.data;
                    }
                }

                console.log('ğŸ“ è§£æåˆ°çš„å¤ç›˜è®°å½•:', reviews);

                // æŸ¥æ‰¾åŒ¹é…çš„å¤ç›˜è®°å½•ï¼ˆç²¾ç¡®åŒ¹é…è‚¡ç¥¨ä»£ç å’Œæ—¥æœŸï¼‰
                const existingReview = reviews.find(review => {
                    const matchStock = review.stock_code === stockCode;
                    const matchDate = review.review_date === reviewDate;
                    console.log(`ğŸ” æ£€æŸ¥è®°å½• ${review.id}: è‚¡ç¥¨åŒ¹é…=${matchStock}, æ—¥æœŸåŒ¹é…=${matchDate}`);
                    return matchStock && matchDate;
                });

                if (existingReview) {
                    console.log('âœ… æ‰¾åˆ°ç°æœ‰å¤ç›˜è®°å½•:', existingReview);

                    // è®¾ç½®å¤ç›˜IDï¼ˆç”¨äºæ›´æ–°è€Œä¸æ˜¯åˆ›å»ºï¼‰
                    const reviewIdField = document.getElementById('review-id')
                    if (reviewIdField) {
                        reviewIdField.value = existingReview.id;
                        console.log('ğŸ†” è®¾ç½®å¤ç›˜ID:', existingReview.id);
                    }

                    // å¡«å……ç°æœ‰æ•°æ®
                    populateModalWithExistingReview(existingReview);

                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    if (typeof showInfoMessage === 'function') {
                        showInfoMessage(`å·²åŠ è½½ ${stockCode} åœ¨ ${reviewDate} çš„å¤ç›˜è®°å½•`, {
                            position: 'toast',
                            duration: 2000
                        });
                    }
                } else {
                    console.log('â„¹ï¸ æœªæ‰¾åˆ°ç°æœ‰å¤ç›˜è®°å½•ï¼Œå°†åˆ›å»ºæ–°è®°å½•');

                    // æ¸…ç©ºå¤ç›˜ID
                    const reviewIdField = document.getElementById('review-id');
                    if (reviewIdField) {
                        reviewIdField.value = '';
                    }

                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    if (typeof showInfoMessage === 'function') {
                        showInfoMessage(`å°†ä¸º ${stockCode} åˆ›å»ºæ–°çš„å¤ç›˜è®°å½•`, {
                            position: 'toast',
                            duration: 2000
                        });
                    }
                }

            }).catch(error => {
                console.error('âŒ æ£€æŸ¥ç°æœ‰å¤ç›˜è®°å½•å¤±è´¥:', error);

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage('åŠ è½½å¤ç›˜è®°å½•å¤±è´¥: ' + error.message)
                }

                // æ¸…ç©ºå¤ç›˜IDï¼Œç¡®ä¿ä¸ä¼šæ„å¤–æ›´æ–°é”™è¯¯çš„è®°å½•
                const reviewIdField = document.getElementById('review-id');
                if (reviewIdField) {
                    reviewIdField.value = '';
                }
            });
        } catch (error) {
            console.error('âŒ æ£€æŸ¥ç°æœ‰å¤ç›˜è®°å½•å¤±è´¥:', error);

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (typeof showErrorMessage === 'function') {
                showErrorMessage('åŠ è½½å¤ç›˜è®°å½•å¤±è´¥: ' + error.message)
            }

            // æ¸…ç©ºå¤ç›˜IDï¼Œç¡®ä¿ä¸ä¼šæ„å¤–æ›´æ–°é”™è¯¯çš„è®°å½•
            const reviewIdField = document.getElementById('review-id');
            if (reviewIdField) {
                reviewIdField.value = '';
            }
        }
    }

    function populateModalWithExistingReview(review) {
        console.log('ğŸ“ å¡«å……ç°æœ‰å¤ç›˜è®°å½•æ•°æ®:', review);

        try {
            // å¡«å……åŸºæœ¬ä¿¡æ¯
            const holdingDaysField = document.getElementById('holding-days');
            if (holdingDaysField && review.holding_days) {
                holdingDaysField.value = review.holding_days;
                console.log('âœ… å·²å¡«å……æŒä»“å¤©æ•°:', review.holding_days);
            }

            const currentPriceField = document.getElementById('current-price-input');
            if (currentPriceField && review.current_price) {
                currentPriceField.value = review.current_price;
                console.log('âœ… å·²å¡«å……å½“å‰ä»·æ ¼:', review.current_price);
            }

            // å¡«å……è¯„åˆ†å¤é€‰æ¡†
            const scoreFields = [
                { id: 'price-up-score', value: review.price_up_score, name: 'æ”¶ç›˜ä»·ä¸Šå‡' },
                { id: 'bbi-score', value: review.bbi_score, name: 'ä¸ç ´BBIçº¿' },
                { id: 'volume-score', value: review.volume_score, name: 'æ— æ”¾é‡é˜´çº¿' },
                { id: 'trend-score', value: review.trend_score, name: 'è¶‹åŠ¿è¿˜åœ¨å‘ä¸Š' },
                { id: 'j-score', value: review.j_score, name: 'Jæ²¡æ­»å‰' }
            ];

            let checkedCount = 0;
            scoreFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    const isChecked = field.value === 1;
                    element.checked = isChecked;
                    if (isChecked) checkedCount++;
                    console.log(`âœ… å·²å¡«å……è¯„åˆ† ${field.name}:`, isChecked);
                } else {
                    console.warn(`âš ï¸ æœªæ‰¾åˆ°è¯„åˆ†å­—æ®µ: ${field.id}`);
                }
            });

            console.log(`ğŸ“Š æ€»è¯„åˆ†: ${checkedCount}/5`);

            // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
            const totalScoreEl = document.getElementById('total-score');
            if (totalScoreEl) {
                totalScoreEl.textContent = checkedCount;
            }

            // å¡«å……æ–‡æœ¬å­—æ®µ
            const analysisField = document.getElementById('analysis');
            if (analysisField) {
                analysisField.value = review.analysis || '';
                console.log('âœ… å·²å¡«å……åˆ†æå†…å®¹:', review.analysis ? 'æœ‰å†…å®¹' : 'ç©º');
            }

            const decisionField = document.getElementById('decision');
            if (decisionField) {
                decisionField.value = review.decision || '';
                console.log('âœ… å·²å¡«å……å†³ç­–ç»“æœ:', review.decision);
            }

            const reasonField = document.getElementById('reason');
            if (reasonField) {
                reasonField.value = review.reason || '';
                console.log('âœ… å·²å¡«å……å†³ç­–ç†ç”±:', review.reason ? 'æœ‰å†…å®¹' : 'ç©º');
            }

            // å¤„ç†æµ®ç›ˆä¿¡æ¯æ˜¾ç¤º
            if (review.floating_profit_ratio !== null && review.floating_profit_ratio !== undefined) {
                const profitRatio = parseFloat(review.floating_profit_ratio);
                const profitPercentage = (profitRatio * 100).toFixed(2);

                const profitRatioEl = document.getElementById('floating-profit-ratio');
                if (profitRatioEl) {
                    profitRatioEl.textContent = profitPercentage + '%';

                    // è®¾ç½®é¢œè‰²
                    const container = profitRatioEl.closest('.floating-profit-container');
                    if (container) {
                        container.className = 'floating-profit-container';
                        if (profitRatio > 0) {
                            container.classList.add('profit');
                            profitRatioEl.style.color = '#dc3545'; // çº¢è‰²è¡¨ç¤ºç›ˆåˆ©
                        } else if (profitRatio < 0) {
                            container.classList.add('loss');
                            profitRatioEl.style.color = '#28a745'; // ç»¿è‰²è¡¨ç¤ºäºæŸ
                        } else {
                            container.classList.add('neutral');
                            profitRatioEl.style.color = '#6c757d'; // ç°è‰²è¡¨ç¤ºæŒå¹³
                        }
                    }
                    console.log('âœ… å·²å¡«å……æµ®ç›ˆæ¯”ä¾‹:', profitPercentage + '%');
                }
            }

            // æ˜¾ç¤ºä¹°å…¥ä»·æ ¼
            if (review.buy_price) {
                const buyPriceDisplay = document.getElementById('buy-price-display');
                if (buyPriceDisplay) {
                    buyPriceDisplay.textContent = `Â¥${parseFloat(review.buy_price).toFixed(2)}`;
                    console.log('âœ… å·²å¡«å……ä¹°å…¥ä»·æ ¼:', review.buy_price);
                }
            }

            // è§¦å‘å˜åŒ–æ£€æµ‹ï¼Œæ›´æ–°ä¿å­˜çŠ¶æ€
            if (window.reviewSaveManager && typeof window.reviewSaveManager.captureOriginalFormData === 'function') {
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å·²å¡«å……
                setTimeout(() => {
                    window.reviewSaveManager.captureOriginalFormData();
                    console.log('âœ… å·²æ›´æ–°åŸå§‹è¡¨å•æ•°æ®');
                }, 100);
            }

            console.log('âœ… å¤ç›˜è®°å½•æ•°æ®å¡«å……å®Œæˆ');

        } catch (error) {
            console.error('âŒ å¡«å……å¤ç›˜è®°å½•æ•°æ®å¤±è´¥:', error);

            if (typeof showErrorMessage === 'function') {
                showErrorMessage('å¡«å……å¤ç›˜æ•°æ®å¤±è´¥: ' + error.message)
            }
        }
    }

    function loadHoldingInfo(stockCode) {
        try {
            fetch('/api/holdings').then(response => {
                return response.json();
            }).then(data => {
                if (data.success && data.data) {
                    currentHoldings = data.data;
                    const holding = data.data.find(h => h.stock_code === stockCode);
                    return holding;
                }
                return null;
            }).catch(error => {
                console.error('è·å–æŒä»“ä¿¡æ¯å¤±è´¥:', error);
                return null;
            });
        } catch (error) {
            console.error('è·å–æŒä»“ä¿¡æ¯å¤±è´¥:', error);
            return null;
        }
    }

    function populateModalWithHoldingData(stockCode, holding) {
        console.log('ğŸ”§ å¡«å……æ¨¡æ€æ¡†æ•°æ®:', stockCode, holding);

        // è®¾ç½®æŒä»“å¤©æ•°
        const holdingDays = document.getElementById('holding-days');
        if (holdingDays) {
            holdingDays.value = holding.holding_days || 1;
        }

        // è®¾ç½®æˆæœ¬ä»·
        const buyPriceDisplay = document.getElementById('buy-price-display');
        if (buyPriceDisplay) {
            const buyPrice = holding.avg_buy_price || holding.avg_price;
            buyPriceDisplay.textContent = buyPrice ? `Â¥${buyPrice.toFixed(2)}` : '--';
            console.log('âœ… æˆæœ¬ä»·å·²è®¾ç½®:', buyPrice);
        }

        // è®¾ç½®å½“å‰ä»·æ ¼
        const currentPriceInput = document.getElementById('current-price-input');
        if (currentPriceInput && holding.current_price) {
            currentPriceInput.value = holding.current_price.toFixed(2);
            console.log('âœ… å½“å‰ä»·æ ¼å·²è®¾ç½®:', holding.current_price);

            // è®¡ç®—å¹¶æ˜¾ç¤ºæµ®ç›ˆ
            calculateAndDisplayProfit(holding);
        }
    }

    function calculateAndDisplayProfit(holding) {
        const buyPrice = holding.avg_buy_price || holding.avg_price;
        const currentPrice = holding.current_price;

        if (buyPrice && currentPrice) {
            const profitRatio = ((currentPrice - buyPrice) / buyPrice * 100).toFixed(2);
            const profitRatioEl = document.getElementById('floating-profit-ratio');

            if (profitRatioEl) {
                profitRatioEl.textContent = profitRatio + '%';

                // è®¾ç½®é¢œè‰²
                const container = profitRatioEl.closest('.floating-profit-container');
                if (container) {
                    container.className = 'floating-profit-container';
                    if (profitRatio > 0) {
                        container.classList.add('profit');
                        profitRatioEl.style.color = '#dc3545'; // çº¢è‰²
                    } else if (profitRatio < 0) {
                        container.classList.add('loss');
                        profitRatioEl.style.color = '#28a745'; // ç»¿è‰²
                    } else {
                        container.classList.add('neutral');
                        profitRatioEl.style.color = '#6c757d'; // ç°è‰²
                    }
                }
            }
        }
    }

    // é‡å¤å‡½æ•°å®šä¹‰å·²åˆ é™¤ - ä½¿ç”¨ä¸Šé¢å·²å®šä¹‰çš„å‡½æ•°
    // è°ƒè¯•å‡½æ•°ï¼šæµ‹è¯•å¤ç›˜æ•°æ®å›å¡«
    window.testReviewDataBackfill = async function (stockCode, reviewDate) {
        console.log('ğŸ§ª æµ‹è¯•å¤ç›˜æ•°æ®å›å¡«:', stockCode, reviewDate);

        try {
            // æµ‹è¯•APIè°ƒç”¨
            const queryParams = new URLSearchParams({
                stock_code: stockCode,
                start_date: reviewDate,
                end_date: reviewDate,
                per_page: 1
            });

            return fetch(`/api/reviews?${queryParams}`).then(response => {
                return response.json();
            }).then(data => {
                console.log('ğŸ“Š APIå“åº”:', data);

                // æµ‹è¯•æ•°æ®è§£æ
                let reviews = [];
                if (data.data) {
                    if (Array.isArray(data.data)) {
                        reviews = data.data;
                    } else if (data.data.reviews && Array.isArray(data.data.reviews)) {
                        reviews = data.data.reviews;
                    }
                }

                console.log('ğŸ“ è§£æåˆ°çš„è®°å½•:', reviews);

                const existingReview = reviews.find(review =>
                    review.stock_code === stockCode && review.review_date === reviewDate
                );

                if (existingReview) {
                    console.log('âœ… æ‰¾åˆ°åŒ¹é…è®°å½•:', existingReview);
                    return existingReview;
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°åŒ¹é…è®°å½•');
                    return null;
                }
            }).catch(error => {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                return null;
            });
        } catch (error) {
            console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
            return null;
        }
    };

    // è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥æ¨¡æ€æ¡†çŠ¶æ€
    window.debugReviewModal = function () {
        console.log('ğŸ” æ£€æŸ¥å¤ç›˜æ¨¡æ€æ¡†çŠ¶æ€');

        const modal = document.getElementById('reviewModal');
        const form = document.getElementById('review-form');
        const stockCodeInput = document.getElementById('review-stock-code');
        const reviewIdField = document.getElementById('review-id');
        const reviewDateField = document.getElementById('review-date');

        console.log('æ¨¡æ€æ¡†å…ƒç´ :', modal ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        console.log('è¡¨å•å…ƒç´ :', form ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        console.log('è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†:', stockCodeInput ? stockCodeInput.value : 'ä¸å­˜åœ¨');
        console.log('å¤ç›˜IDå­—æ®µ:', reviewIdField ? reviewIdField.value : 'ä¸å­˜åœ¨');
        console.log('å¤ç›˜æ—¥æœŸå­—æ®µ:', reviewDateField ? reviewDateField.value : 'ä¸å­˜åœ¨');

        if (form) {
            const formData = new FormData(form);
            const formObject = {};
            for (let [key, value] of formData.entries()) {
                formObject[key] = value;
            }
            console.log('è¡¨å•æ•°æ®:', formObject);
        }

        return {
            modal: !!modal,
            form: !!form,
            stockCode: stockCodeInput?.value,
            reviewId: reviewIdField?.value,
            reviewDate: reviewDateField?.value
        };
    };

    // æš´éœ²å…¨å±€å‡½æ•°
    window.saveReview = saveReview;
    window.testInitialization = testInitialization;
    window.diagnoseReviewPage = diagnoseReviewPage;
    window.verifySaveStateManagementIntegration = verifySaveStateManagementIntegration;

    // æš´éœ²åˆå§‹åŒ–ç›¸å…³å‡½æ•°
    window.getInitializationLogs = getInitializationLogs;
    window.clearInitializationLogs = clearInitializationLogs;
    window.exportInitializationLogs = exportInitializationLogs;
    window.showInitializationReport = showInitializationReport;

    // é¡µé¢å¸è½½æ—¶è®°å½•æ—¥å¿—
    window.addEventListener('beforeunload', function () {
        if (typeof logInitializationProgress === 'function') {
            logInitializationProgress('é¡µé¢å¸è½½', 'info', {
                duration: performance.now(),
                userAgent: navigator.userAgent
            });
        }
    });

    // å¤ç›˜è®°å½•æ˜¾ç¤ºä¿®å¤è„šæœ¬
    document.addEventListener('DOMContentLoaded', function () {
        console.log('[FIX] å¤ç›˜é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ä¿®å¤...');

        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        setTimeout(function () {
            fixReviewsDisplay();
        }, 1000);
    });

    function fixReviewsDisplay() {
        console.log('[FIX] å¼€å§‹ä¿®å¤å¤ç›˜è®°å½•æ˜¾ç¤º...');

        // æ£€æŸ¥æ˜¯å¦æœ‰loadReviewså‡½æ•°
        if (typeof loadReviews === 'function') {
            console.log('[FIX] loadReviewså‡½æ•°å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨');
            loadReviews();
            return;
        }

        // å¦‚æœæ²¡æœ‰loadReviewså‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„ç‰ˆæœ¬
        console.log('[FIX] loadReviewså‡½æ•°ä¸å­˜åœ¨ï¼Œåˆ›å»ºç®€å•ç‰ˆæœ¬');

        window.loadReviews = async function () {
            console.log('[FIX] ç®€å•ç‰ˆæœ¬loadReviewså¼€å§‹æ‰§è¡Œ');

            const reviewsList = document.getElementById('reviews-list');
            if (!reviewsList) {
                console.log('[FIX] æ‰¾ä¸åˆ°reviews-listå…ƒç´ ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            reviewsList.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½å¤ç›˜è®°å½•...</p>
        </div>
    `;

            try {
                fetch('/api/reviews').then(response => {
                    console.log('[FIX] APIå“åº”çŠ¶æ€:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    return response.json();
                }).then(data => {
                    console.log('[FIX] APIè¿”å›æ•°æ®:', data);

                    if (data.success && data.data && data.data.reviews) {
                        const reviews = data.data.reviews;
                        console.log('[FIX] æ‰¾åˆ°å¤ç›˜è®°å½•:', reviews.length, 'æ¡');

                        if (reviews.length > 0) {
                            displayReviewsSimple(reviews);
                        } else {
                            reviewsList.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <h5>æš‚æ— å¤ç›˜è®°å½•</h5>
                        <p>å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¤ç›˜åˆ†æ</p>
                    </div>
                `;
                        }
                    } else {
                        throw new Error(data.message || 'è·å–æ•°æ®å¤±è´¥');
                    }
                }).catch(error => {
                    console.error('[FIX] åŠ è½½å¤±è´¥:', error);
                    reviewsList.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h6>åŠ è½½å¤ç›˜è®°å½•å¤±è´¥</h6>
                <p>${error.message}</p>
                <button class="btn btn-outline-primary btn-sm" onclick="loadReviews()">
                    <i class="fas fa-redo"></i> é‡è¯•
                </button>
            </div>
        `;
                });
            } catch (error) {
                console.error('[FIX] åŠ è½½å¤±è´¥:', error);
                reviewsList.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h6>åŠ è½½å¤ç›˜è®°å½•å¤±è´¥</h6>
                <p>${error.message}</p>
                <button class="btn btn-outline-primary btn-sm" onclick="loadReviews()">
                    <i class="fas fa-redo"></i> é‡è¯•
                </button>
            </div>
        `;
            }
        };

        // åˆ›å»ºç®€å•çš„æ˜¾ç¤ºå‡½æ•°
        window.displayReviewsSimple = function (reviews) {
            console.log('[FIX] æ˜¾ç¤ºå¤ç›˜è®°å½•:', reviews);

            const reviewsList = document.getElementById('reviews-list');
            if (!reviewsList) return;

            const html = reviews.map(review => {
                const profitDisplay = review.floating_profit_display || {};
                const profitColor = profitDisplay.color || 'text-muted';
                const profitText = profitDisplay.display || 'æ— æ•°æ®';

                return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1"><strong>${review.stock_code}</strong></h6>
                            <small class="text-muted">${review.review_date}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-primary">${review.decision || 'æœªè®¾ç½®'}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æŒä»“å¤©æ•°</small><br>
                            <strong>${review.holding_days || 0}å¤©</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æµ®ç›ˆ</small><br>
                            <strong class="${profitColor}">${profitText}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">æ€»åˆ†</small><br>
                            <strong>${review.total_score || 0}/25</strong>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-outline-primary btn-sm" title="æŸ¥çœ‹">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    ${review.analysis ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">åˆ†æ:</small>
                                <p class="mb-0 small">${review.analysis}</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
            }).join('');

            reviewsList.innerHTML = html;
            console.log('[FIX] å¤ç›˜è®°å½•æ˜¾ç¤ºå®Œæˆ');
        };

        // æ‰§è¡ŒåŠ è½½
        loadReviews();
    }

    // æš´éœ²å…¨å±€å‡½æ•°
    window.refreshHoldings = refreshHoldings;
    window.refreshHoldingsWithPrices = refreshHoldingsWithPrices;
    window.toggleAutoRefresh = toggleAutoRefresh;
    window.openQuickReview = openQuickReview;
    window.openReviewModal = openReviewModal;
</script>
{% endblock %}