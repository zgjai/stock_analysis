{% extends "base.html" %}

{% block title %}历史交易 - 股票交易记录系统{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">历史交易</li>
{% endblock %}

{% block page_title %}历史交易{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-outline-primary" onclick="syncHistoricalTrades()">
    <i class="bi bi-arrow-clockwise"></i>
    同步数据
</button>
<button type="button" class="btn btn-outline-secondary" onclick="refreshHistoricalTrades()">
    <i class="bi bi-arrow-clockwise"></i>
    刷新
</button>
{% endblock %}

{% block content %}
<!-- 统计概览卡片 - 横排布局 -->
<div class="row mb-4" id="statistics-cards" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="me-3">
                                <i class="bi bi-graph-up fs-1 text-primary"></i>
                            </div>
                            <div class="text-start">
                                <h6 class="text-muted mb-1">总交易数</h6>
                                <h4 class="mb-0 text-primary" id="total-trades">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="me-3">
                                <i class="bi bi-arrow-up-circle fs-1 text-success"></i>
                            </div>
                            <div class="text-start">
                                <h6 class="text-muted mb-1">盈利交易</h6>
                                <h4 class="mb-0 text-success" id="profitable-trades">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 mb-md-0">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="me-3">
                                <i class="bi bi-currency-dollar fs-1 text-info"></i>
                            </div>
                            <div class="text-start">
                                <h6 class="text-muted mb-1">总收益</h6>
                                <h4 class="mb-0 text-info" id="total-return">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="me-3">
                                <i class="bi bi-percent fs-1 text-warning"></i>
                            </div>
                            <div class="text-start">
                                <h6 class="text-muted mb-1">平均收益率</h6>
                                <h4 class="mb-0 text-warning" id="average-return-rate">-</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">历史交易记录列表</h5>
            <div class="text-muted small" id="records-count">
                <!-- 记录数量将在这里显示 -->
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- 筛选器 -->
        <div class="row mb-3">
            <div class="col-lg-2 col-md-3 col-sm-6 mb-2">
                <input type="text" class="form-control" placeholder="股票代码" id="stock-code-filter" 
                       title="输入股票代码进行筛选">
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-2">
                <input type="text" class="form-control" placeholder="股票名称" id="stock-name-filter"
                       title="输入股票名称进行筛选">
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-2">
                <input type="date" class="form-control" id="date-from" title="开始日期"
                       placeholder="开始日期">
            </div>
            <div class="col-lg-2 col-md-3 col-sm-6 mb-2">
                <input type="date" class="form-control" id="date-to" title="结束日期"
                       placeholder="结束日期">
            </div>
            <div class="col-lg-2 col-md-6 col-sm-6 mb-2">
                <select class="form-select" id="return-rate-filter" title="按收益情况筛选">
                    <option value="">全部收益率</option>
                    <option value="positive">盈利交易</option>
                    <option value="negative">亏损交易</option>
                </select>
            </div>
            <div class="col-lg-2 col-md-6 col-sm-6 mb-2">
                <button type="button" class="btn btn-outline-primary w-100" onclick="filterHistoricalTrades()"
                        title="应用筛选条件 (Ctrl+Enter)">
                    <i class="bi bi-search"></i>
                    筛选
                </button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-2">
                <label class="form-label small text-muted">排序字段</label>
                <select class="form-select" id="sort-by">
                    <option value="completion_date">按完成日期</option>
                    <option value="stock_code">按股票代码</option>
                    <option value="return_rate">按收益率</option>
                    <option value="holding_days">按持仓天数</option>
                    <option value="total_investment">按投入本金</option>
                    <option value="total_return">按实际收益</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">排序方向</label>
                <select class="form-select" id="sort-order">
                    <option value="desc">降序</option>
                    <option value="asc">升序</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">&nbsp;</label>
                <button type="button" class="btn btn-outline-primary w-100 d-block" onclick="filterHistoricalTrades()">
                    <i class="bi bi-funnel"></i>
                    应用排序
                </button>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">&nbsp;</label>
                <button type="button" class="btn btn-outline-secondary w-100 d-block" onclick="resetFilter()">
                    <i class="bi bi-arrow-clockwise"></i>
                    重置
                </button>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">每页显示</label>
                <select class="form-select" id="per-page">
                    <option value="10">每页10条</option>
                    <option value="20" selected>每页20条</option>
                    <option value="50">每页50条</option>
                    <option value="100">每页100条</option>
                </select>
            </div>
        </div>

        <!-- 历史交易记录表格 -->
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" class="text-nowrap">股票</th>
                        <th scope="col" class="text-nowrap">买入日期</th>
                        <th scope="col" class="text-nowrap">卖出日期</th>
                        <th scope="col" class="text-nowrap">持仓天数</th>
                        <th scope="col" class="text-nowrap">投入本金</th>
                        <th scope="col" class="text-nowrap">实际收益</th>
                        <th scope="col" class="text-nowrap">收益率</th>
                        <th scope="col" class="text-nowrap">复盘</th>
                        <th scope="col" class="text-nowrap">操作</th>
                    </tr>
                </thead>
                <tbody id="historical-trades-table-body">
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            正在加载历史交易记录...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <nav aria-label="历史交易记录分页">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- 复盘模态框 -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="review-modal-title">交易复盘</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 交易基本信息 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">交易信息</h6>
                                <div class="row" id="trade-info">
                                    <!-- 交易信息将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 复盘表单 -->
                <form id="review-form" novalidate>
                    <input type="hidden" id="historical-trade-id" name="historical_trade_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="review-title" class="form-label">复盘标题</label>
                                <input type="text" class="form-control" id="review-title" name="review_title" 
                                       placeholder="为这次交易复盘起个标题...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="review-type" class="form-label">复盘类型</label>
                                <select class="form-select" id="review-type" name="review_type">
                                    <option value="general">一般复盘</option>
                                    <option value="success">成功案例</option>
                                    <option value="failure">失败教训</option>
                                    <option value="lesson">重要学习</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="review-content" class="form-label">复盘内容</label>
                        <textarea class="form-control" id="review-content" name="review_content" rows="6" 
                                  placeholder="详细描述这次交易的过程、思考和感悟..."></textarea>
                    </div>

                    <!-- 评分系统 -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="strategy-score" class="form-label">策略执行评分</label>
                            <select class="form-select" id="strategy-score" name="strategy_score">
                                <option value="">请选择</option>
                                <option value="1">1分 - 很差</option>
                                <option value="2">2分 - 较差</option>
                                <option value="3">3分 - 一般</option>
                                <option value="4">4分 - 良好</option>
                                <option value="5">5分 - 优秀</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="timing-score" class="form-label">时机把握评分</label>
                            <select class="form-select" id="timing-score" name="timing_score">
                                <option value="">请选择</option>
                                <option value="1">1分 - 很差</option>
                                <option value="2">2分 - 较差</option>
                                <option value="3">3分 - 一般</option>
                                <option value="4">4分 - 良好</option>
                                <option value="5">5分 - 优秀</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="risk-control-score" class="form-label">风险控制评分</label>
                            <select class="form-select" id="risk-control-score" name="risk_control_score">
                                <option value="">请选择</option>
                                <option value="1">1分 - 很差</option>
                                <option value="2">2分 - 较差</option>
                                <option value="3">3分 - 一般</option>
                                <option value="4">4分 - 良好</option>
                                <option value="5">5分 - 优秀</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="overall-score" class="form-label">总体评分</label>
                            <select class="form-select" id="overall-score" name="overall_score">
                                <option value="">请选择</option>
                                <option value="1">1分 - 很差</option>
                                <option value="2">2分 - 较差</option>
                                <option value="3">3分 - 一般</option>
                                <option value="4">4分 - 良好</option>
                                <option value="5">5分 - 优秀</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="key-learnings" class="form-label">关键学习点</label>
                            <textarea class="form-control" id="key-learnings" name="key_learnings" rows="3" 
                                      placeholder="这次交易中学到的重要经验..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="improvement-areas" class="form-label">改进领域</label>
                            <textarea class="form-control" id="improvement-areas" name="improvement_areas" rows="3" 
                                      placeholder="下次可以改进的地方..."></textarea>
                        </div>
                    </div>

                    <!-- 图片上传 -->
                    <div class="mb-3">
                        <label class="form-label">复盘图片</label>
                        <div id="image-uploader-container">
                            <!-- 图片上传组件将在这里初始化 -->
                        </div>
                        <!-- 保留原有的隐藏文件输入，用于兼容性 -->
                        <input type="file" class="d-none" id="review-images" multiple accept="image/*">
                        <div id="image-preview" class="mt-2" style="display: none;">
                            <!-- 图片预览将在这里显示 -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="save-review-btn">
                    <span class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></span>
                    保存复盘
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 查看复盘模态框 -->
<div class="modal fade" id="viewReviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">查看复盘</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="view-review-content">
                <!-- 复盘内容将在这里显示 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="edit-review-btn">
                    <i class="bi bi-pencil"></i>
                    编辑复盘
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* 统计卡片样式优化 */
    #statistics-cards .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
    }
    
    #statistics-cards .card-body {
        padding: 1.5rem;
    }
    
    #statistics-cards .row > div {
        position: relative;
    }
    
    #statistics-cards .row > div:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 60%;
        width: 1px;
        background-color: #e9ecef;
    }
    
    @media (max-width: 991.98px) {
        #statistics-cards .row > div::after {
            display: none;
        }
        
        #statistics-cards .row > div {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 1rem;
        }
        
        #statistics-cards .row > div:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
    }
    
    /* 表格样式优化 */
    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    /* 筛选器样式 */
    .form-label.small {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/fix_sorting_issue.js') }}"></script>
<script>
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化组件
        window.reviewEditor = new ReviewEditor();
        window.reviewViewer = new ReviewViewer();
        window.historicalTradesManager = new HistoricalTradesManager();
        
        // 设置组件间的通信
        setupComponentCommunication();
    });

    function setupComponentCommunication() {
        // 监听复盘保存事件
        document.addEventListener('reviewSaved', function(event) {
            if (window.historicalTradesManager) {
                window.historicalTradesManager.loadHistoricalTrades();
            }
        });

        // 监听编辑复盘事件
        document.addEventListener('editReview', function(event) {
            const { reviewId, reviewData } = event.detail;
            if (window.historicalTradesManager) {
                window.historicalTradesManager.editReviewById(reviewId, reviewData);
            }
        });
    }

    // 全局函数供按钮调用
    function syncHistoricalTrades() {
        if (window.historicalTradesManager) {
            window.historicalTradesManager.syncHistoricalTrades();
        }
    }

    function refreshHistoricalTrades() {
        if (window.historicalTradesManager) {
            window.historicalTradesManager.loadHistoricalTrades();
        }
    }

    function filterHistoricalTrades() {
        if (window.historicalTradesManager) {
            window.historicalTradesManager.applyFilters();
        }
    }

    function resetFilter() {
        if (window.historicalTradesManager) {
            window.historicalTradesManager.resetFilters();
        }
    }
</script>
{% endblock %}