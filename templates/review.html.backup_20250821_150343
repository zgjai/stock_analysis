{% extends "base.html" %}

{% block title %}å¤ç›˜åˆ†æ - è‚¡ç¥¨äº¤æ˜“è®°å½•ç³»ç»Ÿ{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">å¤ç›˜åˆ†æ</li>
{% endblock %}

{% block page_title %}å¤ç›˜åˆ†æ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-optimizations.css') }}">
<style>
body {
    background-color: #f8f9fa;
}

/* æµ®ç›ˆè®¡ç®—å™¨æ ·å¼ */
.floating-profit-container {
    position: relative;
}

.floating-profit-container.profit {
    background-color: rgba(25, 135, 84, 0.1);
    border-radius: 4px;
    padding: 2px 4px;
}

.floating-profit-container.loss {
    background-color: rgba(220, 53, 69, 0.1);
    border-radius: 4px;
    padding: 2px 4px;
}

.floating-profit-container.neutral {
    background-color: rgba(108, 117, 125, 0.1);
    border-radius: 4px;
    padding: 2px 4px;
}

#floating-profit-ratio {
    font-size: 1.1em;
    font-weight: bold;
}

/* æŒä»“åˆ—è¡¨å¢å¼ºæ ·å¼ */
.holding-item {
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
    background-color: #fff;
}

.holding-item:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
    border-color: #007bff;
}

.holding-item .fw-bold {
    font-size: 1.1rem;
}

.holding-item .text-success {
    color: #28a745 !important;
    font-weight: 600;
}

.holding-item .text-danger {
    color: #dc3545 !important;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="review-page">
<div class="row">
    <!-- å½“å‰æŒä»“åˆ—è¡¨ -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">å½“å‰æŒä»“</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshHoldings()">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="refreshHoldingsWithPrices()">
                            <i class="fas fa-dollar-sign"></i> åˆ·æ–°ä»·æ ¼
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="toggleAutoRefresh()" id="auto-refresh-btn">
                            <i class="fas fa-play"></i> è‡ªåŠ¨åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted" id="price-update-status">
                        <i class="fas fa-clock"></i> ä»·æ ¼æ›´æ–°æ—¶é—´: <span id="last-price-update">--</span>
                    </small>
                </div>
            </div>
            <div class="card-body">
                <div id="holdings-list">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
        </div>

        <!-- å¤ç›˜è®°å½•å†å² -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">å¤ç›˜è®°å½•</h5>
            </div>
            <div class="card-body">
                <div id="reviews-list">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒä»“æé†’å’Œæ“ä½œé¢æ¿ -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">æŒä»“ç­–ç•¥æé†’</h5>
            </div>
            <div class="card-body">
                <div id="holding-alerts">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿå¤ç›˜é¢æ¿ -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">å¿«é€Ÿå¤ç›˜</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©è‚¡ç¥¨</label>
                    <select class="form-select" id="quick-review-stock">
                        <option value="">è¯·é€‰æ‹©æŒä»“è‚¡ç¥¨</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100" onclick="openQuickReview()">å¼€å§‹å¤ç›˜</button>
            </div>
        </div>
    </div>
</div>

<!-- å¤ç›˜è¯„åˆ†æ¨¡æ€æ¡† -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å¤ç›˜è¯„åˆ†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="review-form">
                    <input type="hidden" id="review-stock-code">
                    <input type="hidden" id="review-id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" class="form-control" id="display-stock-code" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å¤ç›˜æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="review-date" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">æŒä»“å¤©æ•°</label>
                            <input type="number" class="form-control" id="holding-days" min="1" required>
                        </div>
                    </div>

                    <!-- å½“å‰ä»·æ ¼å’Œæµ®ç›ˆè®¡ç®— -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">æµ®ç›ˆè®¡ç®—</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">å½“å‰ä»·æ ¼</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        <input type="number" class="form-control" id="current-price-input" 
                                               placeholder="è¾“å…¥å½“å‰ä»·æ ¼" step="0.01" min="0.01" max="9999.99">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">æˆæœ¬ä»·</label>
                                    <div class="form-control-plaintext" id="buy-price-display">--</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">æµ®ç›ˆæ¯”ä¾‹</label>
                                    <div class="floating-profit-container">
                                        <div class="form-control-plaintext fw-bold" id="floating-profit-ratio">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">è¯„åˆ†æ ‡å‡† (æ¯é¡¹1åˆ†ï¼Œæ€»åˆ†5åˆ†)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="price-up-score" value="1">
                                        <label class="form-check-label" for="price-up-score">æ”¶ç›˜ä»·ä¸Šå‡</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="bbi-score" value="1">
                                        <label class="form-check-label" for="bbi-score">ä¸ç ´BBIçº¿</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="volume-score" value="1">
                                        <label class="form-check-label" for="volume-score">æ— æ”¾é‡é˜´çº¿</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="trend-score" value="1">
                                        <label class="form-check-label" for="trend-score">è¶‹åŠ¿è¿˜åœ¨å‘ä¸Š</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="j-score" value="1">
                                        <label class="form-check-label" for="j-score">Jæ²¡æ­»å‰</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <strong>æ€»åˆ†: <span id="total-score" class="text-primary">0</span>/5</strong>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†æå†…å®¹</label>
                        <textarea class="form-control" id="analysis" rows="3" placeholder="è¯·è¾“å…¥åˆ†æå†…å®¹..."></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">å†³ç­–ç»“æœ</label>
                            <select class="form-select" id="decision" required>
                                <option value="">è¯·é€‰æ‹©å†³ç­–</option>
                                <option value="hold">ç»§ç»­æŒæœ‰</option>
                                <option value="sell_partial">éƒ¨åˆ†æ­¢ç›ˆ</option>
                                <option value="sell_all">æ¸…ä»“</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å†³ç­–ç†ç”±</label>
                        <textarea class="form-control" id="reason" rows="2" placeholder="è¯·è¾“å…¥å†³ç­–ç†ç”±..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="save-review-btn" onclick="saveReview()">ä¿å­˜å¤ç›˜</button>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block extra_js %}
<!-- ç´§æ€¥ä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
<script src="{{ url_for('static', filename='js/review-emergency-fix.js') }}"></script>
<script>
// ç®€åŒ–çš„å¤ç›˜åˆ†æé¡µé¢ç®¡ç†
let reviewModal = null;
let currentHoldings = [];
let currentReviews = [];

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–å¤ç›˜é¡µé¢');
    
    // åˆå§‹åŒ–reviewModal
    const modalElement = document.getElementById('reviewModal');
    if (modalElement) {
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            try {
                reviewModal = new bootstrap.Modal(modalElement);
                console.log('âœ… reviewModalåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ reviewModalåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
    }
    
    // ç»‘å®šè¯„åˆ†å¤é€‰æ¡†äº‹ä»¶
    bindScoreCheckboxes();
    
    // åŠ è½½æ‰€æœ‰æ•°æ®
    loadAllData();
});

function bindScoreCheckboxes() {
    const checkboxes = ['price-up-score', 'bbi-score', 'volume-score', 'trend-score', 'j-score'];
    checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.addEventListener('change', calculateTotalScore);
        }
    });
}

function calculateTotalScore() {
    const checkboxes = ['price-up-score', 'bbi-score', 'volume-score', 'trend-score', 'j-score'];
    let total = 0;
    checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox && checkbox.checked) {
            total += 1;
        }
    });
    const totalScoreEl = document.getElementById('total-score');
    if (totalScoreEl) {
        totalScoreEl.textContent = total;
    }
}

async function loadAllData() {
    try {
        await Promise.allSettled([
            loadHoldings(),
            loadReviews(),
            loadHoldingAlerts()
        ]);
    } catch (error) {
        console.error('åŠ è½½æ•°æ®æ—¶å‡ºé”™:', error);
    }
}

async function loadHoldings(forceRefreshPrices = false) {
    console.log('ğŸ“Š å¼€å§‹åŠ è½½æŒä»“æ•°æ®', forceRefreshPrices ? '(å¼ºåˆ¶åˆ·æ–°ä»·æ ¼)' : '');
    const holdingsList = document.getElementById('holdings-list');

    if (!holdingsList) {
        console.error('æŒä»“åˆ—è¡¨å®¹å™¨ä¸å­˜åœ¨');
        return;
    }

    try {
        holdingsList.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                ${forceRefreshPrices ? 'æ­£åœ¨åˆ·æ–°ä»·æ ¼æ•°æ®...' : 'æ­£åœ¨åŠ è½½æŒä»“æ•°æ®...'}
            </div>
        `;

        const url = forceRefreshPrices ? '/api/holdings?force_refresh=true' : '/api/holdings';
        const response = await fetch(url);
        const data = await response.json();

        if (data.success && data.data && data.data.length > 0) {
            currentHoldings = data.data;
            displayHoldings(data.data);
            updateQuickReviewOptions(data.data);
            
            // æ›´æ–°ä»·æ ¼æ›´æ–°æ—¶é—´
            updatePriceUpdateTime(forceRefreshPrices);
        } else {
            showEmptyHoldings();
        }

    } catch (error) {
        console.error('åŠ è½½æŒä»“æ•°æ®å¤±è´¥:', error);
        showHoldingsError(error.message);
    }
}

function displayHoldings(holdings) {
    const holdingsList = document.getElementById('holdings-list');
    if (!holdingsList) return;

    if (!holdings || holdings.length === 0) {
        showEmptyHoldings();
        return;
    }

    const holdingsHtml = holdings.map(holding => `
        <div class="holding-item card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <div class="fw-bold">${holding.stock_code}</div>
                        <div class="text-muted small">${holding.stock_name || '--'}</div>
                    </div>
                    <div class="col-md-2">
                        <div class="small text-muted">æˆæœ¬ä»·</div>
                        <div class="fw-bold">Â¥${holding.avg_buy_price ? holding.avg_buy_price.toFixed(2) : (holding.avg_price ? holding.avg_price.toFixed(2) : '--')}</div>
                    </div>
                    <div class="col-md-2">
                        <div class="small text-muted">å½“å‰ä»·</div>
                        <div class="fw-bold">Â¥${holding.current_price ? holding.current_price.toFixed(2) : '--'}</div>
                        <div class="small text-muted">${getPriceUpdateTime()}</div>
                    </div>
                    <div class="col-md-2">
                        <div class="small text-muted">æŒä»“é‡</div>
                        <div class="fw-bold">${holding.current_quantity || holding.total_quantity || 0}</div>
                    </div>
                    <div class="col-md-2">
                        <div class="small text-muted">æµ®ç›ˆæ¯”ä¾‹</div>
                        <div class="fw-bold ${getProfitClass(holding)}">${calculateProfitRatio(holding)}</div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary btn-sm w-100" onclick="openReviewModal('${holding.stock_code}')">
                            <i class="fas fa-chart-line"></i> å¤ç›˜åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    holdingsList.innerHTML = holdingsHtml;
}

function calculateProfitRatio(holding) {
    if (!holding.avg_buy_price || !holding.current_price) {
        return '--';
    }
    const ratio = ((holding.current_price - holding.avg_buy_price) / holding.avg_buy_price * 100).toFixed(2);
    return ratio + '%';
}

function getProfitClass(holding) {
    if (!holding.avg_buy_price || !holding.current_price) {
        return 'text-muted';
    }
    const ratio = (holding.current_price - holding.avg_buy_price) / holding.avg_buy_price;
    return ratio > 0 ? 'text-danger' : ratio < 0 ? 'text-success' : 'text-muted';
}

function getPriceUpdateTime() {
    const now = new Date();
    return now.toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
}

function updatePriceUpdateTime(wasForceRefresh = false) {
    const statusEl = document.getElementById('last-price-update');
    if (statusEl) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        statusEl.textContent = timeStr;
        
        // å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ ‡è¯†
        if (wasForceRefresh) {
            statusEl.parentElement.innerHTML = `
                <i class="fas fa-sync-alt text-success"></i> 
                ä»·æ ¼å·²åˆ·æ–°: <span class="text-success">${timeStr}</span>
            `;
            
            // 3ç§’åæ¢å¤æ­£å¸¸æ˜¾ç¤º
            setTimeout(() => {
                statusEl.parentElement.innerHTML = `
                    <i class="fas fa-clock"></i> 
                    ä»·æ ¼æ›´æ–°æ—¶é—´: <span id="last-price-update">${timeStr}</span>
                `;
            }, 3000);
        }
    }
}

function showEmptyHoldings() {
    const holdingsList = document.getElementById('holdings-list');
    if (holdingsList) {
        holdingsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-briefcase fa-3x mb-3 text-muted"></i>
                <div class="h5 mb-2">æš‚æ— æŒä»“æ•°æ®</div>
                <p class="mb-3">æ‚¨å½“å‰æ²¡æœ‰æŒä»“è‚¡ç¥¨</p>
                <a href="/trading-records" class="btn btn-outline-primary">
                    <i class="fas fa-plus"></i> æ·»åŠ äº¤æ˜“è®°å½•
                </a>
            </div>
        `;
    }
}

function showHoldingsError(message) {
    const holdingsList = document.getElementById('holdings-list');
    if (holdingsList) {
        holdingsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <div class="h5 mb-2">åŠ è½½å¤±è´¥</div>
                <p class="mb-3">${message}</p>
                <button class="btn btn-outline-primary" onclick="loadHoldings()">
                    <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                </button>
            </div>
        `;
    }
}

async function loadReviews() {
    console.log('ğŸ“ å¼€å§‹åŠ è½½å¤ç›˜è®°å½•');
    const reviewsList = document.getElementById('reviews-list');

    if (!reviewsList) return;

    try {
        reviewsList.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                æ­£åœ¨åŠ è½½å¤ç›˜è®°å½•...
            </div>
        `;

        const response = await fetch('/api/reviews');
        const data = await response.json();

        if (data.success && data.data && data.data.length > 0) {
            currentReviews = data.data;
            displayReviews(data.data);
        } else {
            showEmptyReviews();
        }

    } catch (error) {
        console.error('åŠ è½½å¤ç›˜è®°å½•å¤±è´¥:', error);
        showReviewsError(error.message);
    }
}

function displayReviews(reviews) {
    const reviewsList = document.getElementById('reviews-list');
    if (!reviewsList) return;

    if (!reviews || reviews.length === 0) {
        showEmptyReviews();
        return;
    }

    const reviewsHtml = reviews.map(review => `
        <div class="review-item card mb-2">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <div class="fw-bold">${review.stock_code}</div>
                        <div class="small text-muted">${review.review_date || '--'}</div>
                    </div>
                    <div class="col-md-2">
                        <div class="small text-muted">è¯„åˆ†</div>
                        <div class="fw-bold">${review.total_score || 0}/5</div>
                    </div>
                    <div class="col-md-2">
                        <div class="small text-muted">å†³ç­–</div>
                        <div class="fw-bold">${getDecisionText(review.decision)}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="small text-muted">åˆ†æå†…å®¹</div>
                        <div class="small">${review.analysis ? review.analysis.substring(0, 50) + '...' : '--'}</div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="editReview(${review.id})">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    reviewsList.innerHTML = reviewsHtml;
}

function showEmptyReviews() {
    const reviewsList = document.getElementById('reviews-list');
    if (reviewsList) {
        reviewsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-journal-whills fa-3x mb-3 text-muted"></i>
                <div class="h5 mb-2">æš‚æ— å¤ç›˜è®°å½•</div>
                <p class="mb-3">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¤ç›˜åˆ†æ</p>
            </div>
        `;
    }
}

function showReviewsError(message) {
    const reviewsList = document.getElementById('reviews-list');
    if (reviewsList) {
        reviewsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <div class="h5 mb-2">åŠ è½½å¤±è´¥</div>
                <p class="mb-3">${message}</p>
                <button class="btn btn-outline-primary" onclick="loadReviews()">
                    <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                </button>
            </div>
        `;
    }
}

async function loadHoldingAlerts() {
    console.log('ğŸ”” å¼€å§‹åŠ è½½æŒä»“æé†’');
    const holdingAlerts = document.getElementById('holding-alerts');

    if (!holdingAlerts) return;

    try {
        holdingAlerts.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                æ­£åœ¨åŠ è½½æé†’...
            </div>
        `;

        const response = await fetch('/api/holdings/alerts');
        const data = await response.json();

        if (data.success && data.data && data.data.length > 0) {
            displayHoldingAlerts(data.data);
        } else {
            showEmptyAlerts();
        }

    } catch (error) {
        console.error('åŠ è½½æŒä»“æé†’å¤±è´¥:', error);
        showAlertsError(error.message);
    }
}

function displayHoldingAlerts(alerts) {
    const holdingAlerts = document.getElementById('holding-alerts');
    if (!holdingAlerts) return;

    const alertsHtml = alerts.map(alert => `
        <div class="alert alert-${alert.type || 'info'} alert-dismissible fade show">
            <div class="d-flex align-items-center">
                <i class="fas fa-bell me-2"></i>
                <div class="flex-grow-1">
                    <div class="fw-bold">${alert.stock_code}</div>
                    <div class="small">${alert.message}</div>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `).join('');

    holdingAlerts.innerHTML = alertsHtml;
}

function showEmptyAlerts() {
    const holdingAlerts = document.getElementById('holding-alerts');
    if (holdingAlerts) {
        holdingAlerts.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <div class="h5 mb-2">æš‚æ— æé†’</div>
                <p class="mb-0">å½“å‰æŒä»“çŠ¶æ€è‰¯å¥½</p>
            </div>
        `;
    }
}

function showAlertsError(message) {
    const holdingAlerts = document.getElementById('holding-alerts');
    if (holdingAlerts) {
        holdingAlerts.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                <div class="h5 mb-2">åŠ è½½å¤±è´¥</div>
                <p class="mb-3">${message}</p>
                <button class="btn btn-outline-primary" onclick="loadHoldingAlerts()">
                    <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                </button>
            </div>
        `;
    }
}

function updateQuickReviewOptions(holdings) {
    const select = document.getElementById('quick-review-stock');
    if (!select) return;

    select.innerHTML = '<option value="">è¯·é€‰æ‹©æŒä»“è‚¡ç¥¨</option>';

    if (holdings && holdings.length > 0) {
        holdings.forEach(holding => {
            const option = document.createElement('option');
            option.value = holding.stock_code;
            option.textContent = `${holding.stock_code} - ${holding.stock_name || ''}`;
            select.appendChild(option);
        });
    }
}

function getDecisionText(decision) {
    const decisions = {
        'hold': 'ç»§ç»­æŒæœ‰',
        'sell_partial': 'éƒ¨åˆ†æ­¢ç›ˆ',
        'sell_all': 'æ¸…ä»“',
        '': '--'
    };
    return decisions[decision] || decision || '--';
}

// å…¨å±€å˜é‡
let autoRefreshInterval = null;
let isAutoRefreshEnabled = false;

// å…¨å±€å‡½æ•°
function refreshHoldings() {
    console.log('åˆ·æ–°æŒä»“æ•°æ®');
    loadHoldings();
}

function refreshHoldingsWithPrices() {
    console.log('å¼ºåˆ¶åˆ·æ–°æŒä»“æ•°æ®å’Œä»·æ ¼');
    loadHoldings(true); // ä¼ å…¥trueè¡¨ç¤ºå¼ºåˆ¶åˆ·æ–°ä»·æ ¼
}

function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    
    if (isAutoRefreshEnabled) {
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        isAutoRefreshEnabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> è‡ªåŠ¨åˆ·æ–°';
        btn.className = 'btn btn-sm btn-outline-info';
        console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
    } else {
        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        isAutoRefreshEnabled = true;
        btn.innerHTML = '<i class="fas fa-pause"></i> åœæ­¢åˆ·æ–°';
        btn.className = 'btn btn-sm btn-warning';
        
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡ä»·æ ¼
        autoRefreshInterval = setInterval(() => {
            console.log('è‡ªåŠ¨åˆ·æ–°ä»·æ ¼...');
            loadHoldings(true);
        }, 30000); // 30ç§’
        
        console.log('è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œæ¯30ç§’åˆ·æ–°ä¸€æ¬¡');
    }
}

function openQuickReview() {
    const select = document.getElementById('quick-review-stock');
    if (!select || !select.value) {
        alert('è¯·å…ˆé€‰æ‹©è‚¡ç¥¨');
        return;
    }
    openReviewModal(select.value);
}

function openReviewModal(stockCode) {
    console.log('ğŸ”§ æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†:', stockCode);

    if (!reviewModal) {
        console.error('âŒ å¤ç›˜æ¨¡æ€æ¡†æœªåˆå§‹åŒ–');
        alert('å¤ç›˜æ¨¡æ€æ¡†æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }

    try {
        // é‡ç½®è¡¨å•
        const form = document.getElementById('review-form');
        if (form) form.reset();

        // è®¾ç½®è‚¡ç¥¨ä»£ç 
        const stockCodeInput = document.getElementById('review-stock-code');
        const displayStockCode = document.getElementById('display-stock-code');

        if (stockCodeInput) stockCodeInput.value = stockCode;
        if (displayStockCode) displayStockCode.value = stockCode;

        // è®¾ç½®å½“å‰æ—¥æœŸ
        const reviewDate = document.getElementById('review-date');
        if (reviewDate) {
            reviewDate.value = new Date().toISOString().split('T')[0];
        }

        // æŸ¥æ‰¾æŒä»“ä¿¡æ¯å¹¶å¡«å……æ•°æ®
        const holding = currentHoldings.find(h => h.stock_code === stockCode);
        if (holding) {
            console.log('âœ… æ‰¾åˆ°æŒä»“ä¿¡æ¯:', holding);
            populateModalWithHoldingData(stockCode, holding);
        } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ°æŒä»“ä¿¡æ¯ï¼Œå°è¯•ä»APIè·å–:', stockCode);
            loadHoldingInfo(stockCode).then(holdingData => {
                if (holdingData) {
                    populateModalWithHoldingData(stockCode, holdingData);
                }
            });
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        reviewModal.show();
        console.log('âœ… æ¨¡æ€æ¡†æ˜¾ç¤ºæˆåŠŸ');

    } catch (error) {
        console.error('âŒ openReviewModalå¤±è´¥:', error);
        alert('æ‰“å¼€å¤ç›˜æ¨¡æ€æ¡†å¤±è´¥: ' + error.message);
    }
}

async function loadHoldingInfo(stockCode) {
    try {
        const response = await fetch('/api/holdings');
        const data = await response.json();
        
        if (data.success && data.data) {
            currentHoldings = data.data;
            const holding = data.data.find(h => h.stock_code === stockCode);
            return holding;
        }
        return null;
    } catch (error) {
        console.error('è·å–æŒä»“ä¿¡æ¯å¤±è´¥:', error);
        return null;
    }
}

function populateModalWithHoldingData(stockCode, holding) {
    console.log('ğŸ”§ å¡«å……æ¨¡æ€æ¡†æ•°æ®:', stockCode, holding);
    
    // è®¾ç½®æŒä»“å¤©æ•°
    const holdingDays = document.getElementById('holding-days');
    if (holdingDays) {
        holdingDays.value = holding.holding_days || 1;
    }

    // è®¾ç½®æˆæœ¬ä»·
    const buyPriceDisplay = document.getElementById('buy-price-display');
    if (buyPriceDisplay) {
        const buyPrice = holding.avg_buy_price || holding.avg_price;
        buyPriceDisplay.textContent = buyPrice ? `Â¥${buyPrice.toFixed(2)}` : '--';
        console.log('âœ… æˆæœ¬ä»·å·²è®¾ç½®:', buyPrice);
    }

    // è®¾ç½®å½“å‰ä»·æ ¼
    const currentPriceInput = document.getElementById('current-price-input');
    if (currentPriceInput && holding.current_price) {
        currentPriceInput.value = holding.current_price.toFixed(2);
        console.log('âœ… å½“å‰ä»·æ ¼å·²è®¾ç½®:', holding.current_price);
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºæµ®ç›ˆ
        calculateAndDisplayProfit(holding);
    }
}

function calculateAndDisplayProfit(holding) {
    const buyPrice = holding.avg_buy_price || holding.avg_price;
    const currentPrice = holding.current_price;
    
    if (buyPrice && currentPrice) {
        const profitRatio = ((currentPrice - buyPrice) / buyPrice * 100).toFixed(2);
        const profitRatioEl = document.getElementById('floating-profit-ratio');
        
        if (profitRatioEl) {
            profitRatioEl.textContent = profitRatio + '%';
            
            // è®¾ç½®é¢œè‰²
            const container = profitRatioEl.closest('.floating-profit-container');
            if (container) {
                container.className = 'floating-profit-container';
                if (profitRatio > 0) {
                    container.classList.add('profit');
                    profitRatioEl.style.color = '#dc3545'; // çº¢è‰²
                } else if (profitRatio < 0) {
                    container.classList.add('loss');
                    profitRatioEl.style.color = '#28a745'; // ç»¿è‰²
                } else {
                    container.classList.add('neutral');
                    profitRatioEl.style.color = '#6c757d'; // ç°è‰²
                }
            }
        }
    }
}

function saveReview() {
    console.log('ä¿å­˜å¤ç›˜è®°å½•');
    // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜é€»è¾‘
    alert('å¤ç›˜è®°å½•ä¿å­˜åŠŸèƒ½å¾…å®ç°');
}

function editReview(reviewId) {
    console.log('ç¼–è¾‘å¤ç›˜è®°å½•:', reviewId);
    // è¿™é‡Œå¯ä»¥æ·»åŠ ç¼–è¾‘é€»è¾‘
    alert('ç¼–è¾‘å¤ç›˜è®°å½•åŠŸèƒ½å¾…å®ç°');
}

</script>
{% endblock %}