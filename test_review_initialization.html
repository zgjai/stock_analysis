<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ç›˜é¡µé¢åˆå§‹åŒ–æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>å¤ç›˜é¡µé¢åˆå§‹åŒ–æµ‹è¯•</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>æµ‹è¯•æ§åˆ¶</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testInitialization()">æµ‹è¯•åˆå§‹åŒ–</button>
                        <button class="btn btn-info mb-2" onclick="diagnoseReviewPage()">è¯Šæ–­é¡µé¢</button>
                        <button class="btn btn-success mb-2" onclick="testSaveReview()">æµ‹è¯•ä¿å­˜åŠŸèƒ½</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>çŠ¶æ€æ˜¾ç¤º</h5>
                    </div>
                    <div class="card-body">
                        <div id="status-display">
                            <p>ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹çŠ¶æ€</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¨¡æ‹Ÿå¤ç›˜è¡¨å• -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>æ¨¡æ‹Ÿå¤ç›˜è¡¨å•</h5>
            </div>
            <div class="card-body">
                <form id="review-form">
                    <input type="hidden" id="review-stock-code" value="000001">
                    <input type="hidden" id="review-id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" class="form-control" id="display-stock-code" value="000001" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å¤ç›˜æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="review-date" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">æŒä»“å¤©æ•°</label>
                            <input type="number" class="form-control" id="holding-days" min="1" value="1" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å½“å‰ä»·æ ¼</label>
                            <input type="number" class="form-control" id="current-price-input" step="0.01" value="10.00">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">å†³ç­–ç»“æœ</label>
                        <select class="form-select" id="decision" required>
                            <option value="">è¯·é€‰æ‹©å†³ç­–</option>
                            <option value="hold">ç»§ç»­æŒæœ‰</option>
                            <option value="sell_partial">éƒ¨åˆ†æ­¢ç›ˆ</option>
                            <option value="sell_all">æ¸…ä»“</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">å†³ç­–ç†ç”±</label>
                        <textarea class="form-control" id="reason" rows="2" placeholder="è¯·è¾“å…¥å†³ç­–ç†ç”±..." required>æµ‹è¯•ç†ç”±</textarea>
                    </div>
                    
                    <button type="button" class="btn btn-primary" id="save-review-btn" onclick="saveReview()">ä¿å­˜å¤ç›˜</button>
                </form>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„JavaScriptæ–‡ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- å¼•å…¥é¡¹ç›®çš„JavaScriptæ–‡ä»¶ -->
    <script src="static/js/api.js"></script>
    <script src="static/js/review-save-manager.js"></script>
    
    <script>
        // å…¨å±€APIå®¢æˆ·ç«¯å’Œä¿å­˜ç®¡ç†å™¨å®ä¾‹
        let apiClient = null;
        let reviewSaveManager = null;

        // ä¾èµ–æ£€æŸ¥å‡½æ•°
        function checkDependencies() {
            console.log('ğŸ” æ£€æŸ¥JavaScriptä¾èµ–...');
            
            const dependencies = [
                { name: 'ApiClient', check: () => typeof ApiClient !== 'undefined' },
                { name: 'ReviewSaveManager', check: () => typeof ReviewSaveManager !== 'undefined' },
                { name: 'Bootstrap', check: () => typeof bootstrap !== 'undefined' }
            ];
            
            const missing = dependencies.filter(dep => !dep.check());
            
            if (missing.length > 0) {
                const missingNames = missing.map(dep => dep.name).join(', ');
                console.error('âŒ ç¼ºå°‘ä¾èµ–:', missingNames);
                showErrorMessage(`é¡µé¢ä¾èµ–åŠ è½½å¤±è´¥: ${missingNames}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`);
                return false;
            }
            
            console.log('âœ… æ‰€æœ‰ä¾èµ–æ£€æŸ¥é€šè¿‡');
            return true;
        }

        // åˆå§‹åŒ–APIå®¢æˆ·ç«¯
        function initializeApiClient() {
            console.log('ğŸ”§ åˆå§‹åŒ–APIå®¢æˆ·ç«¯...');
            
            try {
                if (typeof ApiClient !== 'undefined') {
                    apiClient = new ApiClient();
                    console.log('âœ… APIå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ ApiClientç±»æœªæ‰¾åˆ°');
                    showErrorMessage('APIå®¢æˆ·ç«¯åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return false;
                }
            } catch (error) {
                console.error('âŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
                showErrorMessage('APIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨
        function initializeReviewSaveManager() {
            console.log('ğŸ”§ åˆå§‹åŒ–å¤ç›˜ä¿å­˜ç®¡ç†å™¨...');
            
            try {
                if (typeof ReviewSaveManager !== 'undefined') {
                    reviewSaveManager = new ReviewSaveManager('#review-form');
                    console.log('âœ… å¤ç›˜ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ ReviewSaveManagerç±»æœªæ‰¾åˆ°');
                    showErrorMessage('ä¿å­˜ç®¡ç†å™¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return false;
                }
            } catch (error) {
                console.error('âŒ å¤ç›˜ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                showErrorMessage('ä¿å­˜ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º
        function showErrorMessage(message) {
            console.error('é”™è¯¯:', message);
            
            // åˆ›å»ºé”™è¯¯æç¤º
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // ç»Ÿä¸€æˆåŠŸæ¶ˆæ¯æ˜¾ç¤º
        function showSuccessMessage(message) {
            console.log('æˆåŠŸ:', message);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // é¡µé¢åˆå§‹åŒ–ä¸»å‡½æ•°
        async function initializeReviewPage() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–å¤ç›˜é¡µé¢');
            
            const initSteps = [
                { name: 'ä¾èµ–æ£€æŸ¥', fn: checkDependencies },
                { name: 'APIå®¢æˆ·ç«¯', fn: initializeApiClient },
                { name: 'ä¿å­˜ç®¡ç†å™¨', fn: initializeReviewSaveManager }
            ];
            
            let allSuccess = true;
            
            for (const step of initSteps) {
                try {
                    console.log(`ğŸ“‹ æ‰§è¡Œ${step.name}...`);
                    const success = step.fn();
                    if (success === false) {
                        console.error(`âŒ ${step.name}å¤±è´¥`);
                        allSuccess = false;
                        // ç»§ç»­æ‰§è¡Œå…¶ä»–æ­¥éª¤ï¼Œä¸ä¸­æ–­
                    } else {
                        console.log(`âœ… ${step.name}æˆåŠŸ`);
                    }
                } catch (error) {
                    console.error(`âŒ ${step.name}å¼‚å¸¸:`, error);
                    showErrorMessage(`${step.name}å¤±è´¥: ${error.message}`);
                    allSuccess = false;
                }
            }
            
            if (allSuccess) {
                console.log('ğŸ‰ å¤ç›˜é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                showSuccessMessage('å¤ç›˜é¡µé¢åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.warn('âš ï¸ å¤ç›˜é¡µé¢åˆå§‹åŒ–éƒ¨åˆ†å¤±è´¥ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨');
            }
            
            return allSuccess;
        }

        // ä¿å­˜å¤ç›˜å‡½æ•° - æ›¿æ¢å ä½ç¬¦å®ç°
        function saveReview() {
            console.log('ğŸ”§ æ‰§è¡Œå¤ç›˜ä¿å­˜');
            
            // æ£€æŸ¥ä¿å­˜ç®¡ç†å™¨æ˜¯å¦å·²åˆå§‹åŒ–
            if (!reviewSaveManager) {
                console.error('âŒ ä¿å­˜ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                showErrorMessage('ä¿å­˜åŠŸèƒ½æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            // æ£€æŸ¥APIå®¢æˆ·ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
            if (!apiClient) {
                console.error('âŒ APIå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                showErrorMessage('ç½‘ç»œè¿æ¥æœªæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            // è°ƒç”¨ä¿å­˜ç®¡ç†å™¨çš„ä¿å­˜æ–¹æ³•
            try {
                reviewSaveManager.saveReview();
            } catch (error) {
                console.error('âŒ è°ƒç”¨ä¿å­˜ç®¡ç†å™¨å¤±è´¥:', error);
                showErrorMessage('ä¿å­˜è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }

        // è°ƒè¯•å’Œæµ‹è¯•å‡½æ•°
        function testInitialization() {
            console.log('ğŸ§ª æµ‹è¯•åˆå§‹åŒ–çŠ¶æ€');
            
            const results = {
                dependencies: checkDependencies(),
                apiClient: apiClient !== null,
                reviewSaveManager: reviewSaveManager !== null
            };
            
            console.table(results);
            
            const allGood = Object.values(results).every(v => v === true);
            
            if (allGood) {
                showSuccessMessage('æ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–æ­£å¸¸');
            } else {
                showErrorMessage('éƒ¨åˆ†ç»„ä»¶åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusDiv = document.getElementById('status-display');
            statusDiv.innerHTML = `
                <h6>åˆå§‹åŒ–çŠ¶æ€:</h6>
                <ul class="list-unstyled">
                    <li>${results.dependencies ? 'âœ…' : 'âŒ'} ä¾èµ–æ£€æŸ¥</li>
                    <li>${results.apiClient ? 'âœ…' : 'âŒ'} APIå®¢æˆ·ç«¯</li>
                    <li>${results.reviewSaveManager ? 'âœ…' : 'âŒ'} ä¿å­˜ç®¡ç†å™¨</li>
                </ul>
            `;
            
            return results;
        }

        // è¯Šæ–­å‡½æ•°
        function diagnoseReviewPage() {
            console.log('ğŸ” è¯Šæ–­å¤ç›˜é¡µé¢çŠ¶æ€');
            
            const diagnosis = {
                'é¡µé¢å…ƒç´ ': {
                    'review-form': !!document.getElementById('review-form'),
                    'save-review-btn': !!document.getElementById('save-review-btn')
                },
                'JavaScriptç±»': {
                    'ApiClient': typeof ApiClient !== 'undefined',
                    'ReviewSaveManager': typeof ReviewSaveManager !== 'undefined',
                    'Bootstrap': typeof bootstrap !== 'undefined'
                },
                'å…¨å±€å®ä¾‹': {
                    'apiClient': apiClient !== null,
                    'reviewSaveManager': reviewSaveManager !== null
                }
            };
            
            console.group('ğŸ“Š è¯Šæ–­ç»“æœ');
            Object.entries(diagnosis).forEach(([category, items]) => {
                console.group(category);
                Object.entries(items).forEach(([item, status]) => {
                    console.log(`${status ? 'âœ…' : 'âŒ'} ${item}: ${status}`);
                });
                console.groupEnd();
            });
            console.groupEnd();
            
            return diagnosis;
        }

        // æµ‹è¯•ä¿å­˜åŠŸèƒ½
        function testSaveReview() {
            console.log('ğŸ§ª æµ‹è¯•ä¿å­˜åŠŸèƒ½');
            
            // è®¾ç½®æµ‹è¯•æ•°æ®
            document.getElementById('review-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('decision').value = 'hold';
            
            // è°ƒç”¨ä¿å­˜
            saveReview();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å¤ç›˜é¡µé¢');
            await initializeReviewPage();
        });

        // åœ¨æ§åˆ¶å°ä¸­æš´éœ²æµ‹è¯•å‡½æ•°
        window.testInitialization = testInitialization;
        window.diagnoseReviewPage = diagnoseReviewPage;
        window.testSaveReview = testSaveReview;
    </script>
</body>
</html>